
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>R: Reserving with LASSO &#8212; Actuaries&#39; Analytical Cookbook</title>
    
  <link href="../_static/css/theme.css" rel="stylesheet">
  <link href="../_static/css/index.ff1ffe594081f20da1ef19478df9384b.css" rel="stylesheet">

    
  <link rel="stylesheet"
    href="../_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    
      

    
    <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-book-theme.css?digest=c3fdc42140077d1ad13ad2f1588a4309" />
    <link rel="stylesheet" type="text/css" href="../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/mystnb.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="../_static/panels-main.c949a650a448cc0ae9fd3441c0e17fb0.css" />
    <link rel="stylesheet" type="text/css" href="../_static/panels-variables.06eb56fa6e07937060861dad626602ad.css" />
    
  <link rel="preload" as="script" href="../_static/js/index.be7d3bbb2ef33a8344ce.js">

    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/togglebutton.js"></script>
    <script src="../_static/clipboard.min.js"></script>
    <script src="../_static/copybutton.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
    <script src="../_static/sphinx-book-theme.d59cb220de22ca1c485ebbdc042f0030.js"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"
const thebe_selector = ".thebe,.cell"
const thebe_selector_input = "pre"
const thebe_selector_output = ".output, .cell_output"
</script>
    <script async="async" src="../_static/sphinx-thebe.js"></script>
    <script>window.MathJax = {"options": {"processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="R: Machine Learning Triangles" href="MLRWP_R_mlr3.html" />
    <link rel="prev" title="R: Reserving with GLMs" href="MLRWP_R_GLMs.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="None">
    

    <!-- Google Analytics -->
    
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="80">
    
    <div class="container-fluid" id="banner"></div>

    

    <div class="container-xl">
      <div class="row">
          
<div class="col-12 col-md-3 bd-sidebar site-navigation show" id="site-navigation">
    
        <div class="navbar-brand-box">
    <a class="navbar-brand text-wrap" href="../index.html">
      
        <!-- `logo` is deprecated in Sphinx 4.0, so remove this when we stop supporting 3 -->
        
      
      
      <img src="../_static/actuaries-logo.svg" class="logo" alt="logo">
      
      
      <h1 class="site-logo" id="site-title">Actuaries' Analytical Cookbook</h1>
      
    </a>
</div><form class="bd-search d-flex align-items-center" action="../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search this book..." aria-label="Search this book..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item active">
        <p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Introduction to Python
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="about_py.html">
   About Python
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="getting_started.html">
   Setting up Your Python Environment
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="python_by_example.html">
   An Introductory Example
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="learn_more.html">
   Learn More
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="Useful_Python_packages.html">
   Useful Python packages for Data Science
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Introduction to R
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="about_R.html">
   About R
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="getting_started_R.html">
   Setting Up R
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="introductory_R.html">
   Introduction to R
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="intermediate_R.html">
   Next Steps With R
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="top_ten_r_packages.html">
   Useful Packages
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="MLRWP_R_DataTable.html">
   R: data.table for actuaries
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Workflow Management
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="version_control.html">
   Version control
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Regression, Classification and Technical Price
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="DAA_M05_CS1.html">
   Py: Customer Churn Classification
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="multitasking_risk_pricing.html">
   Py/R: Multitasking Risk Pricing Using Deep Learning
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="py_shap_values.html">
   Py: Explainable Models with SHAP
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Life Insurance
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="LifeRecipeBook.html">
   R: Life Modelling Recipes
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="life_stats.html">
   R: Life Industry Stats in Tableau and R
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  General Insurance
 </span>
</p>
<ul class="current nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="MLRWP_R_GLMs.html">
   R: Reserving with GLMs
  </a>
 </li>
 <li class="toctree-l1 current active">
  <a class="current reference internal" href="#">
   R: Reserving with LASSO
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="MLRWP_R_mlr3.html">
   R: Machine Learning Triangles
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="MLRWP_Py_triangles_example.html">
   Py: Machine Learning Triangles
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Unsupervised Learning
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="DAA_M06_CS1.html">
   Py: Socio-Economic Index Construction
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="DAA_M06_CS2.html">
   Py: Clustering Credit Card Fraud
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="DAA_M06_Ex4.html">
   Py: K-means clustering of COVID dataset
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="DAA_M06_Ex5.html">
   Py: Hierarchical clustering on COVID dataset
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Natural Language Processing
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="R_case_study_word_cloud.html">
   R: Word Cloud Case Study
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="textClassificationEntry.html">
   Py: Text Classification
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="DAA_M05_Ex10.html">
   Py: Decision Tree Classification
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="DAA_M05_Ex18.html">
   Py: Neural Net Classification
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="DAA_M07_CS1.html">
   Py: Classifying review sentiment
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="DAA_M07_CS2.html">
   Py: Customer Sentiment Analysis
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Business Optimization
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="DAA_2021_S2_Tutorial10_exercise_scipy.html">
   Py: Linear Programming
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Image Recognition
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="DAA_M05_CS2.html">
   Py: Image Recognition
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Data Ethics
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="automated_decision.html">
   Automated Decision-Making Systems
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Contributing
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="contributing.html">
   Contributing
  </a>
 </li>
</ul>

    </div>
</nav> <!-- To handle the deprecated key -->

<div class="navbar_extra_footer">
  Powered by <a href="https://jupyterbook.org">Jupyter Book</a>
</div>

</div>


          


          
<main class="col py-md-3 pl-md-4 bd-content overflow-auto" role="main">
    
    <div class="topbar container-xl fixed-top">
    <div class="topbar-contents row">
        <div class="col-12 col-md-3 bd-topbar-whitespace site-navigation show"></div>
        <div class="col pl-md-4 topbar-main">
            
            <button id="navbar-toggler" class="navbar-toggler ml-0" type="button" data-toggle="collapse"
                data-toggle="tooltip" data-placement="bottom" data-target=".site-navigation" aria-controls="navbar-menu"
                aria-expanded="true" aria-label="Toggle navigation" aria-controls="site-navigation"
                title="Toggle navigation" data-toggle="tooltip" data-placement="left">
                <i class="fas fa-bars"></i>
                <i class="fas fa-arrow-left"></i>
                <i class="fas fa-arrow-up"></i>
            </button>
            
            
<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn" aria-label="Download this page"><i
            class="fas fa-download"></i></button>

    <div class="dropdown-buttons">
        <!-- ipynb file if we had a myst markdown file -->
        
        <!-- Download raw file -->
        <a class="dropdown-buttons" href="../_sources/docs/MLRWP_R_Lasso.ipynb"><button type="button"
                class="btn btn-secondary topbarbtn" title="Download source file" data-toggle="tooltip"
                data-placement="left">.ipynb</button></a>
        <!-- Download PDF via print -->
        <button type="button" id="download-print" class="btn btn-secondary topbarbtn" title="Print to PDF"
                onclick="printPdf(this)" data-toggle="tooltip" data-placement="left">.pdf</button>
    </div>
</div>

            <!-- Source interaction buttons -->

<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn"
        aria-label="Connect with source repository"><i class="fab fa-github"></i></button>
    <div class="dropdown-buttons sourcebuttons">
        <a class="repository-button"
            href="https://github.com/ActuariesInstitute/cookbook"><button type="button" class="btn btn-secondary topbarbtn"
                data-toggle="tooltip" data-placement="left" title="Source repository"><i
                    class="fab fa-github"></i>repository</button></a>
        
        <a class="edit-button" href="https://github.com/ActuariesInstitute/cookbook/edit/main/cookbook/docs/MLRWP_R_Lasso.ipynb"><button
                type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip" data-placement="left"
                title="Edit this page"><i class="fas fa-pencil-alt"></i>suggest edit</button></a>
    </div>
</div>

            <!-- Full screen (wrap in <a> to have style consistency -->

<a class="full-screen-button"><button type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip"
        data-placement="bottom" onclick="toggleFullScreen()" aria-label="Fullscreen mode"
        title="Fullscreen mode"><i
            class="fas fa-expand"></i></button></a>

            <!-- Launch buttons -->

<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn"
        aria-label="Launch interactive content"><i class="fas fa-rocket"></i></button>
    <div class="dropdown-buttons">
        
        <a class="binder-button" href="https://mybinder.org/v2/gh/ActuariesInstitute/cookbook/main?urlpath=tree/cookbook/docs/MLRWP_R_Lasso.ipynb"><button type="button"
                class="btn btn-secondary topbarbtn" title="Launch Binder" data-toggle="tooltip"
                data-placement="left"><img class="binder-button-logo"
                    src="../_static/images/logo_binder.svg"
                    alt="Interact on binder">Binder</button></a>
        
        
        
        <a class="colab-button" href="https://colab.research.google.com/github/ActuariesInstitute/cookbook/blob/main/cookbook/docs/MLRWP_R_Lasso.ipynb"><button type="button" class="btn btn-secondary topbarbtn"
                title="Launch Colab" data-toggle="tooltip" data-placement="left"><img class="colab-button-logo"
                    src="../_static/images/logo_colab.png"
                    alt="Interact on Colab">Colab</button></a>
        
        <button type="button" class="btn btn-secondary topbarbtn"
            onclick="initThebeSBT()" title="Launch Thebe" data-toggle="tooltip" data-placement="left"><i
                class="fas fa-play"></i><span style="margin-left: .4em;">Live Code</span></button>
        
    </div>
</div>

        </div>

        <!-- Table of contents -->
        <div class="d-none d-md-block col-md-2 bd-toc show noprint">
            
            <div class="tocsection onthispage pt-5 pb-3">
                <i class="fas fa-list"></i> Contents
            </div>
            <nav id="bd-toc-nav" aria-label="Page">
                <ul class="visible nav section-nav flex-column">
 <li class="toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="#">
   R: Reserving with LASSO
  </a>
 </li>
 <li class="toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="#introduction-to-the-lasso">
   Introduction to the LASSO
  </a>
  <ul class="visible nav section-nav flex-column">
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#from-glms">
     From GLMs …
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#to-the-lasso">
     … to the LASSO
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#model-selection">
     Model selection
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="#using-the-lasso-for-reserving">
   Using the LASSO for reserving
  </a>
 </li>
 <li class="toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="#tutorial-on-how-to-use-our-lasso-technique-for-reserving">
   Tutorial on how to use our LASSO technique for reserving
  </a>
  <ul class="visible nav section-nav flex-column">
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#initial-setup">
     Initial Setup
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#generating-the-synthetic-data-set">
     Generating the synthetic data set
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#specifying-the-lasso-model">
     Specifying the LASSO model
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#set-of-basis-functions">
       Set of basis functions
      </a>
     </li>
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#scaling">
       Scaling
      </a>
     </li>
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#code">
       Code
      </a>
     </li>
    </ul>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#fitting-a-lasso">
     Fitting a LASSO
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#analysing-the-model">
     Analysing the model
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#model-coefficients">
       Model coefficients
      </a>
     </li>
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#tracking-plots">
       Tracking plots
      </a>
     </li>
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#heat-map">
       Heat map
      </a>
     </li>
    </ul>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#claims-reserves">
     Claims reserves
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#chainladder-reserves">
       Chainladder reserves
      </a>
     </li>
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#results-by-accident-period">
       Results by accident period
      </a>
     </li>
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#total-reserves">
       Total reserves
      </a>
     </li>
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#commentary">
       Commentary
      </a>
     </li>
    </ul>
   </li>
  </ul>
 </li>
 <li class="toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="#conclusion">
   Conclusion
  </a>
 </li>
 <li class="toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="#session-information">
   Session information
  </a>
 </li>
</ul>

            </nav>
        </div>
    </div>
</div>
    <div id="main-content" class="row">
        <div class="col-12 col-md-9 pl-md-3 pr-md-0">
            <!-- Table of contents that is only displayed when printing the page -->
            <div id="jb-print-docs-body" class="onlyprint">
                <h1>R: Reserving with LASSO</h1>
                <!-- Table of contents -->
                <div id="print-main-content">
                    <div id="jb-print-toc">
                        
                        <div>
                            <h2> Contents </h2>
                        </div>
                        <nav aria-label="Page">
                            <ul class="visible nav section-nav flex-column">
 <li class="toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="#">
   R: Reserving with LASSO
  </a>
 </li>
 <li class="toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="#introduction-to-the-lasso">
   Introduction to the LASSO
  </a>
  <ul class="visible nav section-nav flex-column">
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#from-glms">
     From GLMs …
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#to-the-lasso">
     … to the LASSO
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#model-selection">
     Model selection
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="#using-the-lasso-for-reserving">
   Using the LASSO for reserving
  </a>
 </li>
 <li class="toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="#tutorial-on-how-to-use-our-lasso-technique-for-reserving">
   Tutorial on how to use our LASSO technique for reserving
  </a>
  <ul class="visible nav section-nav flex-column">
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#initial-setup">
     Initial Setup
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#generating-the-synthetic-data-set">
     Generating the synthetic data set
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#specifying-the-lasso-model">
     Specifying the LASSO model
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#set-of-basis-functions">
       Set of basis functions
      </a>
     </li>
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#scaling">
       Scaling
      </a>
     </li>
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#code">
       Code
      </a>
     </li>
    </ul>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#fitting-a-lasso">
     Fitting a LASSO
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#analysing-the-model">
     Analysing the model
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#model-coefficients">
       Model coefficients
      </a>
     </li>
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#tracking-plots">
       Tracking plots
      </a>
     </li>
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#heat-map">
       Heat map
      </a>
     </li>
    </ul>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#claims-reserves">
     Claims reserves
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#chainladder-reserves">
       Chainladder reserves
      </a>
     </li>
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#results-by-accident-period">
       Results by accident period
      </a>
     </li>
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#total-reserves">
       Total reserves
      </a>
     </li>
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#commentary">
       Commentary
      </a>
     </li>
    </ul>
   </li>
  </ul>
 </li>
 <li class="toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="#conclusion">
   Conclusion
  </a>
 </li>
 <li class="toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="#session-information">
   Session information
  </a>
 </li>
</ul>

                        </nav>
                    </div>
                </div>
            </div>
            
              <div>
                
  <div class="tex2jax_ignore mathjax_ignore section" id="r-reserving-with-lasso">
<h1>R: Reserving with LASSO<a class="headerlink" href="#r-reserving-with-lasso" title="Permalink to this headline">¶</a></h1>
<p><em>This article was originally created by Grainne McGuire and Greg Taylor and published in the <a class="reference external" href="https://institute-and-faculty-of-actuaries.github.io/mlr-blog/">General Insurance Machine Learning for Reserving Working Party (“MLR-WP”) blog</a>. The MLR-WP is an international research group on machine learning techniques to reserving, with over 50 actuaries from around the globe. The goal of the group is to bring machine learning techniques into widespread adoption ‘on the ground’ by identifying what the barriers are, communicating any benefits, and helping develop the research techniques in pragmatic ways. Whilst some articles have been brought into this cookbook, consider exploring the <a class="reference external" href="https://institute-and-faculty-of-actuaries.github.io/mlr-blog/">blog</a> further for additional content including detailed walkthroughs of more advanced models.</em></p>
<p><em>In this post we look at how regularised regression techniques such as the LASSO can be used to set reserves for triangles.</em></p>
<p>The <span class="xref myst">Foundation Workstream’s first post</span> set out a suggested path to getting to grips with machine learning. The first step was to start by applying GLMs to reserving and one way of doing this was covered in our most recent post (<a class="reference external" href="https://institute-and-faculty-of-actuaries.github.io/mlr-blog/post/glms/">Reserving with GLMs</a>).</p>
<p>In this post, we move onto the next step which is to use regularised regression methods. These allow us to build something that looks like a GLM but in a machine learning way - i.e. the machine selects the model.
Put simply, regularisation techniques shrink or regularise regression parameters towards zero (excluding the intercept - this is normally not regularised, so in effect, this means that the fitted values are regularised towards the constant term in the regression). This penalises more complex models and reduces the risk of overfitting.</p>
<p>Here we will be focussing on a particular type of regularised regression, called the LASSO. As well as shrinking the parameters towards zero, the LASSO also selects parameters (and their corresponding regressor) by explicitly setting some to zero. This makes it a particularly useful method.</p>
<p>Below we will first provide a brief technical overview of the LASSO for those interested, before moving onto a practical example.</p>
</div>
<div class="tex2jax_ignore mathjax_ignore section" id="introduction-to-the-lasso">
<h1>Introduction to the LASSO<a class="headerlink" href="#introduction-to-the-lasso" title="Permalink to this headline">¶</a></h1>
<p>The LASSO (<strong>L</strong>east <strong>A</strong>bsolute <strong>S</strong>hrinkage and <strong>S</strong>election <strong>O</strong>perator) is a form of regularised regression. This means that the regression is subject to a penalty for the addition of each additional term in the predictor. The purpose of this is to prevent over-fitting of the model to data.</p>
<div class="section" id="from-glms">
<h2>From GLMs …<a class="headerlink" href="#from-glms" title="Permalink to this headline">¶</a></h2>
<p>The loss function associated with a GLM regression is the <strong>deviance</strong>, defined as</p>
<div class="math notranslate nohighlight">
\[D(y; X, \hat{\beta}) = -\sum_{i=1}^N \ell (y_i; X, \hat{\beta})  + \text{other terms}\]</div>
<p>where:</p>
<ul class="simple">
<li><p><span class="math notranslate nohighlight">\(y\)</span> is the <em>N</em>-vector of observations <span class="math notranslate nohighlight">\(y_i\)</span></p></li>
<li><p><span class="math notranslate nohighlight">\(X\)</span> is the regression design matrix</p></li>
<li><p><span class="math notranslate nohighlight">\(\beta\)</span> is the <em>p</em>-vector of coefficients <span class="math notranslate nohighlight">\(\beta_j\)</span> in the linear predictor</p></li>
<li><p><span class="math notranslate nohighlight">\(\hat{\beta}\)</span> is the regression estimate of <span class="math notranslate nohighlight">\(\beta\)</span></p></li>
<li><p><span class="math notranslate nohighlight">\(\ell (y_i; X, \hat{\beta})\)</span> is the log-likelihood of observation <span class="math notranslate nohighlight">\(y_i\)</span></p></li>
<li><p>the other terms are of no great interest here.</p></li>
</ul>
<p>Parameter estimation of a GLM can be performed by minimisation of the deviance with respect to <span class="math notranslate nohighlight">\(\hat{\beta}\)</span>, which is equivalent to maximisation of the likelihood.</p>
</div>
<div class="section" id="to-the-lasso">
<h2>… to the LASSO<a class="headerlink" href="#to-the-lasso" title="Permalink to this headline">¶</a></h2>
<p>The loss function for the LASSO version of this GLM is:</p>
<div class="math notranslate nohighlight">
\[\mathcal{L} (y; X, \hat{\beta}) = D(y; X, \hat{\beta}) + \lambda ||\hat{\beta}||_1\]</div>
<p>where:</p>
<ul class="simple">
<li><p><span class="math notranslate nohighlight">\(\lambda ||\hat{\beta}||_1\)</span> is the parameter penalty or regularisation</p></li>
<li><p><span class="math notranslate nohighlight">\(||\hat{\beta}||_1 = \sum_{j=1}^p | \hat{\beta}_j|\)</span> is the <span class="math notranslate nohighlight">\(L_1\)</span> norm of <span class="math notranslate nohighlight">\(\hat{\beta}\)</span> (which is the absolute value)</p></li>
<li><p><span class="math notranslate nohighlight">\(\lambda \geq 0\)</span> is a tuning parameter controlling the size of the penalty and therefore the amount of the regularisation.</p></li>
</ul>
<p>LASSO parameter estimation is effected by minimisation of <span class="math notranslate nohighlight">\(\mathcal{L} (y; X, \hat{\beta})\)</span> with respect to <span class="math notranslate nohighlight">\(\hat{\beta}\)</span>. The quantity <span class="math notranslate nohighlight">\(\lambda ||\hat{\beta}||_1\)</span> adds a penalty for each non-zero coefficient.</p>
</div>
<div class="section" id="model-selection">
<h2>Model selection<a class="headerlink" href="#model-selection" title="Permalink to this headline">¶</a></h2>
<p>The non-differentiability of the penalty function tends to cause the occurrence of corner solutions in the minimisation, so that some coefficients <span class="math notranslate nohighlight">\(\hat{\beta}_j\)</span> are forced to zero.<br />
The strength of this effect increases with <span class="math notranslate nohighlight">\(\lambda\)</span>. In the limit <span class="math notranslate nohighlight">\(\lambda=0\)</span>, the LASSO is the same as the GLM; in the limit <span class="math notranslate nohighlight">\(\lambda \rightarrow \infty\)</span>, the LASSO model becomes null, i.e. <span class="math notranslate nohighlight">\(\hat{\beta} = 0\)</span> (other than the intercept if this has not been regularised). Thus, as <span class="math notranslate nohighlight">\(\lambda\)</span> increases from 0 to <span class="math notranslate nohighlight">\(\infty\)</span>, the LASSO model shifts from the relatively complex GLM to increasingly simpler representations of the data.</p>
<p>In practical use, models are fitted for a number of different possible values of <span class="math notranslate nohighlight">\(\lambda\)</span> (a path of values, from high to low).
Cross-validation may then be used to select a particular <span class="math notranslate nohighlight">\(\lambda\)</span>, and therefore model - one popular choice is the model which minimises the selected error measure over the different folds. Another popular alternative is to select the model with an average error across the folds that is one standard deviation away from the minimum. In this case, it is always the simpler model (i.e. higher <span class="math notranslate nohighlight">\(\lambda\)</span> value) that is selected with the aim of further reducing the risk of overfitting.</p>
<p>There is a Bayesian version of the LASSO (further details in the paper, and references therein), in which it is viewed as a hierarchical model, consisting of the original GLM with randomised parameters, each subject to the Laplace prior density:</p>
<div class="math notranslate nohighlight">
\[ \pi(\beta_j) = \frac{1}{2} \lambda \exp( -\lambda | \beta_j |), \space\space\space\space -\infty &lt; \beta_j &lt; \infty .\]</div>
<p>The LASSO is dealt with in more detail in <a class="reference external" href="https://web.stanford.edu/~hastie/ElemStatLearn/">Hastie T, Tibshirani R and Friedman J. (2009). <strong>The Elements of Statistical Learning: Data Mining, Inference and Prediction</strong>. Springer, New York USA.</a></p>
</div>
</div>
<div class="tex2jax_ignore mathjax_ignore section" id="using-the-lasso-for-reserving">
<h1>Using the LASSO for reserving<a class="headerlink" href="#using-the-lasso-for-reserving" title="Permalink to this headline">¶</a></h1>
<p>In GIRO 2018 (and presented again at TIGI 2019), we, along with our co-author Hugh Miller, describe how the LASSO could be used to carry out reserving for a traditional triangle.
The motivation behind this work was to develop an automatic method to construct a general insurance claims reserving model for data sets with complex features where simple approaches such as the chain ladder fail. In the past we have advocated the use of GLM models for such data sets, but the construction of a GLM is a time-consuming process, even for a skilled analyst. Our aim was to develop a procedure that produced a model similar to a GLM, but using machine learning techniques.</p>
<p>We used the LASSO rather than other types of regularised regression, for the following reasons:</p>
<ul class="simple">
<li><p>The ability of the LASSO to select parameters (by setting some parameter estimates to zero)</p></li>
<li><p>The LASSO leads to lower error variance in the fitted values (at the cost of some additional bias).</p></li>
</ul>
<p>This approach has performed well - as may be seen from the figures towards the end of this article, which show that the fitted curves can track the underlying specification quite closely, even in the presence of significant noise, or difficult to detect interactions. A paper describing the method is available on <a class="reference external" href="https://papers.ssrn.com/sol3/papers.cfm?abstract_id=3241906">SSRN</a>. This contains much more technical detail around the choice, use and implementation of the LASSO for the reserving problem.</p>
<p>For the rest of this post, we will work through this method in a tutorial example.
This is based on an existing <a class="reference external" href="https://grainnemcguire.github.io/post/self-assembling-claim-reserving-models/">worked example</a> so if you’ve seen that one, then you may already be familiar with a lot of the content below.</p>
</div>
<div class="tex2jax_ignore mathjax_ignore section" id="tutorial-on-how-to-use-our-lasso-technique-for-reserving">
<h1>Tutorial on how to use our LASSO technique for reserving<a class="headerlink" href="#tutorial-on-how-to-use-our-lasso-technique-for-reserving" title="Permalink to this headline">¶</a></h1>
<p>In our paper we investigate the use of the LASSO using four synthetic (i.e. simulated) data sets as well as a real data set. This worked example will use the third simulated data set. The specifications for this data set are given in Section 4.2.1 of the paper. The main points to note are that this data set:</p>
<ul class="simple">
<li><p>is a 40x40 triangle, with</p></li>
<li><p>accident and development period effects</p></li>
<li><p>calendar period effects (i.e. superimposed inflation)</p></li>
<li><p>a step-interaction between accident and development period for accident periods greater than 16 and development periods greater than 20 (note this affects only 10 cells of the triangle)</p></li>
</ul>
<p>These effects are represented graphically below.</p>
<div class="cell tag_remove_input docutils container">
<div class="cell_output docutils container">
<img alt="../_images/MLRWP_R_Lasso_11_0.png" src="../_images/MLRWP_R_Lasso_11_0.png" />
</div>
</div>
<div class="section" id="initial-setup">
<h2>Initial Setup<a class="headerlink" href="#initial-setup" title="Permalink to this headline">¶</a></h2>
<p>First we must open R and load any libraries required. These include:</p>
<ul class="simple">
<li><p><strong>data.table</strong> for manipulating data</p></li>
<li><p><strong>glmnet</strong> to fit the LASSO model</p></li>
<li><p><strong>ggplot2</strong> and <strong>patchwork</strong> for graphing</p></li>
</ul>
<p>If you would prefer all data manipulation in base R, then refer to the [original version of this tutorial](<a class="reference external" href="https://grainnemcguire.github.io/post/self-assembling-claim-reserving-models/">worked example</a>).</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="nf">library</span><span class="p">(</span><span class="n">data.table</span><span class="p">)</span>
<span class="nf">library</span><span class="p">(</span><span class="n">glmnet</span><span class="p">)</span>
<span class="nf">library</span><span class="p">(</span><span class="n">ggplot2</span><span class="p">)</span>
<span class="nf">library</span><span class="p">(</span><span class="n">patchwork</span><span class="p">)</span>

<span class="nf">library</span><span class="p">(</span><span class="n">kableExtra</span><span class="p">)</span> <span class="c1"># format tables nicely</span>
<span class="nf">library</span><span class="p">(</span><span class="n">magrittr</span><span class="p">)</span>  <span class="c1"># to use the pipe %&gt;%</span>

<span class="c1"># other setup</span>
<span class="nf">options</span><span class="p">(</span><span class="s">&quot;scipen&quot;</span><span class="o">=</span><span class="m">99</span><span class="p">)</span> <span class="c1"># turn off scientific notation</span>

<span class="c1"># colour palette for some plots</span>
<span class="c1"># IFoA colours</span>
<span class="c1"># primary colours</span>
<span class="n">dblue</span> <span class="o">&lt;-</span> <span class="s">&quot;#113458&quot;</span>
<span class="n">mblue</span> <span class="o">&lt;-</span> <span class="s">&quot;#4096b8&quot;</span>
<span class="n">gold</span> <span class="o">&lt;-</span> <span class="s">&quot;#d9ab16&quot;</span>
<span class="n">lgrey</span> <span class="o">&lt;-</span> <span class="s">&quot;#dcddd9&quot;</span>
<span class="n">dgrey</span> <span class="o">&lt;-</span> <span class="s">&quot;#3f4548&quot;</span>
<span class="n">black</span> <span class="o">&lt;-</span> <span class="s">&quot;#3F4548&quot;</span>
<span class="c1">#secondary colours</span>
<span class="n">red</span> <span class="o">&lt;-</span> <span class="s">&quot;#d01e45&quot;</span>
<span class="n">purple</span> <span class="o">&lt;-</span> <span class="s">&quot;#8f4693&quot;</span>
<span class="n">orange</span> <span class="o">&lt;-</span> <span class="s">&quot;#ee741d&quot;</span>
<span class="n">fuscia</span> <span class="o">&lt;-</span> <span class="s">&quot;#e9458c&quot;</span>
<span class="n">violet</span> <span class="o">&lt;-</span> <span class="s">&quot;#8076cf&quot;</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Loading required package: Matrix

Loaded glmnet 4.1-1
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="generating-the-synthetic-data-set">
<h2>Generating the synthetic data set<a class="headerlink" href="#generating-the-synthetic-data-set" title="Permalink to this headline">¶</a></h2>
<p>The functions defined below will generate data sets similar to those used in our paper.
Here we’ll use simulated data set 3, but we’ve included the code to generate the other data sets so that you can experiment with others if you wish.</p>
<p>The utility function <code class="docutils literal notranslate"><span class="pre">LinearSpline()</span></code> will be widely used in this example - it takes a vector <code class="docutils literal notranslate"><span class="pre">var</span></code> and produces a spline piece between <code class="docutils literal notranslate"><span class="pre">start</span></code> and <code class="docutils literal notranslate"><span class="pre">stop</span></code> - flat (and 0) up to <code class="docutils literal notranslate"><span class="pre">start</span></code>, thereafter increasing to <code class="docutils literal notranslate"><span class="pre">stop</span></code> and then levelling out at this point. This is used both in the data generation and in the generation of basis functions for the LASSO.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">LinearSpline</span> <span class="o">&lt;-</span> <span class="nf">function</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">stop</span><span class="p">){</span>
	<span class="nf">pmin</span><span class="p">(</span><span class="n">stop</span> <span class="o">-</span> <span class="n">start</span><span class="p">,</span> <span class="nf">pmax</span><span class="p">(</span><span class="m">0</span><span class="p">,</span> <span class="n">var</span> <span class="o">-</span> <span class="n">start</span><span class="p">))</span>
<span class="p">}</span>


<span class="n">CreateSyntheticData</span><span class="o">&lt;-</span><span class="nf">function</span><span class="p">(</span><span class="n">whichsim</span><span class="p">,</span> <span class="n">numperiods</span><span class="p">)</span>
<span class="p">{</span>

    <span class="c1"># whichsim determins which data set to simulate</span>
    <span class="c1"># numperiods determines the size of the triangle</span>

	<span class="c1"># create the acc/dev/cal parameters</span>
	<span class="n">kk</span> <span class="o">&lt;-</span> <span class="nf">rep</span><span class="p">(</span><span class="m">1</span><span class="o">:</span><span class="n">numperiods</span><span class="p">,</span> <span class="n">each</span> <span class="o">=</span> <span class="n">numperiods</span><span class="p">)</span> <span class="c1">#AQ</span>
	<span class="n">jj</span> <span class="o">&lt;-</span> <span class="nf">rep</span><span class="p">(</span><span class="m">1</span><span class="o">:</span><span class="n">numperiods</span><span class="p">,</span> <span class="n">times</span><span class="o">=</span> <span class="n">numperiods</span><span class="p">)</span> <span class="c1">#DQ</span>
	<span class="n">tt</span> <span class="o">&lt;-</span> <span class="n">kk</span><span class="o">+</span><span class="n">jj</span><span class="m">-1</span> <span class="c1"># PQ</span>

	<span class="c1"># set alpha/beta/gamma - hard-code up the sim values</span>
	<span class="nf">if </span><span class="p">(</span><span class="n">whichsim</span> <span class="o">==</span> <span class="m">1</span><span class="p">){</span>
		<span class="n">alpha</span> <span class="o">&lt;-</span> <span class="nf">log</span><span class="p">(</span><span class="m">100000</span><span class="p">)</span><span class="m">+0.1</span><span class="o">*</span><span class="nf">LinearSpline</span><span class="p">(</span><span class="n">kk</span><span class="p">,</span><span class="m">1</span><span class="p">,</span><span class="m">15</span><span class="p">)</span><span class="m">+0.2</span><span class="o">*</span><span class="nf">LinearSpline</span><span class="p">(</span><span class="n">kk</span><span class="p">,</span><span class="m">15</span><span class="p">,</span><span class="m">20</span><span class="p">)</span> <span class="o">-</span> <span class="m">0.05</span><span class="o">*</span><span class="nf">LinearSpline</span><span class="p">(</span><span class="n">kk</span><span class="p">,</span><span class="m">30</span><span class="p">,</span><span class="m">40</span><span class="p">)</span>
		<span class="n">beta</span>  <span class="o">&lt;-</span> <span class="p">(</span><span class="m">16</span><span class="o">/</span><span class="m">3</span> <span class="o">-</span> <span class="m">1</span><span class="p">)</span><span class="o">*</span><span class="nf">log</span><span class="p">(</span><span class="n">jj</span><span class="p">)</span><span class="o">-</span> <span class="p">(</span><span class="m">1</span><span class="o">/</span><span class="m">3</span><span class="p">)</span><span class="o">*</span><span class="n">jj</span>
		<span class="n">gamma</span> <span class="o">&lt;-</span> <span class="m">0</span>
		<span class="n">mu</span> <span class="o">&lt;-</span> <span class="nf">exp</span><span class="p">(</span> <span class="n">alpha</span> <span class="o">+</span> <span class="n">beta</span> <span class="o">+</span> <span class="n">gamma</span><span class="p">)</span>  
	<span class="p">}</span>
	<span class="n">else</span> <span class="nf">if </span><span class="p">(</span><span class="n">whichsim</span> <span class="o">==</span> <span class="m">2</span><span class="p">){</span>
		<span class="n">alpha</span> <span class="o">&lt;-</span> <span class="nf">log</span><span class="p">(</span><span class="m">100000</span><span class="p">)</span><span class="m">+0.1</span><span class="o">*</span><span class="nf">LinearSpline</span><span class="p">(</span><span class="n">kk</span><span class="p">,</span><span class="m">1</span><span class="p">,</span><span class="m">15</span><span class="p">)</span><span class="m">+0.2</span><span class="o">*</span><span class="nf">LinearSpline</span><span class="p">(</span><span class="n">kk</span><span class="p">,</span><span class="m">15</span><span class="p">,</span><span class="m">20</span><span class="p">)</span> <span class="o">-</span> <span class="m">0.05</span><span class="o">*</span><span class="nf">LinearSpline</span><span class="p">(</span><span class="n">kk</span><span class="p">,</span><span class="m">30</span><span class="p">,</span><span class="m">40</span><span class="p">)</span>
		<span class="n">beta</span>  <span class="o">&lt;-</span> <span class="p">(</span><span class="m">16</span><span class="o">/</span><span class="m">3</span> <span class="o">-</span> <span class="m">1</span><span class="p">)</span><span class="o">*</span><span class="nf">log</span><span class="p">(</span><span class="n">jj</span><span class="p">)</span><span class="o">-</span> <span class="p">(</span><span class="m">1</span><span class="o">/</span><span class="m">3</span><span class="p">)</span><span class="o">*</span><span class="n">jj</span>  <span class="c1"># a is 16/3, b is 1/3</span>
		<span class="n">gamma</span> <span class="o">&lt;-</span> <span class="nf">gammafunc</span><span class="p">(</span><span class="n">tt</span><span class="p">)</span>
		<span class="n">mu</span> <span class="o">&lt;-</span> <span class="nf">exp</span><span class="p">(</span> <span class="n">alpha</span> <span class="o">+</span> <span class="n">beta</span> <span class="o">+</span> <span class="n">gamma</span><span class="p">)</span>  
	<span class="p">}</span>
	<span class="n">else</span> <span class="nf">if </span><span class="p">(</span><span class="n">whichsim</span> <span class="o">==</span> <span class="m">3</span><span class="p">){</span>
		<span class="n">alpha</span> <span class="o">&lt;-</span> <span class="nf">log</span><span class="p">(</span><span class="m">100000</span><span class="p">)</span><span class="m">+0.1</span><span class="o">*</span><span class="nf">LinearSpline</span><span class="p">(</span><span class="n">kk</span><span class="p">,</span><span class="m">1</span><span class="p">,</span><span class="m">15</span><span class="p">)</span><span class="m">+0.2</span><span class="o">*</span><span class="nf">LinearSpline</span><span class="p">(</span><span class="n">kk</span><span class="p">,</span><span class="m">15</span><span class="p">,</span><span class="m">20</span><span class="p">)</span> <span class="o">-</span> <span class="m">0.05</span><span class="o">*</span><span class="nf">LinearSpline</span><span class="p">(</span><span class="n">kk</span><span class="p">,</span><span class="m">30</span><span class="p">,</span><span class="m">40</span><span class="p">)</span>
		<span class="n">beta</span>  <span class="o">&lt;-</span> <span class="p">(</span><span class="m">16</span><span class="o">/</span><span class="m">3</span> <span class="o">-</span> <span class="m">1</span><span class="p">)</span><span class="o">*</span><span class="nf">log</span><span class="p">(</span><span class="n">jj</span><span class="p">)</span><span class="o">-</span> <span class="p">(</span><span class="m">1</span><span class="o">/</span><span class="m">3</span><span class="p">)</span><span class="o">*</span><span class="n">jj</span>  <span class="c1"># a is 16/3, b is 1/3</span>
		<span class="n">gamma</span> <span class="o">&lt;-</span> <span class="nf">gammafunc</span><span class="p">(</span><span class="n">tt</span><span class="p">)</span>
		<span class="n">mu</span> <span class="o">&lt;-</span> <span class="nf">exp</span><span class="p">(</span> <span class="n">alpha</span> <span class="o">+</span> <span class="n">beta</span> <span class="o">+</span> <span class="n">gamma</span> <span class="o">+</span> <span class="m">0.3</span><span class="o">*</span><span class="n">beta</span><span class="o">*</span><span class="nf">ifelse</span><span class="p">(</span><span class="n">kk</span><span class="o">&gt;</span><span class="m">16</span> <span class="o">&amp;</span> <span class="n">jj</span><span class="o">&gt;</span><span class="m">20</span><span class="p">,</span><span class="m">1</span><span class="p">,</span><span class="m">0</span><span class="p">))</span>  
	<span class="p">}</span>
	<span class="n">else</span> <span class="nf">if </span><span class="p">(</span><span class="n">whichsim</span> <span class="o">==</span> <span class="m">4</span><span class="p">){</span>
		<span class="n">alpha</span> <span class="o">&lt;-</span> <span class="nf">log</span><span class="p">(</span><span class="m">100000</span><span class="p">)</span><span class="m">+0.1</span><span class="o">*</span><span class="nf">LinearSpline</span><span class="p">(</span><span class="n">kk</span><span class="p">,</span><span class="m">1</span><span class="p">,</span><span class="m">15</span><span class="p">)</span><span class="m">+0.2</span><span class="o">*</span><span class="nf">LinearSpline</span><span class="p">(</span><span class="n">kk</span><span class="p">,</span><span class="m">15</span><span class="p">,</span><span class="m">20</span><span class="p">)</span> <span class="o">-</span> <span class="m">0.05</span><span class="o">*</span><span class="nf">LinearSpline</span><span class="p">(</span><span class="n">kk</span><span class="p">,</span><span class="m">30</span><span class="p">,</span><span class="m">40</span><span class="p">)</span>
		<span class="n">beta</span>  <span class="o">&lt;-</span> <span class="p">(</span><span class="m">16</span><span class="o">/</span><span class="m">3</span> <span class="o">-</span> <span class="m">1</span><span class="p">)</span><span class="o">*</span><span class="nf">log</span><span class="p">(</span><span class="n">jj</span><span class="p">)</span><span class="o">-</span> <span class="p">(</span><span class="m">1</span><span class="o">/</span><span class="m">3</span><span class="p">)</span><span class="o">*</span><span class="n">jj</span>  <span class="c1"># a is 16/3, b is 1/3</span>
		<span class="n">gamma</span> <span class="o">&lt;-</span> <span class="nf">gammafunc</span><span class="p">(</span><span class="n">tt</span><span class="p">)</span>
		<span class="n">mu</span> <span class="o">&lt;-</span> <span class="nf">exp</span><span class="p">(</span> <span class="n">alpha</span> <span class="o">+</span> <span class="n">beta</span> <span class="o">+</span> <span class="n">gamma</span><span class="o">*</span><span class="p">((</span><span class="n">numperiods</span><span class="m">-1</span><span class="p">)</span><span class="o">-</span><span class="nf">LinearSpline</span><span class="p">(</span><span class="n">jj</span><span class="p">,</span><span class="m">1</span><span class="p">,</span><span class="n">numperiods</span><span class="p">))</span><span class="o">/</span><span class="p">(</span><span class="n">numperiods</span><span class="m">-1</span><span class="p">)</span> <span class="p">)</span>  <span class="c1"># need to check</span>
	<span class="p">}</span>

	<span class="n">varbase</span> <span class="o">&lt;-</span> <span class="p">(</span><span class="m">0.3</span> <span class="o">*</span> <span class="n">mu</span><span class="p">[</span>  <span class="n">kk</span><span class="o">==</span><span class="m">1</span> <span class="o">&amp;</span> <span class="n">jj</span> <span class="o">==</span><span class="m">16</span><span class="p">]</span> <span class="p">)</span><span class="o">^</span><span class="m">2</span> <span class="c1"># can scale variance up and down here</span>
	<span class="n">CC</span>  <span class="o">&lt;-</span>  <span class="n">varbase</span> <span class="o">/</span> <span class="n">mu</span><span class="p">[</span>  <span class="n">kk</span><span class="o">==</span><span class="m">1</span> <span class="o">&amp;</span> <span class="n">jj</span> <span class="o">==</span><span class="m">16</span><span class="p">]</span>

	<span class="n">vars</span>   <span class="o">&lt;-</span> <span class="n">CC</span><span class="o">*</span><span class="n">mu</span>
	<span class="n">tausq</span>  <span class="o">&lt;-</span> <span class="nf">log </span><span class="p">(</span><span class="n">vars</span> <span class="o">/</span> <span class="p">(</span><span class="n">mu</span><span class="o">^</span><span class="m">2</span><span class="p">)</span> <span class="o">+</span> <span class="m">1</span><span class="p">)</span>

	<span class="n">pmts</span> <span class="o">&lt;-</span> <span class="nf">exp</span><span class="p">(</span> <span class="nf">rnorm</span><span class="p">(</span> <span class="n">numperiods</span><span class="o">^</span><span class="m">2</span><span class="p">,</span> <span class="n">mean</span> <span class="o">=</span> <span class="nf">log</span><span class="p">(</span><span class="n">mu</span><span class="p">)</span><span class="m">-0.5</span><span class="o">*</span><span class="n">tausq</span> <span class="p">,</span> <span class="n">sd</span> <span class="o">=</span> <span class="nf">sqrt</span><span class="p">(</span><span class="n">tausq</span><span class="p">)</span>  <span class="p">)</span> <span class="p">)</span>

	<span class="c1"># indicator for past/future = traint/test</span>
	<span class="n">train_ind</span><span class="o">&lt;-</span><span class="p">(</span><span class="n">tt</span><span class="o">&lt;=</span><span class="n">numperiods</span><span class="p">)</span>

	<span class="c1">### data.table for output</span>
	<span class="n">full</span><span class="o">&lt;-</span><span class="nf">data.table</span><span class="p">(</span><span class="n">pmts</span><span class="p">,</span> <span class="n">acc</span><span class="o">=</span><span class="nf">as.integer</span><span class="p">(</span><span class="n">kk</span><span class="p">),</span> <span class="n">dev</span><span class="o">=</span><span class="nf">as.integer</span><span class="p">(</span><span class="n">jj</span><span class="p">),</span> <span class="n">cal</span><span class="o">=</span><span class="nf">as.integer</span><span class="p">(</span><span class="n">tt</span><span class="p">),</span> <span class="n">mu</span><span class="p">,</span> <span class="n">train_ind</span> <span class="p">)</span>
	<span class="n">full</span>
<span class="p">}</span>


<span class="c1">#---------------------------</span>
<span class="c1"># function to generate calendar period effects used in CreateSyntheticData()</span>
<span class="c1"># written as a seperate function for convenience</span>

<span class="n">gammafunc</span> <span class="o">&lt;-</span> <span class="nf">function</span><span class="p">(</span><span class="n">t</span><span class="p">){</span>
	<span class="n">gg</span> <span class="o">&lt;-</span>
		<span class="nf">ifelse</span><span class="p">(</span> <span class="n">t</span><span class="o">&lt;=</span><span class="m">12</span><span class="p">,</span> <span class="n">gg</span> <span class="o">&lt;-</span> <span class="m">0.0075</span><span class="o">*</span><span class="nf">LinearSpline</span><span class="p">(</span><span class="n">t</span><span class="p">,</span><span class="m">1</span><span class="p">,</span><span class="m">12</span><span class="p">),</span>
				<span class="nf">ifelse</span><span class="p">(</span><span class="n">t</span><span class="o">&lt;=</span><span class="m">24</span><span class="p">,</span>  <span class="n">gg</span> <span class="o">&lt;-</span> <span class="m">0.0075</span><span class="o">*</span><span class="nf">LinearSpline</span><span class="p">(</span><span class="m">12</span><span class="p">,</span><span class="m">1</span><span class="p">,</span><span class="m">12</span><span class="p">)</span> <span class="o">+</span> <span class="m">0.001</span><span class="o">*</span> <span class="p">(</span><span class="n">t</span><span class="m">-12</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">t</span><span class="m">-11</span><span class="p">)</span><span class="o">/</span><span class="m">2</span><span class="p">,</span>
					   <span class="nf">ifelse</span><span class="p">(</span><span class="n">t</span><span class="o">&lt;=</span><span class="m">32</span><span class="p">,</span> <span class="n">gg</span> <span class="o">&lt;-</span> <span class="m">0.0075</span><span class="o">*</span><span class="nf">LinearSpline</span><span class="p">(</span><span class="m">12</span><span class="p">,</span><span class="m">1</span><span class="p">,</span><span class="m">12</span><span class="p">)</span> <span class="o">+</span> <span class="m">0.001</span><span class="o">*</span> <span class="p">(</span><span class="m">24-12</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="m">24-11</span><span class="p">)</span><span class="o">/</span><span class="m">2</span><span class="p">,</span>
					   	   <span class="nf">ifelse</span><span class="p">(</span><span class="n">t</span><span class="o">&lt;=</span><span class="m">40</span><span class="p">,</span> <span class="n">gg</span> <span class="o">&lt;-</span> <span class="m">0.0075</span><span class="o">*</span><span class="nf">LinearSpline</span><span class="p">(</span><span class="m">12</span><span class="p">,</span><span class="m">1</span><span class="p">,</span><span class="m">12</span><span class="p">)</span> <span class="o">+</span> <span class="m">0.001</span><span class="o">*</span> <span class="p">(</span><span class="m">24-12</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="m">24-11</span><span class="p">)</span><span class="o">/</span><span class="m">2</span> <span class="o">+</span> <span class="m">0.002</span><span class="o">*</span><span class="p">(</span><span class="n">t</span><span class="m">-32</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">t</span><span class="m">-31</span><span class="p">)</span><span class="o">/</span><span class="m">2</span><span class="p">,</span>
					   	   	   <span class="m">0.0075</span><span class="o">*</span><span class="nf">LinearSpline</span><span class="p">(</span><span class="m">12</span><span class="p">,</span><span class="m">1</span><span class="p">,</span><span class="m">12</span><span class="p">)</span> <span class="o">+</span> <span class="m">0.001</span><span class="o">*</span> <span class="p">(</span><span class="m">24-12</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="m">24-11</span><span class="p">)</span><span class="o">/</span><span class="m">2</span> <span class="o">+</span> <span class="m">0.002</span><span class="o">*</span><span class="p">(</span><span class="m">40-32</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="m">40-31</span><span class="p">)</span><span class="o">/</span><span class="m">2</span>
					   	   <span class="p">))))</span>
	<span class="n">gg</span>  
<span class="p">}</span>
</pre></div>
</div>
</div>
</div>
<p>The code below generates the data set as specified in our paper. If you want to use our data set, use a seed of 130. Otherwise, use different seeds to produce different data sets. Or change <code class="docutils literal notranslate"><span class="pre">use_data_set</span></code> to 1, 2 or 4 to use data sets simulated in a similar way to those in our paper.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">use_data_set</span> <span class="o">&lt;-</span> <span class="m">3</span>       <span class="c1"># which data set to use</span>
<span class="n">use_data_set_seed</span> <span class="o">&lt;-</span> <span class="m">130</span>  <span class="c1"># seed to generate data</span>
<span class="n">num_periods</span> <span class="o">&lt;-</span> <span class="m">40</span>   <span class="c1"># size of data set</span>

<span class="nf">set.seed</span><span class="p">(</span><span class="n">use_data_set_seed</span><span class="p">)</span>

<span class="n">dat</span> <span class="o">&lt;-</span> <span class="nf">CreateSyntheticData</span><span class="p">(</span><span class="n">whichsim</span><span class="o">=</span><span class="n">use_data_set</span><span class="p">,</span> <span class="n">numperiods</span><span class="o">=</span><span class="n">num_periods</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Let’s have a look at the data:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">acc</span></code> / <code class="docutils literal notranslate"><span class="pre">dev</span></code> / <code class="docutils literal notranslate"><span class="pre">cal</span></code> = accident / development / calendar quarter</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">pmts</span></code> = simulated payments</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">mu</span></code> = underlying mean</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">train_ind</span></code>: TRUE for past values and FALSE for future.</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="c1"># head(dat,10) gives the same information, the rest is just formatting</span>

<span class="nf">head</span><span class="p">(</span><span class="n">dat</span><span class="p">,</span> <span class="m">10</span><span class="p">)</span> <span class="o">%&gt;%</span>
    <span class="nf">kable</span><span class="p">(</span><span class="n">digits</span><span class="o">=</span><span class="m">0</span><span class="p">,</span> <span class="n">format.args</span> <span class="o">=</span> <span class="nf">list</span><span class="p">(</span><span class="n">big.mark</span> <span class="o">=</span> <span class="s">&quot;,&quot;</span><span class="p">,</span> <span class="n">scientific</span> <span class="o">=</span> <span class="kc">FALSE</span><span class="p">))</span> <span class="o">%&gt;%</span>
    <span class="nf">kable_styling</span><span class="p">(</span><span class="n">full_width</span><span class="o">=</span><span class="kc">FALSE</span><span class="p">,</span> <span class="n">bootstrap_options</span> <span class="o">=</span> <span class="nf">c</span><span class="p">(</span><span class="s">&quot;striped&quot;</span><span class="p">,</span> <span class="s">&quot;hover&quot;</span><span class="p">,</span> <span class="s">&quot;condensed&quot;</span><span class="p">))</span> <span class="o">%&gt;%</span>
    <span class="nf">as.character</span><span class="p">()</span> <span class="o">%&gt;%</span>
    <span class="nf">display_html</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><table class="table table-striped table-hover table-condensed" style="width: auto !important; margin-left: auto; margin-right: auto;">
 <thead>
  <tr>
   <th style="text-align:right;"> pmts </th>
   <th style="text-align:right;"> acc </th>
   <th style="text-align:right;"> dev </th>
   <th style="text-align:right;"> cal </th>
   <th style="text-align:right;"> mu </th>
   <th style="text-align:left;"> train_ind </th>
  </tr>
 </thead>
<tbody>
  <tr>
   <td style="text-align:right;"> 242,671 </td>
   <td style="text-align:right;"> 1 </td>
   <td style="text-align:right;"> 1 </td>
   <td style="text-align:right;"> 1 </td>
   <td style="text-align:right;"> 71,653 </td>
   <td style="text-align:left;"> TRUE </td>
  </tr>
  <tr>
   <td style="text-align:right;"> 164,001 </td>
   <td style="text-align:right;"> 1 </td>
   <td style="text-align:right;"> 2 </td>
   <td style="text-align:right;"> 2 </td>
   <td style="text-align:right;"> 1,042,776 </td>
   <td style="text-align:left;"> TRUE </td>
  </tr>
  <tr>
   <td style="text-align:right;"> 3,224,478 </td>
   <td style="text-align:right;"> 1 </td>
   <td style="text-align:right;"> 3 </td>
   <td style="text-align:right;"> 3 </td>
   <td style="text-align:right;"> 4,362,600 </td>
   <td style="text-align:left;"> TRUE </td>
  </tr>
  <tr>
   <td style="text-align:right;"> 3,682,531 </td>
   <td style="text-align:right;"> 1 </td>
   <td style="text-align:right;"> 4 </td>
   <td style="text-align:right;"> 4 </td>
   <td style="text-align:right;"> 10,955,670 </td>
   <td style="text-align:left;"> TRUE </td>
  </tr>
  <tr>
   <td style="text-align:right;"> 10,149,369 </td>
   <td style="text-align:right;"> 1 </td>
   <td style="text-align:right;"> 5 </td>
   <td style="text-align:right;"> 5 </td>
   <td style="text-align:right;"> 20,800,545 </td>
   <td style="text-align:left;"> TRUE </td>
  </tr>
  <tr>
   <td style="text-align:right;"> 28,578,275 </td>
   <td style="text-align:right;"> 1 </td>
   <td style="text-align:right;"> 6 </td>
   <td style="text-align:right;"> 6 </td>
   <td style="text-align:right;"> 33,089,167 </td>
   <td style="text-align:left;"> TRUE </td>
  </tr>
  <tr>
   <td style="text-align:right;"> 29,022,301 </td>
   <td style="text-align:right;"> 1 </td>
   <td style="text-align:right;"> 7 </td>
   <td style="text-align:right;"> 7 </td>
   <td style="text-align:right;"> 46,588,740 </td>
   <td style="text-align:left;"> TRUE </td>
  </tr>
  <tr>
   <td style="text-align:right;"> 56,795,754 </td>
   <td style="text-align:right;"> 1 </td>
   <td style="text-align:right;"> 8 </td>
   <td style="text-align:right;"> 8 </td>
   <td style="text-align:right;"> 59,989,023 </td>
   <td style="text-align:left;"> TRUE </td>
  </tr>
  <tr>
   <td style="text-align:right;"> 47,360,541 </td>
   <td style="text-align:right;"> 1 </td>
   <td style="text-align:right;"> 9 </td>
   <td style="text-align:right;"> 9 </td>
   <td style="text-align:right;"> 72,148,133 </td>
   <td style="text-align:left;"> TRUE </td>
  </tr>
  <tr>
   <td style="text-align:right;"> 99,139,255 </td>
   <td style="text-align:right;"> 1 </td>
   <td style="text-align:right;"> 10 </td>
   <td style="text-align:right;"> 10 </td>
   <td style="text-align:right;"> 82,224,253 </td>
   <td style="text-align:left;"> TRUE </td>
  </tr>
</tbody>
</table></div></div>
</div>
<p>It may also be helpful to visualise the data, using shading to indicate the size of the payments (specifically, log(payments)).</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="c1"># get limits for use with raster plots</span>
<span class="n">data_raster_limits</span> <span class="o">&lt;-</span> <span class="nf">c</span><span class="p">(</span><span class="nf">floor</span><span class="p">(</span><span class="n">dat</span><span class="p">[,</span> <span class="nf">min</span><span class="p">(</span><span class="nf">log</span><span class="p">(</span><span class="n">pmts</span><span class="p">))]),</span> <span class="nf">ceiling</span><span class="p">(</span><span class="n">dat</span><span class="p">[,</span> <span class="nf">max</span><span class="p">(</span><span class="nf">log</span><span class="p">(</span><span class="n">pmts</span><span class="p">))]))</span>

<span class="nf">ggplot</span><span class="p">(</span><span class="n">dat</span><span class="p">,</span> <span class="nf">aes</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">acc</span><span class="p">))</span> <span class="o">+</span>
  <span class="nf">geom_raster</span><span class="p">(</span><span class="nf">aes</span><span class="p">(</span><span class="n">fill</span> <span class="o">=</span> <span class="nf">log</span><span class="p">(</span><span class="n">pmts</span><span class="p">)))</span><span class="o">+</span>
  <span class="nf">geom_line</span><span class="p">(</span><span class="nf">aes</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">num_periods</span><span class="m">+1</span><span class="o">-</span><span class="n">acc</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">acc</span><span class="p">),</span> <span class="n">colour</span><span class="o">=</span><span class="n">dgrey</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="m">2</span><span class="p">)</span><span class="o">+</span>
  <span class="nf">scale_y_reverse</span><span class="p">()</span><span class="o">+</span>
  <span class="nf">scale_fill_viridis_c</span><span class="p">(</span><span class="n">begin</span><span class="o">=</span><span class="m">1</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="m">0</span><span class="p">,</span> <span class="n">limits</span><span class="o">=</span><span class="n">data_raster_limits</span><span class="p">)</span><span class="o">+</span>
  <span class="nf">theme_classic</span><span class="p">()</span><span class="o">+</span>
  <span class="nf">labs</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s">&quot;Development quarter&quot;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s">&quot;Accident quarter&quot;</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s">&quot;Log(payments)&quot;</span><span class="p">)</span><span class="o">+</span>
  <span class="kc">NULL</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/MLRWP_R_Lasso_24_0.png" src="../_images/MLRWP_R_Lasso_24_0.png" />
</div>
</div>
</div>
<div class="section" id="specifying-the-lasso-model">
<h2>Specifying the LASSO model<a class="headerlink" href="#specifying-the-lasso-model" title="Permalink to this headline">¶</a></h2>
<p>The LASSO model requires data (which we have), basis functions or regressors and model settings for the LASSO procedure. In our example we have 3 regressors - accident, development and calendar periods. If we use these as is, then all our model can potentially contain are a linear effect related to each of these. That won’t come anywhere close to modelling the data.
Therefore, a key part of our paper was how to expand these 3 regressors into a flexible set of basis functions, capable of capturing a variety of shapes in the model experience.</p>
<div class="section" id="set-of-basis-functions">
<h3>Set of basis functions<a class="headerlink" href="#set-of-basis-functions" title="Permalink to this headline">¶</a></h3>
<p>In the paper we proposed creating a basis function set consisting of ramp functions and step (or heaviside) functions, as shown in the plot below:</p>
<ul class="simple">
<li><p>Ramps start flat at 0, then have a knot (turning point) after which they increase linearly</p></li>
<li><p>Step or heaviside functions start at 0, then step up to 1 and a specific point and remain there.</p></li>
</ul>
<div class="cell tag_remove_input docutils container">
<div class="cell_output docutils container">
<img alt="../_images/MLRWP_R_Lasso_28_0.png" src="../_images/MLRWP_R_Lasso_28_0.png" />
</div>
</div>
<p>More specifically we use the ramp functions for main effects and the heaviside functions for interactions.</p>
<p>Since the procedure is intended to be automatic, the default basis function set includes all possible main effects ramps and all possible two-way interaction step functions.</p>
<p>For the particular data set here, this means that our basis functions include:</p>
<ul class="simple">
<li><p>3 x 39 ramp functions, e.g.
$<span class="math notranslate nohighlight">\(\max(\text{acc} - k, 0), \;\; k=1, 2, ..., 39\)</span>$</p>
<ul>
<li><p>and similar for <code class="docutils literal notranslate"><span class="pre">dev</span></code> and <code class="docutils literal notranslate"><span class="pre">cal</span></code>.</p></li>
</ul>
</li>
<li><p>3 x 39 x 39 interactions
$<span class="math notranslate nohighlight">\(I(\text{acc} \geq k)*I(\text{acc} \geq j), \;\; k, j = 2,3,..., 40\)</span>$</p>
<ul>
<li><p>similar for (<code class="docutils literal notranslate"><span class="pre">acc</span></code>, <code class="docutils literal notranslate"><span class="pre">cal</span></code>) and (<code class="docutils literal notranslate"><span class="pre">dev</span></code>, <code class="docutils literal notranslate"><span class="pre">cal</span></code>)</p></li>
</ul>
</li>
<li><p>This leads to 4680(!) basis functions.</p></li>
</ul>
<p>Since there are really only 2 regressors (as in, once you know two of accident, development and calendar, you know the third), there are a lot of correlated variables. For real problems (as in the real data example in the paper), where you have prior knowledge about what effects are likely to be in the data we would recommend more discernment in the selection of which of the effects to include. For example, if you expect only development and calendar effects, then do not include the accident period basis functions.</p>
</div>
<div class="section" id="scaling">
<h3>Scaling<a class="headerlink" href="#scaling" title="Permalink to this headline">¶</a></h3>
<p>Referring back to the introduction of this article, the loss function to be minimised for the LASSO is</p>
<div class="math notranslate nohighlight">
\[\mathcal{L} (y; X, \hat{\beta}) = D(y; X, \hat{\beta}) + \lambda ||\hat{\beta}||_1\]</div>
<p>We noted that <span class="math notranslate nohighlight">\(\lambda\)</span> controlled the size of the penalty attaching to each parameter, and therefore each basis function.
However, as the size of the parameters also features in this equation, it is important that the basis functions be on similar scales.
Otherwise whether a parameter is included or not could depend on whether the corresponding basis function has large values (and therefore smaller <span class="math notranslate nohighlight">\(\hat{\beta}\)</span>) or small values (and therefore larger <span class="math notranslate nohighlight">\(\hat{\beta}\)</span>), which is clearly undesirable.</p>
<p>Once you’re aware of this issue, it should come as no surprise that scaling parameters is something that is common in machine learning work like this one. Indeed, the <strong>glmnet</strong> package which we will be using comes with an in-built scaling tool. However this scaling will scale each variable independently. This isn’t what we want since the basis functions are not independent - we have over 4000 of these, but really we only have 3 fundamental regressors so we probably want all <code class="docutils literal notranslate"><span class="pre">acc</span></code> functions to be scaled similarly (and the same is true for <code class="docutils literal notranslate"><span class="pre">dev</span></code> and <code class="docutils literal notranslate"><span class="pre">cal</span></code>).</p>
<p>Our paper has some more discussion around scaling. In a nutshell, we calculate a scaling factor for each of the 3 fundamental regressors and then apply that to all basis functions generated from that regressor. The scaling we use is <span class="math notranslate nohighlight">\(\rho\)</span> scaling which is calculated as</p>
<div class="math notranslate nohighlight">
\[\sum_{i=1}^n {\frac{(x_i-\bar{x})^2}{n}}\]</div>
<p>where</p>
<ul class="simple">
<li><p><span class="math notranslate nohighlight">\(\bar{x}\)</span> is the mean of the regressor <span class="math notranslate nohighlight">\(x\)</span> and</p></li>
<li><p><span class="math notranslate nohighlight">\(n\)</span> is the number of elements in the regressor.</p></li>
</ul>
<p>Another nuance to note is that in the real world, the future data will not be available. So our fundamental regressors contain only past data and the scaling factors should therefore be calculated using past data only.</p>
<p>In other implementations of the LASSO, it is often common to centre the variables as well. We don’t do that here as we want to preserve interactions having a zero level.</p>
</div>
<div class="section" id="code">
<h3>Code<a class="headerlink" href="#code" title="Permalink to this headline">¶</a></h3>
<p>Now we’ll go through the code used to generate the set of basis functions.</p>
<p>We first write a function to do the <span class="math notranslate nohighlight">\(\rho\)</span>-scaling. The input is a vector and the output is a scaling factor.
Having this as a function makes sense because we need to call it three times (once for each of <code class="docutils literal notranslate"><span class="pre">acc</span></code>, <code class="docutils literal notranslate"><span class="pre">dev</span></code> and <code class="docutils literal notranslate"><span class="pre">cal</span></code>).</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="c1"># function to calculate scaling factors for the basis functions</span>
<span class="c1"># scaling is discussed in the paper</span>
<span class="n">GetScaling</span> <span class="o">&lt;-</span> <span class="nf">function</span><span class="p">(</span><span class="n">vec</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">fn</span> <span class="o">&lt;-</span> <span class="nf">length</span><span class="p">(</span><span class="n">vec</span><span class="p">)</span>
  <span class="n">fm</span> <span class="o">&lt;-</span> <span class="nf">mean</span><span class="p">(</span><span class="n">vec</span><span class="p">)</span>
  <span class="n">fc</span> <span class="o">&lt;-</span> <span class="n">vec</span> <span class="o">-</span> <span class="n">fm</span>
  <span class="n">rho_factor</span> <span class="o">&lt;-</span> <span class="p">((</span><span class="nf">sum</span><span class="p">(</span><span class="n">fc</span><span class="o">^</span><span class="m">2</span><span class="p">))</span><span class="o">/</span><span class="n">fn</span><span class="p">)</span><span class="o">^</span><span class="m">0.5</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
</div>
<p>We next write some code to calculate the main effects ramp functions.
This is also a function, again because we need to run it three times.</p>
<p>Inputs to this function are the fundamental regressor and its name and scaling and the number of periods, which in turn tell the function what ramps to generate (you might think that is not needed because we can calculate it from the input vector, but it is important if we are working with vectors that contain future time periods - vectors of future <code class="docutils literal notranslate"><span class="pre">cal</span></code> will contain calendar periods not present in the past data and we don’t want to generate ramp functions for these values).</p>
<p>The output is a matrix with named columns - e.g. <code class="docutils literal notranslate"><span class="pre">L_1_999_acc</span></code>, <code class="docutils literal notranslate"><span class="pre">L_2_999_acc</span></code>, …, <code class="docutils literal notranslate"><span class="pre">L_39_999_acc</span></code> where each column is the scaled ramp vector.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="c1"># function to create the ramps for a particular primary vector</span>
<span class="n">GetRamps</span> <span class="o">&lt;-</span> <span class="nf">function</span><span class="p">(</span><span class="n">vec</span><span class="p">,</span> <span class="n">vecname</span><span class="p">,</span> <span class="n">np</span><span class="p">,</span> <span class="n">scaling</span><span class="p">){</span>

  <span class="c1"># vec = fundamental regressor</span>
  <span class="c1"># vecname = name of regressor</span>
  <span class="c1"># np = number of periods</span>
  <span class="c1"># scaling = scaling factor to use</span>

  <span class="c1"># pre-allocate the matrix to hold the results for speed/efficiency</span>
  <span class="n">n</span> <span class="o">&lt;-</span> <span class="nf">length</span><span class="p">(</span><span class="n">vec</span><span class="p">)</span>
  <span class="n">nramps</span> <span class="o">&lt;-</span> <span class="p">(</span><span class="n">np</span><span class="m">-1</span><span class="p">)</span>

  <span class="n">mat</span> <span class="o">&lt;-</span> <span class="nf">matrix</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="kc">NA</span><span class="p">,</span> <span class="n">nrow</span><span class="o">=</span><span class="n">n</span><span class="p">,</span> <span class="n">ncol</span><span class="o">=</span><span class="n">nramps</span><span class="p">)</span>
  <span class="n">cnames</span> <span class="o">&lt;-</span> <span class="nf">vector</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="s">&quot;character&quot;</span><span class="p">,</span> <span class="n">length</span><span class="o">=</span><span class="n">nramps</span><span class="p">)</span>


  <span class="n">col_indx</span> <span class="o">&lt;-</span> <span class="m">0</span>

  <span class="nf">for </span><span class="p">(</span><span class="n">i</span> <span class="n">in</span> <span class="m">1</span><span class="o">:</span><span class="p">(</span><span class="n">np</span><span class="m">-1</span><span class="p">)){</span>
    <span class="n">col_indx</span> <span class="o">&lt;-</span> <span class="n">col_indx</span> <span class="o">+</span> <span class="m">1</span>

    <span class="n">mat</span><span class="p">[,</span> <span class="n">col_indx</span><span class="p">]</span> <span class="o">&lt;-</span> <span class="nf">LinearSpline</span><span class="p">(</span><span class="n">vec</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="m">999</span><span class="p">)</span> <span class="o">/</span> <span class="n">scaling</span>
    <span class="n">cnames</span><span class="p">[</span><span class="n">col_indx</span><span class="p">]</span> <span class="o">&lt;-</span> <span class="nf">paste0</span><span class="p">(</span><span class="s">&quot;L_&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="s">&quot;_999_&quot;</span><span class="p">,</span> <span class="n">vecname</span><span class="p">)</span>
  <span class="p">}</span>

  <span class="nf">colnames</span><span class="p">(</span><span class="n">mat</span><span class="p">)</span> <span class="o">&lt;-</span> <span class="n">cnames</span>

  <span class="nf">return</span><span class="p">(</span><span class="n">mat</span><span class="p">)</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
</div>
<p>We also need to calculate the interactions which the function does below for a given pair of input vectors, e.g. accident and development periods.
The inputs are similar to those for the <code class="docutils literal notranslate"><span class="pre">GetRamps()</span></code> function, except that we have two sets, one for each input fundamental regressor.
The output is also a column-named matrix where names are, e.g., <code class="docutils literal notranslate"><span class="pre">I_acc_ge_5xI_dev_ge_14</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="c1"># create the step (heaviside) function interactions</span>
<span class="n">GetInts</span> <span class="o">&lt;-</span> <span class="nf">function</span><span class="p">(</span><span class="n">vec1</span><span class="p">,</span> <span class="n">vec2</span><span class="p">,</span> <span class="n">vecname1</span><span class="p">,</span> <span class="n">vecname2</span><span class="p">,</span> <span class="n">np</span><span class="p">,</span> <span class="n">scaling1</span><span class="p">,</span> <span class="n">scaling2</span><span class="p">)</span> <span class="p">{</span>

  <span class="c1"># vec1 = fundamental regressor 1</span>
  <span class="c1"># vec2 = fundamental regressor 2</span>
  <span class="c1"># vecname1 = name of regressor 1</span>
  <span class="c1"># vecname2 = name of regressor 2</span>
  <span class="c1"># np = number of periods</span>
  <span class="c1"># scaling1 = scaling factor to use for regressor 1</span>
  <span class="c1"># scaling2 = scaling factor to use for regressor 2</span>


  <span class="c1"># pre-allocate the matrix to hold the results for speed/efficiency</span>
  <span class="n">n</span> <span class="o">&lt;-</span> <span class="nf">length</span><span class="p">(</span><span class="n">vec1</span><span class="p">)</span>
  <span class="n">nints</span> <span class="o">&lt;-</span> <span class="p">(</span><span class="n">np</span><span class="m">-1</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">np</span><span class="m">-1</span><span class="p">)</span>

  <span class="n">mat</span> <span class="o">&lt;-</span> <span class="nf">matrix</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="kc">NA_real_</span><span class="p">,</span> <span class="n">nrow</span><span class="o">=</span><span class="n">n</span><span class="p">,</span> <span class="n">ncol</span><span class="o">=</span><span class="n">nints</span><span class="p">)</span>
  <span class="n">cnames</span> <span class="o">&lt;-</span> <span class="nf">vector</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="s">&quot;character&quot;</span><span class="p">,</span> <span class="n">length</span><span class="o">=</span><span class="n">nints</span><span class="p">)</span>


  <span class="n">col_indx</span> <span class="o">&lt;-</span> <span class="m">0</span>

  <span class="nf">for </span><span class="p">(</span><span class="n">i</span> <span class="n">in</span> <span class="m">2</span><span class="o">:</span><span class="n">np</span><span class="p">){</span>

    <span class="n">ivec</span> <span class="o">&lt;-</span> <span class="nf">LinearSpline</span><span class="p">(</span><span class="n">vec1</span><span class="p">,</span> <span class="n">i</span><span class="m">-1</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="o">/</span> <span class="n">scaling1</span>
    <span class="n">iname</span> <span class="o">&lt;-</span> <span class="nf">paste0</span><span class="p">(</span><span class="s">&quot;I_&quot;</span><span class="p">,</span> <span class="n">vecname1</span><span class="p">,</span> <span class="s">&quot;_ge_&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>

    <span class="nf">if </span><span class="p">(</span><span class="nf">length</span><span class="p">(</span><span class="n">ivec</span><span class="p">[</span><span class="nf">is.na</span><span class="p">(</span><span class="n">ivec</span><span class="p">)]</span><span class="o">&gt;</span><span class="m">0</span><span class="p">))</span> <span class="nf">print</span><span class="p">(</span><span class="nf">paste</span><span class="p">(</span><span class="s">&quot;NAs in ivec for&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">))</span>

    <span class="nf">for </span><span class="p">(</span><span class="n">j</span> <span class="n">in</span> <span class="m">2</span><span class="o">:</span><span class="n">np</span><span class="p">){</span>
      <span class="n">col_indx</span> <span class="o">&lt;-</span> <span class="n">col_indx</span> <span class="o">+</span> <span class="m">1</span>  
      <span class="n">mat</span><span class="p">[,</span> <span class="n">col_indx</span><span class="p">]</span> <span class="o">&lt;-</span> <span class="n">ivec</span> <span class="o">*</span> <span class="nf">LinearSpline</span><span class="p">(</span><span class="n">vec2</span><span class="p">,</span> <span class="n">j</span><span class="m">-1</span><span class="p">,</span> <span class="n">j</span><span class="p">)</span> <span class="o">/</span> <span class="n">scaling2</span>
      <span class="n">cnames</span><span class="p">[</span><span class="n">col_indx</span><span class="p">]</span> <span class="o">&lt;-</span> <span class="nf">paste0</span><span class="p">(</span><span class="n">iname</span><span class="p">,</span> <span class="s">&quot;xI_&quot;</span><span class="p">,</span> <span class="n">vecname2</span><span class="p">,</span> <span class="s">&quot;_ge_&quot;</span><span class="p">,</span> <span class="n">j</span><span class="p">)</span>

      <span class="n">jvec</span> <span class="o">&lt;-</span> <span class="nf">LinearSpline</span><span class="p">(</span><span class="n">vec2</span><span class="p">,</span> <span class="n">j</span><span class="m">-1</span><span class="p">,</span> <span class="n">j</span><span class="p">)</span> <span class="o">/</span> <span class="n">scaling2</span>
      <span class="nf">if </span><span class="p">(</span><span class="nf">length</span><span class="p">(</span><span class="n">jvec</span><span class="p">[</span><span class="nf">is.na</span><span class="p">(</span><span class="n">jvec</span><span class="p">)]</span><span class="o">&gt;</span><span class="m">0</span><span class="p">))</span> <span class="nf">print</span><span class="p">(</span><span class="nf">paste</span><span class="p">(</span><span class="s">&quot;NAs in jvec for&quot;</span><span class="p">,</span> <span class="n">j</span><span class="p">))</span>

    <span class="p">}</span>
  <span class="p">}</span>

  <span class="nf">colnames</span><span class="p">(</span><span class="n">mat</span><span class="p">)</span> <span class="o">&lt;-</span> <span class="n">cnames</span>

  <span class="nf">return</span><span class="p">(</span><span class="n">mat</span><span class="p">)</span>


<span class="p">}</span>
</pre></div>
</div>
</div>
</div>
<p>Finally we put all these functions together and run the code to:</p>
<ul class="simple">
<li><p>calculate the scaling factors</p></li>
<li><p>generate the ramp functions</p></li>
<li><p>generate the interactions</p></li>
<li><p>put everything together into a single matrix, <code class="docutils literal notranslate"><span class="pre">varset</span></code></p>
<ul>
<li><p>We create <code class="docutils literal notranslate"><span class="pre">varset</span></code> as a matrix and not a data.frame or a data.table since this is the form required by <strong>glmnet</strong>.</p></li>
</ul>
</li>
</ul>
<p>Note that we calculate the basis functions for all the data, both past and future. However we only use past data when calculating the scaling factors - <code class="docutils literal notranslate"><span class="pre">dat[train_ind</span> <span class="pre">==</span> <span class="pre">TRUE,]</span></code> is the data.table way to select the past rows in the data set.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="c1"># get the scaling values</span>
<span class="n">rho_factor_list</span> <span class="o">&lt;-</span> <span class="nf">vector</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="s">&quot;list&quot;</span><span class="p">,</span> <span class="n">length</span><span class="o">=</span><span class="m">3</span><span class="p">)</span>
<span class="nf">names</span><span class="p">(</span><span class="n">rho_factor_list</span><span class="p">)</span> <span class="o">&lt;-</span> <span class="nf">c</span><span class="p">(</span><span class="s">&quot;acc&quot;</span><span class="p">,</span> <span class="s">&quot;dev&quot;</span><span class="p">,</span> <span class="s">&quot;cal&quot;</span><span class="p">)</span>

<span class="nf">for </span><span class="p">(</span><span class="n">v</span> <span class="n">in</span> <span class="nf">c</span><span class="p">(</span><span class="s">&quot;acc&quot;</span><span class="p">,</span> <span class="s">&quot;dev&quot;</span><span class="p">,</span> <span class="s">&quot;cal&quot;</span><span class="p">)){</span>
  <span class="c1"># NB: only calculating scaling using past data    </span>
  <span class="n">rho_factor_list</span><span class="p">[[</span><span class="n">v</span><span class="p">]]</span> <span class="o">&lt;-</span> <span class="nf">GetScaling</span><span class="p">(</span><span class="n">dat</span><span class="p">[</span><span class="n">train_ind</span> <span class="o">==</span> <span class="kc">TRUE</span><span class="p">,</span> <span class="nf">get</span><span class="p">(</span><span class="n">v</span><span class="p">)])</span>
<span class="p">}</span>


<span class="c1"># main effects - matrix of values of Ramp functions</span>

<span class="n">main_effects_acc</span> <span class="o">&lt;-</span> <span class="nf">GetRamps</span><span class="p">(</span><span class="n">vec</span> <span class="o">=</span> <span class="n">dat</span><span class="p">[,</span> <span class="n">acc</span><span class="p">],</span> <span class="n">vecname</span> <span class="o">=</span> <span class="s">&quot;acc&quot;</span><span class="p">,</span> <span class="n">np</span> <span class="o">=</span> <span class="n">num_periods</span><span class="p">,</span> <span class="n">scaling</span> <span class="o">=</span> <span class="n">rho_factor_list</span><span class="p">[[</span><span class="s">&quot;acc&quot;</span><span class="p">]])</span>
<span class="n">main_effects_dev</span> <span class="o">&lt;-</span> <span class="nf">GetRamps</span><span class="p">(</span><span class="n">vec</span> <span class="o">=</span> <span class="n">dat</span><span class="p">[,</span> <span class="n">dev</span><span class="p">],</span> <span class="n">vecname</span> <span class="o">=</span> <span class="s">&quot;dev&quot;</span><span class="p">,</span> <span class="n">np</span> <span class="o">=</span> <span class="n">num_periods</span><span class="p">,</span> <span class="n">scaling</span> <span class="o">=</span> <span class="n">rho_factor_list</span><span class="p">[[</span><span class="s">&quot;dev&quot;</span><span class="p">]])</span>
<span class="n">main_effects_cal</span> <span class="o">&lt;-</span> <span class="nf">GetRamps</span><span class="p">(</span><span class="n">vec</span> <span class="o">=</span> <span class="n">dat</span><span class="p">[,</span> <span class="n">cal</span><span class="p">],</span> <span class="n">vecname</span> <span class="o">=</span> <span class="s">&quot;cal&quot;</span><span class="p">,</span> <span class="n">np</span> <span class="o">=</span> <span class="n">num_periods</span><span class="p">,</span> <span class="n">scaling</span> <span class="o">=</span> <span class="n">rho_factor_list</span><span class="p">[[</span><span class="s">&quot;cal&quot;</span><span class="p">]])</span>

<span class="n">main_effects</span> <span class="o">&lt;-</span> <span class="nf">cbind</span><span class="p">(</span><span class="n">main_effects_acc</span><span class="p">,</span> <span class="n">main_effects_dev</span><span class="p">,</span> <span class="n">main_effects_cal</span><span class="p">)</span>


<span class="c1"># interaction effects</span>
<span class="n">int_effects</span> <span class="o">&lt;-</span> <span class="nf">cbind</span><span class="p">(</span>
    <span class="nf">GetInts</span><span class="p">(</span><span class="n">vec1</span><span class="o">=</span><span class="n">dat</span><span class="p">[,</span> <span class="n">acc</span><span class="p">],</span> <span class="n">vecname1</span><span class="o">=</span><span class="s">&quot;acc&quot;</span><span class="p">,</span> <span class="n">scaling1</span><span class="o">=</span><span class="n">rho_factor_list</span><span class="p">[[</span><span class="s">&quot;acc&quot;</span><span class="p">]],</span> <span class="n">np</span><span class="o">=</span><span class="n">num_periods</span><span class="p">,</span>
            <span class="n">vec2</span><span class="o">=</span><span class="n">dat</span><span class="p">[,</span> <span class="n">dev</span><span class="p">],</span> <span class="n">vecname2</span><span class="o">=</span><span class="s">&quot;dev&quot;</span><span class="p">,</span> <span class="n">scaling2</span><span class="o">=</span><span class="n">rho_factor_list</span><span class="p">[[</span><span class="s">&quot;dev&quot;</span><span class="p">]]),</span>

    <span class="nf">GetInts</span><span class="p">(</span><span class="n">vec1</span><span class="o">=</span><span class="n">dat</span><span class="p">[,</span> <span class="n">dev</span><span class="p">],</span> <span class="n">vecname1</span><span class="o">=</span><span class="s">&quot;dev&quot;</span><span class="p">,</span> <span class="n">scaling1</span><span class="o">=</span><span class="n">rho_factor_list</span><span class="p">[[</span><span class="s">&quot;dev&quot;</span><span class="p">]],</span> <span class="n">np</span><span class="o">=</span><span class="n">num_periods</span><span class="p">,</span>
            <span class="n">vec2</span><span class="o">=</span><span class="n">dat</span><span class="p">[,</span> <span class="n">cal</span><span class="p">],</span> <span class="n">vecname2</span><span class="o">=</span><span class="s">&quot;cal&quot;</span><span class="p">,</span> <span class="n">scaling2</span><span class="o">=</span><span class="n">rho_factor_list</span><span class="p">[[</span><span class="s">&quot;cal&quot;</span><span class="p">]]),</span>

    <span class="nf">GetInts</span><span class="p">(</span><span class="n">vec1</span><span class="o">=</span><span class="n">dat</span><span class="p">[,</span> <span class="n">acc</span><span class="p">],</span> <span class="n">vecname1</span><span class="o">=</span><span class="s">&quot;acc&quot;</span><span class="p">,</span> <span class="n">scaling1</span><span class="o">=</span><span class="n">rho_factor_list</span><span class="p">[[</span><span class="s">&quot;acc&quot;</span><span class="p">]],</span> <span class="n">np</span><span class="o">=</span><span class="n">num_periods</span><span class="p">,</span>
            <span class="n">vec2</span><span class="o">=</span><span class="n">dat</span><span class="p">[,</span> <span class="n">cal</span><span class="p">],</span> <span class="n">vecname2</span><span class="o">=</span><span class="s">&quot;cal&quot;</span><span class="p">,</span> <span class="n">scaling2</span><span class="o">=</span><span class="n">rho_factor_list</span><span class="p">[[</span><span class="s">&quot;cal&quot;</span><span class="p">]])</span>
<span class="p">)</span>


<span class="n">varset</span> <span class="o">&lt;-</span> <span class="nf">cbind</span><span class="p">(</span><span class="n">main_effects</span><span class="p">,</span> <span class="n">int_effects</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Have a look at a subset of the data</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">varset</span><span class="p">[</span><span class="m">1</span><span class="o">:</span><span class="m">10</span><span class="p">,</span> <span class="m">39</span><span class="o">:</span><span class="m">44</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><table class="dataframe">
<caption>A matrix: 10 × 6 of type dbl</caption>
<thead>
	<tr><th scope=col>L_39_999_acc</th><th scope=col>L_1_999_dev</th><th scope=col>L_2_999_dev</th><th scope=col>L_3_999_dev</th><th scope=col>L_4_999_dev</th><th scope=col>L_5_999_dev</th></tr>
</thead>
<tbody>
	<tr><td>0</td><td>0.0000000</td><td>0.0000000</td><td>0.0000000</td><td>0.0000000</td><td>0.0000000</td></tr>
	<tr><td>0</td><td>0.1048285</td><td>0.0000000</td><td>0.0000000</td><td>0.0000000</td><td>0.0000000</td></tr>
	<tr><td>0</td><td>0.2096570</td><td>0.1048285</td><td>0.0000000</td><td>0.0000000</td><td>0.0000000</td></tr>
	<tr><td>0</td><td>0.3144855</td><td>0.2096570</td><td>0.1048285</td><td>0.0000000</td><td>0.0000000</td></tr>
	<tr><td>0</td><td>0.4193139</td><td>0.3144855</td><td>0.2096570</td><td>0.1048285</td><td>0.0000000</td></tr>
	<tr><td>0</td><td>0.5241424</td><td>0.4193139</td><td>0.3144855</td><td>0.2096570</td><td>0.1048285</td></tr>
	<tr><td>0</td><td>0.6289709</td><td>0.5241424</td><td>0.4193139</td><td>0.3144855</td><td>0.2096570</td></tr>
	<tr><td>0</td><td>0.7337994</td><td>0.6289709</td><td>0.5241424</td><td>0.4193139</td><td>0.3144855</td></tr>
	<tr><td>0</td><td>0.8386279</td><td>0.7337994</td><td>0.6289709</td><td>0.5241424</td><td>0.4193139</td></tr>
	<tr><td>0</td><td>0.9434564</td><td>0.8386279</td><td>0.7337994</td><td>0.6289709</td><td>0.5241424</td></tr>
</tbody>
</table>
</div></div>
</div>
<p>We can also look at the scaling factors used</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="nf">print</span><span class="p">(</span><span class="n">rho_factor_list</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>$acc
[1] 9.539392

$dev
[1] 9.539392

$cal
[1] 9.539392
</pre></div>
</div>
</div>
</div>
<p>The factors are all equal in this case. In hindsight this makes sense - we have the complete 40 x 40 past triangle, and all regressors are numbered from 1, so all three regressors are permutations of the same numbers.</p>
<br>
<p>Some of the interactions will be constant over the past data set - i.e. those that involve combinations of parameters that are only possible in the future such as <code class="docutils literal notranslate"><span class="pre">I_acc_ge35xI_dev_ge30</span></code>. We don’t have to remove these but we can do if we want.</p>
<p>This next block of code does this.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="c1"># drop any constant columns over the training data set</span>
<span class="c1"># do this by identifying the constant columns and dropping them</span>

<span class="c1"># get the past data subset only using TRUE/FALSE from train_ind in dat</span>
<span class="n">varset_train</span> <span class="o">&lt;-</span> <span class="n">varset</span><span class="p">[</span><span class="n">dat</span><span class="o">$</span><span class="n">train_ind</span><span class="p">,</span> <span class="p">]</span>

<span class="c1"># identify constant columns as those with max=min</span>
<span class="n">rm_cols</span> <span class="o">&lt;-</span> <span class="n">varset_train</span><span class="p">[,</span> <span class="nf">apply</span><span class="p">(</span><span class="n">varset_train</span><span class="p">,</span> <span class="n">MARGIN</span><span class="o">=</span><span class="m">2</span><span class="p">,</span> <span class="nf">function</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="nf">max</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">na.rm</span> <span class="o">=</span> <span class="kc">TRUE</span><span class="p">)</span> <span class="o">==</span> <span class="nf">min</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">na.rm</span> <span class="o">=</span> <span class="kc">TRUE</span><span class="p">))]</span>

<span class="c1"># drop these constant columns</span>
<span class="n">varset</span> <span class="o">&lt;-</span> <span class="n">varset</span><span class="p">[,</span> <span class="o">!</span><span class="p">(</span><span class="nf">colnames</span><span class="p">(</span><span class="n">varset</span><span class="p">)</span> <span class="o">%in%</span> <span class="nf">colnames</span><span class="p">(</span><span class="n">rm_cols</span><span class="p">))]</span>
</pre></div>
</div>
</div>
</div>
<br>
</div>
</div>
<div class="section" id="fitting-a-lasso">
<h2>Fitting a LASSO<a class="headerlink" href="#fitting-a-lasso" title="Permalink to this headline">¶</a></h2>
<p>The <strong>glmnet</strong> package has two functions for fitting a LASSO: <code class="docutils literal notranslate"><span class="pre">glmnet()</span></code> and <code class="docutils literal notranslate"><span class="pre">cv.glmnet()</span></code>.</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">glmnet()</span></code> fits a regularised regression model for various values of the penalty parameter, <span class="math notranslate nohighlight">\(\lambda\)</span>.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">cv.glmnet()</span></code> adds a cross-validation (“CV”) layer on top of this so helps us to select the particular value of <span class="math notranslate nohighlight">\(\lambda\)</span> to use - <span class="math notranslate nohighlight">\(\lambda\)</span> values that have lower cross-validation error values are preferred.</p></li>
</ul>
<p>We’ll use the latter function here.</p>
<p>In addition to the data and basis functions, <code class="docutils literal notranslate"><span class="pre">cv.glmnet()</span></code> has a number of parameters. These include:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">family</span></code> - the response type to use. We’ll use the Poisson distribution here, but note that recent versions of the <strong>glmnet</strong> package have widened the options available for this parameter. At the time we did this work, the Poisson (with a log link) was the most suitable option.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">nlambda</span></code> and <code class="docutils literal notranslate"><span class="pre">lambda.min.ratio</span></code> - control the vector of lambda values calculated by <code class="docutils literal notranslate"><span class="pre">cv.glmnet()</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">pmax</span></code> - the maximum number of variables ever to be non-zero in a model</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">dfmax</span></code> - maximum number of variables in a model</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">alpha</span></code> - set this to 1 for the LASSO</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">thresh</span></code> - convergence parameter. Default is 1E-7</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">maxit</span></code> - maximum number of interations</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">nfolds</span></code> - number of cross-validation folds</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">standardize</span></code> - whether to standardise the x variables (we set this to FALSE since we have done our own standardisation).</p></li>
</ul>
<p>There’s also a <code class="docutils literal notranslate"><span class="pre">parallel</span></code> argument which will use parallel processing to speed things up. This is worth using if you have a large data set and access to a multi-core machine.</p>
<p>Below we fit the LASSO via <code class="docutils literal notranslate"><span class="pre">cv.glmnet()</span></code> with our selections for the parameters above.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">my_pmax</span> <span class="o">&lt;-</span> <span class="n">num_periods</span><span class="o">^</span><span class="m">2</span>   <span class="c1"># max number of variables ever to be nonzero</span>
<span class="n">my_dfmax</span> <span class="o">&lt;-</span> <span class="n">num_periods</span><span class="o">*</span><span class="m">10</span>  <span class="c1">#max number of vars in the model</span>

<span class="n">time1</span> <span class="o">&lt;-</span> <span class="nf">Sys.time</span><span class="p">()</span>
<span class="n">cv_fit</span> <span class="o">&lt;-</span> <span class="nf">cv.glmnet</span><span class="p">(</span><span class="n">x</span> <span class="o">=</span> <span class="n">varset</span><span class="p">[</span><span class="n">dat</span><span class="o">$</span><span class="n">train_ind</span><span class="p">,],</span>
                  <span class="n">y</span> <span class="o">=</span> <span class="n">dat</span><span class="p">[</span><span class="n">train_ind</span><span class="o">==</span><span class="kc">TRUE</span><span class="p">,</span> <span class="n">pmts</span><span class="p">],</span>
                  <span class="n">family</span> <span class="o">=</span> <span class="s">&quot;poisson&quot;</span><span class="p">,</span>
                  <span class="n">nlambda</span> <span class="o">=</span> <span class="m">200</span><span class="p">,</span>  <span class="c1"># default is 100 but often not enough for this type of problem</span>
                  <span class="n">nfolds</span> <span class="o">=</span> <span class="m">8</span><span class="p">,</span>
                  <span class="n">thresh</span> <span class="o">=</span> <span class="m">1e-08</span><span class="p">,</span> <span class="c1"># default is 1e-7 but we found we needed to reduce it from time to time</span>
                  <span class="n">lambda.min.ratio</span> <span class="o">=</span> <span class="m">0</span><span class="p">,</span> <span class="c1"># allow very small values in lambda</span>
                  <span class="n">dfmax</span> <span class="o">=</span> <span class="n">my_dfmax</span><span class="p">,</span>
                  <span class="n">pmax</span> <span class="o">=</span> <span class="n">my_pmax</span><span class="p">,</span>
                  <span class="n">alpha</span> <span class="o">=</span> <span class="m">1</span><span class="p">,</span>
                  <span class="n">standardize</span> <span class="o">=</span> <span class="kc">FALSE</span><span class="p">,</span>
                  <span class="n">maxit</span> <span class="o">=</span> <span class="m">200000</span><span class="p">)</span>  <span class="c1"># convergence can be slow so increase max number of iterations</span>
<span class="nf">print</span><span class="p">(</span><span class="s">&quot;time taken for cross validation fit: &quot;</span><span class="p">)</span>
<span class="nf">Sys.time</span><span class="p">()</span> <span class="o">-</span> <span class="n">time1</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[1] &quot;time taken for cross validation fit: &quot;
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Time difference of 1.635672 mins
</pre></div>
</div>
</div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">cv.glmnet</span></code> objects have a plot method associated with them which plots the CV fit:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="nf">plot</span><span class="p">(</span><span class="n">cv_fit</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/MLRWP_R_Lasso_53_0.png" src="../_images/MLRWP_R_Lasso_53_0.png" />
</div>
</div>
<p>Each point shows the average error across all folds, the bars show the standard deviation. The dashed lines represent the minimum CV error model (smaller <span class="math notranslate nohighlight">\(\lambda\)</span>, called <code class="docutils literal notranslate"><span class="pre">lambda.min</span></code>) and one a standard deviation away (<code class="docutils literal notranslate"><span class="pre">lambda.1se</span></code>). These are selections commonly used by modellers. The numbers across the upper y-axis are the number of non-zero parameters in the model for that value of <span class="math notranslate nohighlight">\(\lambda\)</span>.</p>
<p>Occasionally, the minimum CV value is the final point in the lambda sequence. In this case you should rerun <code class="docutils literal notranslate"><span class="pre">cv.glmnet()</span></code> with a longer lambda vector - one easy way to do this is to extract the <code class="docutils literal notranslate"><span class="pre">lambda</span></code> vector from the <code class="docutils literal notranslate"><span class="pre">cv.glmnet</span></code> object, and then extend it by adding values at the end, e.g. using a decay factor. Then rerun the cross-validation fit with this longer vector (specify its use via the <code class="docutils literal notranslate"><span class="pre">lambda</span></code> function argument) and, all going well, the minimum CV error lambda will now be a true minimum, rather than the last evaluated point. The original article does something like this, if you would like to see some more details around this.</p>
</div>
<div class="section" id="analysing-the-model">
<h2>Analysing the model<a class="headerlink" href="#analysing-the-model" title="Permalink to this headline">¶</a></h2>
<div class="section" id="model-coefficients">
<h3>Model coefficients<a class="headerlink" href="#model-coefficients" title="Permalink to this headline">¶</a></h3>
<p>We used the model corresponding to the minimum CV error in the paper (<code class="docutils literal notranslate"><span class="pre">lambda.min</span></code> in the <code class="docutils literal notranslate"><span class="pre">cv.glmnet</span></code> results object, <code class="docutils literal notranslate"><span class="pre">cv_fit</span></code>). First let’s look at the coefficients in this model.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="c1"># all coefficients, including those that are 0</span>
<span class="n">coefs_min</span> <span class="o">&lt;-</span> <span class="nf">predict</span><span class="p">(</span><span class="n">cv_fit</span><span class="p">,</span> <span class="n">type</span> <span class="o">=</span> <span class="s">&quot;coefficients&quot;</span><span class="p">,</span> <span class="n">s</span> <span class="o">=</span> <span class="n">cv_fit</span><span class="o">$</span><span class="n">lambda.min</span><span class="p">)</span>  <span class="c1"># NB this is a data.frame not a vector</span>
<span class="n">coefnames</span> <span class="o">&lt;-</span> <span class="nf">c</span><span class="p">(</span><span class="s">&quot;Intercept&quot;</span><span class="p">,</span> <span class="nf">colnames</span><span class="p">(</span><span class="n">varset</span><span class="p">))</span>  <span class="c1"># don&#39;t forget the intercept  # coeff names - this is a vector</span>

<span class="c1"># get indicators for non-zero ones</span>
<span class="n">ind_nz_min</span><span class="o">&lt;-</span><span class="nf">which</span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">coefs_min</span> <span class="o">==</span> <span class="m">0</span><span class="p">))</span>

<span class="c1"># make a data.table for easy viewing</span>
<span class="n">nzcoefs_min</span> <span class="o">&lt;-</span> <span class="nf">data.table</span><span class="p">(</span><span class="n">Parameter</span> <span class="o">=</span> <span class="n">coefnames</span><span class="p">[</span><span class="n">ind_nz_min</span><span class="p">],</span> <span class="n">Coefficient</span> <span class="o">=</span> <span class="n">coefs_min</span><span class="p">[</span><span class="n">ind_nz_min</span><span class="p">,])</span>

<span class="c1"># print the table</span>
<span class="n">nzcoefs_min</span> <span class="o">%&gt;%</span>
    <span class="nf">kable</span><span class="p">(</span><span class="n">digits</span><span class="o">=</span><span class="m">4</span><span class="p">,</span> <span class="n">format.args</span> <span class="o">=</span> <span class="nf">list</span><span class="p">(</span><span class="n">scientific</span> <span class="o">=</span> <span class="kc">FALSE</span><span class="p">))</span> <span class="o">%&gt;%</span>
    <span class="nf">kable_styling</span><span class="p">(</span><span class="n">full_width</span><span class="o">=</span><span class="kc">FALSE</span><span class="p">,</span> <span class="n">bootstrap_options</span> <span class="o">=</span> <span class="nf">c</span><span class="p">(</span><span class="s">&quot;striped&quot;</span><span class="p">,</span> <span class="s">&quot;hover&quot;</span><span class="p">,</span> <span class="s">&quot;condensed&quot;</span><span class="p">))</span> <span class="o">%&gt;%</span>
    <span class="nf">as.character</span><span class="p">()</span> <span class="o">%&gt;%</span>
    <span class="nf">display_html</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><table class="table table-striped table-hover table-condensed" style="width: auto !important; margin-left: auto; margin-right: auto;">
 <thead>
  <tr>
   <th style="text-align:left;"> Parameter </th>
   <th style="text-align:right;"> Coefficient </th>
  </tr>
 </thead>
<tbody>
  <tr>
   <td style="text-align:left;"> Intercept </td>
   <td style="text-align:right;"> 12.9221 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> L_3_999_acc </td>
   <td style="text-align:right;"> -0.1425 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> L_6_999_acc </td>
   <td style="text-align:right;"> 0.1425 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> L_8_999_acc </td>
   <td style="text-align:right;"> -0.0885 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> L_9_999_acc </td>
   <td style="text-align:right;"> -0.0024 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> L_10_999_acc </td>
   <td style="text-align:right;"> -0.0006 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> L_11_999_acc </td>
   <td style="text-align:right;"> -0.0170 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> L_12_999_acc </td>
   <td style="text-align:right;"> 0.3078 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> L_14_999_acc </td>
   <td style="text-align:right;"> -0.1343 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> L_15_999_acc </td>
   <td style="text-align:right;"> 0.3683 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> L_16_999_acc </td>
   <td style="text-align:right;"> 0.9012 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> L_18_999_acc </td>
   <td style="text-align:right;"> -0.5227 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> L_19_999_acc </td>
   <td style="text-align:right;"> -0.2039 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> L_20_999_acc </td>
   <td style="text-align:right;"> -1.3892 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> L_23_999_acc </td>
   <td style="text-align:right;"> -0.7503 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> L_24_999_acc </td>
   <td style="text-align:right;"> 1.1541 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> L_25_999_acc </td>
   <td style="text-align:right;"> -0.8621 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> L_26_999_acc </td>
   <td style="text-align:right;"> 0.2987 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> L_30_999_acc </td>
   <td style="text-align:right;"> -0.6825 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> L_33_999_acc </td>
   <td style="text-align:right;"> 0.4850 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> L_1_999_dev </td>
   <td style="text-align:right;"> 8.9527 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> L_2_999_dev </td>
   <td style="text-align:right;"> -0.0046 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> L_3_999_dev </td>
   <td style="text-align:right;"> -0.0229 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> L_4_999_dev </td>
   <td style="text-align:right;"> -3.0200 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> L_5_999_dev </td>
   <td style="text-align:right;"> -2.8857 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> L_6_999_dev </td>
   <td style="text-align:right;"> -0.6692 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> L_7_999_dev </td>
   <td style="text-align:right;"> -0.7572 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> L_8_999_dev </td>
   <td style="text-align:right;"> -0.9759 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> L_9_999_dev </td>
   <td style="text-align:right;"> -0.2522 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> L_10_999_dev </td>
   <td style="text-align:right;"> -0.3039 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> L_11_999_dev </td>
   <td style="text-align:right;"> -0.6490 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> L_12_999_dev </td>
   <td style="text-align:right;"> -0.3327 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> L_13_999_dev </td>
   <td style="text-align:right;"> -0.1587 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> L_14_999_dev </td>
   <td style="text-align:right;"> 0.0191 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> L_15_999_dev </td>
   <td style="text-align:right;"> -0.7603 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> L_18_999_dev </td>
   <td style="text-align:right;"> 0.0090 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> L_19_999_dev </td>
   <td style="text-align:right;"> 0.6620 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> L_21_999_dev </td>
   <td style="text-align:right;"> -1.5670 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> L_22_999_dev </td>
   <td style="text-align:right;"> -0.4151 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> L_24_999_dev </td>
   <td style="text-align:right;"> 1.0428 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> L_26_999_dev </td>
   <td style="text-align:right;"> -1.0515 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> L_27_999_dev </td>
   <td style="text-align:right;"> -0.0598 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> L_29_999_dev </td>
   <td style="text-align:right;"> 0.7672 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> L_35_999_dev </td>
   <td style="text-align:right;"> 1.6120 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> L_36_999_dev </td>
   <td style="text-align:right;"> 2.6817 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> L_1_999_cal </td>
   <td style="text-align:right;"> 1.1549 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> L_8_999_cal </td>
   <td style="text-align:right;"> -0.0003 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> L_10_999_cal </td>
   <td style="text-align:right;"> -0.0382 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> L_11_999_cal </td>
   <td style="text-align:right;"> 0.0000 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> L_13_999_cal </td>
   <td style="text-align:right;"> -0.5499 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> L_15_999_cal </td>
   <td style="text-align:right;"> 0.3092 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> L_16_999_cal </td>
   <td style="text-align:right;"> 0.2270 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> L_17_999_cal </td>
   <td style="text-align:right;"> 0.0595 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> L_20_999_cal </td>
   <td style="text-align:right;"> 0.0086 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> L_21_999_cal </td>
   <td style="text-align:right;"> 0.0000 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> L_22_999_cal </td>
   <td style="text-align:right;"> -0.0529 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> L_24_999_cal </td>
   <td style="text-align:right;"> -0.3902 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> L_26_999_cal </td>
   <td style="text-align:right;"> 0.1052 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> L_28_999_cal </td>
   <td style="text-align:right;"> 0.1896 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> L_29_999_cal </td>
   <td style="text-align:right;"> 0.1673 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> L_31_999_cal </td>
   <td style="text-align:right;"> 0.0983 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> L_32_999_cal </td>
   <td style="text-align:right;"> -0.7529 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> L_33_999_cal </td>
   <td style="text-align:right;"> 0.4106 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> L_34_999_cal </td>
   <td style="text-align:right;"> 0.0238 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> L_35_999_cal </td>
   <td style="text-align:right;"> -0.1085 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> L_36_999_cal </td>
   <td style="text-align:right;"> 0.6728 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> L_37_999_cal </td>
   <td style="text-align:right;"> -0.2999 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> L_38_999_cal </td>
   <td style="text-align:right;"> 0.3772 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> L_39_999_cal </td>
   <td style="text-align:right;"> -0.7330 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> I_acc_ge_17xI_dev_ge_19 </td>
   <td style="text-align:right;"> 4.9584 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> I_acc_ge_17xI_dev_ge_20 </td>
   <td style="text-align:right;"> 0.4301 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> I_acc_ge_17xI_dev_ge_21 </td>
   <td style="text-align:right;"> 137.6568 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> I_acc_ge_18xI_dev_ge_21 </td>
   <td style="text-align:right;"> 5.6673 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> I_dev_ge_10xI_cal_ge_31 </td>
   <td style="text-align:right;"> -1.6737 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> I_dev_ge_12xI_cal_ge_26 </td>
   <td style="text-align:right;"> -0.3625 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> I_dev_ge_13xI_cal_ge_37 </td>
   <td style="text-align:right;"> 0.6549 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> I_dev_ge_22xI_cal_ge_39 </td>
   <td style="text-align:right;"> 0.9191 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> I_acc_ge_20xI_cal_ge_36 </td>
   <td style="text-align:right;"> -1.1361 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> I_acc_ge_20xI_cal_ge_37 </td>
   <td style="text-align:right;"> -3.5266 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> I_acc_ge_20xI_cal_ge_38 </td>
   <td style="text-align:right;"> -4.0518 </td>
  </tr>
</tbody>
</table></div></div>
</div>
<p>Note the interactions at the end. Are these detecting the interaction that we know is in this simulated data set? We will find out below.</p>
</div>
<div class="section" id="tracking-plots">
<h3>Tracking plots<a class="headerlink" href="#tracking-plots" title="Permalink to this headline">¶</a></h3>
<p>We plot the model results in a number of different ways in the paper. Below we replicate some of these plots.</p>
<p>First, we add the fitted values to the data.table.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">dat</span><span class="p">[,</span> <span class="n">fitted</span> <span class="o">:=</span> <span class="nf">as.vector</span><span class="p">(</span><span class="nf">predict</span><span class="p">(</span><span class="n">cv_fit</span><span class="p">,</span>
                                  <span class="n">newx</span> <span class="o">=</span> <span class="n">varset</span><span class="p">,</span>
                                  <span class="n">s</span> <span class="o">=</span> <span class="n">cv_fit</span><span class="o">$</span><span class="n">lambda.min</span><span class="p">,</span>
                                  <span class="n">type</span><span class="o">=</span><span class="s">&quot;response&quot;</span><span class="p">))]</span>
</pre></div>
</div>
</div>
</div>
<p>The function below produces the tracking graphs shown in the paper - plot values for all levels of one fundamental predictor holding a second predictor at a fixed value. To help with interpreting the results, it also shades the past part of the data in grey.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">GraphModelVals</span><span class="o">&lt;-</span><span class="nf">function</span><span class="p">(</span><span class="n">dat</span><span class="p">,</span> <span class="n">primary_predictor</span><span class="p">,</span> <span class="n">secondary_predictor</span><span class="p">,</span> <span class="n">secondary_predictor_val</span><span class="p">,</span>
                         <span class="n">xaxis_label</span><span class="p">,</span> <span class="n">yaxis_label</span><span class="p">,</span> <span class="n">var_names</span><span class="p">,</span> <span class="n">log_values</span> <span class="o">=</span> <span class="kc">TRUE</span><span class="p">,</span>
                         <span class="n">include_st</span><span class="o">=</span><span class="kc">FALSE</span><span class="p">,</span> <span class="n">include_legend</span><span class="o">=</span><span class="kc">FALSE</span><span class="p">,</span> <span class="n">font_size</span><span class="o">=</span><span class="m">6</span><span class="p">){</span>

  <span class="c1"># dat = input data. Must be in wide format</span>
  <span class="c1"># primary_predictor = plot values for this predictor</span>
  <span class="c1"># secondary_predictor = hold this predictor fixed</span>
  <span class="c1"># secondary_predictor_val = value to hold secondary_predictor fixed at</span>
  <span class="c1"># xaxis_label = label for x axis</span>
  <span class="c1"># yaxis_label = label for y axis</span>
  <span class="c1"># var_names = names of actual / fitted variables in the input data to plot.     </span>
  <span class="c1">#    var_names must be list with names like this: list(actual=&quot;pmts&quot;, mean=&quot;mu&quot;, fitted=&quot;fitted&quot;)</span>
  <span class="c1"># log_values = plot log(values) - default = TRUE</span>
  <span class="c1"># include_st = include a subtitle in the plot saying the grey rectangle is past data, default=FALSE    </span>
  <span class="c1"># include_legend = include the legend in the plot, default=FALSE    </span>
  <span class="c1"># font_size = size of font, default = 6</span>
  <span class="c1"># (these last 3 variables + default values might seem odd - this function is used in a later article</span>
  <span class="c1">#    and the defaults are sensible in that context)    </span>


  <span class="c1"># extract data we want to use</span>
  <span class="n">use_dat</span> <span class="o">&lt;-</span> <span class="n">dat</span><span class="p">[</span><span class="nf">get</span><span class="p">(</span><span class="n">secondary_predictor</span><span class="p">)</span> <span class="o">==</span> <span class="n">secondary_predictor_val</span><span class="p">,</span> <span class="p">]</span>

  <span class="c1"># turn into long format (tidy format in this case) using melt.data.table since that works better with ggplot</span>
  <span class="n">dat_long</span> <span class="o">&lt;-</span> <span class="nf">melt</span><span class="p">(</span><span class="n">dat</span><span class="p">[</span><span class="nf">get</span><span class="p">(</span><span class="n">secondary_predictor</span><span class="p">)</span> <span class="o">==</span> <span class="n">secondary_predictor_val</span><span class="p">,</span> <span class="p">],</span>
                   <span class="n">measure.vars</span> <span class="o">=</span> <span class="nf">unlist</span><span class="p">(</span><span class="n">var_names</span><span class="p">),</span>
                   <span class="n">id.vars</span> <span class="o">=</span> <span class="n">primary_predictor</span><span class="p">)</span>

  <span class="c1"># make the names nicer - colnames and labels</span>
  <span class="nf">setnames</span><span class="p">(</span><span class="n">dat_long</span><span class="p">,</span> <span class="n">primary_predictor</span><span class="p">,</span> <span class="s">&quot;predictor&quot;</span><span class="p">)</span>

  <span class="n">dat_long</span><span class="p">[</span><span class="n">variable</span> <span class="o">==</span> <span class="n">var_names</span><span class="o">$</span><span class="n">actual</span><span class="p">,</span> <span class="n">variable</span> <span class="o">:=</span> <span class="s">&quot;Simulated&quot;</span>
           <span class="p">][</span><span class="n">variable</span> <span class="o">==</span> <span class="n">var_names</span><span class="o">$</span><span class="n">mean</span><span class="p">,</span> <span class="n">variable</span> <span class="o">:=</span> <span class="s">&quot;Underlying&quot;</span>
             <span class="p">][</span><span class="n">variable</span> <span class="o">==</span> <span class="n">var_names</span><span class="o">$</span><span class="n">fitted</span><span class="p">,</span> <span class="n">variable</span> <span class="o">:=</span> <span class="s">&quot;Fitted&quot;</span><span class="p">]</span>

  <span class="c1"># get the levels of the variables right so that they are plotted in the right order</span>
  <span class="n">dat_long</span><span class="p">[,</span> <span class="n">variable</span> <span class="o">:=</span> <span class="nf">factor</span><span class="p">(</span><span class="n">variable</span><span class="p">,</span> <span class="n">levels</span><span class="o">=</span><span class="nf">c</span><span class="p">(</span><span class="s">&quot;Fitted&quot;</span><span class="p">,</span> <span class="s">&quot;Simulated&quot;</span><span class="p">,</span> <span class="s">&quot;Underlying&quot;</span><span class="p">))]</span>


  <span class="nf">if </span><span class="p">(</span><span class="n">log_values</span><span class="p">)</span> <span class="n">dat_long</span><span class="p">[,</span> <span class="n">value</span> <span class="o">:=</span> <span class="nf">log</span><span class="p">(</span><span class="n">value</span><span class="p">)]</span>

  <span class="c1"># figure out past data rectangle coordinates</span>
  <span class="n">xmin1</span> <span class="o">&lt;-</span> <span class="n">use_dat</span><span class="p">[</span><span class="n">train_ind</span> <span class="o">==</span> <span class="kc">TRUE</span><span class="p">,</span> <span class="nf">min</span><span class="p">(</span><span class="nf">get</span><span class="p">(</span><span class="n">primary_predictor</span><span class="p">))]</span>
  <span class="n">xmax1</span> <span class="o">&lt;-</span> <span class="n">use_dat</span><span class="p">[</span><span class="n">train_ind</span> <span class="o">==</span> <span class="kc">TRUE</span><span class="p">,</span> <span class="nf">max</span><span class="p">(</span><span class="nf">get</span><span class="p">(</span><span class="n">primary_predictor</span><span class="p">))]</span>

  <span class="n">ymin1</span> <span class="o">&lt;-</span> <span class="n">dat_long</span><span class="p">[,</span> <span class="nf">min</span><span class="p">(</span><span class="n">value</span><span class="p">)]</span><span class="o">*</span><span class="m">0.95</span>
  <span class="n">ymax1</span> <span class="o">&lt;-</span> <span class="n">dat_long</span><span class="p">[,</span> <span class="nf">max</span><span class="p">(</span><span class="n">value</span><span class="p">)]</span><span class="o">*</span><span class="m">1.05</span>


  <span class="c1"># draw the tracking plots</span>
  <span class="n">g</span> <span class="o">&lt;-</span> <span class="nf">ggplot</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">dat_long</span><span class="p">,</span> <span class="nf">aes</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">predictor</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">value</span><span class="p">,</span> <span class="n">group</span><span class="o">=</span><span class="n">variable</span><span class="p">))</span><span class="o">+</span>
    <span class="nf">geom_line</span><span class="p">(</span><span class="nf">aes</span><span class="p">(</span><span class="n">linetype</span><span class="o">=</span><span class="n">variable</span><span class="p">,</span> <span class="n">colour</span><span class="o">=</span><span class="n">variable</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">variable</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="n">variable</span><span class="p">))</span><span class="o">+</span>
    <span class="nf">geom_line</span><span class="p">(</span><span class="nf">aes</span><span class="p">(</span><span class="n">linetype</span><span class="o">=</span><span class="n">variable</span><span class="p">,</span> <span class="n">colour</span><span class="o">=</span><span class="n">variable</span><span class="p">))</span><span class="o">+</span>
    <span class="nf">scale_colour_manual</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&quot;&quot;</span><span class="p">,</span> <span class="n">values</span><span class="o">=</span><span class="nf">c</span><span class="p">(</span><span class="n">red</span><span class="p">,</span> <span class="n">dgrey</span><span class="p">,</span> <span class="n">dgrey</span><span class="p">))</span><span class="o">+</span>
    <span class="nf">scale_linetype_manual</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&quot;&quot;</span><span class="p">,</span> <span class="n">values</span><span class="o">=</span><span class="nf">c</span><span class="p">(</span><span class="s">&quot;solid&quot;</span><span class="p">,</span> <span class="s">&quot;solid&quot;</span><span class="p">,</span> <span class="s">&quot;dotted&quot;</span><span class="p">))</span><span class="o">+</span>
    <span class="nf">scale_size_manual</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&quot;&quot;</span><span class="p">,</span> <span class="n">values</span><span class="o">=</span><span class="nf">c</span><span class="p">(</span><span class="m">2</span><span class="p">,</span><span class="m">1</span><span class="p">,</span><span class="m">1</span><span class="p">))</span><span class="o">+</span>
    <span class="nf">scale_alpha_manual</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&quot;&quot;</span><span class="p">,</span> <span class="n">values</span><span class="o">=</span><span class="nf">c</span><span class="p">(</span><span class="m">0.8</span><span class="p">,</span> <span class="m">0.5</span><span class="p">,</span> <span class="m">0.5</span><span class="p">))</span><span class="o">+</span>
    <span class="nf">theme_classic</span><span class="p">()</span><span class="o">+</span>
    <span class="nf">annotate</span><span class="p">(</span><span class="n">geom</span><span class="o">=</span><span class="s">&quot;rect&quot;</span><span class="p">,</span> <span class="n">xmin</span><span class="o">=</span><span class="n">xmin1</span><span class="p">,</span> <span class="n">xmax</span><span class="o">=</span><span class="n">xmax1</span><span class="p">,</span> <span class="n">ymin</span><span class="o">=</span><span class="n">ymin1</span><span class="p">,</span> <span class="n">ymax</span><span class="o">=</span><span class="n">ymax1</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="m">0.1</span><span class="p">)</span><span class="o">+</span>
    <span class="nf">labs</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">xaxis_label</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">yaxis_label</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="nf">paste</span><span class="p">(</span><span class="n">xaxis_label</span><span class="p">,</span> <span class="s">&quot;tracking for&quot;</span><span class="p">,</span> <span class="n">secondary_predictor</span><span class="p">,</span> <span class="s">&quot;=&quot;</span><span class="p">,</span> <span class="n">secondary_predictor_val</span><span class="p">))</span> <span class="o">+</span>
    <span class="nf">theme</span><span class="p">(</span><span class="n">axis.title</span> <span class="o">=</span> <span class="nf">element_text</span><span class="p">(</span><span class="n">size</span> <span class="o">=</span> <span class="n">font_size</span><span class="p">),</span> <span class="n">axis.text</span> <span class="o">=</span> <span class="nf">element_text</span><span class="p">(</span><span class="n">size</span> <span class="o">=</span> <span class="n">font_size</span><span class="m">-1</span><span class="p">))</span>

  <span class="nf">if</span><span class="p">(</span><span class="n">include_st</span><span class="o">==</span><span class="kc">TRUE</span><span class="p">)</span> <span class="n">g</span> <span class="o">&lt;-</span> <span class="n">g</span> <span class="o">+</span> <span class="nf">labs</span><span class="p">(</span><span class="n">subtitle</span><span class="o">=</span><span class="s">&quot;Past data in grey rectangle&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="nf">theme</span><span class="p">(</span><span class="n">plot.subtitle</span> <span class="o">=</span> <span class="nf">element_text </span><span class="p">(</span><span class="n">size</span> <span class="o">=</span> <span class="n">font_size</span><span class="p">))</span>

  <span class="n">g</span> <span class="o">&lt;-</span> <span class="nf">if</span><span class="p">(</span><span class="n">include_legend</span><span class="o">==</span><span class="kc">TRUE</span><span class="p">)</span> <span class="n">g</span> <span class="o">+</span> <span class="nf">theme</span><span class="p">(</span><span class="n">legend.position</span><span class="o">=</span><span class="s">&quot;bottom&quot;</span><span class="p">)</span> <span class="n">else</span> <span class="n">g</span> <span class="o">+</span> <span class="nf">theme</span><span class="p">(</span><span class="n">legend.position</span> <span class="o">=</span> <span class="s">&quot;none&quot;</span><span class="p">)</span>



  <span class="c1"># return the results  </span>
  <span class="nf">invisible</span><span class="p">(</span><span class="nf">list</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">dat_long</span><span class="p">,</span> <span class="n">graph</span><span class="o">=</span><span class="n">g</span><span class="p">))</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
</div>
<p>Now let’s look at development quarter when accident quarter is 20. Remember the step-interaction starts at dev=21 - which we see in the graph.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">dev_graph_list</span> <span class="o">&lt;-</span> <span class="nf">GraphModelVals</span><span class="p">(</span><span class="n">dat</span><span class="p">,</span>
                                 <span class="n">primary_predictor</span> <span class="o">=</span> <span class="s">&quot;dev&quot;</span><span class="p">,</span>
                                 <span class="n">secondary_predictor</span> <span class="o">=</span> <span class="s">&quot;acc&quot;</span><span class="p">,</span>
                                 <span class="n">secondary_predictor_val</span> <span class="o">=</span> <span class="m">20</span><span class="p">,</span>
                                 <span class="n">xaxis_label</span> <span class="o">=</span> <span class="s">&quot;Development quarter&quot;</span><span class="p">,</span>
                                 <span class="n">yaxis_label</span> <span class="o">=</span> <span class="s">&quot;Log(Payments)&quot;</span><span class="p">,</span>
                                 <span class="n">var_names</span> <span class="o">=</span> <span class="nf">list</span><span class="p">(</span><span class="n">actual</span><span class="o">=</span><span class="s">&quot;pmts&quot;</span><span class="p">,</span> <span class="n">mean</span><span class="o">=</span><span class="s">&quot;mu&quot;</span><span class="p">,</span> <span class="n">fitted</span><span class="o">=</span><span class="s">&quot;fitted&quot;</span><span class="p">),</span>
                                 <span class="n">include_st</span> <span class="o">=</span> <span class="kc">TRUE</span><span class="p">,</span>
                                 <span class="n">include_legend</span> <span class="o">=</span> <span class="kc">TRUE</span><span class="p">,</span>
                                 <span class="n">font_size</span> <span class="o">=</span> <span class="m">10</span><span class="p">)</span>

<span class="n">dev_graph_list</span><span class="o">$</span><span class="n">graph</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/MLRWP_R_Lasso_65_0.png" src="../_images/MLRWP_R_Lasso_65_0.png" />
</div>
</div>
<p>Similarly we can look at accident quarter tracking when development quarter is 24 and again see the interaction.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">acc_graph_list</span> <span class="o">&lt;-</span> <span class="nf">GraphModelVals</span><span class="p">(</span><span class="n">dat</span><span class="p">,</span>
                                 <span class="n">primary_predictor</span> <span class="o">=</span> <span class="s">&quot;acc&quot;</span><span class="p">,</span>
                                 <span class="n">secondary_predictor</span> <span class="o">=</span> <span class="s">&quot;dev&quot;</span><span class="p">,</span>
                                 <span class="n">secondary_predictor_val</span> <span class="o">=</span> <span class="m">24</span><span class="p">,</span>
                                 <span class="n">xaxis_label</span> <span class="o">=</span> <span class="s">&quot;Accident quarter&quot;</span><span class="p">,</span>
                                 <span class="n">yaxis_label</span> <span class="o">=</span> <span class="s">&quot;Log(Payments)&quot;</span><span class="p">,</span>
                                 <span class="n">var_names</span> <span class="o">=</span> <span class="nf">list</span><span class="p">(</span><span class="n">actual</span><span class="o">=</span><span class="s">&quot;pmts&quot;</span><span class="p">,</span> <span class="n">mean</span><span class="o">=</span><span class="s">&quot;mu&quot;</span><span class="p">,</span> <span class="n">fitted</span><span class="o">=</span><span class="s">&quot;fitted&quot;</span><span class="p">),</span>
                                 <span class="n">include_st</span> <span class="o">=</span> <span class="kc">TRUE</span><span class="p">,</span>
                                 <span class="n">include_legend</span> <span class="o">=</span> <span class="kc">TRUE</span><span class="p">,</span>
                                 <span class="n">font_size</span> <span class="o">=</span> <span class="m">10</span><span class="p">)</span>
<span class="n">acc_graph_list</span><span class="o">$</span><span class="n">graph</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/MLRWP_R_Lasso_67_0.png" src="../_images/MLRWP_R_Lasso_67_0.png" />
</div>
</div>
<p>You can explore other combinations of <code class="docutils literal notranslate"><span class="pre">primary_predictor</span></code>, <code class="docutils literal notranslate"><span class="pre">secondary_predictor</span></code> and <code class="docutils literal notranslate"><span class="pre">secondary_predictor_val</span></code> to see how the models track the past and future experience in other parts of the triangle</p>
</div>
<div class="section" id="heat-map">
<h3>Heat map<a class="headerlink" href="#heat-map" title="Permalink to this headline">¶</a></h3>
<p>Plotting colour-coded actual/fitted values can be a useful way of looking at the model fit. The function below plots these values (subject to lower and upper bounds of 25% and 400%) and shades them with blue values being less than 100% and red values being greater than 100%. The darker the shading, the further from 100%.</p>
<p>The function below will draw the heatmap.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="c1"># heat maps</span>

<span class="n">GraphHeatMap</span> <span class="o">&lt;-</span> <span class="nf">function</span><span class="p">(</span><span class="n">dat</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="s">&quot;dev&quot;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s">&quot;acc&quot;</span><span class="p">,</span> <span class="n">actual</span><span class="p">,</span> <span class="n">fitted</span><span class="p">,</span> <span class="n">lims</span><span class="o">=</span><span class="nf">c</span><span class="p">(</span><span class="m">0.25</span><span class="p">,</span> <span class="m">4</span><span class="p">),</span>
                         <span class="n">xlab</span><span class="o">=</span><span class="s">&quot;Development quarter&quot;</span><span class="p">,</span> <span class="n">ylab</span><span class="o">=</span><span class="s">&quot;Accident Quarter&quot;</span><span class="p">){</span>

  <span class="c1"># copy data to avoid modifying original</span>
  <span class="n">localdat</span> <span class="o">&lt;-</span> <span class="nf">copy</span><span class="p">(</span><span class="n">dat</span><span class="p">)</span>

  <span class="c1"># get fails if there is a variable with the same name so make local copies</span>
  <span class="n">local_x</span> <span class="o">&lt;-</span> <span class="n">x</span>
  <span class="n">local_y</span> <span class="o">&lt;-</span> <span class="n">y</span>
  <span class="n">local_actual</span> <span class="o">&lt;-</span> <span class="n">actual</span>
  <span class="n">local_fitted</span> <span class="o">&lt;-</span> <span class="n">fitted</span>

  <span class="c1"># make restricted Avs F for heatmap and set up past/future split line</span>
  <span class="n">np</span> <span class="o">&lt;-</span> <span class="nf">max</span><span class="p">(</span><span class="n">localdat</span><span class="p">[[</span><span class="n">y</span><span class="p">]])</span>

  <span class="n">localdat</span><span class="p">[,</span> <span class="n">.avsf</span> <span class="o">:=</span> <span class="nf">get</span><span class="p">(</span><span class="n">local_actual</span><span class="p">)</span> <span class="o">/</span> <span class="nf">get</span><span class="p">(</span><span class="n">local_fitted</span><span class="p">)</span>
           <span class="p">][,</span> <span class="n">.avsf_restrict_log</span> <span class="o">:=</span> <span class="nf">log</span><span class="p">(</span><span class="nf">pmax</span><span class="p">(</span><span class="nf">min</span><span class="p">(</span><span class="n">lims</span><span class="p">),</span> <span class="nf">pmin</span><span class="p">(</span><span class="nf">max</span><span class="p">(</span><span class="n">lims</span><span class="p">),</span> <span class="n">.avsf</span><span class="p">)))</span>
             <span class="p">][,</span> <span class="n">.past_line</span> <span class="o">:=</span> <span class="n">np</span> <span class="o">+</span> <span class="m">1</span> <span class="o">-</span> <span class="nf">get</span><span class="p">(</span><span class="n">local_y</span><span class="p">)]</span>


  <span class="n">g</span> <span class="o">&lt;-</span> <span class="nf">ggplot</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">localdat</span><span class="p">,</span> <span class="nf">aes_string</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">local_x</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">local_y</span><span class="p">))</span> <span class="o">+</span>
    <span class="nf">geom_tile</span><span class="p">(</span><span class="nf">aes</span><span class="p">(</span><span class="n">fill</span> <span class="o">=</span> <span class="n">.avsf_restrict_log</span><span class="p">))</span><span class="o">+</span><span class="nf">scale_y_reverse</span><span class="p">()</span><span class="o">+</span>
    <span class="nf">theme_classic</span><span class="p">()</span><span class="o">+</span>
    <span class="nf">scale_fill_gradient2</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&quot;AvF_min&quot;</span><span class="p">,</span> <span class="n">low</span><span class="o">=</span><span class="n">mblue</span><span class="p">,</span> <span class="n">mid</span><span class="o">=</span><span class="s">&quot;white&quot;</span><span class="p">,</span> <span class="n">high</span><span class="o">=</span><span class="n">red</span><span class="p">,</span> <span class="n">midpoint</span><span class="o">=</span><span class="m">0</span><span class="p">,</span>
                         <span class="n">space</span><span class="o">=</span><span class="s">&quot;Lab&quot;</span><span class="p">,</span> <span class="n">na.value</span><span class="o">=</span><span class="n">lgrey</span><span class="p">,</span> <span class="n">guide</span><span class="o">=</span><span class="s">&quot;colourbar&quot;</span><span class="p">)</span><span class="o">+</span>
    <span class="nf">labs</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">xlab</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">ylab</span><span class="p">)</span><span class="o">+</span>
    <span class="nf">geom_line</span><span class="p">(</span><span class="nf">aes_string</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s">&quot;.past_line&quot;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">local_y</span><span class="p">),</span> <span class="n">colour</span><span class="o">=</span><span class="n">dgrey</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="m">2</span><span class="p">)</span><span class="o">+</span>
    <span class="nf">theme</span><span class="p">(</span><span class="n">strip.text</span> <span class="o">=</span> <span class="nf">element_text</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="m">8</span><span class="p">,</span><span class="n">colour</span><span class="o">=</span><span class="n">dgrey</span><span class="p">),</span>
          <span class="n">strip.background</span> <span class="o">=</span> <span class="nf">element_rect</span><span class="p">(</span><span class="n">colour</span><span class="o">=</span><span class="s">&quot;white&quot;</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="s">&quot;white&quot;</span><span class="p">))</span><span class="o">+</span>
    <span class="nf">theme</span><span class="p">(</span><span class="n">axis.title.x</span> <span class="o">=</span> <span class="nf">element_text</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="m">10</span><span class="p">),</span> <span class="n">axis.text.x</span>  <span class="o">=</span> <span class="nf">element_text</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="m">10</span><span class="p">))</span><span class="o">+</span>
    <span class="nf">theme</span><span class="p">(</span><span class="n">axis.title.y</span> <span class="o">=</span> <span class="nf">element_text</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="m">10</span><span class="p">),</span> <span class="n">axis.text.y</span>  <span class="o">=</span> <span class="nf">element_text</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="m">10</span><span class="p">))</span><span class="o">+</span>
    <span class="nf">theme</span><span class="p">(</span><span class="nf">element_line</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="m">0.25</span><span class="p">,</span> <span class="n">colour</span><span class="o">=</span><span class="n">dgrey</span><span class="p">))</span><span class="o">+</span>
    <span class="nf">theme</span><span class="p">(</span><span class="n">legend.position</span><span class="o">=</span><span class="s">&quot;none&quot;</span><span class="p">,</span> <span class="p">)</span><span class="o">+</span>  
    <span class="kc">NULL</span>    


  <span class="nf">invisible</span><span class="p">(</span><span class="nf">list</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">localdat</span><span class="p">,</span> <span class="n">graph</span><span class="o">=</span><span class="n">g</span><span class="p">))</span>


<span class="p">}</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">g</span> <span class="o">&lt;-</span> <span class="nf">GraphHeatMap</span><span class="p">(</span><span class="n">dat</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="s">&quot;dev&quot;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s">&quot;acc&quot;</span><span class="p">,</span> <span class="n">actual</span><span class="o">=</span><span class="s">&quot;pmts&quot;</span><span class="p">,</span> <span class="n">fitted</span><span class="o">=</span><span class="s">&quot;fitted&quot;</span><span class="p">)</span>
<span class="n">g</span><span class="o">$</span><span class="n">graph</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/MLRWP_R_Lasso_72_0.png" src="../_images/MLRWP_R_Lasso_72_0.png" />
</div>
</div>
<p>You should, of course, carry out a full model validation exercise on any model prior to use. These plots may be helpful tools in this.</p>
</div>
</div>
<div class="section" id="claims-reserves">
<h2>Claims reserves<a class="headerlink" href="#claims-reserves" title="Permalink to this headline">¶</a></h2>
<p>Finally, let’s have a look at the claim reserve estimates and compare them to those from an 8-period chain ladder.</p>
<p>The code below uses data.table functionality to sum up the reserves by accident period and overall.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">os_acc</span> <span class="o">&lt;-</span> <span class="n">dat</span><span class="p">[</span><span class="n">train_ind</span> <span class="o">==</span> <span class="kc">FALSE</span><span class="p">,</span>
              <span class="nf">.</span><span class="p">(</span><span class="n">LASSO</span> <span class="o">=</span> <span class="nf">sum</span><span class="p">(</span><span class="n">fitted</span><span class="p">),</span> <span class="n">simulated</span> <span class="o">=</span> <span class="nf">sum</span><span class="p">(</span><span class="n">pmts</span><span class="p">),</span> <span class="n">underlying</span> <span class="o">=</span> <span class="nf">sum</span><span class="p">(</span><span class="n">mu</span><span class="p">)),</span>
              <span class="n">keyby</span><span class="o">=</span><span class="nf">.</span><span class="p">(</span><span class="n">acc</span><span class="p">)]</span>

<span class="n">os</span> <span class="o">&lt;-</span> <span class="n">os_acc</span><span class="p">[,</span> <span class="nf">.</span><span class="p">(</span><span class="n">LASSO</span> <span class="o">=</span> <span class="nf">sum</span><span class="p">(</span><span class="n">LASSO</span><span class="p">),</span>
                 <span class="n">simulated</span> <span class="o">=</span> <span class="nf">sum</span><span class="p">(</span><span class="n">simulated</span><span class="p">),</span>
                 <span class="n">underlying</span> <span class="o">=</span> <span class="nf">sum</span><span class="p">(</span><span class="n">underlying</span><span class="p">))]</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="chainladder-reserves">
<h3>Chainladder reserves<a class="headerlink" href="#chainladder-reserves" title="Permalink to this headline">¶</a></h3>
<p>In the paper we compared some of our results to the 8-period Chainladder reserve.
This is calculated below.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="c1"># get cumulative payments to make it easier to calculate CL factors</span>
<span class="n">dat</span><span class="p">[,</span> <span class="n">cumpmts</span> <span class="o">:=</span> <span class="nf">cumsum</span><span class="p">(</span><span class="n">pmts</span><span class="p">),</span> <span class="n">by</span><span class="o">=</span><span class="nf">.</span><span class="p">(</span><span class="n">acc</span><span class="p">)][</span><span class="n">train_ind</span><span class="o">==</span><span class="kc">FALSE</span><span class="p">,</span> <span class="n">cumpmts</span> <span class="o">:=</span> <span class="kc">NA</span><span class="p">]</span>

<span class="c1"># 8-period average</span>
<span class="n">cl_fac</span> <span class="o">&lt;-</span> <span class="nf">numeric</span><span class="p">(</span><span class="n">num_periods</span><span class="m">-1</span><span class="p">)</span> <span class="c1"># hold CL factors</span>

<span class="nf">for </span><span class="p">(</span><span class="n">j</span> <span class="n">in</span> <span class="m">1</span><span class="o">:</span><span class="n">num_periods</span><span class="m">-1</span><span class="p">){</span>

  <span class="n">cl_fac</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">&lt;-</span>
      <span class="n">dat</span><span class="p">[</span><span class="n">train_ind</span><span class="o">==</span><span class="kc">TRUE</span> <span class="o">&amp;</span> <span class="n">dev</span> <span class="o">==</span> <span class="p">(</span><span class="n">j</span><span class="m">+1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">acc</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">num_periods</span><span class="m">-8</span><span class="o">-</span><span class="n">j</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">acc</span> <span class="o">&lt;=</span> <span class="p">(</span><span class="n">num_periods</span><span class="o">-</span><span class="n">j</span><span class="p">),</span> <span class="nf">sum</span><span class="p">(</span><span class="n">cumpmts</span><span class="p">)]</span> <span class="o">/</span>
      <span class="n">dat</span><span class="p">[</span><span class="n">train_ind</span><span class="o">==</span><span class="kc">TRUE</span> <span class="o">&amp;</span> <span class="n">dev</span> <span class="o">==</span> <span class="p">(</span><span class="n">j</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">acc</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">num_periods</span><span class="m">-8</span><span class="o">-</span><span class="n">j</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">acc</span> <span class="o">&lt;=</span> <span class="p">(</span><span class="n">num_periods</span><span class="o">-</span><span class="n">j</span><span class="p">),</span> <span class="nf">sum</span><span class="p">(</span><span class="n">cumpmts</span><span class="p">)]</span>
<span class="p">}</span>

<span class="c1"># accumulate the CL factors</span>
<span class="n">cl_cum</span> <span class="o">&lt;-</span> <span class="nf">cumprod</span><span class="p">(</span><span class="nf">rev</span><span class="p">(</span><span class="n">cl_fac</span><span class="p">))</span>

<span class="c1"># leading diagonal for projection</span>
<span class="n">leading_diagonal</span> <span class="o">&lt;-</span> <span class="n">dat</span><span class="p">[</span><span class="n">train_ind</span><span class="o">==</span><span class="kc">TRUE</span> <span class="o">&amp;</span> <span class="n">cal</span> <span class="o">==</span> <span class="n">num_periods</span> <span class="o">&amp;</span> <span class="n">acc</span> <span class="o">&gt;</span> <span class="m">1</span><span class="p">,</span> <span class="n">cumpmts</span><span class="p">]</span>

<span class="c1"># CL amounts now</span>
<span class="n">cl_os</span> <span class="o">&lt;-</span> <span class="n">cl_cum</span> <span class="o">*</span> <span class="n">leading_diagonal</span> <span class="o">-</span> <span class="n">leading_diagonal</span>
</pre></div>
</div>
</div>
</div>
<p>We will attach these results to the data.tables holding the results from the LASSO.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">os_acc</span><span class="p">[,</span> <span class="n">Chainladder</span> <span class="o">:=</span> <span class="n">cl_os</span><span class="p">]</span>

<span class="n">os</span><span class="p">[,</span> <span class="n">Chainladder</span> <span class="o">:=</span> <span class="nf">sum</span><span class="p">(</span><span class="n">cl_os</span><span class="p">)]</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="results-by-accident-period">
<h3>Results by accident period<a class="headerlink" href="#results-by-accident-period" title="Permalink to this headline">¶</a></h3>
<p>Here’s a plot of the results (similar to that in the paper). Note that the y-axis is restricted for readability so that the actual chain ladder value (488 Bn) for accident period 40 does not display on the graph.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="c1"># make a long [tidy format] version of the data for use with ggplot2</span>
<span class="n">os_acc_long</span> <span class="o">&lt;-</span> <span class="nf">melt</span><span class="p">(</span><span class="n">os_acc</span><span class="p">,</span> <span class="n">id.vars</span> <span class="o">=</span> <span class="s">&quot;acc&quot;</span><span class="p">)</span>

<span class="c1"># divide by Bn to make numbers more readable</span>
<span class="n">os_acc_long</span><span class="p">[,</span> <span class="n">value</span> <span class="o">:=</span> <span class="n">value</span><span class="o">/</span><span class="m">1e9</span><span class="p">]</span>

<span class="n">os_plot</span> <span class="o">&lt;-</span>
	<span class="nf">ggplot</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">os_acc_long</span><span class="p">,</span> <span class="nf">aes</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">acc</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">value</span><span class="p">,</span> <span class="n">colour</span><span class="o">=</span><span class="n">variable</span><span class="p">,</span>
	                             <span class="n">linetype</span><span class="o">=</span><span class="n">variable</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">variable</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="n">variable</span><span class="p">))</span><span class="o">+</span>
	<span class="nf">geom_line</span><span class="p">()</span><span class="o">+</span>
 	<span class="nf">scale_linetype_manual</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&quot;&quot;</span><span class="p">,</span> <span class="n">values</span><span class="o">=</span><span class="nf">c</span><span class="p">(</span><span class="s">&quot;solid&quot;</span><span class="p">,</span> <span class="s">&quot;dashed&quot;</span><span class="p">,</span> <span class="s">&quot;dotted&quot;</span><span class="p">,</span> <span class="s">&quot;solid&quot;</span> <span class="p">))</span><span class="o">+</span>
 	<span class="nf">scale_colour_manual</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&quot;&quot;</span><span class="p">,</span> <span class="n">values</span><span class="o">=</span><span class="nf">c</span><span class="p">(</span><span class="n">red</span><span class="p">,</span> <span class="n">dgrey</span><span class="p">,</span> <span class="n">dgrey</span><span class="p">,</span> <span class="n">mblue</span> <span class="p">))</span><span class="o">+</span>
    <span class="nf">scale_size_manual</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&quot;&quot;</span><span class="p">,</span> <span class="n">values</span><span class="o">=</span><span class="nf">c</span><span class="p">(</span><span class="m">2</span><span class="p">,</span> <span class="m">1</span><span class="p">,</span> <span class="m">1</span><span class="p">,</span> <span class="m">1.5</span><span class="p">))</span><span class="o">+</span>
    <span class="nf">scale_alpha_manual</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&quot;&quot;</span><span class="p">,</span> <span class="n">values</span><span class="o">=</span><span class="nf">c</span><span class="p">(</span><span class="m">0.8</span><span class="p">,</span> <span class="m">0.5</span><span class="p">,</span> <span class="m">0.5</span><span class="p">,</span> <span class="m">0.8</span><span class="p">))</span><span class="o">+</span>
    <span class="nf">coord_cartesian</span><span class="p">(</span><span class="n">ylim</span><span class="o">=</span><span class="nf">c</span><span class="p">(</span><span class="m">0</span><span class="p">,</span> <span class="m">40</span><span class="p">))</span><span class="o">+</span>
	<span class="nf">theme_classic</span><span class="p">()</span><span class="o">+</span>
	<span class="nf">theme</span><span class="p">(</span><span class="n">legend.position</span><span class="o">=</span><span class="s">&quot;bottom&quot;</span><span class="p">,</span> <span class="n">legend.title</span><span class="o">=</span><span class="nf">element_blank</span><span class="p">())</span><span class="o">+</span>
 	<span class="nf">labs</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s">&quot;Accident quarter&quot;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s">&quot;Amount (B)&quot;</span><span class="p">)</span><span class="o">+</span>
    <span class="nf">annotate</span><span class="p">(</span><span class="n">geom</span><span class="o">=</span><span class="s">&quot;text&quot;</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="m">37</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="m">40</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s">&quot;488B-&gt;&quot;</span><span class="p">)</span><span class="o">+</span>
    <span class="nf">ggtitle</span><span class="p">(</span><span class="s">&quot;Outstanding amounts&quot;</span><span class="p">)</span>

<span class="n">os_plot</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/MLRWP_R_Lasso_81_0.png" src="../_images/MLRWP_R_Lasso_81_0.png" />
</div>
</div>
<p>You can see from the graph that - despite the presence of an interaction affecting only a small number of cells, the LASSO model detects and responds appropriately to this change. By contrast, the chainladder model does not perform so well.</p>
<p>The table below displays these results also.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">os_acc</span><span class="p">[,</span> <span class="nf">lapply</span><span class="p">(</span><span class="n">.SD</span><span class="p">,</span> <span class="nf">function</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="n">x</span><span class="o">/</span><span class="m">1e9</span><span class="p">)][,</span> <span class="n">acc</span> <span class="o">:=</span> <span class="n">acc</span><span class="o">*</span><span class="m">1e9</span><span class="p">]</span> <span class="o">%&gt;%</span>
    <span class="nf">kable</span><span class="p">(</span><span class="n">digits</span><span class="o">=</span><span class="m">2</span><span class="p">,</span> <span class="n">format.args</span> <span class="o">=</span> <span class="nf">list</span><span class="p">(</span><span class="n">big.mark</span> <span class="o">=</span> <span class="s">&quot;,&quot;</span><span class="p">,</span> <span class="n">scientific</span> <span class="o">=</span> <span class="kc">FALSE</span><span class="p">))</span> <span class="o">%&gt;%</span>
    <span class="nf">kable_styling</span><span class="p">(</span><span class="n">full_width</span><span class="o">=</span><span class="kc">FALSE</span><span class="p">,</span> <span class="n">bootstrap_options</span> <span class="o">=</span> <span class="nf">c</span><span class="p">(</span><span class="s">&quot;striped&quot;</span><span class="p">,</span> <span class="s">&quot;hover&quot;</span><span class="p">,</span> <span class="s">&quot;condensed&quot;</span><span class="p">))</span> <span class="o">%&gt;%</span>
    <span class="nf">as.character</span><span class="p">()</span> <span class="o">%&gt;%</span>
    <span class="nf">display_html</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><table class="table table-striped table-hover table-condensed" style="width: auto !important; margin-left: auto; margin-right: auto;">
 <thead>
  <tr>
   <th style="text-align:right;"> acc </th>
   <th style="text-align:right;"> LASSO </th>
   <th style="text-align:right;"> simulated </th>
   <th style="text-align:right;"> underlying </th>
   <th style="text-align:right;"> Chainladder </th>
  </tr>
 </thead>
<tbody>
  <tr>
   <td style="text-align:right;"> 2 </td>
   <td style="text-align:right;"> 0.02 </td>
   <td style="text-align:right;"> 0.00 </td>
   <td style="text-align:right;"> 0.00 </td>
   <td style="text-align:right;"> 0.00 </td>
  </tr>
  <tr>
   <td style="text-align:right;"> 3 </td>
   <td style="text-align:right;"> 0.05 </td>
   <td style="text-align:right;"> 0.01 </td>
   <td style="text-align:right;"> 0.00 </td>
   <td style="text-align:right;"> 0.06 </td>
  </tr>
  <tr>
   <td style="text-align:right;"> 4 </td>
   <td style="text-align:right;"> 0.07 </td>
   <td style="text-align:right;"> 0.01 </td>
   <td style="text-align:right;"> 0.01 </td>
   <td style="text-align:right;"> 0.07 </td>
  </tr>
  <tr>
   <td style="text-align:right;"> 5 </td>
   <td style="text-align:right;"> 0.09 </td>
   <td style="text-align:right;"> 0.01 </td>
   <td style="text-align:right;"> 0.02 </td>
   <td style="text-align:right;"> 0.10 </td>
  </tr>
  <tr>
   <td style="text-align:right;"> 6 </td>
   <td style="text-align:right;"> 0.10 </td>
   <td style="text-align:right;"> 0.03 </td>
   <td style="text-align:right;"> 0.02 </td>
   <td style="text-align:right;"> 0.09 </td>
  </tr>
  <tr>
   <td style="text-align:right;"> 7 </td>
   <td style="text-align:right;"> 0.12 </td>
   <td style="text-align:right;"> 0.02 </td>
   <td style="text-align:right;"> 0.04 </td>
   <td style="text-align:right;"> 0.12 </td>
  </tr>
  <tr>
   <td style="text-align:right;"> 8 </td>
   <td style="text-align:right;"> 0.15 </td>
   <td style="text-align:right;"> 0.07 </td>
   <td style="text-align:right;"> 0.05 </td>
   <td style="text-align:right;"> 0.16 </td>
  </tr>
  <tr>
   <td style="text-align:right;"> 9 </td>
   <td style="text-align:right;"> 0.18 </td>
   <td style="text-align:right;"> 0.08 </td>
   <td style="text-align:right;"> 0.08 </td>
   <td style="text-align:right;"> 0.19 </td>
  </tr>
  <tr>
   <td style="text-align:right;"> 10 </td>
   <td style="text-align:right;"> 0.22 </td>
   <td style="text-align:right;"> 0.17 </td>
   <td style="text-align:right;"> 0.11 </td>
   <td style="text-align:right;"> 0.23 </td>
  </tr>
  <tr>
   <td style="text-align:right;"> 11 </td>
   <td style="text-align:right;"> 0.27 </td>
   <td style="text-align:right;"> 0.16 </td>
   <td style="text-align:right;"> 0.15 </td>
   <td style="text-align:right;"> 0.30 </td>
  </tr>
  <tr>
   <td style="text-align:right;"> 12 </td>
   <td style="text-align:right;"> 0.34 </td>
   <td style="text-align:right;"> 0.21 </td>
   <td style="text-align:right;"> 0.21 </td>
   <td style="text-align:right;"> 0.34 </td>
  </tr>
  <tr>
   <td style="text-align:right;"> 13 </td>
   <td style="text-align:right;"> 0.43 </td>
   <td style="text-align:right;"> 0.31 </td>
   <td style="text-align:right;"> 0.29 </td>
   <td style="text-align:right;"> 0.46 </td>
  </tr>
  <tr>
   <td style="text-align:right;"> 14 </td>
   <td style="text-align:right;"> 0.56 </td>
   <td style="text-align:right;"> 0.46 </td>
   <td style="text-align:right;"> 0.40 </td>
   <td style="text-align:right;"> 0.61 </td>
  </tr>
  <tr>
   <td style="text-align:right;"> 15 </td>
   <td style="text-align:right;"> 0.72 </td>
   <td style="text-align:right;"> 0.52 </td>
   <td style="text-align:right;"> 0.54 </td>
   <td style="text-align:right;"> 0.74 </td>
  </tr>
  <tr>
   <td style="text-align:right;"> 16 </td>
   <td style="text-align:right;"> 0.98 </td>
   <td style="text-align:right;"> 0.76 </td>
   <td style="text-align:right;"> 0.81 </td>
   <td style="text-align:right;"> 1.05 </td>
  </tr>
  <tr>
   <td style="text-align:right;"> 17 </td>
   <td style="text-align:right;"> 7.03 </td>
   <td style="text-align:right;"> 5.25 </td>
   <td style="text-align:right;"> 5.31 </td>
   <td style="text-align:right;"> 2.49 </td>
  </tr>
  <tr>
   <td style="text-align:right;"> 18 </td>
   <td style="text-align:right;"> 11.05 </td>
   <td style="text-align:right;"> 8.13 </td>
   <td style="text-align:right;"> 8.17 </td>
   <td style="text-align:right;"> 3.87 </td>
  </tr>
  <tr>
   <td style="text-align:right;"> 19 </td>
   <td style="text-align:right;"> 15.64 </td>
   <td style="text-align:right;"> 12.62 </td>
   <td style="text-align:right;"> 12.49 </td>
   <td style="text-align:right;"> 5.99 </td>
  </tr>
  <tr>
   <td style="text-align:right;"> 20 </td>
   <td style="text-align:right;"> 19.90 </td>
   <td style="text-align:right;"> 19.18 </td>
   <td style="text-align:right;"> 18.93 </td>
   <td style="text-align:right;"> 8.98 </td>
  </tr>
  <tr>
   <td style="text-align:right;"> 21 </td>
   <td style="text-align:right;"> 24.10 </td>
   <td style="text-align:right;"> 22.76 </td>
   <td style="text-align:right;"> 23.29 </td>
   <td style="text-align:right;"> 11.68 </td>
  </tr>
  <tr>
   <td style="text-align:right;"> 22 </td>
   <td style="text-align:right;"> 25.21 </td>
   <td style="text-align:right;"> 24.22 </td>
   <td style="text-align:right;"> 24.06 </td>
   <td style="text-align:right;"> 12.80 </td>
  </tr>
  <tr>
   <td style="text-align:right;"> 23 </td>
   <td style="text-align:right;"> 26.36 </td>
   <td style="text-align:right;"> 25.50 </td>
   <td style="text-align:right;"> 24.92 </td>
   <td style="text-align:right;"> 14.16 </td>
  </tr>
  <tr>
   <td style="text-align:right;"> 24 </td>
   <td style="text-align:right;"> 25.48 </td>
   <td style="text-align:right;"> 25.69 </td>
   <td style="text-align:right;"> 25.87 </td>
   <td style="text-align:right;"> 13.74 </td>
  </tr>
  <tr>
   <td style="text-align:right;"> 25 </td>
   <td style="text-align:right;"> 27.86 </td>
   <td style="text-align:right;"> 26.97 </td>
   <td style="text-align:right;"> 26.90 </td>
   <td style="text-align:right;"> 16.17 </td>
  </tr>
  <tr>
   <td style="text-align:right;"> 26 </td>
   <td style="text-align:right;"> 27.90 </td>
   <td style="text-align:right;"> 28.46 </td>
   <td style="text-align:right;"> 28.01 </td>
   <td style="text-align:right;"> 16.38 </td>
  </tr>
  <tr>
   <td style="text-align:right;"> 27 </td>
   <td style="text-align:right;"> 28.89 </td>
   <td style="text-align:right;"> 29.18 </td>
   <td style="text-align:right;"> 29.18 </td>
   <td style="text-align:right;"> 17.82 </td>
  </tr>
  <tr>
   <td style="text-align:right;"> 28 </td>
   <td style="text-align:right;"> 29.89 </td>
   <td style="text-align:right;"> 29.57 </td>
   <td style="text-align:right;"> 30.39 </td>
   <td style="text-align:right;"> 18.89 </td>
  </tr>
  <tr>
   <td style="text-align:right;"> 29 </td>
   <td style="text-align:right;"> 30.90 </td>
   <td style="text-align:right;"> 32.03 </td>
   <td style="text-align:right;"> 31.62 </td>
   <td style="text-align:right;"> 20.09 </td>
  </tr>
  <tr>
   <td style="text-align:right;"> 30 </td>
   <td style="text-align:right;"> 31.90 </td>
   <td style="text-align:right;"> 33.17 </td>
   <td style="text-align:right;"> 32.83 </td>
   <td style="text-align:right;"> 21.99 </td>
  </tr>
  <tr>
   <td style="text-align:right;"> 31 </td>
   <td style="text-align:right;"> 30.58 </td>
   <td style="text-align:right;"> 32.31 </td>
   <td style="text-align:right;"> 32.33 </td>
   <td style="text-align:right;"> 21.16 </td>
  </tr>
  <tr>
   <td style="text-align:right;"> 32 </td>
   <td style="text-align:right;"> 29.19 </td>
   <td style="text-align:right;"> 31.28 </td>
   <td style="text-align:right;"> 31.72 </td>
   <td style="text-align:right;"> 21.39 </td>
  </tr>
  <tr>
   <td style="text-align:right;"> 33 </td>
   <td style="text-align:right;"> 27.74 </td>
   <td style="text-align:right;"> 31.10 </td>
   <td style="text-align:right;"> 30.98 </td>
   <td style="text-align:right;"> 19.42 </td>
  </tr>
  <tr>
   <td style="text-align:right;"> 34 </td>
   <td style="text-align:right;"> 27.62 </td>
   <td style="text-align:right;"> 29.77 </td>
   <td style="text-align:right;"> 30.12 </td>
   <td style="text-align:right;"> 19.59 </td>
  </tr>
  <tr>
   <td style="text-align:right;"> 35 </td>
   <td style="text-align:right;"> 27.34 </td>
   <td style="text-align:right;"> 29.49 </td>
   <td style="text-align:right;"> 29.13 </td>
   <td style="text-align:right;"> 22.05 </td>
  </tr>
  <tr>
   <td style="text-align:right;"> 36 </td>
   <td style="text-align:right;"> 26.93 </td>
   <td style="text-align:right;"> 28.36 </td>
   <td style="text-align:right;"> 28.04 </td>
   <td style="text-align:right;"> 21.28 </td>
  </tr>
  <tr>
   <td style="text-align:right;"> 37 </td>
   <td style="text-align:right;"> 26.41 </td>
   <td style="text-align:right;"> 26.83 </td>
   <td style="text-align:right;"> 26.87 </td>
   <td style="text-align:right;"> 17.47 </td>
  </tr>
  <tr>
   <td style="text-align:right;"> 38 </td>
   <td style="text-align:right;"> 25.80 </td>
   <td style="text-align:right;"> 25.85 </td>
   <td style="text-align:right;"> 25.66 </td>
   <td style="text-align:right;"> 21.60 </td>
  </tr>
  <tr>
   <td style="text-align:right;"> 39 </td>
   <td style="text-align:right;"> 25.15 </td>
   <td style="text-align:right;"> 24.63 </td>
   <td style="text-align:right;"> 24.45 </td>
   <td style="text-align:right;"> 13.97 </td>
  </tr>
  <tr>
   <td style="text-align:right;"> 40 </td>
   <td style="text-align:right;"> 24.48 </td>
   <td style="text-align:right;"> 23.32 </td>
   <td style="text-align:right;"> 23.26 </td>
   <td style="text-align:right;"> 488.32 </td>
  </tr>
</tbody>
</table></div></div>
</div>
</div>
<div class="section" id="total-reserves">
<h3>Total reserves<a class="headerlink" href="#total-reserves" title="Permalink to this headline">¶</a></h3>
<p>The overall reserve values (in units of B) are</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">os</span><span class="p">[,</span> <span class="nf">lapply</span><span class="p">(</span><span class="n">.SD</span><span class="p">,</span> <span class="nf">function</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="n">x</span><span class="o">/</span><span class="m">1e9</span><span class="p">)]</span> <span class="o">%&gt;%</span>
    <span class="nf">kable</span><span class="p">(</span><span class="n">digits</span><span class="o">=</span><span class="m">1</span><span class="p">,</span> <span class="n">format.args</span> <span class="o">=</span> <span class="nf">list</span><span class="p">(</span><span class="n">big.mark</span> <span class="o">=</span> <span class="s">&quot;,&quot;</span><span class="p">,</span> <span class="n">scientific</span> <span class="o">=</span> <span class="kc">FALSE</span><span class="p">))</span> <span class="o">%&gt;%</span>
    <span class="nf">kable_styling</span><span class="p">(</span><span class="n">full_width</span><span class="o">=</span><span class="kc">FALSE</span><span class="p">,</span> <span class="n">bootstrap_options</span> <span class="o">=</span> <span class="nf">c</span><span class="p">(</span><span class="s">&quot;striped&quot;</span><span class="p">,</span> <span class="s">&quot;hover&quot;</span><span class="p">,</span> <span class="s">&quot;condensed&quot;</span><span class="p">))</span>  <span class="o">%&gt;%</span>
    <span class="nf">as.character</span><span class="p">()</span> <span class="o">%&gt;%</span>
    <span class="nf">display_html</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><table class="table table-striped table-hover table-condensed" style="width: auto !important; margin-left: auto; margin-right: auto;">
 <thead>
  <tr>
   <th style="text-align:right;"> LASSO </th>
   <th style="text-align:right;"> simulated </th>
   <th style="text-align:right;"> underlying </th>
   <th style="text-align:right;"> Chainladder </th>
  </tr>
 </thead>
<tbody>
  <tr>
   <td style="text-align:right;"> 607.7 </td>
   <td style="text-align:right;"> 608.5 </td>
   <td style="text-align:right;"> 607.3 </td>
   <td style="text-align:right;"> 855.8 </td>
  </tr>
</tbody>
</table></div></div>
</div>
</div>
<div class="section" id="commentary">
<h3>Commentary<a class="headerlink" href="#commentary" title="Permalink to this headline">¶</a></h3>
<p>In practice, no actuary would fit the 8-period chainladder (or any other estimating period) without significant review and likely modification based on actuarial judgement. So in an example like this, the gains from a method like the LASSO will not be as large as suggested by the results above. Furthermore, the large step change in this data set would likely result from something like a legislative change that the actuary should know about and be able to estimate its effect and then incorporate this into any projection.</p>
<p>Nonetheless, there is benefit from the raw or naive model projection being closer to what we might want to project and in that sense, the LASSO model clearly outperforms the chainladder.</p>
</div>
</div>
</div>
<div class="tex2jax_ignore mathjax_ignore section" id="conclusion">
<h1>Conclusion<a class="headerlink" href="#conclusion" title="Permalink to this headline">¶</a></h1>
<p>The aim of this article has been to demonstrate the fitting of a claims reserving model using a LASSO approach in R and to produce some of the model diagnostic and results output that a user might wish to examine. If you would like to experiment some more, you could try modifying the synthetic data set code to produce other types of simulated data (such as those in our paper), or try it out on a real data example.</p>
</div>
<div class="tex2jax_ignore mathjax_ignore section" id="session-information">
<h1>Session information<a class="headerlink" href="#session-information" title="Permalink to this headline">¶</a></h1>
<p>To assist with reproducibility, here are the details of R session used to run the code.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="nf">sessionInfo</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>R version 4.1.0 (2021-05-18)
Platform: x86_64-apple-darwin17.0 (64-bit)
Running under: macOS High Sierra 10.13.6

Matrix products: default
BLAS:   /Library/Frameworks/R.framework/Versions/4.1/Resources/lib/libRblas.dylib
LAPACK: /Library/Frameworks/R.framework/Versions/4.1/Resources/lib/libRlapack.dylib

locale:
[1] en_AU.UTF-8/en_AU.UTF-8/en_AU.UTF-8/C/en_AU.UTF-8/en_AU.UTF-8

attached base packages:
[1] stats     graphics  grDevices utils     datasets  methods   base     

other attached packages:
[1] magrittr_2.0.1    kableExtra_1.3.4  glmnet_4.1-1      Matrix_1.3-3     
[5] IRdisplay_1.0     patchwork_1.1.1   ggplot2_3.3.4     data.table_1.14.0

loaded via a namespace (and not attached):
 [1] pbdZMQ_0.3-5      shape_1.4.6       tidyselect_1.1.1  xfun_0.23        
 [5] repr_1.1.3        purrr_0.3.4       splines_4.1.0     lattice_0.20-44  
 [9] colorspace_2.0-1  vctrs_0.3.8       generics_0.1.0    viridisLite_0.4.0
[13] htmltools_0.5.1.1 base64enc_0.1-3   utf8_1.2.1        survival_3.2-11  
[17] rlang_0.4.11      pillar_1.6.1      glue_1.4.2        withr_2.4.2      
[21] DBI_1.1.1         uuid_0.1-4        foreach_1.5.1     lifecycle_1.0.0  
[25] stringr_1.4.0     munsell_0.5.0     gtable_0.3.0      rvest_1.0.0      
[29] codetools_0.2-18  evaluate_0.14     labeling_0.4.2    knitr_1.33       
[33] fansi_0.5.0       highr_0.9         scales_1.1.1      IRkernel_1.2     
[37] webshot_0.5.2     jsonlite_1.7.2    systemfonts_1.0.2 farver_2.1.0     
[41] digest_0.6.27     stringi_1.6.2     dplyr_1.0.7       grid_4.1.0       
[45] tools_4.1.0       tibble_3.1.2      crayon_1.4.1      pkgconfig_2.0.3  
[49] ellipsis_0.3.2    xml2_1.3.2        svglite_2.0.0     assertthat_0.2.1 
[53] rmarkdown_2.9     httr_1.4.2        rstudioapi_0.13   iterators_1.0.13 
[57] R6_2.5.0          compiler_4.1.0   
</pre></div>
</div>
</div>
</div>
</div>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "ActuariesInstitute/cookbook",
            ref: "main",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "r"
        },
        kernelOptions: {
            kernelName: "ir",
            path: "./docs"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'ir'</script>

              </div>
              
            
                <!-- Previous / next buttons -->
<div class='prev-next-area'> 
    <a class='left-prev' id="prev-link" href="MLRWP_R_GLMs.html" title="previous page">
        <i class="fas fa-angle-left"></i>
        <div class="prev-next-info">
            <p class="prev-next-subtitle">previous</p>
            <p class="prev-next-title">R: Reserving with GLMs</p>
        </div>
    </a>
    <a class='right-next' id="next-link" href="MLRWP_R_mlr3.html" title="next page">
    <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">R: Machine Learning Triangles</p>
    </div>
    <i class="fas fa-angle-right"></i>
    </a>
</div>
            
        </div>
    </div>
    <footer class="footer">
  <p>
    
      By YDAWG, DAPC, YAC and other contributors.<br/>
    
      <div class="extra_footer">
         The Actuaries' Analytical Cookbook is a series of data and analytics recipes to help actuaries quickly get started with a new project.   This site is intended to be a resource to actuaries in both data science and traditional fields.  Opinions expressed in this publication are the opinions of contributors and do not necessarily represent those of either the Institute of Actuaries of Australia (the ‘Institute’), its members, directors, officers, employees, agents, or that of the employers of the contributors. <br>© Institute of Actuaries of Australia and Contributors 2021. All rights reserved.
      </div>
  </p>
</footer>
</main>


      </div>
    </div>
  
  <script src="../_static/js/index.be7d3bbb2ef33a8344ce.js"></script>

  </body>
</html>