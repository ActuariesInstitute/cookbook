
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>R: Machine Learning Triangles &#8212; Actuaries&#39; Analytical Cookbook</title>
    
  <link href="../_static/css/theme.css" rel="stylesheet">
  <link href="../_static/css/index.ff1ffe594081f20da1ef19478df9384b.css" rel="stylesheet">

    
  <link rel="stylesheet"
    href="../_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    
      

    
    <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-book-theme.css?digest=c3fdc42140077d1ad13ad2f1588a4309" />
    <link rel="stylesheet" type="text/css" href="../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/mystnb.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="../_static/panels-main.c949a650a448cc0ae9fd3441c0e17fb0.css" />
    <link rel="stylesheet" type="text/css" href="../_static/panels-variables.06eb56fa6e07937060861dad626602ad.css" />
    
  <link rel="preload" as="script" href="../_static/js/index.be7d3bbb2ef33a8344ce.js">

    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/togglebutton.js"></script>
    <script src="../_static/clipboard.min.js"></script>
    <script src="../_static/copybutton.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
    <script src="../_static/sphinx-book-theme.d59cb220de22ca1c485ebbdc042f0030.js"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"
const thebe_selector = ".thebe,.cell"
const thebe_selector_input = "pre"
const thebe_selector_output = ".output, .cell_output"
</script>
    <script async="async" src="../_static/sphinx-thebe.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Py: Machine Learning Triangles" href="MLRWP_Py_triangles_example.html" />
    <link rel="prev" title="R: Reserving with LASSO" href="MLRWP_R_Lasso.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="None">
    

    <!-- Google Analytics -->
    
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="80">
    
    <div class="container-fluid" id="banner"></div>

    

    <div class="container-xl">
      <div class="row">
          
<div class="col-12 col-md-3 bd-sidebar site-navigation show" id="site-navigation">
    
        <div class="navbar-brand-box">
    <a class="navbar-brand text-wrap" href="../index.html">
      
        <!-- `logo` is deprecated in Sphinx 4.0, so remove this when we stop supporting 3 -->
        
      
      
      <img src="../_static/actuaries-logo.svg" class="logo" alt="logo">
      
      
      <h1 class="site-logo" id="site-title">Actuaries' Analytical Cookbook</h1>
      
    </a>
</div><form class="bd-search d-flex align-items-center" action="../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search this book..." aria-label="Search this book..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item active">
        <p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Introduction to Python
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="about_py.html">
   About Python
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="getting_started.html">
   Setting up Your Python Environment
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="python_by_example.html">
   An Introductory Example
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="learn_more.html">
   Learn More
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="Useful_Python_packages.html">
   Useful Python packages for Data Science
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Introduction to R
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="about_R.html">
   About R
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="getting_started_R.html">
   Setting Up R
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="introductory_R.html">
   Introduction to R
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="intermediate_R.html">
   Next Steps With R
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="top_ten_r_packages.html">
   Useful Packages
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="MLRWP_R_DataTable.html">
   R: data.table for actuaries
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Workflow Management
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="version_control.html">
   Version control
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Regression, Classification and Technical Price
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="DAA_M05_CS1.html">
   Py: Customer Churn Classification
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="multitasking_risk_pricing.html">
   Py/R: Multitasking Risk Pricing Using Deep Learning
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="py_shap_values.html">
   Py: Explainable Models with SHAP
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Life Insurance
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="LifeRecipeBook.html">
   R: Life Modelling Recipes
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="life_stats.html">
   R: Life Industry Stats in Tableau and R
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  General Insurance
 </span>
</p>
<ul class="current nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="MLRWP_R_GLMs.html">
   R: Reserving with GLMs
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="MLRWP_R_Lasso.html">
   R: Reserving with LASSO
  </a>
 </li>
 <li class="toctree-l1 current active">
  <a class="current reference internal" href="#">
   R: Machine Learning Triangles
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="MLRWP_Py_triangles_example.html">
   Py: Machine Learning Triangles
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Unsupervised Learning
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="DAA_M06_CS1.html">
   Py: Socio-Economic Index Construction
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="DAA_M06_CS2.html">
   Py: Clustering Credit Card Fraud
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="DAA_M06_Ex4.html">
   Py: K-means clustering of COVID dataset
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="DAA_M06_Ex5.html">
   Py: Hierarchical clustering on COVID dataset
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Natural Language Processing
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="R_case_study_word_cloud.html">
   R: Word Cloud Case Study
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="textClassificationEntry.html">
   Py: Text Classification
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="DAA_M05_Ex10.html">
   Py: Decision Tree Classification
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="DAA_M05_Ex18.html">
   Py: Neural Net Classification
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="DAA_M07_CS1.html">
   Py: Classifying review sentiment
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="DAA_M07_CS2.html">
   Py: Customer Sentiment Analysis
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Business Optimization
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="DAA_2021_S2_Tutorial10_exercise_scipy.html">
   Py: Linear Programming
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Image Recognition
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="DAA_M05_CS2.html">
   Py: Image Recognition
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Data Ethics
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="automated_decision.html">
   Automated Decision-Making Systems
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Contributing
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="contributing.html">
   Contributing
  </a>
 </li>
</ul>

    </div>
</nav> <!-- To handle the deprecated key -->

<div class="navbar_extra_footer">
  Powered by <a href="https://jupyterbook.org">Jupyter Book</a>
</div>

</div>


          


          
<main class="col py-md-3 pl-md-4 bd-content overflow-auto" role="main">
    
    <div class="topbar container-xl fixed-top">
    <div class="topbar-contents row">
        <div class="col-12 col-md-3 bd-topbar-whitespace site-navigation show"></div>
        <div class="col pl-md-4 topbar-main">
            
            <button id="navbar-toggler" class="navbar-toggler ml-0" type="button" data-toggle="collapse"
                data-toggle="tooltip" data-placement="bottom" data-target=".site-navigation" aria-controls="navbar-menu"
                aria-expanded="true" aria-label="Toggle navigation" aria-controls="site-navigation"
                title="Toggle navigation" data-toggle="tooltip" data-placement="left">
                <i class="fas fa-bars"></i>
                <i class="fas fa-arrow-left"></i>
                <i class="fas fa-arrow-up"></i>
            </button>
            
            
<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn" aria-label="Download this page"><i
            class="fas fa-download"></i></button>

    <div class="dropdown-buttons">
        <!-- ipynb file if we had a myst markdown file -->
        
        <!-- Download raw file -->
        <a class="dropdown-buttons" href="../_sources/docs/MLRWP_R_mlr3.ipynb"><button type="button"
                class="btn btn-secondary topbarbtn" title="Download source file" data-toggle="tooltip"
                data-placement="left">.ipynb</button></a>
        <!-- Download PDF via print -->
        <button type="button" id="download-print" class="btn btn-secondary topbarbtn" title="Print to PDF"
                onclick="printPdf(this)" data-toggle="tooltip" data-placement="left">.pdf</button>
    </div>
</div>

            <!-- Source interaction buttons -->

<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn"
        aria-label="Connect with source repository"><i class="fab fa-github"></i></button>
    <div class="dropdown-buttons sourcebuttons">
        <a class="repository-button"
            href="https://github.com/ActuariesInstitute/cookbook"><button type="button" class="btn btn-secondary topbarbtn"
                data-toggle="tooltip" data-placement="left" title="Source repository"><i
                    class="fab fa-github"></i>repository</button></a>
        
        <a class="edit-button" href="https://github.com/ActuariesInstitute/cookbook/edit/main/cookbook/docs/MLRWP_R_mlr3.ipynb"><button
                type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip" data-placement="left"
                title="Edit this page"><i class="fas fa-pencil-alt"></i>suggest edit</button></a>
    </div>
</div>

            <!-- Full screen (wrap in <a> to have style consistency -->

<a class="full-screen-button"><button type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip"
        data-placement="bottom" onclick="toggleFullScreen()" aria-label="Fullscreen mode"
        title="Fullscreen mode"><i
            class="fas fa-expand"></i></button></a>

            <!-- Launch buttons -->

<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn"
        aria-label="Launch interactive content"><i class="fas fa-rocket"></i></button>
    <div class="dropdown-buttons">
        
        <a class="binder-button" href="https://mybinder.org/v2/gh/ActuariesInstitute/cookbook/main?urlpath=tree/cookbook/docs/MLRWP_R_mlr3.ipynb"><button type="button"
                class="btn btn-secondary topbarbtn" title="Launch Binder" data-toggle="tooltip"
                data-placement="left"><img class="binder-button-logo"
                    src="../_static/images/logo_binder.svg"
                    alt="Interact on binder">Binder</button></a>
        
        
        
        <a class="colab-button" href="https://colab.research.google.com/github/ActuariesInstitute/cookbook/blob/main/cookbook/docs/MLRWP_R_mlr3.ipynb"><button type="button" class="btn btn-secondary topbarbtn"
                title="Launch Colab" data-toggle="tooltip" data-placement="left"><img class="colab-button-logo"
                    src="../_static/images/logo_colab.png"
                    alt="Interact on Colab">Colab</button></a>
        
        <button type="button" class="btn btn-secondary topbarbtn"
            onclick="initThebeSBT()" title="Launch Thebe" data-toggle="tooltip" data-placement="left"><i
                class="fas fa-play"></i><span style="margin-left: .4em;">Live Code</span></button>
        
    </div>
</div>

        </div>

        <!-- Table of contents -->
        <div class="d-none d-md-block col-md-2 bd-toc show noprint">
            
            <div class="tocsection onthispage pt-5 pb-3">
                <i class="fas fa-list"></i> Contents
            </div>
            <nav id="bd-toc-nav" aria-label="Page">
                <ul class="visible nav section-nav flex-column">
 <li class="toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="#">
   R: Machine Learning Triangles
  </a>
 </li>
 <li class="toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="#introduction">
   Introduction
  </a>
  <ul class="visible nav section-nav flex-column">
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#who-is-this-article-aimed-at">
     Who is this article aimed at?
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#pre-requisites-to-this-article">
     Pre-requisites to this article
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#the-data-set">
     The data set
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#machine-learning-and-aggregate-triangles">
     Machine learning and aggregate triangles
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#don-t-rank-the-ml-models-used-based-on-this-example">
     Don’t rank the ML models used based on this example
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#mlr3-package">
     mlr3 package
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#ml-methods-used">
     ML methods used
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="#outline-of-the-workflow">
   Outline of the workflow
  </a>
 </li>
 <li class="toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="#setup">
   Setup
  </a>
 </li>
 <li class="toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="#data-preparation">
   Data preparation
  </a>
  <ul class="visible nav section-nav flex-column">
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#data-table-package">
     data.table package
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#load-the-data">
     Load the data
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#create-a-mlr3-task">
     Create a mlr3 task
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="#tuning-process-for-hyper-parameters">
   Tuning process for hyper-parameters
  </a>
  <ul class="visible nav section-nav flex-column">
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#cross-validation">
     Cross-validation
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#setting-up-cross-validation-in-mlr3">
     Setting up cross-validation in mlr3
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#performance-measure">
     Performance measure
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#searching-hyper-parameter-space">
     Searching hyper-parameter space
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="#fitting-some-ml-models">
   Fitting some ML models
  </a>
  <ul class="visible nav section-nav flex-column">
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#decision-tree">
     Decision tree
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#fitting-a-single-model">
       Fitting a single model
      </a>
     </li>
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#tuning-the-decision-tree">
       Tuning the decision tree
      </a>
     </li>
    </ul>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#random-forest-fitting">
     Random forest fitting
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#xgboost">
     XGBoost
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#consolidate-results">
     Consolidate results
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#chainladder-the-baseline-model">
     Chainladder - the baseline model
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#getting-the-chainladder-reserve-estimates">
       Getting the Chainladder reserve estimates
      </a>
     </li>
    </ul>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#lasso-regularised-regression">
     LASSO (regularised regression)
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#basis-functions">
       Basis functions
      </a>
     </li>
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#mlr3-setup-for-lasso">
       mlr3 setup for LASSO
      </a>
     </li>
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#model-fitting">
       Model fitting
      </a>
     </li>
    </ul>
   </li>
  </ul>
 </li>
 <li class="toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="#model-analysis">
   Model analysis
  </a>
  <ul class="visible nav section-nav flex-column">
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#rmse">
     RMSE
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#visualising-the-fit">
     Visualising the fit
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#fitted-values">
       Fitted values
      </a>
     </li>
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#actual-vs-fitted-heat-maps">
       Actual vs Fitted heat maps
      </a>
     </li>
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#quarterly-tracking">
       Quarterly tracking
      </a>
     </li>
    </ul>
   </li>
  </ul>
 </li>
 <li class="toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="#reserves">
   Reserves
  </a>
 </li>
 <li class="toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="#commentary">
   Commentary
  </a>
 </li>
 <li class="toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="#conclusion">
   Conclusion
  </a>
  <ul class="visible nav section-nav flex-column">
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#what-next">
     What next?
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="#session-details">
   Session details
  </a>
 </li>
</ul>

            </nav>
        </div>
    </div>
</div>
    <div id="main-content" class="row">
        <div class="col-12 col-md-9 pl-md-3 pr-md-0">
            <!-- Table of contents that is only displayed when printing the page -->
            <div id="jb-print-docs-body" class="onlyprint">
                <h1>R: Machine Learning Triangles</h1>
                <!-- Table of contents -->
                <div id="print-main-content">
                    <div id="jb-print-toc">
                        
                        <div>
                            <h2> Contents </h2>
                        </div>
                        <nav aria-label="Page">
                            <ul class="visible nav section-nav flex-column">
 <li class="toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="#">
   R: Machine Learning Triangles
  </a>
 </li>
 <li class="toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="#introduction">
   Introduction
  </a>
  <ul class="visible nav section-nav flex-column">
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#who-is-this-article-aimed-at">
     Who is this article aimed at?
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#pre-requisites-to-this-article">
     Pre-requisites to this article
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#the-data-set">
     The data set
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#machine-learning-and-aggregate-triangles">
     Machine learning and aggregate triangles
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#don-t-rank-the-ml-models-used-based-on-this-example">
     Don’t rank the ML models used based on this example
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#mlr3-package">
     mlr3 package
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#ml-methods-used">
     ML methods used
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="#outline-of-the-workflow">
   Outline of the workflow
  </a>
 </li>
 <li class="toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="#setup">
   Setup
  </a>
 </li>
 <li class="toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="#data-preparation">
   Data preparation
  </a>
  <ul class="visible nav section-nav flex-column">
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#data-table-package">
     data.table package
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#load-the-data">
     Load the data
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#create-a-mlr3-task">
     Create a mlr3 task
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="#tuning-process-for-hyper-parameters">
   Tuning process for hyper-parameters
  </a>
  <ul class="visible nav section-nav flex-column">
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#cross-validation">
     Cross-validation
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#setting-up-cross-validation-in-mlr3">
     Setting up cross-validation in mlr3
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#performance-measure">
     Performance measure
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#searching-hyper-parameter-space">
     Searching hyper-parameter space
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="#fitting-some-ml-models">
   Fitting some ML models
  </a>
  <ul class="visible nav section-nav flex-column">
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#decision-tree">
     Decision tree
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#fitting-a-single-model">
       Fitting a single model
      </a>
     </li>
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#tuning-the-decision-tree">
       Tuning the decision tree
      </a>
     </li>
    </ul>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#random-forest-fitting">
     Random forest fitting
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#xgboost">
     XGBoost
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#consolidate-results">
     Consolidate results
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#chainladder-the-baseline-model">
     Chainladder - the baseline model
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#getting-the-chainladder-reserve-estimates">
       Getting the Chainladder reserve estimates
      </a>
     </li>
    </ul>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#lasso-regularised-regression">
     LASSO (regularised regression)
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#basis-functions">
       Basis functions
      </a>
     </li>
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#mlr3-setup-for-lasso">
       mlr3 setup for LASSO
      </a>
     </li>
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#model-fitting">
       Model fitting
      </a>
     </li>
    </ul>
   </li>
  </ul>
 </li>
 <li class="toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="#model-analysis">
   Model analysis
  </a>
  <ul class="visible nav section-nav flex-column">
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#rmse">
     RMSE
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#visualising-the-fit">
     Visualising the fit
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#fitted-values">
       Fitted values
      </a>
     </li>
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#actual-vs-fitted-heat-maps">
       Actual vs Fitted heat maps
      </a>
     </li>
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#quarterly-tracking">
       Quarterly tracking
      </a>
     </li>
    </ul>
   </li>
  </ul>
 </li>
 <li class="toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="#reserves">
   Reserves
  </a>
 </li>
 <li class="toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="#commentary">
   Commentary
  </a>
 </li>
 <li class="toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="#conclusion">
   Conclusion
  </a>
  <ul class="visible nav section-nav flex-column">
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#what-next">
     What next?
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="#session-details">
   Session details
  </a>
 </li>
</ul>

                        </nav>
                    </div>
                </div>
            </div>
            
              <div>
                
  <div class="tex2jax_ignore mathjax_ignore section" id="r-machine-learning-triangles">
<h1>R: Machine Learning Triangles<a class="headerlink" href="#r-machine-learning-triangles" title="Permalink to this headline">¶</a></h1>
<p><em>This article was originally created by Grainne McGuire and Jacky Poon and published in the <a class="reference external" href="https://institute-and-faculty-of-actuaries.github.io/mlr-blog/">General Insurance Machine Learning for Reserving Working Party (“MLR-WP”) blog</a>. The MLR-WP is an international research group on machine learning techniques to reserving, with over 50 actuaries from around the globe. The goal of the group is to bring machine learning techniques into widespread adoption ‘on the ground’ by identifying what the barriers are, communicating any benefits, and helping develop the research techniques in pragmatic ways. Whilst some articles have been brought into this cookbook, consider exploring the <a class="reference external" href="https://institute-and-faculty-of-actuaries.github.io/mlr-blog/">blog</a> further for additional content including detailed walkthroughs of more advanced models.</em></p>
</div>
<div class="tex2jax_ignore mathjax_ignore section" id="introduction">
<h1>Introduction<a class="headerlink" href="#introduction" title="Permalink to this headline">¶</a></h1>
<p>In this article we look at applying different machine learning (ML) models to a data set.
Our goal is to illustrate a work flow for:</p>
<ul class="simple">
<li><p>setting up a data set for ML</p></li>
<li><p>applying different ML models to this data</p></li>
<li><p>tuning the ML hyper-parameters</p></li>
<li><p>comparing and contrasting performance for the past fitted values and the future predictions.</p></li>
</ul>
<p>A secondary goal is to demonstrate the utility of a multi-model machine learning framework which enables the user to easily “plug and play” different machine learning models within the same framework. We use the <strong>mlr3</strong> set of packages in R here - this and other similar packages in R (e.g. <strong>caret</strong> and <strong>tidymodels</strong>) and tools in <strong>scikit-learn</strong> in python may be useful in creating a smoother work flow.</p>
<p>A [notebook version of this article](/mlr-blog/f_notebooks/ML modelling on triangles - a worked example.html) is also available which may be helpful if you want to experiment with this code.</p>
<div class="section" id="who-is-this-article-aimed-at">
<h2>Who is this article aimed at?<a class="headerlink" href="#who-is-this-article-aimed-at" title="Permalink to this headline">¶</a></h2>
<p>This article is aimed at those who know a little about some of the standard machine learning models, but who may not have done much hands-on work with an analysis. It will also be useful for those who have done some experimentation, but maybe not on a reserving data set. Finally, it may also be of interest to R users who have never used a multi-model framework before and who would like to see how the <strong>mlr3</strong> ecosystem works.</p>
</div>
<div class="section" id="pre-requisites-to-this-article">
<h2>Pre-requisites to this article<a class="headerlink" href="#pre-requisites-to-this-article" title="Permalink to this headline">¶</a></h2>
<p>We’ve tried to make this article accessible to people new to ML, and to make this article stand-alone. Having some knowledge about basic machine learning techniques like decision trees, random forests and XGBoost (gradient boosting) will help. Furthermore, we also fit the Chainladder model as a GLM (sometimes referred to as a Stochastic Chainladder) and fit a particular type of LASSO model. We’ve included limited details on these models here - our previous blog posts have more details on these:</p>
<ul class="simple">
<li><p><a class="reference external" href="https://institute-and-faculty-of-actuaries.github.io/mlr-blog/post/glms/">Reserving with GLMs</a></p></li>
<li><p><a class="reference external" href="https://institute-and-faculty-of-actuaries.github.io/mlr-blog/post/f-lasso/">Self-assembling claim reserving models using the LASSO</a></p></li>
</ul>
</div>
<div class="section" id="the-data-set">
<h2>The data set<a class="headerlink" href="#the-data-set" title="Permalink to this headline">¶</a></h2>
<p>Our example deals with using ML to set reserves for a single aggregate 40x40 triangle. We’ve selected the data set because:</p>
<ul class="simple">
<li><p>It’s small, so the code will run relatively quickly on your machine - there’s nothing worse than running through a worked example and having to wait hours for results!</p></li>
<li><p>A lot of reserving is still done using traditional accident (or underwriting) + development aggregated triangles so it is relevant to the real world.</p></li>
</ul>
<p>We use a simulated data set. There are several reasons for this:</p>
<ul class="simple">
<li><p>We know the future results so can examine how different reserve predictions perform.</p></li>
<li><p>We can control how the future experience emerges. In particular, we can ensure there are no future systemic changes (e.g. from legislation or court precedent) that would impact future payments. Changes like this can make it difficult when examining performance of reserve prediction methods on real data - it can be hard to separate poor performance of the model from a good model where the future experience departs markedly from that used to build the model.</p></li>
<li><p>We can share the data set (and the code to generate it) with you.</p></li>
</ul>
<p>The data set used is simulated data set 3 from the paper <a class="reference external" href="https://papers.ssrn.com/sol3/papers.cfm?abstract_id=3241906">Self-assembling insurance claim models using regularized regression and machine learning</a>. This is a 40x40 triangle of incremental quarterly payments over 10 years. Variables on the data set are accident, development and calendar quarters only. A copy of the data set is available <a class="reference external" href="https://institute-and-faculty-of-actuaries.github.io/mlr-blog/csv/lasso_simdata3.csv">here</a>.</p>
</div>
<div class="section" id="machine-learning-and-aggregate-triangles">
<h2>Machine learning and aggregate triangles<a class="headerlink" href="#machine-learning-and-aggregate-triangles" title="Permalink to this headline">¶</a></h2>
<p>Typically, ML and big data go hand-in-hand. By big data we mean lots of observations and lots of features (covariates / independent variables / regressors). Aggregate triangles are small in both senses - small numbers of observations and limited features (often just the 3 time features of accident/underwriting period, development period and calendar period).</p>
<p>This is not to say that it is invalid to use machine learning for aggregate triangles - many people have demonstrated good results from machine learning for such data - there are many papers on this topic. But it’s also true that an experienced actuary using a Chainladder model (or other traditional) method, overlaid with judgement, will often get a similar answer to the best ML method, even for a complex triangle. However ML may be a more efficient way of getting to an answer. In the worked example below, we use a data set which deviates significantly from Chainladder assumptions. Therefore the unadjusted Chainladder projection is quite poor and would need a significant investment of time to yield a better model. In contrast, the better performing ML models we looked at have a better first estimate, so may not require as much intervention to produce a final estimate, thereby leading to a time-saving.</p>
</div>
<div class="section" id="don-t-rank-the-ml-models-used-based-on-this-example">
<h2>Don’t rank the ML models used based on this example<a class="headerlink" href="#don-t-rank-the-ml-models-used-based-on-this-example" title="Permalink to this headline">¶</a></h2>
<p>The purpose of this article is to demonstrate a workflow for fitting ML models in R. While we’ve done some work to improve model fitting, there are a lot more things we would consider if we were looking for the best models (e.g. feature engineering, train/test splits, performance measures). So, although we do look at the relative performance of the different models at the end, you should not make any conclusions about the relative performance of the different ML methods based on this work.</p>
<p>You may find that by adjusting some hyper-parameters, or by revising the training/test data set split, you’re able to find better models.
We’ll be discussing this point a bit further at the end of the article.</p>
<p><em>A priori</em>, given the form of the data (simulated using a regression style structure) and that the LASSO model we used is based on previous work which did aim to establish a framework to fit good models to triangular data using the LASSO, we expected that the LASSO model would perform the best and (spoiler alert!) it did.</p>
</div>
<div class="section" id="mlr3-package">
<h2>mlr3 package<a class="headerlink" href="#mlr3-package" title="Permalink to this headline">¶</a></h2>
<p>One problem with applying many different types of ML models is that they all generally have different input specifications for the data, and different output types. This can make it a bit tedious to try several models.</p>
<p>There are a number of ML aggregator or multi-model packages that do a lot of the data manipulation behind the scenes. These packages take in data in a specified form and allow users to call the different ML methods. They abstract away any data manipulation required to put the data into the form required by the method. The benefit of these is apparent - set up the data in the aggregator and then switch models in and out at will.</p>
<p>One of our <a class="reference external" href="https://institute-and-faculty-of-actuaries.github.io/mlr-blog/post/topten-r-packages/">previous articles</a> covers multi-model packages.</p>
<p>Some ML aggregators in R include</p>
<ul class="simple">
<li><p><a class="reference external" href="https://cran.r-project.org/web/packages/caret/index.html">caret</a></p></li>
<li><p><a class="reference external" href="https://www.tidymodels.org/">tidymodels</a> - a successor to caret.</p></li>
<li><p><a class="reference external" href="https://mlr3.mlr-org.com/">mlr3</a> is the successor to the popular but no longer actively developed <a class="reference external" href="https://mlr.mlr-org.com/">mlr</a>.</p></li>
</ul>
<p>The Python package <strong>scikit-learn</strong> also provides a lot of useful machine learning tools.</p>
<p>If you’re looking to use an aggregator package then it’s probably best to read up on a few of them, then select the one that best works for you.
We picked <strong>mlr3</strong> first because one of us has used <strong>mlr</strong> in the past and second we are part of the <strong>M</strong>achine <strong>L</strong>earning in <strong>R</strong>eserving working party, so we had to give <strong>mlr3</strong> a try!</p>
<p><strong>mlr3</strong> uses the R6 object orientated classes - R6 is similar to object orientated programming in other languages such as Python or C++, but is quite different to R’s S3 and S4 object orientated approaches. So, depending on your programming experience, the syntax may take a bit of getting used to.</p>
<p>As a rough rule of thumb, when working with R6 classes we:</p>
<ul class="simple">
<li><p>First set up an instance of the class. Note that the class can contain both methods (like functions) and data.</p></li>
<li><p>We then run methods for the class object. These may update the data in the object.</p></li>
<li><p>We can view and use the data in the class object. Sometimes we can edit the data directory, othertimes, the data is read only and can only be modified using a method (function) available in the class object.</p></li>
</ul>
<p>If you want to learn more there is plenty of documentation out there:</p>
<ul class="simple">
<li><p>The <a class="reference external" href="https://mlr3book.mlr-org.com/">mlr3 book</a></p></li>
<li><p><a class="reference external" href="https://cheatsheets.mlr-org.com/">Cheatsheets</a></p></li>
<li><p><a class="reference external" href="https://mlr3gallery.mlr-org.com/">Gallery of examples</a></p></li>
</ul>
<p>When using <strong>mlr3</strong> code, then you can get inline help in R by using the <code class="docutils literal notranslate"><span class="pre">help()</span></code> method in a class object. This will bring you to help pages.
E.g. <code class="docutils literal notranslate"><span class="pre">lrn(&quot;regr.rpart&quot;)$help()</span></code> with get you help on decision tree learners and the learner object in general.</p>
<p>In our worked example below, we aim to explain each step clearly, so if you prefer to use another package (or language) or work separately with the individual ML packages, you should be able to translate what we are doing into code that is more familiar to you.</p>
</div>
<div class="section" id="ml-methods-used">
<h2>ML methods used<a class="headerlink" href="#ml-methods-used" title="Permalink to this headline">¶</a></h2>
<p>We’ve looked at the following methods:</p>
<ul class="simple">
<li><p>Decision trees</p></li>
<li><p>Random forests</p></li>
<li><p>XGBoost</p></li>
<li><p>LASSO</p></li>
</ul>
<p>We also use a GLM which is set up to replicate the Chainladder estimates (refer to this <a class="reference external" href="https://institute-and-faculty-of-actuaries.github.io/mlr-blog/post/glms/">post</a> for more details).</p>
<p>An obvious omission from here are neural networks / deep learning models. We’ve omitted these for a couple of reasons:</p>
<ul class="simple">
<li><p>We’re using <strong>mlr3</strong> here. While there is a <a class="reference external" href="https://github.com/mlr-org/mlr3keras"><strong>mlr3keras</strong></a> package, the developers state (as of May 2021) that <em>mlr3keras is in very early stages, and currently under development. Functionality is therefore experimental and we do not guarantee correctness, safety or stability</em>.</p></li>
<li><p>The setup for <strong>mlr3keras</strong> is more difficult as it requires having an instance of Python running on your system. R’s <strong>reticulate</strong> package then interfaces between the two. Sometimes this is straightforward (some recent improvements have made this a lot easier), but other times it can be frustrating.</p></li>
</ul>
<p>However, we are actively looking at using deep learning models and will be revisiting them in the near future.</p>
</div>
</div>
<div class="tex2jax_ignore mathjax_ignore section" id="outline-of-the-workflow">
<h1>Outline of the workflow<a class="headerlink" href="#outline-of-the-workflow" title="Permalink to this headline">¶</a></h1>
<p>The workflow we have set up consists of the following:</p>
<ul class="simple">
<li><p>Prepare the data for use in the models, including train and test partitions (past data) and hold-out or validation partitions (future data).</p></li>
<li><p>Fit each of the models selected. For each of these we:</p>
<ul>
<li><p>Select hyper-parameters (these control the model-fitting process) for tuning</p></li>
<li><p>Tune the hyper-parameters using the train and test partitions and select the set of values that yield the best results</p></li>
<li><p>Calculate predicted values on the holdout (future) data.</p></li>
</ul>
</li>
<li><p>Run diagnostics on the predicted values for each model and look at the reserve estimates.</p></li>
</ul>
<p>We’ll now work through each of the stages below.</p>
</div>
<div class="tex2jax_ignore mathjax_ignore section" id="setup">
<h1>Setup<a class="headerlink" href="#setup" title="Permalink to this headline">¶</a></h1>
<p>The first step is to load all the libraries required for this work (and install them first if needed).
We’ve included details of our session which includes versions of the packages we used at the end of this article.
If you are having problems running our code, check that your packages (the mlr3 ones in particular) are the same as ours.</p>
<p>Note that <strong>mlr3</strong> is actually a collection of a number of different packages. If you want to do a specific task, it’s worth seeing if there is an <strong>mlr3</strong> package out there for it.
There are a number of core <strong>mlr3</strong> packages which are hosted on CRAN.
We’ve attached them separately here to make it clear which ones we are using but it is also possible to install and attach the most commonly used ones via the <a class="reference external" href="https://cran.r-project.org/web/packages/mlr3verse/index.html">mlr3verse</a> wrapper package.</p>
<p>Some of the accompanying packages are on github only.
Of these, we’re just going to use one here - <strong>mlr3extralearners</strong> - which contains an extended set of machine learning models (the CRAN package <strong>mlr3learners</strong> includes the most common ones).
Install this using the <strong>remotes</strong> package - the code is given below in the comments.</p>
<p>You also need to have the following packages installed - but you do not need to attach them as a library:</p>
<ul class="simple">
<li><p><strong>glmnet</strong> (for the LASSO model)</p></li>
<li><p><strong>rpart</strong> (decision tree)</p></li>
<li><p><strong>ranger</strong> (random forest)</p></li>
<li><p><strong>xgboost</strong></p></li>
<li><p><strong>viridis</strong> (colour schemes used in some of the plots).</p></li>
</ul>
<p>Finally you need to install <strong>mlr3measures</strong> but you <strong>must not</strong> attach it (i.e. use <code class="docutils literal notranslate"><span class="pre">library(mlr3measures)</span></code>) as this will lead to code errors.</p>
<p>The code below checks for these packages and will give you a warning message if you are missing any of them. You can then install them (with the exception of <strong>mlr3extralearners</strong>) with <code class="docutils literal notranslate"><span class="pre">install.packages()</span></code> or, for RStudio users, via the Packages tab.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">reqd_packages</span> <span class="o">&lt;-</span> <span class="nf">c</span><span class="p">(</span><span class="s">&quot;data.table&quot;</span><span class="p">,</span>
                   <span class="s">&quot;ggplot2&quot;</span><span class="p">,</span>
                   <span class="s">&quot;glmnet&quot;</span><span class="p">,</span>
                   <span class="s">&quot;kableExtra&quot;</span><span class="p">,</span>
                   <span class="s">&quot;IRdisplay&quot;</span><span class="p">,</span>
                   <span class="s">&quot;mlr3&quot;</span><span class="p">,</span>
                   <span class="s">&quot;mlr3extralearners&quot;</span><span class="p">,</span>
                   <span class="s">&quot;mlr3learners&quot;</span><span class="p">,</span>
                   <span class="s">&quot;mlr3measures&quot;</span><span class="p">,</span>
                   <span class="s">&quot;mlr3tuning&quot;</span><span class="p">,</span>
                   <span class="s">&quot;paradox&quot;</span><span class="p">,</span>
                   <span class="s">&quot;patchwork&quot;</span><span class="p">,</span>
                   <span class="s">&quot;ranger&quot;</span><span class="p">,</span>
                   <span class="s">&quot;remotes&quot;</span><span class="p">,</span>
                   <span class="s">&quot;rpart&quot;</span><span class="p">,</span>
                   <span class="s">&quot;rpart.plot&quot;</span><span class="p">,</span>
                   <span class="s">&quot;viridis&quot;</span><span class="p">,</span>
                   <span class="s">&quot;xgboost&quot;</span><span class="p">)</span>


<span class="nf">for </span><span class="p">(</span><span class="n">p</span> <span class="n">in</span> <span class="n">reqd_packages</span><span class="p">){</span>
  <span class="n">check_p</span> <span class="o">&lt;-</span> <span class="nf">requireNamespace</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">quietly</span> <span class="o">=</span> <span class="kc">TRUE</span><span class="p">)</span>
  <span class="nf">if </span><span class="p">(</span><span class="o">!</span><span class="n">check_p</span><span class="p">)</span> <span class="nf">warning</span><span class="p">(</span><span class="nf">paste</span><span class="p">(</span><span class="s">&quot;Install the package&quot;</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="s">&quot;before continuing\n&quot;</span><span class="p">))</span>
<span class="p">}</span>

<span class="nf">message</span><span class="p">(</span><span class="s">&quot;Package checking complete\n&quot;</span><span class="p">)</span>


<span class="c1"># To install packages via code:</span>
<span class="c1"># install.packages(&lt;package name&gt;)</span>

<span class="c1"># To install mlr3extralearners (which is not on CRAN so must be installed on github)</span>
<span class="c1"># 1. Ensure you have the remotes package installed</span>
<span class="c1"># 2. install using</span>
<span class="c1">#     remotes::install_github(&quot;mlr-org/mlr3extralearners&quot;)</span>
<span class="c1">#</span>
<span class="c1"># if this fails (e.g. if you are using renv to manage packages then it might), you may need to use</span>
<span class="c1"># remotes::install_github(&quot;mlr-org/mlr3extralearners&quot;, INSTALL_opts = c(&quot;--no-multiarch&quot;) )</span>
<span class="c1"># see https://github.com/rstudio/renv/issues/162</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Package checking complete
</pre></div>
</div>
</div>
</div>
<p>Now that we’ve checked the required packages are there, we can get started with the example by attaching the libraries we require.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="c1"># machine learning libraries</span>
<span class="nf">library</span><span class="p">(</span><span class="n">mlr3</span><span class="p">)</span>   <span class="c1"># base mlr3 package</span>
<span class="nf">library</span><span class="p">(</span><span class="n">mlr3learners</span><span class="p">)</span>  <span class="c1"># implements common learners</span>
<span class="nf">library</span><span class="p">(</span><span class="n">mlr3tuning</span><span class="p">)</span>    <span class="c1"># tuning methodology</span>
<span class="nf">library</span><span class="p">(</span><span class="n">paradox</span><span class="p">)</span>   <span class="c1"># used to create parameter sets for hyperparameter tuning</span>
<span class="nf">library</span><span class="p">(</span><span class="n">mlr3extralearners</span><span class="p">)</span> <span class="c1"># needed for glms</span>

<span class="c1"># data manipulation</span>
<span class="nf">library</span><span class="p">(</span><span class="n">data.table</span><span class="p">)</span>

<span class="c1"># graphing</span>
<span class="nf">library</span><span class="p">(</span><span class="n">ggplot2</span><span class="p">)</span>  <span class="c1"># plotting</span>
<span class="nf">library</span><span class="p">(</span><span class="n">patchwork</span><span class="p">)</span> <span class="c1"># easy way to combine ggplots</span>
<span class="nf">library</span><span class="p">(</span><span class="n">rpart.plot</span><span class="p">)</span>   <span class="c1"># to draw decision trees created by rpart</span>

<span class="c1"># making nice tables</span>
<span class="nf">library</span><span class="p">(</span><span class="n">kableExtra</span><span class="p">)</span>
<span class="nf">library</span><span class="p">(</span><span class="n">IRdisplay</span><span class="p">)</span> <span class="c1"># displays tables when in ipynb format</span>

<span class="c1"># stop R from showing big numbers in scientific notation</span>
<span class="nf">options</span><span class="p">(</span><span class="s">&quot;scipen&quot;</span><span class="o">=</span><span class="m">99</span><span class="p">)</span>  


<span class="c1"># colours for plots - not all are used</span>
<span class="c1"># We will also use viridis for some plots</span>
<span class="n">dblue</span>  <span class="o">&lt;-</span> <span class="s">&quot;#113458&quot;</span>
<span class="n">mblue</span>  <span class="o">&lt;-</span> <span class="s">&quot;#4096b8&quot;</span>
<span class="n">gold</span>   <span class="o">&lt;-</span> <span class="s">&quot;#d9ab16&quot;</span>
<span class="n">lgrey</span>  <span class="o">&lt;-</span> <span class="s">&quot;#dcddd9&quot;</span>
<span class="n">dgrey</span>  <span class="o">&lt;-</span> <span class="s">&quot;#3f4548&quot;</span>
<span class="n">black</span>  <span class="o">&lt;-</span> <span class="s">&quot;#3F4548&quot;</span>
<span class="n">red</span>    <span class="o">&lt;-</span> <span class="s">&quot;#d01e45&quot;</span>
<span class="n">purple</span> <span class="o">&lt;-</span> <span class="s">&quot;#8f4693&quot;</span>
<span class="n">orange</span> <span class="o">&lt;-</span> <span class="s">&quot;#ee741d&quot;</span>
<span class="n">fuscia</span> <span class="o">&lt;-</span> <span class="s">&quot;#e9458c&quot;</span>
<span class="n">violet</span> <span class="o">&lt;-</span> <span class="s">&quot;#8076cf&quot;</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Loading required package: paradox


Attaching package: ‘mlr3extralearners’


The following objects are masked from ‘package:mlr3’:

    lrn, lrns


Loading required package: rpart
</pre></div>
</div>
</div>
</div>
</div>
<div class="tex2jax_ignore mathjax_ignore section" id="data-preparation">
<h1>Data preparation<a class="headerlink" href="#data-preparation" title="Permalink to this headline">¶</a></h1>
<p>We’re using a simulated data triangle with all values (past and future).</p>
<div class="cell tag_remove_input docutils container">
<div class="cell_output docutils container">
<img alt="../_images/MLRWP_R_mlr3_20_0.png" src="../_images/MLRWP_R_mlr3_20_0.png" />
</div>
</div>
<p>The data set we use is the simulated data set 3 from this <a class="reference external" href="https://papers.ssrn.com/sol3/papers.cfm?abstract_id=3241906">paper</a>.
It is available in CSV form <a class="reference external" href="https://institute-and-faculty-of-actuaries.github.io/mlr-blog/csv/lasso_simdata3.csv">here</a>.</p>
<p>This is a 40x40 triangle of payments:</p>
<ul class="simple">
<li><p>That vary by accident quarter</p></li>
<li><p>That vary by development quarter</p></li>
<li><p>Have varying rates of superimposed inflation in payment size by calendar quarter (including no inflation)</p></li>
<li><p>Have a step-up in payment size for accident quarters &gt; 16 and development quarters &gt; 20.</p></li>
</ul>
<p>The first two effects are captured by a Chainladder model but the last two effects depart from Chainladder assumptions.</p>
<div class="section" id="data-table-package">
<h2>data.table package<a class="headerlink" href="#data-table-package" title="Permalink to this headline">¶</a></h2>
<p>We’ll be using the <strong>data.table</strong> package for manipulating the data. There’s an introduction to <strong>data.table</strong> on our <a class="reference external" href="https://institute-and-faculty-of-actuaries.github.io/mlr-blog/post/datatable/">blog</a> if you are unfamiliar with it.
If you see <code class="docutils literal notranslate"><span class="pre">:=</span></code> in the R code, then that’s <strong>data.table</strong> assignment.
(Actually in the code chunks you may see an underscore under the <code class="docutils literal notranslate"><span class="pre">:=</span></code> - this is inserted by the formatting we are using to prepare the notebook for some reason, so please ignore the underscore).</p>
</div>
<div class="section" id="load-the-data">
<h2>Load the data<a class="headerlink" href="#load-the-data" title="Permalink to this headline">¶</a></h2>
<p>First, load in the data and have a look at it.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">dat</span> <span class="o">&lt;-</span> <span class="nf">fread</span><span class="p">(</span><span class="s">&quot;https://institute-and-faculty-of-actuaries.github.io/mlr-blog/csv/lasso_simdata3.csv&quot;</span><span class="p">)</span>

<span class="nf">head</span><span class="p">(</span><span class="n">dat</span><span class="p">)</span>
<span class="nf">tail</span><span class="p">(</span><span class="n">dat</span><span class="p">)</span>

<span class="c1"># create the num_periods variable - number of acc/dev periods</span>
<span class="n">num_periods</span> <span class="o">&lt;-</span> <span class="n">dat</span><span class="p">[,</span> <span class="nf">max</span><span class="p">(</span><span class="n">acc</span><span class="p">)]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><table class="dataframe">
<caption>A data.table: 6 × 6</caption>
<thead>
	<tr><th scope=col>pmts</th><th scope=col>acc</th><th scope=col>dev</th><th scope=col>cal</th><th scope=col>mu</th><th scope=col>train_ind</th></tr>
	<tr><th scope=col>&lt;dbl&gt;</th><th scope=col>&lt;int&gt;</th><th scope=col>&lt;int&gt;</th><th scope=col>&lt;int&gt;</th><th scope=col>&lt;dbl&gt;</th><th scope=col>&lt;lgl&gt;</th></tr>
</thead>
<tbody>
	<tr><td>  242671.2</td><td>1</td><td>1</td><td>1</td><td>   71653.13</td><td>TRUE</td></tr>
	<tr><td>  164001.3</td><td>1</td><td>2</td><td>2</td><td> 1042775.62</td><td>TRUE</td></tr>
	<tr><td> 3224477.8</td><td>1</td><td>3</td><td>3</td><td> 4362599.77</td><td>TRUE</td></tr>
	<tr><td> 3682530.8</td><td>1</td><td>4</td><td>4</td><td>10955670.09</td><td>TRUE</td></tr>
	<tr><td>10149368.6</td><td>1</td><td>5</td><td>5</td><td>20800545.12</td><td>TRUE</td></tr>
	<tr><td>28578274.7</td><td>1</td><td>6</td><td>6</td><td>33089166.75</td><td>TRUE</td></tr>
</tbody>
</table>
</div><div class="output text_html"><table class="dataframe">
<caption>A data.table: 6 × 6</caption>
<thead>
	<tr><th scope=col>pmts</th><th scope=col>acc</th><th scope=col>dev</th><th scope=col>cal</th><th scope=col>mu</th><th scope=col>train_ind</th></tr>
	<tr><th scope=col>&lt;dbl&gt;</th><th scope=col>&lt;int&gt;</th><th scope=col>&lt;int&gt;</th><th scope=col>&lt;int&gt;</th><th scope=col>&lt;dbl&gt;</th><th scope=col>&lt;lgl&gt;</th></tr>
</thead>
<tbody>
	<tr><td>125261750</td><td>40</td><td>35</td><td>74</td><td>109039367</td><td>FALSE</td></tr>
	<tr><td> 62657370</td><td>40</td><td>36</td><td>75</td><td> 82853302</td><td>FALSE</td></tr>
	<tr><td> 63467681</td><td>40</td><td>37</td><td>76</td><td> 62682720</td><td>FALSE</td></tr>
	<tr><td> 26041979</td><td>40</td><td>38</td><td>77</td><td> 47227843</td><td>FALSE</td></tr>
	<tr><td> 33947274</td><td>40</td><td>39</td><td>78</td><td> 35444881</td><td>FALSE</td></tr>
	<tr><td> 37258687</td><td>40</td><td>40</td><td>79</td><td> 26503298</td><td>FALSE</td></tr>
</tbody>
</table>
</div></div>
</div>
<p>As you can see, the data is not in triangular form as per the diagram above, but is instead in long form where:</p>
<ul class="simple">
<li><p>each row of the data set consists of one observation</p></li>
<li><p>each observation has the accident(<code class="docutils literal notranslate"><span class="pre">acc</span></code>), development(<code class="docutils literal notranslate"><span class="pre">dev</span></code>) and calendar(<code class="docutils literal notranslate"><span class="pre">cal</span></code>) period associated with it</p></li>
<li><p>the <code class="docutils literal notranslate"><span class="pre">mu</span></code> value is the mean value of the distribution from which <code class="docutils literal notranslate"><span class="pre">pmts</span></code> was simulated - this won’t form part of the analysis below so can be ignored</p></li>
<li><p>the final variable, <code class="docutils literal notranslate"><span class="pre">train_ind</span></code> is <code class="docutils literal notranslate"><span class="pre">TRUE</span></code> for past values and <code class="docutils literal notranslate"><span class="pre">FALSE</span></code> for future values.</p></li>
</ul>
<p>This long format of data is standard for a lot of modelling and data analysis.</p>
<p>We can also show a visualisation of the data. This contains both past and future data (with a diagonal line marking the boundary). The plot uses shading to indicate the size of the payments (specifically, log(payments)).
The step-up in claim size (acc &gt; 16 and dev &gt; 20) is quite obvious in this graphic. What is also apparent is this this increase only affects a small part of the past triangle (10 cells out of 820 to be exact), but impacts much of the future lower triangle.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="c1"># get limits for use with raster plots</span>
<span class="n">data_raster_limits</span> <span class="o">&lt;-</span> <span class="nf">c</span><span class="p">(</span><span class="nf">floor</span><span class="p">(</span><span class="n">dat</span><span class="p">[,</span> <span class="nf">min</span><span class="p">(</span><span class="nf">log</span><span class="p">(</span><span class="n">pmts</span><span class="p">))]),</span> <span class="nf">ceiling</span><span class="p">(</span><span class="n">dat</span><span class="p">[,</span> <span class="nf">max</span><span class="p">(</span><span class="nf">log</span><span class="p">(</span><span class="n">pmts</span><span class="p">))]))</span>

<span class="nf">ggplot</span><span class="p">(</span><span class="n">dat</span><span class="p">,</span> <span class="nf">aes</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">acc</span><span class="p">))</span> <span class="o">+</span>
  <span class="nf">geom_raster</span><span class="p">(</span><span class="nf">aes</span><span class="p">(</span><span class="n">fill</span> <span class="o">=</span> <span class="nf">log</span><span class="p">(</span><span class="n">pmts</span><span class="p">)))</span><span class="o">+</span>
  <span class="nf">geom_line</span><span class="p">(</span><span class="nf">aes</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">num_periods</span><span class="m">+1</span><span class="o">-</span><span class="n">acc</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">acc</span><span class="p">),</span> <span class="n">colour</span><span class="o">=</span><span class="s">&quot;grey30&quot;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="m">2</span><span class="p">)</span><span class="o">+</span>
  <span class="nf">scale_y_reverse</span><span class="p">()</span><span class="o">+</span>
  <span class="nf">scale_fill_viridis_c</span><span class="p">(</span><span class="n">begin</span><span class="o">=</span><span class="m">1</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="m">0</span><span class="p">,</span> <span class="n">limits</span><span class="o">=</span><span class="n">data_raster_limits</span><span class="p">)</span><span class="o">+</span>
  <span class="nf">theme_classic</span><span class="p">()</span><span class="o">+</span>
  <span class="nf">labs</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s">&quot;Development quarter&quot;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s">&quot;Accident quarter&quot;</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s">&quot;Log(payments)&quot;</span><span class="p">)</span><span class="o">+</span>
  <span class="kc">NULL</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/MLRWP_R_mlr3_27_0.png" src="../_images/MLRWP_R_mlr3_27_0.png" />
</div>
</div>
<p>The step-up in payments can be modelled as an interaction between accident and development quarters.
Because it affects only a small number of past values, it may be difficult for some of the modelling approaches to capture this.
It’s likely, therefore, that the main differentiator between the performance of different methods for this data set will be how much well they capture this interaction.</p>
<p>One thing to note is that the Chainladder will struggle with this data set. Both the calendar period terms and the interaction are not effects that the Chainladder can model - it assumes that only accident and development period main effects (i.e. no interactions) are present. So an actuary using the Chainladder for this data set would need to overlay judgement to obtain a good result.</p>
<p>We need to modify this data a little before proceeding further:</p>
<ul class="simple">
<li><p>We’ll add factor versions (essentially a categorical version) of acc and dev - these are needed later for fitting the Chainladder</p></li>
<li><p>We’ll add a unique ID associated with each row</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="c1"># data.table code, := is assignment</span>
<span class="c1"># if you see an underscore under the := in the code below, then this is a formatting thing - ignore the underscore here and elsewhere</span>
<span class="c1"># the code should look like this: dat[, accf := as.factor(acc)]</span>
<span class="n">dat</span><span class="p">[,</span> <span class="n">accf</span> <span class="o">:=</span> <span class="nf">as.factor</span><span class="p">(</span><span class="n">acc</span><span class="p">)]</span>
<span class="n">dat</span><span class="p">[,</span> <span class="n">devf</span> <span class="o">:=</span> <span class="nf">as.factor</span><span class="p">(</span><span class="n">dev</span><span class="p">)]</span>


<span class="c1"># data.table code, .N = number of rows</span>
<span class="n">dat</span><span class="p">[,</span> <span class="n">row_id</span> <span class="o">:=</span> <span class="m">1</span><span class="o">:</span><span class="n">.N</span><span class="p">]</span>

<span class="nf">tail</span><span class="p">(</span><span class="n">dat</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><table class="dataframe">
<caption>A data.table: 6 × 9</caption>
<thead>
	<tr><th scope=col>pmts</th><th scope=col>acc</th><th scope=col>dev</th><th scope=col>cal</th><th scope=col>mu</th><th scope=col>train_ind</th><th scope=col>accf</th><th scope=col>devf</th><th scope=col>row_id</th></tr>
	<tr><th scope=col>&lt;dbl&gt;</th><th scope=col>&lt;int&gt;</th><th scope=col>&lt;int&gt;</th><th scope=col>&lt;int&gt;</th><th scope=col>&lt;dbl&gt;</th><th scope=col>&lt;lgl&gt;</th><th scope=col>&lt;fct&gt;</th><th scope=col>&lt;fct&gt;</th><th scope=col>&lt;int&gt;</th></tr>
</thead>
<tbody>
	<tr><td>125261750</td><td>40</td><td>35</td><td>74</td><td>109039367</td><td>FALSE</td><td>40</td><td>35</td><td>1595</td></tr>
	<tr><td> 62657370</td><td>40</td><td>36</td><td>75</td><td> 82853302</td><td>FALSE</td><td>40</td><td>36</td><td>1596</td></tr>
	<tr><td> 63467681</td><td>40</td><td>37</td><td>76</td><td> 62682720</td><td>FALSE</td><td>40</td><td>37</td><td>1597</td></tr>
	<tr><td> 26041979</td><td>40</td><td>38</td><td>77</td><td> 47227843</td><td>FALSE</td><td>40</td><td>38</td><td>1598</td></tr>
	<tr><td> 33947274</td><td>40</td><td>39</td><td>78</td><td> 35444881</td><td>FALSE</td><td>40</td><td>39</td><td>1599</td></tr>
	<tr><td> 37258687</td><td>40</td><td>40</td><td>79</td><td> 26503298</td><td>FALSE</td><td>40</td><td>40</td><td>1600</td></tr>
</tbody>
</table>
</div></div>
</div>
</div>
<div class="section" id="create-a-mlr3-task">
<h2>Create a mlr3 task<a class="headerlink" href="#create-a-mlr3-task" title="Permalink to this headline">¶</a></h2>
<p>Now create an <strong>mlr3</strong> <a class="reference external" href="https://mlr3book.mlr-org.com/tasks.html">task</a> - making an object to hold data and set roles for the data.
These tasks abstract away (i.e. do it for you) all the hard work in getting the data into the right form for each model (learner in <strong>mlr3</strong> parlance) - just specify what the target is and what the features are, and <strong>mlr3</strong> will take care of the rest.</p>
<p>We need to make a regression task since we will be estimating payments. So we make a new instance of the <code class="docutils literal notranslate"><span class="pre">TaskRegr</span></code> class via <code class="docutils literal notranslate"><span class="pre">TaskRegr$new</span></code>.
When loading the data in via the <code class="docutils literal notranslate"><span class="pre">backend</span></code>, we’ve omitted <code class="docutils literal notranslate"><span class="pre">mu</span></code> since this is not used in the modelling.
We’ve also omitted the factor versions of <code class="docutils literal notranslate"><span class="pre">acc</span></code> and <code class="docutils literal notranslate"><span class="pre">dev</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="c1"># note can also use the sugar function tsk()</span>
<span class="n">task</span> <span class="o">&lt;-</span> <span class="n">TaskRegr</span><span class="o">$</span><span class="nf">new</span><span class="p">(</span><span class="n">id</span> <span class="o">=</span> <span class="s">&quot;reserves&quot;</span><span class="p">,</span>
                     <span class="n">backend</span> <span class="o">=</span> <span class="n">dat</span><span class="p">[,</span> <span class="nf">.</span><span class="p">(</span><span class="n">pmts</span><span class="p">,</span> <span class="n">train_ind</span><span class="p">,</span> <span class="n">acc</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="n">cal</span><span class="p">,</span> <span class="n">row_id</span><span class="p">)],</span>
                     <span class="n">target</span> <span class="o">=</span> <span class="s">&quot;pmts&quot;</span><span class="p">)</span>

<span class="c1"># look at the task</span>
<span class="n">task</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;TaskRegr:reserves&gt; (1600 x 6)
* Target: pmts
* Properties: -
* Features (5):
  - int (4): acc, cal, dev, row_id
  - lgl (1): train_ind
</pre></div>
</div>
</div>
</div>
<p>We need to ensure everything is correctly assigned:</p>
<ul class="simple">
<li><p>Future data must not be used for model training. Currently all parts of the triangle are used because we loaded all the data into the <code class="docutils literal notranslate"><span class="pre">backend</span></code>.</p></li>
<li><p>The right features must be used in model training. Right now <code class="docutils literal notranslate"><span class="pre">row_id</span></code> and <code class="docutils literal notranslate"><span class="pre">train_ind</span></code> are also included in the features which is incorrect.</p></li>
</ul>
<p>For the first, we’ll use <code class="docutils literal notranslate"><span class="pre">row_roles</span></code> to ensure that future data is not used for model training.
There are two types of <code class="docutils literal notranslate"><span class="pre">row_roles</span></code> - <code class="docutils literal notranslate"><span class="pre">use</span></code> and <code class="docutils literal notranslate"><span class="pre">validation</span></code>. Right now all rows are in <code class="docutils literal notranslate"><span class="pre">use</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="c1"># number of entries in use</span>
<span class="nf">print</span><span class="p">(</span><span class="nf">length</span><span class="p">(</span><span class="n">task</span><span class="o">$</span><span class="n">row_roles</span><span class="o">$</span><span class="n">use</span><span class="p">))</span>

<span class="c1"># for brevity just print first 10 elements</span>
<span class="nf">print</span><span class="p">(</span><span class="n">task</span><span class="o">$</span><span class="n">row_roles</span><span class="o">$</span><span class="n">use</span><span class="p">[</span><span class="m">1</span><span class="o">:</span><span class="m">10</span><span class="p">])</span>

<span class="c1"># number of entries in validation</span>
<span class="nf">print</span><span class="p">(</span><span class="nf">length</span><span class="p">(</span><span class="n">task</span><span class="o">$</span><span class="n">row_roles</span><span class="o">$</span><span class="n">validation</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[1] 1600
 [1]  1  2  3  4  5  6  7  8  9 10
[1] 0
</pre></div>
</div>
</div>
</div>
<p>Move all future values (<code class="docutils literal notranslate"><span class="pre">train_ind==FALSE</span></code>) into <code class="docutils literal notranslate"><span class="pre">validation</span></code> so they are not used in the model.</p>
<p>We can’t edit row_roles directly, so use the method (<code class="docutils literal notranslate"><span class="pre">set_row_roles()</span></code>) to do this. Supply the list of future row_ids in the first argument.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">task</span><span class="o">$</span><span class="nf">set_row_roles</span><span class="p">(</span><span class="n">dat</span><span class="p">[</span><span class="n">train_ind</span><span class="o">==</span><span class="kc">FALSE</span><span class="p">,</span> <span class="n">row_id</span><span class="p">],</span> <span class="n">roles</span><span class="o">=</span><span class="s">&quot;validation&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Check that the task has been updated correctly.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="c1"># number of entries in use</span>
<span class="nf">print</span><span class="p">(</span><span class="nf">length</span><span class="p">(</span><span class="n">task</span><span class="o">$</span><span class="n">row_roles</span><span class="o">$</span><span class="n">use</span><span class="p">))</span>

<span class="c1"># for brevity just print the end of the second accident period - row id 80 should be in validate</span>
<span class="nf">print</span><span class="p">(</span><span class="n">task</span><span class="o">$</span><span class="n">row_roles</span><span class="o">$</span><span class="n">use</span><span class="p">[</span><span class="m">70</span><span class="o">:</span><span class="m">90</span><span class="p">])</span>

<span class="c1"># number of entries in validation</span>
<span class="nf">print</span><span class="p">(</span><span class="nf">length</span><span class="p">(</span><span class="n">task</span><span class="o">$</span><span class="n">row_roles</span><span class="o">$</span><span class="n">validation</span><span class="p">))</span>
<span class="nf">print</span><span class="p">(</span><span class="n">task</span><span class="o">$</span><span class="n">row_roles</span><span class="o">$</span><span class="n">validation</span><span class="p">[</span><span class="m">1</span><span class="o">:</span><span class="m">10</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[1] 820
 [1] 70 71 72 73 74 75 76 77 78 79 81 82 83 84 85 86 87 88 89 90 91
[1] 780
 [1]  80 119 120 158 159 160 197 198 199 200
</pre></div>
</div>
</div>
</div>
<p>This looks right (we’ve checked more than this, but have limited what we display in this notebook).</p>
<p>Now we need to remove <code class="docutils literal notranslate"><span class="pre">row_id</span></code> and <code class="docutils literal notranslate"><span class="pre">train_ind</span></code> from the list of features:</p>
<ul class="simple">
<li><p>we’ll ignore <code class="docutils literal notranslate"><span class="pre">train_ind</span></code> (so it won’t have any role)</p></li>
<li><p>we’ll set <code class="docutils literal notranslate"><span class="pre">row_id</span></code> to be a name. This could be used in plots to label points if needed.</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="c1"># make row_id a name</span>
<span class="n">task</span><span class="o">$</span><span class="nf">set_col_roles</span><span class="p">(</span><span class="s">&quot;row_id&quot;</span><span class="p">,</span> <span class="n">roles</span><span class="o">=</span><span class="s">&quot;name&quot;</span><span class="p">)</span>

<span class="c1"># drop train_ind from the feature list</span>
<span class="n">task</span><span class="o">$</span><span class="n">col_roles</span><span class="o">$</span><span class="n">feature</span> <span class="o">&lt;-</span> <span class="nf">setdiff</span><span class="p">(</span><span class="n">task</span><span class="o">$</span><span class="n">feature_names</span><span class="p">,</span> <span class="s">&quot;train_ind&quot;</span><span class="p">)</span>  

<span class="c1"># check the task has the correct variables now</span>
<span class="n">task</span>

<span class="c1"># check alll the col_roles</span>
<span class="nf">print</span><span class="p">(</span><span class="n">task</span><span class="o">$</span><span class="n">col_roles</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;TaskRegr:reserves&gt; (820 x 4)
* Target: pmts
* Properties: -
* Features (3):
  - int (3): acc, cal, dev
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>$feature
[1] &quot;acc&quot; &quot;cal&quot; &quot;dev&quot;

$target
[1] &quot;pmts&quot;

$name
[1] &quot;row_id&quot;

$order
character(0)

$stratum
character(0)

$group
character(0)

$weight
character(0)

$uri
character(0)
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="tex2jax_ignore mathjax_ignore section" id="tuning-process-for-hyper-parameters">
<h1>Tuning process for hyper-parameters<a class="headerlink" href="#tuning-process-for-hyper-parameters" title="Permalink to this headline">¶</a></h1>
<p>Machine learning models have a number of hyper-parameters that control the model fit.
Tweaking the hyper-parameters that control model fitting (e.g. for decision trees, the depth of the tree, or for random forests, the number of trees to average over) can have a significant impact on the quality of the fit.
The standard way of doing this is to use a train and test data set where:</p>
<ul class="simple">
<li><p>The model is trained (built) on the train data set</p></li>
<li><p>The performance of the model is evaluated on the test data set</p></li>
<li><p>This is repeated for a number of different combinations of hyper-parameters, and the best performing one is selected.</p></li>
</ul>
<p>Evaluating the models on a separate data set not used in the model fitting helps to control over-fitting.
Usually we would then select the hyper-parameters that lead to the best results on the test data set and use these to predict our future values.</p>
<p>There are various ways we can select the test and train data sets.
For this work we use cross-validation. We’ll give a brief overview of it below.
Note that we will be discussing validation options in a separate article.</p>
<div class="section" id="cross-validation">
<h2>Cross-validation<a class="headerlink" href="#cross-validation" title="Permalink to this headline">¶</a></h2>
<p>The simplest implementation of a train and test partition is a random one where each point in the data set is allocated to train and test at random.
Typically, the train part might be around 70-80% of the data and the test part the remainder.</p>
<div class="cell tag_remove_input docutils container">
</div>
<p><strong>Random test data set</strong></p>
<div class="cell tag_remove_input docutils container">
<div class="cell_output docutils container">
<img alt="../_images/MLRWP_R_mlr3_48_0.png" src="../_images/MLRWP_R_mlr3_48_0.png" />
</div>
</div>
<p>Cross-validation repeats this type of split a number of times.</p>
<p>In more detail, the steps are:</p>
<ul class="simple">
<li><p>Randomly partition the data into <em>k</em> equal-sized folds (between 5-10 folds are common choices). These folds are then fixed for the remainder of the algorithm.</p>
<ul>
<li><p>This means that we do a train/test split like the triangle above but repeat this <em>k</em> times.</p></li>
</ul>
</li>
<li><p>Fit the model using data from <em>k</em>-1 of the folds, using the remaining fold as the test data. Do this <em>k</em> times, so each fold is used as test data once.</p></li>
<li><p>Calculate the performance metrics for each model on the corresponding test fold.</p></li>
<li><p>Average the performance metrics across all the folds.</p></li>
</ul>
<p>A simplified representation of the process is given below.</p>
<p><strong>5-fold cross validation</strong></p>
<div class="cell tag_remove_input docutils container">
<div class="cell_output docutils container">
<img alt="../_images/MLRWP_R_mlr3_50_0.png" src="../_images/MLRWP_R_mlr3_50_0.png" />
</div>
</div>
<p>Cross-validation provides an estimate of out-of-sample performance even though all the data is used for training and testing.
It is often considered more robust due to its use of the full dataset for testing, but can be computationally expensive for larger datasets. Here we only have a small amount of data, so there is an advantage to using the full dataset, whilst the computational cost is manageable.</p>
</div>
<div class="section" id="setting-up-cross-validation-in-mlr3">
<h2>Setting up cross-validation in mlr3<a class="headerlink" href="#setting-up-cross-validation-in-mlr3" title="Permalink to this headline">¶</a></h2>
<p>We can set up a cross-validation resampler in mlr3 that can then be applied to any model. As always, the <a class="reference external" href="https://mlr3book.mlr-org.com/resampling.html">book</a> is a useful starting reference point.</p>
<p>Here we will use 6-fold cross validation.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="c1"># create object</span>
<span class="n">crossval</span> <span class="o">=</span> <span class="nf">rsmp</span><span class="p">(</span><span class="s">&quot;cv&quot;</span><span class="p">,</span> <span class="n">folds</span><span class="o">=</span><span class="m">6</span><span class="p">)</span>  


<span class="nf">set.seed</span><span class="p">(</span><span class="m">42</span><span class="p">)</span>  <span class="c1"># reproducible results</span>

<span class="c1"># populate the folds</span>
<span class="c1"># NB: mlr3 will only use data where role was set to “use”</span>
<span class="n">crossval</span><span class="o">$</span><span class="nf">instantiate</span><span class="p">(</span><span class="n">task</span><span class="p">)</span>   
</pre></div>
</div>
</div>
</div>
<p>Below we show the allocation of points into test and train for each fold - the dark blue points are the test subset in each of the 6 folds.</p>
<div class="cell tag_remove_input docutils container">
</div>
<div class="cell tag_remove_input docutils container">
<div class="cell_output docutils container">
<img alt="../_images/MLRWP_R_mlr3_56_0.png" src="../_images/MLRWP_R_mlr3_56_0.png" />
</div>
</div>
</div>
<div class="section" id="performance-measure">
<h2>Performance measure<a class="headerlink" href="#performance-measure" title="Permalink to this headline">¶</a></h2>
<p>As well as the cross-validation process, we want to set up a performance measure to use.
Here we will use RMSE (root mean square error).</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="c1"># to see all measures use</span>
<span class="c1"># mlr_measures$help()</span>
<span class="c1"># follow the links for a specific one, or you can type</span>
<span class="c1"># ?mlr_measures_regr.rmse to get help for RMSE, and then insert the</span>
<span class="c1"># other names for others, eg ?mlr_measures_regr.rmsle etc</span>

<span class="n">measure</span> <span class="o">&lt;-</span> <span class="nf">msr</span><span class="p">(</span><span class="s">&quot;regr.rmse&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="searching-hyper-parameter-space">
<h2>Searching hyper-parameter space<a class="headerlink" href="#searching-hyper-parameter-space" title="Permalink to this headline">¶</a></h2>
<p>Searching hyper-parameter space needs to be customised to each model, so we can’t set up a common framework here.
However, to control computations, it is useful to set a limit on the number of searches that can be performed in a tuning exercise.
<strong>mlr3</strong> offers a number of different options for terminating searches - here we are just going to use the simplest one - where only a limited number of evaluations are permitted.</p>
<p>Given how we set up the tuning process below we need 25 evaluations for the decision tree and random forest models. We need many more evaluations for the XGBoost model since we tune more parameters. However, this can take a long time to run. In practice, using a more powerful computer, or running things in parallel can help.</p>
<p>So we’ve set the number of evaluations to a low number here (25). For the XGBoost model, we used 500 evaluations to tune the hyper-parameters and saved the results for use here.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="c1"># setting we used to get the xgboost results below</span>
<span class="c1">#evals_trm = trm(&quot;evals&quot;, n_evals = 500)</span>

<span class="c1"># using a low number so things run quickly</span>
<span class="n">evals_trm</span> <span class="o">=</span> <span class="nf">trm</span><span class="p">(</span><span class="s">&quot;evals&quot;</span><span class="p">,</span> <span class="n">n_evals</span> <span class="o">=</span> <span class="m">25</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="tex2jax_ignore mathjax_ignore section" id="fitting-some-ml-models">
<h1>Fitting some ML models<a class="headerlink" href="#fitting-some-ml-models" title="Permalink to this headline">¶</a></h1>
<p>Now it’s time to fit and tune the following ML models using <strong>mlr3</strong>:</p>
<ul class="simple">
<li><p>Decision tree</p></li>
<li><p>Random forest</p></li>
<li><p>XGBoost</p></li>
</ul>
<div class="section" id="decision-tree">
<h2>Decision tree<a class="headerlink" href="#decision-tree" title="Permalink to this headline">¶</a></h2>
<p>A decision tree is unlikely to be a very good model for this data, and tuning often doesn’t help much.
Nonetheless, it’s a simple model, so it’s useful to fit it to see what happens.</p>
<p>To illustrate the use of mlr3, we’ll first show how to fit a model using the default hyper-parameters.
We’ll then move onto the code needed to run hyper-parameter tuning using cross-validation.</p>
<div class="section" id="fitting-a-single-model">
<h3>Fitting a single model<a class="headerlink" href="#fitting-a-single-model" title="Permalink to this headline">¶</a></h3>
<p>First let’s fit a decision tree using default parameters.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="c1"># create a learner, ie a container for a decision tree model</span>
<span class="n">lrn_rpart_default</span> <span class="o">&lt;-</span> <span class="nf">lrn</span><span class="p">(</span><span class="s">&quot;regr.rpart&quot;</span><span class="p">)</span>

<span class="c1"># fit the model on all the past data (ie where row_roles==use)</span>
<span class="n">lrn_rpart_default</span><span class="o">$</span><span class="nf">train</span><span class="p">(</span><span class="n">task</span><span class="p">)</span>  

<span class="c1"># Visualise the tree</span>
<span class="n">rpart.plot</span><span class="o">::</span><span class="nf">rpart.plot</span><span class="p">(</span><span class="n">lrn_rpart_default</span><span class="o">$</span><span class="n">model</span><span class="p">,</span> <span class="n">roundint</span> <span class="o">=</span> <span class="kc">FALSE</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/MLRWP_R_mlr3_66_0.png" src="../_images/MLRWP_R_mlr3_66_0.png" />
</div>
</div>
<p>If you are unfamiliar with decision tree diagrams, the model specifies that, for example, for accident years greater than 17, with development periods less than 7.5 (ie 7 or under) and less than 4.5, the predicted claim cost is $43m.</p>
<p>While the tree is fairly simple, we do see splits for acc&lt;17 and dev&lt;21, which match the location of the interaction.</p>
<p>Here’s a list of the parameters - the documentation on <code class="docutils literal notranslate"><span class="pre">rpart.control</span></code> will have more information.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">lrn_rpart_default</span><span class="o">$</span><span class="n">param_set</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;ParamSet&gt;
                id    class lower upper nlevels        default value
 1:       minsplit ParamInt     1   Inf     Inf             20      
 2:      minbucket ParamInt     1   Inf     Inf &lt;NoDefault[3]&gt;      
 3:             cp ParamDbl     0     1     Inf           0.01      
 4:     maxcompete ParamInt     0   Inf     Inf              4      
 5:   maxsurrogate ParamInt     0   Inf     Inf              5      
 6:       maxdepth ParamInt     1    30      30             30      
 7:   usesurrogate ParamInt     0     2       3              2      
 8: surrogatestyle ParamInt     0     1       2              0      
 9:           xval ParamInt     0   Inf     Inf             10     0
10:     keep_model ParamLgl    NA    NA       2          FALSE      
</pre></div>
</div>
</div>
</div>
<p>Let’s try tuning the <code class="docutils literal notranslate"><span class="pre">cp</span></code> and <code class="docutils literal notranslate"><span class="pre">minsplit</span></code> parameters.</p>
</div>
<div class="section" id="tuning-the-decision-tree">
<h3>Tuning the decision tree<a class="headerlink" href="#tuning-the-decision-tree" title="Permalink to this headline">¶</a></h3>
<p>To set up the tuning we need to specify:</p>
<ul class="simple">
<li><p>The ranges of values to search over</p></li>
<li><p>A resampling strategy (already have this - crossvalidation)</p></li>
<li><p>An evaluation measure (this is RMSE)</p></li>
<li><p>A termination criterion so searches don’t go on for ever (our <code class="docutils literal notranslate"><span class="pre">evals_trm</span></code>)</p></li>
<li><p>The search strategy (e.g. grid search, random search, etc - see, e.g., <a class="reference external" href="https://towardsdatascience.com/hyperparameter-tuning-a-practical-guide-and-template-b3bf0504f095">this post</a> )</p></li>
</ul>
<p>We first set ranges of values to consider for these using functionality from the <strong>paradox</strong> library.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">tune_ps_rpart</span> <span class="o">&lt;-</span> <span class="nf">ps</span><span class="p">(</span>
  <span class="n">cp</span> <span class="o">=</span> <span class="nf">p_dbl</span><span class="p">(</span><span class="n">lower</span> <span class="o">=</span> <span class="m">0.001</span><span class="p">,</span> <span class="n">upper</span> <span class="o">=</span> <span class="m">0.1</span><span class="p">),</span>
  <span class="n">minsplit</span> <span class="o">=</span> <span class="nf">p_int</span><span class="p">(</span><span class="n">lower</span> <span class="o">=</span> <span class="m">1</span><span class="p">,</span> <span class="n">upper</span> <span class="o">=</span> <span class="m">10</span><span class="p">)</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>We can see what’s going to be searched over if we specify a 5x5 grid</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="c1"># to see what&#39;s searched if we set a grid of 5</span>
<span class="nf">rbindlist</span><span class="p">(</span><span class="nf">generate_design_grid</span><span class="p">(</span><span class="n">tune_ps_rpart</span><span class="p">,</span> <span class="m">5</span><span class="p">)</span><span class="o">$</span><span class="nf">transpose</span><span class="p">())</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><table class="dataframe">
<caption>A data.table: 25 × 2</caption>
<thead>
	<tr><th scope=col>cp</th><th scope=col>minsplit</th></tr>
	<tr><th scope=col>&lt;dbl&gt;</th><th scope=col>&lt;int&gt;</th></tr>
</thead>
<tbody>
	<tr><td>0.00100</td><td> 1</td></tr>
	<tr><td>0.00100</td><td> 3</td></tr>
	<tr><td>0.00100</td><td> 5</td></tr>
	<tr><td>0.00100</td><td> 8</td></tr>
	<tr><td>0.00100</td><td>10</td></tr>
	<tr><td>0.02575</td><td> 1</td></tr>
	<tr><td>0.02575</td><td> 3</td></tr>
	<tr><td>0.02575</td><td> 5</td></tr>
	<tr><td>0.02575</td><td> 8</td></tr>
	<tr><td>0.02575</td><td>10</td></tr>
	<tr><td>0.05050</td><td> 1</td></tr>
	<tr><td>0.05050</td><td> 3</td></tr>
	<tr><td>0.05050</td><td> 5</td></tr>
	<tr><td>0.05050</td><td> 8</td></tr>
	<tr><td>0.05050</td><td>10</td></tr>
	<tr><td>0.07525</td><td> 1</td></tr>
	<tr><td>0.07525</td><td> 3</td></tr>
	<tr><td>0.07525</td><td> 5</td></tr>
	<tr><td>0.07525</td><td> 8</td></tr>
	<tr><td>0.07525</td><td>10</td></tr>
	<tr><td>0.10000</td><td> 1</td></tr>
	<tr><td>0.10000</td><td> 3</td></tr>
	<tr><td>0.10000</td><td> 5</td></tr>
	<tr><td>0.10000</td><td> 8</td></tr>
	<tr><td>0.10000</td><td>10</td></tr>
</tbody>
</table>
</div></div>
</div>
<p>Given we only have 25 points (in a grid of 5), we can easily evaluate every option so we’ll use a grid search strategy.
In practice other search strategies may be preferable - e.g. a random search often gets similar results to a grid search, in a much smaller amount of time.
Another possible choice is Bayesian optimisation search.</p>
<p>So now we have everything we need to tune our hyper-parameters so we can set this up in <strong>mlr3</strong> now.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="c1"># create the hyper-parameter for this particular learner/model</span>
<span class="n">instance_rpart</span> <span class="o">&lt;-</span> <span class="n">TuningInstanceSingleCrit</span><span class="o">$</span><span class="nf">new</span><span class="p">(</span>
  <span class="n">task</span> <span class="o">=</span> <span class="n">task</span><span class="p">,</span>
  <span class="n">learner</span> <span class="o">=</span> <span class="nf">lrn</span><span class="p">(</span><span class="s">&quot;regr.rpart&quot;</span><span class="p">),</span>
  <span class="n">resampling</span> <span class="o">=</span> <span class="n">crossval</span><span class="p">,</span>
  <span class="n">measure</span> <span class="o">=</span> <span class="n">measure</span><span class="p">,</span>
  <span class="n">search_space</span> <span class="o">=</span> <span class="n">tune_ps_rpart</span><span class="p">,</span>
  <span class="n">terminator</span> <span class="o">=</span> <span class="n">evals_trm</span>
<span class="p">)</span>


<span class="c1"># create a grid-search tuner for a 5-point grid</span>
<span class="n">tuner</span> <span class="o">&lt;-</span> <span class="nf">tnr</span><span class="p">(</span><span class="s">&quot;grid_search&quot;</span><span class="p">,</span> <span class="n">resolution</span> <span class="o">=</span> <span class="m">5</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Finally, we run the tuning on the <code class="docutils literal notranslate"><span class="pre">instance_rpart</span></code> space.</p>
<div class="cell tag_remove_output docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="c1"># suppress log output for readability</span>
<span class="n">lgr</span><span class="o">::</span><span class="nf">get_logger</span><span class="p">(</span><span class="s">&quot;bbotk&quot;</span><span class="p">)</span><span class="o">$</span><span class="nf">set_threshold</span><span class="p">(</span><span class="s">&quot;warn&quot;</span><span class="p">)</span>
<span class="n">lgr</span><span class="o">::</span><span class="nf">get_logger</span><span class="p">(</span><span class="s">&quot;mlr3&quot;</span><span class="p">)</span><span class="o">$</span><span class="nf">set_threshold</span><span class="p">(</span><span class="s">&quot;warn&quot;</span><span class="p">)</span>


<span class="n">tuner</span><span class="o">$</span><span class="nf">optimize</span><span class="p">(</span><span class="n">instance_rpart</span><span class="p">)</span>

<span class="c1"># restart log output</span>
<span class="n">lgr</span><span class="o">::</span><span class="nf">get_logger</span><span class="p">(</span><span class="s">&quot;bbotk&quot;</span><span class="p">)</span><span class="o">$</span><span class="nf">set_threshold</span><span class="p">(</span><span class="s">&quot;info&quot;</span><span class="p">)</span>
<span class="n">lgr</span><span class="o">::</span><span class="nf">get_logger</span><span class="p">(</span><span class="s">&quot;mlr3&quot;</span><span class="p">)</span><span class="o">$</span><span class="nf">set_threshold</span><span class="p">(</span><span class="s">&quot;info&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>The parameters in the best fit may be accessed here:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="nf">print</span><span class="p">(</span><span class="n">instance_rpart</span><span class="o">$</span><span class="n">result_learner_param_vals</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>$xval
[1] 0

$cp
[1] 0.001

$minsplit
[1] 3
</pre></div>
</div>
</div>
</div>
<p>So we can now fit a final model to all the data using these optimised parameters.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">lrn_rpart_tuned</span> <span class="o">&lt;-</span> <span class="nf">lrn</span><span class="p">(</span><span class="s">&quot;regr.rpart&quot;</span><span class="p">)</span>
<span class="n">lrn_rpart_tuned</span><span class="o">$</span><span class="n">param_set</span><span class="o">$</span><span class="n">values</span> <span class="o">=</span> <span class="n">instance_rpart</span><span class="o">$</span><span class="n">result_learner_param_vals</span>
<span class="n">lrn_rpart_tuned</span><span class="o">$</span><span class="nf">train</span><span class="p">(</span><span class="n">task</span><span class="p">)</span>  

<span class="c1"># plot the model</span>
<span class="n">rpart.plot</span><span class="o">::</span><span class="nf">rpart.plot</span><span class="p">(</span><span class="n">lrn_rpart_tuned</span><span class="o">$</span><span class="n">model</span><span class="p">,</span> <span class="n">roundint</span> <span class="o">=</span> <span class="kc">FALSE</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/MLRWP_R_mlr3_84_0.png" src="../_images/MLRWP_R_mlr3_84_0.png" />
</div>
</div>
<p>This model is much more complicated than the original and looks overfitted - we’ll see if this is the case when we evaluate the model performance later in the article.</p>
</div>
</div>
<div class="section" id="random-forest-fitting">
<h2>Random forest fitting<a class="headerlink" href="#random-forest-fitting" title="Permalink to this headline">¶</a></h2>
<p>The <strong>ranger</strong> random forest package is implemented in <strong>mlr3learners</strong> (the regression version is <code class="docutils literal notranslate"><span class="pre">regr.ranger</span></code>).</p>
<p>Let’s have a look at the hyper-parameters.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="nf">lrn</span><span class="p">(</span><span class="s">&quot;regr.ranger&quot;</span><span class="p">)</span><span class="o">$</span><span class="n">param_set</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;ParamSet&gt;
                              id    class lower upper nlevels        default
 1:                        alpha ParamDbl  -Inf   Inf     Inf            0.5
 2:       always.split.variables ParamUty    NA    NA     Inf &lt;NoDefault[3]&gt;
 3:                      holdout ParamLgl    NA    NA       2          FALSE
 4:                   importance ParamFct    NA    NA       4 &lt;NoDefault[3]&gt;
 5:                   keep.inbag ParamLgl    NA    NA       2          FALSE
 6:                    max.depth ParamInt  -Inf   Inf     Inf               
 7:                min.node.size ParamInt     1   Inf     Inf              5
 8:                     min.prop ParamDbl  -Inf   Inf     Inf            0.1
 9:                      minprop ParamDbl  -Inf   Inf     Inf            0.1
10:                         mtry ParamInt     1   Inf     Inf &lt;NoDefault[3]&gt;
11:            num.random.splits ParamInt     1   Inf     Inf              1
12:                  num.threads ParamInt     1   Inf     Inf              1
13:                    num.trees ParamInt     1   Inf     Inf            500
14:                    oob.error ParamLgl    NA    NA       2           TRUE
15:                     quantreg ParamLgl    NA    NA       2          FALSE
16:        regularization.factor ParamUty    NA    NA     Inf              1
17:      regularization.usedepth ParamLgl    NA    NA       2          FALSE
18:                      replace ParamLgl    NA    NA       2           TRUE
19:    respect.unordered.factors ParamFct    NA    NA       3         ignore
20:              sample.fraction ParamDbl     0     1     Inf &lt;NoDefault[3]&gt;
21:                  save.memory ParamLgl    NA    NA       2          FALSE
22: scale.permutation.importance ParamLgl    NA    NA       2          FALSE
23:                    se.method ParamFct    NA    NA       2        infjack
24:                         seed ParamInt  -Inf   Inf     Inf               
25:         split.select.weights ParamDbl     0     1     Inf &lt;NoDefault[3]&gt;
26:                    splitrule ParamFct    NA    NA       3       variance
27:                      verbose ParamLgl    NA    NA       2           TRUE
28:                 write.forest ParamLgl    NA    NA       2           TRUE
                              id    class lower upper nlevels        default
       parents value
 1:  splitrule      
 2:                 
 3:                 
 4:                 
 5:                 
 6:                 
 7:                 
 8:                 
 9:  splitrule      
10:                 
11:  splitrule      
12:                1
13:                 
14:                 
15:                 
16:                 
17:                 
18:                 
19:                 
20:                 
21:                 
22: importance      
23:                 
24:                 
25:                 
26:                 
27:                 
28:                 
       parents value
</pre></div>
</div>
</div>
</div>
<p>Here, we’ll try tuning number of trees (<code class="docutils literal notranslate"><span class="pre">num.trees</span></code>) and the minimum node size (<code class="docutils literal notranslate"><span class="pre">min.node.size</span></code>). <code class="docutils literal notranslate"><span class="pre">max.depth</span></code>, <code class="docutils literal notranslate"><span class="pre">mtry</span></code> and <code class="docutils literal notranslate"><span class="pre">sample.fraction</span></code> are also often helpful to tune.</p>
<p>We’ll follow the same steps as for decision trees - set up a parameter space for searching, combine this with RMSE and cross-validation and then tune using grid search.</p>
<div class="cell tag_remove_output docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">tune_ps_ranger</span> <span class="o">&lt;-</span> <span class="nf">ps</span><span class="p">(</span>
  <span class="n">num.trees</span> <span class="o">=</span> <span class="nf">p_int</span><span class="p">(</span><span class="n">lower</span> <span class="o">=</span> <span class="m">100</span><span class="p">,</span> <span class="n">upper</span> <span class="o">=</span> <span class="m">900</span><span class="p">),</span>
  <span class="n">min.node.size</span> <span class="o">=</span> <span class="nf">p_int</span><span class="p">(</span><span class="n">lower</span> <span class="o">=</span> <span class="m">1</span><span class="p">,</span> <span class="n">upper</span> <span class="o">=</span> <span class="m">5</span><span class="p">)</span>
<span class="p">)</span>

<span class="c1"># to see what&#39;s searched if we set a grid of 5</span>
<span class="c1">#rbindlist(generate_design_grid(tune_ps_ranger, 5)$transpose())</span>

<span class="n">instance_ranger</span> <span class="o">&lt;-</span> <span class="n">TuningInstanceSingleCrit</span><span class="o">$</span><span class="nf">new</span><span class="p">(</span>
  <span class="n">task</span> <span class="o">=</span> <span class="n">task</span><span class="p">,</span>
  <span class="n">learner</span> <span class="o">=</span> <span class="nf">lrn</span><span class="p">(</span><span class="s">&quot;regr.ranger&quot;</span><span class="p">),</span>
  <span class="n">resampling</span> <span class="o">=</span> <span class="n">crossval</span><span class="p">,</span>
  <span class="n">measure</span> <span class="o">=</span> <span class="n">measure</span><span class="p">,</span>
  <span class="n">search_space</span> <span class="o">=</span> <span class="n">tune_ps_ranger</span><span class="p">,</span>
  <span class="n">terminator</span> <span class="o">=</span> <span class="n">evals_trm</span>
<span class="p">)</span>

<span class="c1"># suppress output</span>
<span class="n">lgr</span><span class="o">::</span><span class="nf">get_logger</span><span class="p">(</span><span class="s">&quot;bbotk&quot;</span><span class="p">)</span><span class="o">$</span><span class="nf">set_threshold</span><span class="p">(</span><span class="s">&quot;warn&quot;</span><span class="p">)</span>
<span class="n">lgr</span><span class="o">::</span><span class="nf">get_logger</span><span class="p">(</span><span class="s">&quot;mlr3&quot;</span><span class="p">)</span><span class="o">$</span><span class="nf">set_threshold</span><span class="p">(</span><span class="s">&quot;warn&quot;</span><span class="p">)</span>

<span class="c1">#We can reuse the tuner we set up for the decision tree</span>
<span class="c1">#this was tuner &lt;- tnr(&quot;grid_search&quot;, resolution = 5)</span>

<span class="n">tuner</span><span class="o">$</span><span class="nf">optimize</span><span class="p">(</span><span class="n">instance_ranger</span><span class="p">)</span>

<span class="c1"># turn output back on</span>
<span class="n">lgr</span><span class="o">::</span><span class="nf">get_logger</span><span class="p">(</span><span class="s">&quot;bbotk&quot;</span><span class="p">)</span><span class="o">$</span><span class="nf">set_threshold</span><span class="p">(</span><span class="s">&quot;info&quot;</span><span class="p">)</span>
<span class="n">lgr</span><span class="o">::</span><span class="nf">get_logger</span><span class="p">(</span><span class="s">&quot;mlr3&quot;</span><span class="p">)</span><span class="o">$</span><span class="nf">set_threshold</span><span class="p">(</span><span class="s">&quot;info&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Get the best fit</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="nf">print</span><span class="p">(</span><span class="n">instance_ranger</span><span class="o">$</span><span class="n">result_learner_param_vals</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>$num.threads
[1] 1

$num.trees
[1] 500

$min.node.size
[1] 3
</pre></div>
</div>
</div>
</div>
<p>Now we fit the model to all the parameters</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">lrn_ranger_tuned</span> <span class="o">&lt;-</span> <span class="nf">lrn</span><span class="p">(</span><span class="s">&quot;regr.ranger&quot;</span><span class="p">)</span>
<span class="n">lrn_ranger_tuned</span><span class="o">$</span><span class="n">param_set</span><span class="o">$</span><span class="n">values</span> <span class="o">=</span> <span class="n">instance_ranger</span><span class="o">$</span><span class="n">result_learner_param_vals</span>

<span class="n">lrn_ranger_tuned</span><span class="o">$</span><span class="nf">train</span><span class="p">(</span><span class="n">task</span><span class="p">)</span>  
<span class="n">lrn_ranger_tuned</span><span class="o">$</span><span class="n">model</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Ranger result

Call:
 ranger::ranger(dependent.variable.name = task$target_names, data = task$data(),      case.weights = task$weights$weight, num.threads = 1L, num.trees = 500L,      min.node.size = 3L) 

Type:                             Regression 
Number of trees:                  500 
Sample size:                      820 
Number of independent variables:  3 
Mtry:                             1 
Target node size:                 3 
Variable importance mode:         none 
Splitrule:                        variance 
OOB prediction error (MSE):       14273383385093214 
R squared (OOB):                  0.9223578 
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="xgboost">
<h2>XGBoost<a class="headerlink" href="#xgboost" title="Permalink to this headline">¶</a></h2>
<p>Here are the XGBoost parameters.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="c1"># Can just run</span>
<span class="c1"># lrn(&quot;regr.xgboost&quot;)$param_set</span>

<span class="c1"># the code below just removes some of the columns for display purposes</span>

<span class="nf">kable_styling</span><span class="p">(</span>
  <span class="nf">kable</span><span class="p">(</span><span class="nf">as.data.table</span><span class="p">(</span><span class="nf">lrn</span><span class="p">(</span><span class="s">&quot;regr.xgboost&quot;</span><span class="p">)</span><span class="o">$</span><span class="n">param_set</span><span class="p">)[,</span> <span class="nf">.</span><span class="p">(</span><span class="n">id</span><span class="p">,</span> <span class="n">class</span><span class="p">,</span> <span class="n">default</span><span class="p">)]),</span>
  <span class="n">full_width</span> <span class="o">=</span> <span class="kc">FALSE</span><span class="p">)</span> <span class="o">%&gt;%</span>
  <span class="nf">as.character</span><span class="p">()</span> <span class="o">%&gt;%</span>
  <span class="nf">display_html</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><table class="table" style="width: auto !important; margin-left: auto; margin-right: auto;">
 <thead>
  <tr>
   <th style="text-align:left;"> id </th>
   <th style="text-align:left;"> class </th>
   <th style="text-align:left;"> default </th>
  </tr>
 </thead>
<tbody>
  <tr>
   <td style="text-align:left;"> booster </td>
   <td style="text-align:left;"> ParamFct </td>
   <td style="text-align:left;"> gbtree </td>
  </tr>
  <tr>
   <td style="text-align:left;"> watchlist </td>
   <td style="text-align:left;"> ParamUty </td>
   <td style="text-align:left;"> NULL </td>
  </tr>
  <tr>
   <td style="text-align:left;"> eta </td>
   <td style="text-align:left;"> ParamDbl </td>
   <td style="text-align:left;"> 0.3 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> gamma </td>
   <td style="text-align:left;"> ParamDbl </td>
   <td style="text-align:left;"> 0 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> max_depth </td>
   <td style="text-align:left;"> ParamInt </td>
   <td style="text-align:left;"> 6 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> min_child_weight </td>
   <td style="text-align:left;"> ParamDbl </td>
   <td style="text-align:left;"> 1 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> subsample </td>
   <td style="text-align:left;"> ParamDbl </td>
   <td style="text-align:left;"> 1 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> colsample_bytree </td>
   <td style="text-align:left;"> ParamDbl </td>
   <td style="text-align:left;"> 1 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> colsample_bylevel </td>
   <td style="text-align:left;"> ParamDbl </td>
   <td style="text-align:left;"> 1 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> colsample_bynode </td>
   <td style="text-align:left;"> ParamDbl </td>
   <td style="text-align:left;"> 1 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> num_parallel_tree </td>
   <td style="text-align:left;"> ParamInt </td>
   <td style="text-align:left;"> 1 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> lambda </td>
   <td style="text-align:left;"> ParamDbl </td>
   <td style="text-align:left;"> 1 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> lambda_bias </td>
   <td style="text-align:left;"> ParamDbl </td>
   <td style="text-align:left;"> 0 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> alpha </td>
   <td style="text-align:left;"> ParamDbl </td>
   <td style="text-align:left;"> 0 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> objective </td>
   <td style="text-align:left;"> ParamUty </td>
   <td style="text-align:left;"> reg:linear </td>
  </tr>
  <tr>
   <td style="text-align:left;"> eval_metric </td>
   <td style="text-align:left;"> ParamUty </td>
   <td style="text-align:left;"> rmse </td>
  </tr>
  <tr>
   <td style="text-align:left;"> base_score </td>
   <td style="text-align:left;"> ParamDbl </td>
   <td style="text-align:left;"> 0.5 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> max_delta_step </td>
   <td style="text-align:left;"> ParamDbl </td>
   <td style="text-align:left;"> 0 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> missing </td>
   <td style="text-align:left;"> ParamDbl </td>
   <td style="text-align:left;"> NA </td>
  </tr>
  <tr>
   <td style="text-align:left;"> monotone_constraints </td>
   <td style="text-align:left;"> ParamInt </td>
   <td style="text-align:left;"> 0 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> tweedie_variance_power </td>
   <td style="text-align:left;"> ParamDbl </td>
   <td style="text-align:left;"> 1.5 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> nthread </td>
   <td style="text-align:left;"> ParamInt </td>
   <td style="text-align:left;"> 1 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> nrounds </td>
   <td style="text-align:left;"> ParamInt </td>
   <td style="text-align:left;"> &lt;environment: 0x7fe606ea60a8&gt; </td>
  </tr>
  <tr>
   <td style="text-align:left;"> feval </td>
   <td style="text-align:left;"> ParamUty </td>
   <td style="text-align:left;"> NULL </td>
  </tr>
  <tr>
   <td style="text-align:left;"> verbose </td>
   <td style="text-align:left;"> ParamInt </td>
   <td style="text-align:left;"> 1 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> print_every_n </td>
   <td style="text-align:left;"> ParamInt </td>
   <td style="text-align:left;"> 1 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> early_stopping_rounds </td>
   <td style="text-align:left;"> ParamInt </td>
   <td style="text-align:left;"> NULL </td>
  </tr>
  <tr>
   <td style="text-align:left;"> maximize </td>
   <td style="text-align:left;"> ParamLgl </td>
   <td style="text-align:left;"> NULL </td>
  </tr>
  <tr>
   <td style="text-align:left;"> sample_type </td>
   <td style="text-align:left;"> ParamFct </td>
   <td style="text-align:left;"> uniform </td>
  </tr>
  <tr>
   <td style="text-align:left;"> normalize_type </td>
   <td style="text-align:left;"> ParamFct </td>
   <td style="text-align:left;"> tree </td>
  </tr>
  <tr>
   <td style="text-align:left;"> rate_drop </td>
   <td style="text-align:left;"> ParamDbl </td>
   <td style="text-align:left;"> 0 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> skip_drop </td>
   <td style="text-align:left;"> ParamDbl </td>
   <td style="text-align:left;"> 0 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> one_drop </td>
   <td style="text-align:left;"> ParamLgl </td>
   <td style="text-align:left;"> FALSE </td>
  </tr>
  <tr>
   <td style="text-align:left;"> tree_method </td>
   <td style="text-align:left;"> ParamFct </td>
   <td style="text-align:left;"> auto </td>
  </tr>
  <tr>
   <td style="text-align:left;"> grow_policy </td>
   <td style="text-align:left;"> ParamFct </td>
   <td style="text-align:left;"> depthwise </td>
  </tr>
  <tr>
   <td style="text-align:left;"> max_leaves </td>
   <td style="text-align:left;"> ParamInt </td>
   <td style="text-align:left;"> 0 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> max_bin </td>
   <td style="text-align:left;"> ParamInt </td>
   <td style="text-align:left;"> 256 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> callbacks </td>
   <td style="text-align:left;"> ParamUty </td>
   <td style="text-align:left;"> NULL </td>
  </tr>
  <tr>
   <td style="text-align:left;"> sketch_eps </td>
   <td style="text-align:left;"> ParamDbl </td>
   <td style="text-align:left;"> 0.03 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> scale_pos_weight </td>
   <td style="text-align:left;"> ParamDbl </td>
   <td style="text-align:left;"> 1 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> updater </td>
   <td style="text-align:left;"> ParamUty </td>
   <td style="text-align:left;"> &lt;environment: 0x7fe5f4390ef0&gt; </td>
  </tr>
  <tr>
   <td style="text-align:left;"> refresh_leaf </td>
   <td style="text-align:left;"> ParamLgl </td>
   <td style="text-align:left;"> TRUE </td>
  </tr>
  <tr>
   <td style="text-align:left;"> feature_selector </td>
   <td style="text-align:left;"> ParamFct </td>
   <td style="text-align:left;"> cyclic </td>
  </tr>
  <tr>
   <td style="text-align:left;"> top_k </td>
   <td style="text-align:left;"> ParamInt </td>
   <td style="text-align:left;"> 0 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> predictor </td>
   <td style="text-align:left;"> ParamFct </td>
   <td style="text-align:left;"> cpu_predictor </td>
  </tr>
  <tr>
   <td style="text-align:left;"> save_period </td>
   <td style="text-align:left;"> ParamInt </td>
   <td style="text-align:left;"> NULL </td>
  </tr>
  <tr>
   <td style="text-align:left;"> save_name </td>
   <td style="text-align:left;"> ParamUty </td>
   <td style="text-align:left;"> NULL </td>
  </tr>
  <tr>
   <td style="text-align:left;"> xgb_model </td>
   <td style="text-align:left;"> ParamUty </td>
   <td style="text-align:left;"> NULL </td>
  </tr>
  <tr>
   <td style="text-align:left;"> interaction_constraints </td>
   <td style="text-align:left;"> ParamUty </td>
   <td style="text-align:left;"> &lt;environment: 0x7fe5fa9f8728&gt; </td>
  </tr>
  <tr>
   <td style="text-align:left;"> outputmargin </td>
   <td style="text-align:left;"> ParamLgl </td>
   <td style="text-align:left;"> FALSE </td>
  </tr>
  <tr>
   <td style="text-align:left;"> ntreelimit </td>
   <td style="text-align:left;"> ParamInt </td>
   <td style="text-align:left;"> NULL </td>
  </tr>
  <tr>
   <td style="text-align:left;"> predleaf </td>
   <td style="text-align:left;"> ParamLgl </td>
   <td style="text-align:left;"> FALSE </td>
  </tr>
  <tr>
   <td style="text-align:left;"> predcontrib </td>
   <td style="text-align:left;"> ParamLgl </td>
   <td style="text-align:left;"> FALSE </td>
  </tr>
  <tr>
   <td style="text-align:left;"> approxcontrib </td>
   <td style="text-align:left;"> ParamLgl </td>
   <td style="text-align:left;"> FALSE </td>
  </tr>
  <tr>
   <td style="text-align:left;"> predinteraction </td>
   <td style="text-align:left;"> ParamLgl </td>
   <td style="text-align:left;"> FALSE </td>
  </tr>
  <tr>
   <td style="text-align:left;"> reshape </td>
   <td style="text-align:left;"> ParamLgl </td>
   <td style="text-align:left;"> FALSE </td>
  </tr>
  <tr>
   <td style="text-align:left;"> training </td>
   <td style="text-align:left;"> ParamLgl </td>
   <td style="text-align:left;"> FALSE </td>
  </tr>
</tbody>
</table></div></div>
</div>
<p>With gradient boosting, it is often helpful to optimise over hyper-parameters, so we will vary some parameters and select the best performing set.
For speed reasons we will just consider <code class="docutils literal notranslate"><span class="pre">tweedie_variance_power</span></code>, <code class="docutils literal notranslate"><span class="pre">eta</span></code>, <code class="docutils literal notranslate"><span class="pre">max_depth</span></code> , and <code class="docutils literal notranslate"><span class="pre">nrounds</span></code> but in practice, we could consider doing more.</p>
<p>The steps are the generally same as before for decision trees and random forests.
However as we are searching over a greater number of parameters, we’ve switched to a random search to try to achieve better results.
Depending on your computer, this step takes a while to run (since our terminator is 500 evaluations) - so it might be a good point to grab a cup of coffee or tea! Alternatively reduce the number of evaluations in <code class="docutils literal notranslate"><span class="pre">eval_trm</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">tune_ps_xgboost</span> <span class="o">&lt;-</span> <span class="nf">ps</span><span class="p">(</span>
  <span class="c1"># ensure non-negative values</span>
  <span class="n">objective</span> <span class="o">=</span> <span class="nf">p_fct</span><span class="p">(</span><span class="s">&quot;reg:tweedie&quot;</span><span class="p">),</span>
  <span class="n">tweedie_variance_power</span> <span class="o">=</span> <span class="nf">p_dbl</span><span class="p">(</span><span class="n">lower</span> <span class="o">=</span> <span class="m">1.01</span><span class="p">,</span> <span class="n">upper</span> <span class="o">=</span> <span class="m">1.99</span><span class="p">),</span>

  <span class="c1"># eta can be up to 1, but usually it is better to use low eta, and tune nrounds for a more fine-grained model</span>
  <span class="n">eta</span> <span class="o">=</span> <span class="nf">p_dbl</span><span class="p">(</span><span class="n">lower</span> <span class="o">=</span> <span class="m">0.01</span><span class="p">,</span> <span class="n">upper</span> <span class="o">=</span> <span class="m">0.3</span><span class="p">),</span>
  <span class="c1"># select value for gamma</span>
  <span class="c1"># tuning can help overfitting but we don&#39;t investigate this here</span>
  <span class="n">gamma</span> <span class="o">=</span> <span class="nf">p_dbl</span><span class="p">(</span><span class="n">lower</span> <span class="o">=</span> <span class="m">0</span><span class="p">,</span> <span class="n">upper</span> <span class="o">=</span> <span class="m">0</span><span class="p">),</span>

  <span class="c1"># We know that the problem is not that deep in interactivity so we search a low depth</span>
  <span class="n">max_depth</span> <span class="o">=</span> <span class="nf">p_int</span><span class="p">(</span><span class="n">lower</span> <span class="o">=</span> <span class="m">2</span><span class="p">,</span> <span class="n">upper</span> <span class="o">=</span> <span class="m">6</span><span class="p">),</span>

  <span class="c1"># nrounds to stop overfitting</span>
  <span class="n">nrounds</span> <span class="o">=</span> <span class="nf">p_int</span><span class="p">(</span><span class="n">lower</span> <span class="o">=</span> <span class="m">100</span><span class="p">,</span> <span class="n">upper</span> <span class="o">=</span> <span class="m">500</span><span class="p">)</span>
<span class="p">)</span>

<span class="n">instance_xgboost</span> <span class="o">&lt;-</span> <span class="n">TuningInstanceSingleCrit</span><span class="o">$</span><span class="nf">new</span><span class="p">(</span>
  <span class="n">task</span> <span class="o">=</span> <span class="n">task</span><span class="p">,</span>
  <span class="n">learner</span> <span class="o">=</span> <span class="nf">lrn</span><span class="p">(</span><span class="s">&quot;regr.xgboost&quot;</span><span class="p">),</span>
  <span class="n">resampling</span> <span class="o">=</span> <span class="n">crossval</span><span class="p">,</span>
  <span class="n">measure</span> <span class="o">=</span> <span class="n">measure</span><span class="p">,</span>
  <span class="n">search_space</span> <span class="o">=</span> <span class="n">tune_ps_xgboost</span><span class="p">,</span>
  <span class="n">terminator</span> <span class="o">=</span> <span class="n">evals_trm</span>
<span class="p">)</span>

<span class="c1"># need to make a new tuner with resolution 4</span>
<span class="c1">#tuner &lt;- tnr(&quot;grid_search&quot;, resolution = 4)</span>
<span class="nf">set.seed</span><span class="p">(</span><span class="m">84</span><span class="p">)</span>  <span class="c1"># for random search for reproducibility</span>
<span class="n">tuner</span> <span class="o">&lt;-</span> <span class="nf">tnr</span><span class="p">(</span><span class="s">&quot;random_search&quot;</span><span class="p">)</span>

<span class="n">lgr</span><span class="o">::</span><span class="nf">get_logger</span><span class="p">(</span><span class="s">&quot;bbotk&quot;</span><span class="p">)</span><span class="o">$</span><span class="nf">set_threshold</span><span class="p">(</span><span class="s">&quot;warn&quot;</span><span class="p">)</span>
<span class="n">lgr</span><span class="o">::</span><span class="nf">get_logger</span><span class="p">(</span><span class="s">&quot;mlr3&quot;</span><span class="p">)</span><span class="o">$</span><span class="nf">set_threshold</span><span class="p">(</span><span class="s">&quot;warn&quot;</span><span class="p">)</span>

<span class="n">time_bef</span> <span class="o">&lt;-</span> <span class="nf">Sys.time</span><span class="p">()</span>
<span class="n">tuner</span><span class="o">$</span><span class="nf">optimize</span><span class="p">(</span><span class="n">instance_xgboost</span><span class="p">)</span>

<span class="n">lgr</span><span class="o">::</span><span class="nf">get_logger</span><span class="p">(</span><span class="s">&quot;bbotk&quot;</span><span class="p">)</span><span class="o">$</span><span class="nf">set_threshold</span><span class="p">(</span><span class="s">&quot;info&quot;</span><span class="p">)</span>
<span class="n">lgr</span><span class="o">::</span><span class="nf">get_logger</span><span class="p">(</span><span class="s">&quot;mlr3&quot;</span><span class="p">)</span><span class="o">$</span><span class="nf">set_threshold</span><span class="p">(</span><span class="s">&quot;info&quot;</span><span class="p">)</span>


<span class="nf">Sys.time</span><span class="p">()</span> <span class="o">-</span> <span class="n">time_bef</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><table class="dataframe">
<caption>A data.table: 1 × 9</caption>
<thead>
	<tr><th scope=col>objective</th><th scope=col>tweedie_variance_power</th><th scope=col>eta</th><th scope=col>gamma</th><th scope=col>max_depth</th><th scope=col>nrounds</th><th scope=col>learner_param_vals</th><th scope=col>x_domain</th><th scope=col>regr.rmse</th></tr>
	<tr><th scope=col>&lt;chr&gt;</th><th scope=col>&lt;dbl&gt;</th><th scope=col>&lt;dbl&gt;</th><th scope=col>&lt;dbl&gt;</th><th scope=col>&lt;int&gt;</th><th scope=col>&lt;int&gt;</th><th scope=col>&lt;list&gt;</th><th scope=col>&lt;list&gt;</th><th scope=col>&lt;dbl&gt;</th></tr>
</thead>
<tbody>
	<tr><td>reg:tweedie</td><td>1.555728</td><td>0.1107844</td><td>0</td><td>4</td><td>467</td><td>467              , 1                , 0                , reg:tweedie      , 1.55572789821774 , 0.110784432103392, 0                , 4                </td><td>reg:tweedie      , 1.55572789821774 , 0.110784432103392, 0                , 4                , 467              </td><td>80517695</td></tr>
</tbody>
</table>
</div><div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Time difference of 34.90743 secs
</pre></div>
</div>
</div>
</div>
<p>Get the best fit:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="nf">print</span><span class="p">(</span><span class="n">instance_xgboost</span><span class="o">$</span><span class="n">result_learner_param_vals</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>$nrounds
[1] 467

$nthread
[1] 1

$verbose
[1] 0

$objective
[1] &quot;reg:tweedie&quot;

$tweedie_variance_power
[1] 1.555728

$eta
[1] 0.1107844

$gamma
[1] 0

$max_depth
[1] 4
</pre></div>
</div>
</div>
</div>
<p>However, remember that these results are from 25 evaluations only, and with 4 hyper-parameters, we’d really like to use more evaluations. The model above isn’t a particularly good one</p>
<p>The table below shows the results we got from 500 evaluations along with the results we got in earlier development work for this article (the hyper-parameter tuning results are subject to randomness, first due to the specification of the cross-validation folds and second due to the random search). We’ll use these when looking at the model.</p>
<div class="cell tag_remove_input docutils container">
<div class="cell_output docutils container">
<div class="output text_html"><table class="table" style="width: auto !important; margin-left: auto; margin-right: auto;">
 <thead>
  <tr>
   <th style="text-align:left;"> Hyperparameter </th>
   <th style="text-align:left;"> Evals500 </th>
   <th style="text-align:left;"> Best </th>
  </tr>
 </thead>
<tbody>
  <tr>
   <td style="text-align:left;"> nrounds </td>
   <td style="text-align:left;"> 265 </td>
   <td style="text-align:left;"> 233 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> tweedie_variance_power </td>
   <td style="text-align:left;"> 1.011768 </td>
   <td style="text-align:left;"> 1.01 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> eta </td>
   <td style="text-align:left;"> 0.2310797 </td>
   <td style="text-align:left;"> 0.3 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> gamma[fixed] </td>
   <td style="text-align:left;"> 0 </td>
   <td style="text-align:left;"> 0 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> max_depth </td>
   <td style="text-align:left;"> 3 </td>
   <td style="text-align:left;"> 3 </td>
  </tr>
</tbody>
</table></div></div>
</div>
<p>We’ll fit both models here:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">lrn_xgboost_tuned</span></code> - the results found from running the tuning code with 500 evaluations</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">lrn_xgboost_prevtuned</span></code> - the best results we found in previous work</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">lrn_xgboost_prevtuned</span> <span class="o">=</span> <span class="nf">lrn</span><span class="p">(</span><span class="s">&quot;regr.xgboost&quot;</span><span class="p">,</span> <span class="n">objective</span><span class="o">=</span><span class="s">&quot;reg:tweedie&quot;</span><span class="p">,</span> <span class="n">nrounds</span><span class="o">=</span><span class="m">233</span><span class="p">,</span>
                            <span class="n">tweedie_variance_power</span><span class="o">=</span><span class="m">1.01</span><span class="p">,</span> <span class="n">eta</span><span class="o">=</span><span class="m">0.3</span><span class="p">,</span> <span class="n">gamma</span><span class="o">=</span><span class="m">0</span><span class="p">,</span> <span class="n">max_depth</span><span class="o">=</span><span class="m">3</span><span class="p">)</span>
<span class="n">lrn_xgboost_prevtuned</span><span class="o">$</span><span class="nf">train</span><span class="p">(</span><span class="n">task</span><span class="p">)</span>


<span class="n">lrn_xgboost_tuned</span> <span class="o">=</span> <span class="nf">lrn</span><span class="p">(</span><span class="s">&quot;regr.xgboost&quot;</span><span class="p">,</span> <span class="n">objective</span><span class="o">=</span><span class="s">&quot;reg:tweedie&quot;</span><span class="p">,</span> <span class="n">nrounds</span><span class="o">=</span><span class="m">265</span><span class="p">,</span>
                            <span class="n">tweedie_variance_power</span><span class="o">=</span><span class="m">1.011768</span><span class="p">,</span> <span class="n">eta</span><span class="o">=</span><span class="m">0.2310797</span><span class="p">,</span> <span class="n">gamma</span><span class="o">=</span><span class="m">0</span><span class="p">,</span> <span class="n">max_depth</span><span class="o">=</span><span class="m">3</span><span class="p">)</span>
<span class="n">lrn_xgboost_tuned</span><span class="o">$</span><span class="nf">train</span><span class="p">(</span><span class="n">task</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>If, instead, you would like to fit the XGBoost model found after 25 evaluations, you can use the code below to pick up the selected values after tuning. This replaces the model fitted above using the hyper-parameters found after 500 evaluations.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">lrn_xgboost_tuned</span> <span class="o">=</span> <span class="nf">lrn</span><span class="p">(</span><span class="s">&quot;regr.xgboost&quot;</span><span class="p">)</span>
<span class="n">lrn_xgboost_tuned</span><span class="o">$</span><span class="n">param_set</span><span class="o">$</span><span class="n">values</span> <span class="o">=</span> <span class="n">instance_xgboost</span><span class="o">$</span><span class="n">result_learner_param_vals</span>
<span class="n">lrn_xgboost_tuned</span><span class="o">$</span><span class="nf">train</span><span class="p">(</span><span class="n">task</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>We haven’t run this code so our <code class="docutils literal notranslate"><span class="pre">lrn_xgboost_tuned</span></code> uses the 500 evaluations results.</p>
</div>
<div class="section" id="consolidate-results">
<h2>Consolidate results<a class="headerlink" href="#consolidate-results" title="Permalink to this headline">¶</a></h2>
<p>Now we will consolidate results for these models. We will gather together:</p>
<ul class="simple">
<li><p>RMSE for past and future data</p></li>
<li><p>predictions for each model.</p></li>
</ul>
<p>Note that <strong>mlr3</strong> has various benchmarking tools which we haven’t used here - partially because we want to focus on the concepts rather than the code and partially because we want to compare the results to a couple of other models not fitted in the same framework. If you’re interested in learning more then the section on <a class="reference external" href="https://mlr3book.mlr-org.com/benchmarking.html">benchmarking</a> in the mlr3 book is a good start.
<a class="reference external" href="https://mlr3book.mlr-org.com/pipelines.html">Pipelines</a> offer more flexible functionality too.</p>
<p>First, we’ll set up a data.table to hold the model projections for each model and populate these projections for each model</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="c1"># make a new copy of the data, deleting the row_id, accf and devf columns</span>
<span class="n">model_forecasts</span> <span class="o">&lt;-</span> <span class="nf">copy</span><span class="p">(</span><span class="n">dat</span><span class="p">)[,</span> <span class="nf">c</span><span class="p">(</span><span class="s">&quot;row_id&quot;</span><span class="p">,</span> <span class="s">&quot;accf&quot;</span><span class="p">,</span> <span class="s">&quot;devf&quot;</span><span class="p">)</span> <span class="o">:=</span> <span class="kc">NULL</span><span class="p">]</span>

<span class="c1"># add the model projections - specify list of learners to use and their names</span>
<span class="n">lrnrs</span> <span class="o">&lt;-</span> <span class="nf">c</span><span class="p">(</span><span class="n">lrn_rpart_tuned</span><span class="p">,</span> <span class="n">lrn_ranger_tuned</span><span class="p">,</span> <span class="n">lrn_xgboost_tuned</span><span class="p">,</span> <span class="n">lrn_xgboost_prevtuned</span><span class="p">)</span>

<span class="c1"># the id property is used to name the variables - since we have 2 xgboosts, adjust id where necessary</span>
<span class="n">lrn_xgboost_prevtuned</span><span class="o">$</span><span class="n">id</span> <span class="o">&lt;-</span> <span class="s">&quot;regr.xgboost_prev&quot;</span>


<span class="nf">for</span><span class="p">(</span><span class="n">l</span> <span class="n">in</span> <span class="n">lrnrs</span><span class="p">){</span>
  <span class="c1">#learner$predict(task, row_ids) is how to get predicted values, returns 3 cols with preds in response</span>
  <span class="c1"># use row_ids to tell it to use entire data set, ie &quot;use&quot; and validation rows</span>
  <span class="c1">#model_forecasts[, (nl) := l$predict(task, row_ids=1:nrow(dat))$response]</span>

  <span class="n">model_forecasts</span><span class="p">[,</span> <span class="n">l</span><span class="o">$</span><span class="n">id</span> <span class="o">:=</span> <span class="n">l</span><span class="o">$</span><span class="nf">predict</span><span class="p">(</span><span class="n">task</span><span class="o">=</span><span class="n">task</span><span class="p">,</span> <span class="n">row_ids</span><span class="o">=</span><span class="m">1</span><span class="o">:</span><span class="nf">nrow</span><span class="p">(</span><span class="n">dat</span><span class="p">))</span><span class="o">$</span><span class="n">response</span><span class="p">]</span>
<span class="p">}</span>

<span class="nf">tail</span><span class="p">(</span><span class="n">model_forecasts</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><table class="dataframe">
<caption>A data.table: 6 × 10</caption>
<thead>
	<tr><th scope=col>pmts</th><th scope=col>acc</th><th scope=col>dev</th><th scope=col>cal</th><th scope=col>mu</th><th scope=col>train_ind</th><th scope=col>regr.rpart</th><th scope=col>regr.ranger</th><th scope=col>regr.xgboost</th><th scope=col>regr.xgboost_prev</th></tr>
	<tr><th scope=col>&lt;dbl&gt;</th><th scope=col>&lt;int&gt;</th><th scope=col>&lt;int&gt;</th><th scope=col>&lt;int&gt;</th><th scope=col>&lt;dbl&gt;</th><th scope=col>&lt;lgl&gt;</th><th scope=col>&lt;dbl&gt;</th><th scope=col>&lt;dbl&gt;</th><th scope=col>&lt;dbl&gt;</th><th scope=col>&lt;dbl&gt;</th></tr>
</thead>
<tbody>
	<tr><td>125261750</td><td>40</td><td>35</td><td>74</td><td>109039367</td><td>FALSE</td><td>3276251556</td><td>1039427724</td><td>2161421312</td><td>180676800</td></tr>
	<tr><td> 62657370</td><td>40</td><td>36</td><td>75</td><td> 82853302</td><td>FALSE</td><td>3276251556</td><td>1039394694</td><td>1662855296</td><td> 97294160</td></tr>
	<tr><td> 63467681</td><td>40</td><td>37</td><td>76</td><td> 62682720</td><td>FALSE</td><td>3276251556</td><td>1039474983</td><td>2963930368</td><td>228004720</td></tr>
	<tr><td> 26041979</td><td>40</td><td>38</td><td>77</td><td> 47227843</td><td>FALSE</td><td>3276251556</td><td>1039475232</td><td>1337462528</td><td>201791488</td></tr>
	<tr><td> 33947274</td><td>40</td><td>39</td><td>78</td><td> 35444881</td><td>FALSE</td><td>3276251556</td><td>1039563647</td><td> 458035488</td><td> 97800608</td></tr>
	<tr><td> 37258687</td><td>40</td><td>40</td><td>79</td><td> 26503298</td><td>FALSE</td><td>3276251556</td><td>1039497978</td><td> 458035488</td><td> 97800608</td></tr>
</tbody>
</table>
</div></div>
</div>
<p>Before we do any analysis, let’s fit a couple more models to compare these results against:</p>
<ul class="simple">
<li><p>a Chainladder model</p></li>
<li><p>a LASSO model</p></li>
</ul>
</div>
<div class="section" id="chainladder-the-baseline-model">
<h2>Chainladder - the baseline model<a class="headerlink" href="#chainladder-the-baseline-model" title="Permalink to this headline">¶</a></h2>
<p>Since this is a traditional triangle, it seems natural to compare any results to the Chainladder result. So here, we will get the predicted values and reserve estimate for the Chain ladder model.</p>
<p>It’s important to note that we will just use a volume-all Chainladder (i.e. include all periods in the estimation of the development factors) and will not attempt to impose any judgement over the results. In practice, of course, models like the Chainladder are often subject to additional analysis, reasonableness tests and manual assumption selections, so it’s likely the actual result would be different, perhaps significantly, from that returned here.</p>
<p>At the same time, no model, whether it be the Chainladder, or a more sophisticated ML model should be accepted without further testing, so on that basis, comparing Chainladder and ML results without modification is a reasonable thing to do. Better methods should require less human intervention to return a reasonable result.</p>
<div class="section" id="getting-the-chainladder-reserve-estimates">
<h3>Getting the Chainladder reserve estimates<a class="headerlink" href="#getting-the-chainladder-reserve-estimates" title="Permalink to this headline">¶</a></h3>
<p>The Chainladder reserve can also be calculated using a GLM with:</p>
<ul class="simple">
<li><p>Accident and development factors</p></li>
<li><p>The Poisson or over-dispersed Poisson distribution</p></li>
<li><p>The log link.</p></li>
</ul>
<p>We’ve used this method here as it’s easy to set up in R but practical work using the Chain ladder may be better done with a package like the <a class="reference external" href="https://cran.r-project.org/web/packages/ChainLadder/index.html">R ChainLadder package</a>.</p>
<p>The easiest way to do this is to work outside <strong>mlr3</strong> and use the <code class="docutils literal notranslate"><span class="pre">glm()</span></code> function directly - this is because our mlr3 <code class="docutils literal notranslate"><span class="pre">task</span></code> doesn’t contain <code class="docutils literal notranslate"><span class="pre">accf</span></code> and <code class="docutils literal notranslate"><span class="pre">devf</span></code>.</p>
<p>Here’s the code using <code class="docutils literal notranslate"><span class="pre">glm()</span></code> and the <code class="docutils literal notranslate"><span class="pre">predict()</span></code> method to add predicted values into <code class="docutils literal notranslate"><span class="pre">model_forecasts</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">cl</span> <span class="o">&lt;-</span> <span class="nf">glm</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">dat</span><span class="p">[</span><span class="n">train_ind</span><span class="o">==</span><span class="kc">TRUE</span><span class="p">,</span> <span class="nf">.</span><span class="p">(</span><span class="n">pmts</span><span class="p">,</span> <span class="n">accf</span><span class="p">,</span> <span class="n">devf</span><span class="p">)],</span> <span class="n">formula</span><span class="o">=</span><span class="n">pmts</span> <span class="o">~</span> <span class="n">accf</span> <span class="o">+</span> <span class="n">devf</span><span class="p">,</span> <span class="n">family</span><span class="o">=</span><span class="nf">quasipoisson</span><span class="p">(</span><span class="n">link</span><span class="o">=</span><span class="s">&quot;log&quot;</span><span class="p">))</span>
<span class="n">model_forecasts</span><span class="p">[,</span> <span class="s">&quot;regr.glm&quot;</span> <span class="o">:=</span> <span class="nf">predict</span><span class="p">(</span><span class="n">cl</span><span class="p">,</span> <span class="n">newdata</span><span class="o">=</span><span class="n">dat</span><span class="p">[,</span> <span class="nf">.</span><span class="p">(</span><span class="n">pmts</span><span class="p">,</span> <span class="n">accf</span><span class="p">,</span> <span class="n">devf</span><span class="p">)],</span> <span class="n">type</span><span class="o">=</span><span class="s">&quot;response&quot;</span><span class="p">)]</span>
</pre></div>
</div>
</div>
</div>
<p>It is possible to fit this in <strong>mlr3</strong> too - but as we need to create a new task, it’s easier to fit it directly uisng <code class="docutils literal notranslate"><span class="pre">glm()</span></code> as above. However, we’ve included the <strong>mlr3</strong> code below for those who are interested. There’s a good bit more code here since we need to set up a new task and a new learner.</p>
<p>It isn’t necessary to run this code (we haven’t used it below) but if you do, the end result will be that it recalculates the <code class="docutils literal notranslate"><span class="pre">regr.glm</span></code> variable in the <code class="docutils literal notranslate"><span class="pre">model_forecasts</span></code> data.table.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="c1">#-------------------------------------</span>
<span class="c1"># create a task with the factor versions of acc and dev [accf and devf] as the only features</span>
<span class="n">task_cl</span> <span class="o">&lt;-</span> <span class="n">TaskRegr</span><span class="o">$</span><span class="nf">new</span><span class="p">(</span><span class="n">id</span> <span class="o">=</span> <span class="s">&quot;reserves&quot;</span><span class="p">,</span>
                     <span class="n">backend</span> <span class="o">=</span> <span class="n">dat</span><span class="p">[,</span> <span class="nf">.</span><span class="p">(</span><span class="n">pmts</span><span class="p">,</span> <span class="n">train_ind</span><span class="p">,</span> <span class="n">row_id</span><span class="p">,</span> <span class="n">accf</span><span class="p">,</span> <span class="n">devf</span><span class="p">)],</span>
                     <span class="n">target</span> <span class="o">=</span> <span class="s">&quot;pmts&quot;</span><span class="p">)</span>

<span class="n">task_cl</span><span class="o">$</span><span class="nf">set_row_roles</span><span class="p">(</span><span class="n">dat</span><span class="p">[</span><span class="n">train_ind</span><span class="o">==</span><span class="kc">FALSE</span><span class="p">,</span> <span class="n">row_id</span><span class="p">],</span> <span class="n">roles</span><span class="o">=</span><span class="s">&quot;validation&quot;</span><span class="p">)</span>

<span class="n">task_cl</span><span class="o">$</span><span class="nf">set_col_roles</span><span class="p">(</span><span class="s">&quot;row_id&quot;</span><span class="p">,</span> <span class="n">roles</span><span class="o">=</span><span class="s">&quot;name&quot;</span><span class="p">)</span>

<span class="c1"># drop train_ind from the feature list</span>
<span class="n">task_cl</span><span class="o">$</span><span class="n">col_roles</span><span class="o">$</span><span class="n">feature</span> <span class="o">&lt;-</span> <span class="nf">setdiff</span><span class="p">(</span><span class="n">task_cl</span><span class="o">$</span><span class="n">feature_names</span><span class="p">,</span> <span class="s">&quot;train_ind&quot;</span><span class="p">)</span>  

<span class="n">task_cl</span>


<span class="c1">#-------------------------------------</span>
<span class="c1"># fit the GLM - no hyper-parameter tuning since we know exactly the type of model we want to fit</span>

<span class="n">lrn_glm</span> <span class="o">&lt;-</span> <span class="nf">lrn</span><span class="p">(</span><span class="s">&quot;regr.glm&quot;</span><span class="p">,</span> <span class="n">family</span><span class="o">=</span><span class="s">&quot;quasipoisson&quot;</span><span class="p">,</span> <span class="n">link</span><span class="o">=</span><span class="s">&quot;log&quot;</span><span class="p">)</span>
<span class="n">lrn_glm</span><span class="o">$</span><span class="nf">train</span><span class="p">(</span><span class="n">task_cl</span><span class="p">)</span>

<span class="nf">summary</span><span class="p">(</span><span class="n">lrn_glm</span><span class="o">$</span><span class="n">model</span><span class="p">)</span>


<span class="c1">#-------------------------------------</span>
<span class="c1"># add the predicted values to model_forecasts in the same way as we did for the other models.</span>

<span class="n">model_forecasts</span><span class="p">[,</span> <span class="n">lrn_glm</span><span class="o">$</span><span class="n">id</span> <span class="o">:=</span> <span class="n">lrn_glm</span><span class="o">$</span><span class="nf">predict</span><span class="p">(</span><span class="n">task</span><span class="o">=</span><span class="n">task_cl</span><span class="p">,</span> <span class="n">row_ids</span><span class="o">=</span><span class="m">1</span><span class="o">:</span><span class="nf">nrow</span><span class="p">(</span><span class="n">dat</span><span class="p">))</span><span class="o">$</span><span class="n">response</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;TaskRegr:reserves&gt; (820 x 3)
* Target: pmts
* Properties: -
* Features (2):
  - fct (2): accf, devf
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Call:
stats::glm(formula = formula, family = structure(list(family = &quot;quasipoisson&quot;, 
    link = &quot;log&quot;, linkfun = function (mu) 
    log(mu), linkinv = function (eta) 
    pmax(exp(eta), .Machine$double.eps), variance = function (mu) 
    mu, dev.resids = function (y, mu, wt) 
    {
        r &lt;- mu * wt
        p &lt;- which(y &gt; 0)
        r[p] &lt;- (wt * (y * log(y/mu) - (y - mu)))[p]
        2 * r
    }, aic = function (y, n, mu, wt, dev) 
    NA, mu.eta = function (eta) 
    pmax(exp(eta), .Machine$double.eps), initialize = expression(
        {
            if (any(y &lt; 0)) 
                stop(&quot;negative values not allowed for the &#39;quasiPoisson&#39; family&quot;)
            n &lt;- rep.int(1, nobs)
            mustart &lt;- y + 0.1
        }), validmu = function (mu) 
    all(is.finite(mu)) &amp;&amp; all(mu &gt; 0), valideta = function (eta) 
    TRUE), class = &quot;family&quot;), data = data)

Deviance Residuals: 
     Min        1Q    Median        3Q       Max  
-24314.2   -2132.8    -165.5    2197.1   29768.4  

Coefficients:
            Estimate Std. Error t value             Pr(&gt;|t|)    
(Intercept)  10.4872     1.5323   6.844  0.00000000001614275 ***
accf2         0.1081     0.1850   0.584             0.559170    
accf3         0.2943     0.1790   1.644             0.100514    
accf4         0.3142     0.1783   1.762             0.078428 .  
accf5         0.4975     0.1722   2.889             0.003979 ** 
accf6         0.3966     0.1757   2.257             0.024300 *  
accf7         0.5812     0.1697   3.425             0.000648 ***
accf8         0.7639     0.1646   4.641  0.00000409939508379 ***
accf9         0.8160     0.1634   4.993  0.00000074032195234 ***
accf10        0.9134     0.1612   5.666  0.00000002087163522 ***
accf11        1.0424     0.1585   6.577  0.00000000009061906 ***
accf12        1.0535     0.1584   6.649  0.00000000005719225 ***
accf13        1.2365     0.1550   7.976  0.00000000000000573 ***
accf14        1.3824     0.1527   9.052 &lt; 0.0000000000000002 ***
accf15        1.4433     0.1521   9.491 &lt; 0.0000000000000002 ***
accf16        1.6146     0.1499  10.772 &lt; 0.0000000000000002 ***
accf17        2.3237     0.1430  16.246 &lt; 0.0000000000000002 ***
accf18        2.5606     0.1418  18.061 &lt; 0.0000000000000002 ***
accf19        2.6943     0.1415  19.045 &lt; 0.0000000000000002 ***
accf20        2.7579     0.1418  19.446 &lt; 0.0000000000000002 ***
accf21        2.6739     0.1436  18.627 &lt; 0.0000000000000002 ***
accf22        2.6984     0.1439  18.755 &lt; 0.0000000000000002 ***
accf23        2.7328     0.1442  18.956 &lt; 0.0000000000000002 ***
accf24        2.6458     0.1455  18.178 &lt; 0.0000000000000002 ***
accf25        2.7457     0.1455  18.871 &lt; 0.0000000000000002 ***
accf26        2.6922     0.1471  18.307 &lt; 0.0000000000000002 ***
accf27        2.7095     0.1483  18.265 &lt; 0.0000000000000002 ***
accf28        2.7077     0.1502  18.027 &lt; 0.0000000000000002 ***
accf29        2.7094     0.1527  17.740 &lt; 0.0000000000000002 ***
accf30        2.7414     0.1557  17.604 &lt; 0.0000000000000002 ***
accf31        2.6494     0.1629  16.267 &lt; 0.0000000000000002 ***
accf32        2.6256     0.1715  15.309 &lt; 0.0000000000000002 ***
accf33        2.4901     0.1896  13.135 &lt; 0.0000000000000002 ***
accf34        2.4785     0.2129  11.643 &lt; 0.0000000000000002 ***
accf35        2.5877     0.2423  10.681 &lt; 0.0000000000000002 ***
accf36        2.5514     0.3109   8.207  0.00000000000000100 ***
accf37        2.3602     0.4825   4.891  0.00000122924893227 ***
accf38        2.5342     0.7375   3.436             0.000622 ***
accf39        1.9789     1.8093   1.094             0.274424    
accf40        4.9545     2.8473   1.740             0.082261 .  
devf2         3.5388     1.5474   2.287             0.022480 *  
devf3         4.5296     1.5342   2.952             0.003253 ** 
devf4         5.4969     1.5294   3.594             0.000347 ***
devf5         6.1708     1.5279   4.039  0.00005933339166295 ***
devf6         6.6198     1.5274   4.334  0.00001665091697208 ***
devf7         6.9726     1.5271   4.566  0.00000581983204682 ***
devf8         7.2391     1.5269   4.741  0.00000255053361356 ***
devf9         7.4043     1.5268   4.849  0.00000150962979881 ***
devf10        7.5380     1.5268   4.937  0.00000098014800147 ***
devf11        7.6510     1.5268   5.011  0.00000067710923359 ***
devf12        7.6877     1.5268   5.035  0.00000060002808556 ***
devf13        7.7021     1.5268   5.044  0.00000057258957465 ***
devf14        7.6716     1.5269   5.024  0.00000063396862220 ***
devf15        7.6869     1.5270   5.034  0.00000060323914182 ***
devf16        7.5844     1.5271   4.966  0.00000084691004024 ***
devf17        7.5124     1.5273   4.919  0.00000107303113279 ***
devf18        7.4058     1.5275   4.848  0.00000151766724153 ***
devf19        7.3588     1.5277   4.817  0.00000176877174392 ***
devf20        7.3692     1.5279   4.823  0.00000171603300934 ***
devf21        8.4294     1.5270   5.520  0.00000004683170363 ***
devf22        8.1591     1.5274   5.342  0.00000012242889926 ***
devf23        7.7736     1.5282   5.087  0.00000046187841181 ***
devf24        7.2492     1.5303   4.737  0.00000259778898791 ***
devf25        6.8566     1.5337   4.471  0.00000901569264533 ***
devf26        6.6937     1.5362   4.357  0.00001502151046845 ***
devf27        6.5551     1.5392   4.259  0.00002321246950917 ***
devf28        6.1211     1.5492   3.951  0.00008517947571658 ***
devf29        5.9212     1.5583   3.800             0.000157 ***
devf30        5.8001     1.5676   3.700             0.000232 ***
devf31        5.7787     1.5756   3.668             0.000262 ***
devf32        5.6027     1.5949   3.513             0.000470 ***
devf33        5.5602     1.6111   3.451             0.000590 ***
devf34        5.2985     1.6585   3.195             0.001458 ** 
devf35        4.7153     1.8032   2.615             0.009105 ** 
devf36        4.0068     2.1515   1.862             0.062949 .  
devf37        5.9215     1.6695   3.547             0.000414 ***
devf38        4.4492     2.2576   1.971             0.049121 *  
devf39        7.0278     1.6374   4.292  0.00002004314487218 ***
devf40        4.8165     2.9933   1.609             0.108024    
---
Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1

(Dispersion parameter for quasipoisson family taken to be 29283088)

    Null deviance: 362534258145  on 819  degrees of freedom
Residual deviance:  21654766145  on 741  degrees of freedom
AIC: NA

Number of Fisher Scoring iterations: 5
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="section" id="lasso-regularised-regression">
<h2>LASSO (regularised regression)<a class="headerlink" href="#lasso-regularised-regression" title="Permalink to this headline">¶</a></h2>
<p>Finally, we will use the LASSO to fit a model. We are going to fit the same model as we did in our previous <a class="reference external" href="https://institute-and-faculty-of-actuaries.github.io/mlr-blog/post/f-lasso/">post</a>. We’ll include a bare-bones description of the model here. If you haven’t seen it before, then you may want to just take the model as given and skip ahead to the next section. Once you’ve read this entire article you may then wish to read the post on the LASSO model to understand the specifics of this model.</p>
<p>The main things to note about this model are:</p>
<ul class="simple">
<li><p>Feature engineering is needed to produce continuous functions of accident / development / calendar quarters for the LASSO to fit.</p></li>
<li><p>The blog post and related paper detail how to do this - essentially we create a large group of basis functions from the primary <code class="docutils literal notranslate"><span class="pre">acc</span></code>, <code class="docutils literal notranslate"><span class="pre">dev</span></code> and <code class="docutils literal notranslate"><span class="pre">cal</span></code> variables that are flexible enough to capture a wide variety of shapes.</p></li>
<li><p>If we want to use <strong>mlr3</strong> to do this, then we need to create a task that contains these basis functions as features.</p></li>
<li><p>Cross-validation can be done within the underlying LASSO package (<strong>glmnet</strong>) rather than via <strong>mlr3</strong>. This is what we’ve done here.</p></li>
</ul>
<p>There’s a reasonable amount of code to run this model, whether we use <strong>mlr3</strong> or not:</p>
<ul class="simple">
<li><p>We need to create all the basis functions</p></li>
<li><p><strong>mlr3</strong> only - we need to set up a task</p></li>
<li><p>We need to train the model using <strong>glmnet</strong>’s cross-validation function, <code class="docutils literal notranslate"><span class="pre">cv_glmnet()</span></code>.</p></li>
<li><p>We then need to predict using the values for a particular penalty setting (the regularisation parameter) - following the paper, we use the penalty value that leads to the lowest cross-validation error.</p></li>
</ul>
<p>Since the blog post shows how to do this using <strong>glmnet</strong> directly, here we use some <strong>mlr3</strong> code to fit the model to show how it would work in <strong>mlr3</strong>. As with the Chainladder/GLM example, it’s more efficient code-wise to do the fitting outside of <strong>mlr3</strong>.</p>
<div class="section" id="basis-functions">
<h3>Basis functions<a class="headerlink" href="#basis-functions" title="Permalink to this headline">¶</a></h3>
<p>The first step is to create all the basis functions that we need. The functions below create the ramp and step functions needed (over 4000 of these!). The end result is a data.table of the original payments and all the basis functions. As noted above, all the details are in the blog post and paper.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="c1">#---------------------------</span>
<span class="c1"># linear spline function - used in data generation and in spline generation below</span>
<span class="n">LinearSpline</span> <span class="o">&lt;-</span> <span class="nf">function</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">stop</span><span class="p">){</span>
    <span class="nf">pmin</span><span class="p">(</span><span class="n">stop</span> <span class="o">-</span> <span class="n">start</span><span class="p">,</span> <span class="nf">pmax</span><span class="p">(</span><span class="m">0</span><span class="p">,</span> <span class="n">var</span> <span class="o">-</span> <span class="n">start</span><span class="p">))</span>
<span class="p">}</span>


<span class="c1"># function to calculate scaling factors for the basis functions</span>
<span class="c1"># scaling is discussed in the paper</span>
<span class="n">GetScaling</span> <span class="o">&lt;-</span> <span class="nf">function</span><span class="p">(</span><span class="n">vec</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">fn</span> <span class="o">&lt;-</span> <span class="nf">length</span><span class="p">(</span><span class="n">vec</span><span class="p">)</span>
  <span class="n">fm</span> <span class="o">&lt;-</span> <span class="nf">mean</span><span class="p">(</span><span class="n">vec</span><span class="p">)</span>
  <span class="n">fc</span> <span class="o">&lt;-</span> <span class="n">vec</span> <span class="o">-</span> <span class="n">fm</span>
  <span class="n">rho_factor</span> <span class="o">&lt;-</span> <span class="p">((</span><span class="nf">sum</span><span class="p">(</span><span class="n">fc</span><span class="o">^</span><span class="m">2</span><span class="p">))</span><span class="o">/</span><span class="n">fn</span><span class="p">)</span><span class="o">^</span><span class="m">0.5</span>
<span class="p">}</span>


<span class="c1"># function to create the ramps for a particular primary vector</span>
<span class="n">GetRamps</span> <span class="o">&lt;-</span> <span class="nf">function</span><span class="p">(</span><span class="n">vec</span><span class="p">,</span> <span class="n">vecname</span><span class="p">,</span> <span class="n">np</span><span class="p">,</span> <span class="n">scaling</span><span class="p">){</span>

  <span class="c1"># vec = fundamental regressor</span>
  <span class="c1"># vecname = name of regressor</span>
  <span class="c1"># np = number of periods</span>
  <span class="c1"># scaling = scaling factor to use</span>

  <span class="c1"># pre-allocate the matrix to hold the results for speed/efficiency</span>
  <span class="n">n</span> <span class="o">&lt;-</span> <span class="nf">length</span><span class="p">(</span><span class="n">vec</span><span class="p">)</span>
  <span class="n">nramps</span> <span class="o">&lt;-</span> <span class="p">(</span><span class="n">np</span><span class="m">-1</span><span class="p">)</span>

  <span class="n">mat</span> <span class="o">&lt;-</span> <span class="nf">matrix</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="kc">NA</span><span class="p">,</span> <span class="n">nrow</span><span class="o">=</span><span class="n">n</span><span class="p">,</span> <span class="n">ncol</span><span class="o">=</span><span class="n">nramps</span><span class="p">)</span>
  <span class="n">cnames</span> <span class="o">&lt;-</span> <span class="nf">vector</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="s">&quot;character&quot;</span><span class="p">,</span> <span class="n">length</span><span class="o">=</span><span class="n">nramps</span><span class="p">)</span>


  <span class="n">col_indx</span> <span class="o">&lt;-</span> <span class="m">0</span>

  <span class="nf">for </span><span class="p">(</span><span class="n">i</span> <span class="n">in</span> <span class="m">1</span><span class="o">:</span><span class="p">(</span><span class="n">np</span><span class="m">-1</span><span class="p">)){</span>
    <span class="n">col_indx</span> <span class="o">&lt;-</span> <span class="n">col_indx</span> <span class="o">+</span> <span class="m">1</span>

    <span class="n">mat</span><span class="p">[,</span> <span class="n">col_indx</span><span class="p">]</span> <span class="o">&lt;-</span> <span class="nf">LinearSpline</span><span class="p">(</span><span class="n">vec</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="m">999</span><span class="p">)</span> <span class="o">/</span> <span class="n">scaling</span>
    <span class="n">cnames</span><span class="p">[</span><span class="n">col_indx</span><span class="p">]</span> <span class="o">&lt;-</span> <span class="nf">paste0</span><span class="p">(</span><span class="s">&quot;L_&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="s">&quot;_999_&quot;</span><span class="p">,</span> <span class="n">vecname</span><span class="p">)</span>
  <span class="p">}</span>

  <span class="nf">colnames</span><span class="p">(</span><span class="n">mat</span><span class="p">)</span> <span class="o">&lt;-</span> <span class="n">cnames</span>

  <span class="nf">return</span><span class="p">(</span><span class="n">mat</span><span class="p">)</span>
<span class="p">}</span>


<span class="c1"># create the step (heaviside) function interactions</span>
<span class="n">GetInts</span> <span class="o">&lt;-</span> <span class="nf">function</span><span class="p">(</span><span class="n">vec1</span><span class="p">,</span> <span class="n">vec2</span><span class="p">,</span> <span class="n">vecname1</span><span class="p">,</span> <span class="n">vecname2</span><span class="p">,</span> <span class="n">np</span><span class="p">,</span> <span class="n">scaling1</span><span class="p">,</span> <span class="n">scaling2</span><span class="p">)</span> <span class="p">{</span>

  <span class="c1"># pre-allocate the matrix to hold the results for speed/efficiency</span>
  <span class="n">n</span> <span class="o">&lt;-</span> <span class="nf">length</span><span class="p">(</span><span class="n">vec1</span><span class="p">)</span>
  <span class="n">nints</span> <span class="o">&lt;-</span> <span class="p">(</span><span class="n">np</span><span class="m">-1</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">np</span><span class="m">-1</span><span class="p">)</span>

  <span class="n">mat</span> <span class="o">&lt;-</span> <span class="nf">matrix</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="kc">NA_real_</span><span class="p">,</span> <span class="n">nrow</span><span class="o">=</span><span class="n">n</span><span class="p">,</span> <span class="n">ncol</span><span class="o">=</span><span class="n">nints</span><span class="p">)</span>
  <span class="n">cnames</span> <span class="o">&lt;-</span> <span class="nf">vector</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="s">&quot;character&quot;</span><span class="p">,</span> <span class="n">length</span><span class="o">=</span><span class="n">nints</span><span class="p">)</span>


  <span class="n">col_indx</span> <span class="o">&lt;-</span> <span class="m">0</span>

  <span class="nf">for </span><span class="p">(</span><span class="n">i</span> <span class="n">in</span> <span class="m">2</span><span class="o">:</span><span class="n">np</span><span class="p">){</span>

    <span class="n">ivec</span> <span class="o">&lt;-</span> <span class="nf">LinearSpline</span><span class="p">(</span><span class="n">vec1</span><span class="p">,</span> <span class="n">i</span><span class="m">-1</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="o">/</span> <span class="n">scaling1</span>
    <span class="n">iname</span> <span class="o">&lt;-</span> <span class="nf">paste0</span><span class="p">(</span><span class="s">&quot;I_&quot;</span><span class="p">,</span> <span class="n">vecname1</span><span class="p">,</span> <span class="s">&quot;_ge_&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>

    <span class="nf">if </span><span class="p">(</span><span class="nf">length</span><span class="p">(</span><span class="n">ivec</span><span class="p">[</span><span class="nf">is.na</span><span class="p">(</span><span class="n">ivec</span><span class="p">)]</span><span class="o">&gt;</span><span class="m">0</span><span class="p">))</span> <span class="nf">print</span><span class="p">(</span><span class="nf">paste</span><span class="p">(</span><span class="s">&quot;NAs in ivec for&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">))</span>

    <span class="nf">for </span><span class="p">(</span><span class="n">j</span> <span class="n">in</span> <span class="m">2</span><span class="o">:</span><span class="n">np</span><span class="p">){</span>
      <span class="n">col_indx</span> <span class="o">&lt;-</span> <span class="n">col_indx</span> <span class="o">+</span> <span class="m">1</span>  
      <span class="n">mat</span><span class="p">[,</span> <span class="n">col_indx</span><span class="p">]</span> <span class="o">&lt;-</span> <span class="n">ivec</span> <span class="o">*</span> <span class="nf">LinearSpline</span><span class="p">(</span><span class="n">vec2</span><span class="p">,</span> <span class="n">j</span><span class="m">-1</span><span class="p">,</span> <span class="n">j</span><span class="p">)</span> <span class="o">/</span> <span class="n">scaling2</span>
      <span class="n">cnames</span><span class="p">[</span><span class="n">col_indx</span><span class="p">]</span> <span class="o">&lt;-</span> <span class="nf">paste0</span><span class="p">(</span><span class="n">iname</span><span class="p">,</span> <span class="s">&quot;xI_&quot;</span><span class="p">,</span> <span class="n">vecname2</span><span class="p">,</span> <span class="s">&quot;_ge_&quot;</span><span class="p">,</span> <span class="n">j</span><span class="p">)</span>

      <span class="n">jvec</span> <span class="o">&lt;-</span> <span class="nf">LinearSpline</span><span class="p">(</span><span class="n">vec2</span><span class="p">,</span> <span class="n">j</span><span class="m">-1</span><span class="p">,</span> <span class="n">j</span><span class="p">)</span> <span class="o">/</span> <span class="n">scaling2</span>
      <span class="nf">if </span><span class="p">(</span><span class="nf">length</span><span class="p">(</span><span class="n">jvec</span><span class="p">[</span><span class="nf">is.na</span><span class="p">(</span><span class="n">jvec</span><span class="p">)]</span><span class="o">&gt;</span><span class="m">0</span><span class="p">))</span> <span class="nf">print</span><span class="p">(</span><span class="nf">paste</span><span class="p">(</span><span class="s">&quot;NAs in jvec for&quot;</span><span class="p">,</span> <span class="n">j</span><span class="p">))</span>

    <span class="p">}</span>
  <span class="p">}</span>

  <span class="nf">colnames</span><span class="p">(</span><span class="n">mat</span><span class="p">)</span> <span class="o">&lt;-</span> <span class="n">cnames</span>

  <span class="nf">return</span><span class="p">(</span><span class="n">mat</span><span class="p">)</span>


<span class="p">}</span>
</pre></div>
</div>
</div>
</div>
<p>Now the functions are defined, we’ll create a data.table of basis functions here which we’ll use later when fitting the LASSO.
The <code class="docutils literal notranslate"><span class="pre">dat_plus</span></code> table will hold them.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="c1"># get the scaling values</span>
<span class="n">rho_factor_list</span> <span class="o">&lt;-</span> <span class="nf">vector</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="s">&quot;list&quot;</span><span class="p">,</span> <span class="n">length</span><span class="o">=</span><span class="m">3</span><span class="p">)</span>
<span class="nf">names</span><span class="p">(</span><span class="n">rho_factor_list</span><span class="p">)</span> <span class="o">&lt;-</span> <span class="nf">c</span><span class="p">(</span><span class="s">&quot;acc&quot;</span><span class="p">,</span> <span class="s">&quot;dev&quot;</span><span class="p">,</span> <span class="s">&quot;cal&quot;</span><span class="p">)</span>

<span class="nf">for </span><span class="p">(</span><span class="n">v</span> <span class="n">in</span> <span class="nf">c</span><span class="p">(</span><span class="s">&quot;acc&quot;</span><span class="p">,</span> <span class="s">&quot;dev&quot;</span><span class="p">,</span> <span class="s">&quot;cal&quot;</span><span class="p">)){</span>
  <span class="n">rho_factor_list</span><span class="p">[[</span><span class="n">v</span><span class="p">]]</span> <span class="o">&lt;-</span> <span class="nf">GetScaling</span><span class="p">(</span><span class="n">dat</span><span class="p">[</span><span class="n">train_ind</span> <span class="o">==</span> <span class="kc">TRUE</span><span class="p">,</span> <span class="nf">get</span><span class="p">(</span><span class="n">v</span><span class="p">)])</span>
<span class="p">}</span>


<span class="c1"># main effects - matrix of values</span>

<span class="n">main_effects_acc</span> <span class="o">&lt;-</span> <span class="nf">GetRamps</span><span class="p">(</span><span class="n">vec</span> <span class="o">=</span> <span class="n">dat</span><span class="p">[,</span> <span class="n">acc</span><span class="p">],</span> <span class="n">vecname</span> <span class="o">=</span> <span class="s">&quot;acc&quot;</span><span class="p">,</span> <span class="n">np</span> <span class="o">=</span> <span class="n">num_periods</span><span class="p">,</span> <span class="n">scaling</span> <span class="o">=</span> <span class="n">rho_factor_list</span><span class="p">[[</span><span class="s">&quot;acc&quot;</span><span class="p">]])</span>
<span class="n">main_effects_dev</span> <span class="o">&lt;-</span> <span class="nf">GetRamps</span><span class="p">(</span><span class="n">vec</span> <span class="o">=</span> <span class="n">dat</span><span class="p">[,</span> <span class="n">dev</span><span class="p">],</span> <span class="n">vecname</span> <span class="o">=</span> <span class="s">&quot;dev&quot;</span><span class="p">,</span> <span class="n">np</span> <span class="o">=</span> <span class="n">num_periods</span><span class="p">,</span> <span class="n">scaling</span> <span class="o">=</span> <span class="n">rho_factor_list</span><span class="p">[[</span><span class="s">&quot;dev&quot;</span><span class="p">]])</span>
<span class="n">main_effects_cal</span> <span class="o">&lt;-</span> <span class="nf">GetRamps</span><span class="p">(</span><span class="n">vec</span> <span class="o">=</span> <span class="n">dat</span><span class="p">[,</span> <span class="n">cal</span><span class="p">],</span> <span class="n">vecname</span> <span class="o">=</span> <span class="s">&quot;cal&quot;</span><span class="p">,</span> <span class="n">np</span> <span class="o">=</span> <span class="n">num_periods</span><span class="p">,</span> <span class="n">scaling</span> <span class="o">=</span> <span class="n">rho_factor_list</span><span class="p">[[</span><span class="s">&quot;cal&quot;</span><span class="p">]])</span>

<span class="n">main_effects</span> <span class="o">&lt;-</span> <span class="nf">cbind</span><span class="p">(</span><span class="n">main_effects_acc</span><span class="p">,</span> <span class="n">main_effects_dev</span><span class="p">,</span> <span class="n">main_effects_cal</span><span class="p">)</span>


<span class="c1"># interaction effects</span>
<span class="n">int_effects</span> <span class="o">&lt;-</span> <span class="nf">cbind</span><span class="p">(</span>
    <span class="nf">GetInts</span><span class="p">(</span><span class="n">vec1</span><span class="o">=</span><span class="n">dat</span><span class="p">[,</span> <span class="n">acc</span><span class="p">],</span> <span class="n">vecname1</span><span class="o">=</span><span class="s">&quot;acc&quot;</span><span class="p">,</span> <span class="n">scaling1</span><span class="o">=</span><span class="n">rho_factor_list</span><span class="p">[[</span><span class="s">&quot;acc&quot;</span><span class="p">]],</span> <span class="n">np</span><span class="o">=</span><span class="n">num_periods</span><span class="p">,</span>
            <span class="n">vec2</span><span class="o">=</span><span class="n">dat</span><span class="p">[,</span> <span class="n">dev</span><span class="p">],</span> <span class="n">vecname2</span><span class="o">=</span><span class="s">&quot;dev&quot;</span><span class="p">,</span> <span class="n">scaling2</span><span class="o">=</span><span class="n">rho_factor_list</span><span class="p">[[</span><span class="s">&quot;dev&quot;</span><span class="p">]]),</span>

    <span class="nf">GetInts</span><span class="p">(</span><span class="n">vec1</span><span class="o">=</span><span class="n">dat</span><span class="p">[,</span> <span class="n">dev</span><span class="p">],</span> <span class="n">vecname1</span><span class="o">=</span><span class="s">&quot;dev&quot;</span><span class="p">,</span> <span class="n">scaling1</span><span class="o">=</span><span class="n">rho_factor_list</span><span class="p">[[</span><span class="s">&quot;dev&quot;</span><span class="p">]],</span> <span class="n">np</span><span class="o">=</span><span class="n">num_periods</span><span class="p">,</span>
            <span class="n">vec2</span><span class="o">=</span><span class="n">dat</span><span class="p">[,</span> <span class="n">cal</span><span class="p">],</span> <span class="n">vecname2</span><span class="o">=</span><span class="s">&quot;cal&quot;</span><span class="p">,</span> <span class="n">scaling2</span><span class="o">=</span><span class="n">rho_factor_list</span><span class="p">[[</span><span class="s">&quot;cal&quot;</span><span class="p">]]),</span>

    <span class="nf">GetInts</span><span class="p">(</span><span class="n">vec1</span><span class="o">=</span><span class="n">dat</span><span class="p">[,</span> <span class="n">acc</span><span class="p">],</span> <span class="n">vecname1</span><span class="o">=</span><span class="s">&quot;acc&quot;</span><span class="p">,</span> <span class="n">scaling1</span><span class="o">=</span><span class="n">rho_factor_list</span><span class="p">[[</span><span class="s">&quot;acc&quot;</span><span class="p">]],</span> <span class="n">np</span><span class="o">=</span><span class="n">num_periods</span><span class="p">,</span>
            <span class="n">vec2</span><span class="o">=</span><span class="n">dat</span><span class="p">[,</span> <span class="n">cal</span><span class="p">],</span> <span class="n">vecname2</span><span class="o">=</span><span class="s">&quot;cal&quot;</span><span class="p">,</span> <span class="n">scaling2</span><span class="o">=</span><span class="n">rho_factor_list</span><span class="p">[[</span><span class="s">&quot;cal&quot;</span><span class="p">]])</span>
<span class="p">)</span>


<span class="n">varset</span> <span class="o">&lt;-</span> <span class="nf">cbind</span><span class="p">(</span><span class="n">main_effects</span><span class="p">,</span> <span class="n">int_effects</span><span class="p">)</span>


<span class="c1"># drop any constant columns over the training data set</span>
<span class="c1"># do this by identifying the constant columns and dropping them</span>
<span class="n">varset_train</span> <span class="o">&lt;-</span> <span class="n">varset</span><span class="p">[</span><span class="n">dat</span><span class="o">$</span><span class="n">train_ind</span><span class="p">,</span> <span class="p">]</span>

<span class="n">rm_cols</span> <span class="o">&lt;-</span> <span class="n">varset_train</span><span class="p">[,</span> <span class="nf">apply</span><span class="p">(</span><span class="n">varset_train</span><span class="p">,</span> <span class="n">MARGIN</span><span class="o">=</span><span class="m">2</span><span class="p">,</span> <span class="nf">function</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="nf">max</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">na.rm</span> <span class="o">=</span> <span class="kc">TRUE</span><span class="p">)</span> <span class="o">==</span> <span class="nf">min</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">na.rm</span> <span class="o">=</span> <span class="kc">TRUE</span><span class="p">))]</span>
<span class="n">varset</span> <span class="o">&lt;-</span> <span class="n">varset</span><span class="p">[,</span> <span class="o">!</span><span class="p">(</span><span class="nf">colnames</span><span class="p">(</span><span class="n">varset</span><span class="p">)</span> <span class="o">%in%</span> <span class="nf">colnames</span><span class="p">(</span><span class="n">rm_cols</span><span class="p">))]</span>

<span class="c1"># now add these variables into an extended data object</span>
<span class="c1"># remove anything not used in modelling</span>
<span class="n">dat_plus</span> <span class="o">&lt;-</span> <span class="nf">cbind</span><span class="p">(</span><span class="n">dat</span><span class="p">[,</span> <span class="nf">.</span><span class="p">(</span><span class="n">pmts</span><span class="p">,</span> <span class="n">train_ind</span><span class="p">,</span> <span class="n">row_id</span><span class="p">)],</span> <span class="n">varset</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="mlr3-setup-for-lasso">
<h3>mlr3 setup for LASSO<a class="headerlink" href="#mlr3-setup-for-lasso" title="Permalink to this headline">¶</a></h3>
<p>First we need to set up a task. This differs from the tree-based models task as follows in that the input variables are all the basis functions we created and not the raw accident / development / calendar quarter terms - the <code class="docutils literal notranslate"><span class="pre">dat_plus</span></code> data.table.</p>
<p>Also we don’t need to set up a cross-validation resampling for this task since the <strong>glmnet</strong> package has in-built cross-validation.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">task_lasso</span> <span class="o">&lt;-</span> <span class="n">TaskRegr</span><span class="o">$</span><span class="nf">new</span><span class="p">(</span><span class="n">id</span> <span class="o">=</span> <span class="s">&quot;reserves_lasso&quot;</span><span class="p">,</span> <span class="n">backend</span> <span class="o">=</span> <span class="n">dat_plus</span><span class="p">,</span> <span class="n">target</span> <span class="o">=</span> <span class="s">&quot;pmts&quot;</span><span class="p">)</span>

<span class="c1"># sort out row and column roles</span>
<span class="n">task_lasso</span><span class="o">$</span><span class="nf">set_row_roles</span><span class="p">(</span><span class="n">dat</span><span class="p">[</span><span class="n">train_ind</span><span class="o">==</span><span class="kc">FALSE</span><span class="p">,</span> <span class="n">row_id</span><span class="p">],</span> <span class="n">roles</span><span class="o">=</span><span class="s">&quot;validation&quot;</span><span class="p">)</span>

<span class="c1"># turn row_id into a name</span>
<span class="n">task_lasso</span><span class="o">$</span><span class="nf">set_col_roles</span><span class="p">(</span><span class="s">&quot;row_id&quot;</span><span class="p">,</span> <span class="n">roles</span><span class="o">=</span><span class="s">&quot;name&quot;</span><span class="p">)</span>

<span class="c1"># drop train_ind from the feature list</span>
<span class="n">task_lasso</span><span class="o">$</span><span class="n">col_roles</span><span class="o">$</span><span class="n">feature</span> <span class="o">&lt;-</span> <span class="nf">setdiff</span><span class="p">(</span><span class="n">task_lasso</span><span class="o">$</span><span class="n">feature_names</span><span class="p">,</span> <span class="s">&quot;train_ind&quot;</span><span class="p">)</span>  
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="model-fitting">
<h3>Model fitting<a class="headerlink" href="#model-fitting" title="Permalink to this headline">¶</a></h3>
<p>As noted above, the <strong>glmnet</strong> package has an inbuilt cross-validation function to fit LASSO models so we’ll use that rather than running cross validation via <strong>mlr3</strong>. We’ll use a Poisson distribution so the cross-validation will look to minimise the Poisson deviance.</p>
<p>The results will not be identical to those in the paper - that used 8-fold cross-validation and, even if the number of folds were the same, the random number seeds will be different, so the composition of the folds would be different.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">use_pmax</span>  <span class="o">&lt;-</span> <span class="n">num_periods</span><span class="o">^</span><span class="m">2</span>   <span class="c1"># max number of variables ever to be nonzero</span>
<span class="n">use_dfmax</span> <span class="o">&lt;-</span> <span class="n">num_periods</span><span class="o">*</span><span class="m">10</span>  

<span class="nf">set.seed</span><span class="p">(</span><span class="m">777</span><span class="p">)</span>  <span class="c1"># for reproducibility</span>

<span class="c1"># create the mlr3 learner</span>
<span class="n">lrn_cv_glmnet</span> <span class="o">&lt;-</span> <span class="nf">lrn</span><span class="p">(</span>
    <span class="s">&quot;regr.cv_glmnet&quot;</span><span class="p">,</span>
    <span class="n">family</span> <span class="o">=</span> <span class="s">&quot;poisson&quot;</span><span class="p">,</span>   
    <span class="n">nfolds</span> <span class="o">=</span> <span class="m">6</span><span class="p">,</span>
    <span class="n">thresh</span> <span class="o">=</span> <span class="m">1e-08</span><span class="p">,</span>
    <span class="n">lambda.min.ratio</span> <span class="o">=</span> <span class="m">0</span><span class="p">,</span>
    <span class="c1"># additional parameter for mlr3 - means that the model used when predicting is the min CV error model rather than default 1se model</span>
    <span class="n">s</span><span class="o">=</span><span class="s">&quot;lambda.min&quot;</span><span class="p">,</span>   
    <span class="n">dfmax</span> <span class="o">=</span> <span class="n">use_dfmax</span><span class="p">,</span>
    <span class="n">pmax</span> <span class="o">=</span> <span class="n">use_pmax</span><span class="p">,</span>
    <span class="n">alpha</span> <span class="o">=</span> <span class="m">1</span><span class="p">,</span>
    <span class="n">standardize</span> <span class="o">=</span> <span class="kc">FALSE</span><span class="p">,</span>
    <span class="n">maxit</span> <span class="o">=</span> <span class="m">200000</span><span class="p">)</span>    

<span class="c1"># train the model</span>
<span class="n">lrn_cv_glmnet</span><span class="o">$</span><span class="nf">train</span><span class="p">(</span><span class="n">task_lasso</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">s</span></code> parameter requires a little more explanation. The <code class="docutils literal notranslate"><span class="pre">regr.cv_glmnet</span></code> learner (which uses the <code class="docutils literal notranslate"><span class="pre">cv_glmnet()</span></code> function) fits models for many different possible penalty values (termed the <code class="docutils literal notranslate"><span class="pre">lambda</span></code> vector). For each of these, the average error is calculated across all folds. These are then plotted (together with error bars in the special plot created when we plot a <code class="docutils literal notranslate"><span class="pre">cv.glmnet</span></code> results object).</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="c1"># Check the path includes a minimum value of error</span>
<span class="nf">plot</span><span class="p">(</span><span class="n">lrn_cv_glmnet</span><span class="o">$</span><span class="n">model</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/MLRWP_R_mlr3_132_0.png" src="../_images/MLRWP_R_mlr3_132_0.png" />
</div>
</div>
<p>The two dotted lines in this plot represent two special penalty (or <code class="docutils literal notranslate"><span class="pre">lambda</span></code> values):</p>
<ul class="simple">
<li><p>the <code class="docutils literal notranslate"><span class="pre">lambda.min</span></code> value - the penalty value which has the lowest cross-validation error (the left-most dotted line)</p></li>
<li><p>the <code class="docutils literal notranslate"><span class="pre">lambda.1se</span></code> value - the penalty value where the cross-validation error is 1 standard error from the minimum value and the model is simpler (the right-most dotted line).</p></li>
</ul>
<p>These names come from the <strong>glmnet</strong> package - <code class="docutils literal notranslate"><span class="pre">cv.glmnet</span></code> objects include these values. It’s important to check that a true minimum has been found - if the left-most line (the <code class="docutils literal notranslate"><span class="pre">lambda.min</span></code> value) is the final value where the penalty is lowest, this suggests that the <code class="docutils literal notranslate"><span class="pre">lambda</span></code> vector needs to be lengthened and have smaller values than the current minimum. It’s possible to supply a user-defined vector of penalty values in this case.</p>
<p>When working directly with <strong>glmnet</strong> we can easily access the model corresponding to any parameter value. When using <code class="docutils literal notranslate"><span class="pre">regr.cvglmnet</span> </code> in <strong>mlr3</strong>, we need to specify which penalty value to use for predictions. By default, the <strong>mlr3</strong> <code class="docutils literal notranslate"><span class="pre">predict</span></code> method uses <code class="docutils literal notranslate"><span class="pre">lambda.1se</span></code>, so we specify <code class="docutils literal notranslate"><span class="pre">s=&quot;lambda.min&quot;</span></code> to use the <code class="docutils literal notranslate"><span class="pre">lambda.min</span></code> value as in the LASSO blog post.</p>
<p>Now we add the predictions to the <code class="docutils literal notranslate"><span class="pre">model_forecasts</span></code> table.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">model_forecasts</span><span class="p">[,</span> <span class="n">lrn_cv_glmnet</span><span class="o">$</span><span class="n">id</span> <span class="o">:=</span> <span class="n">lrn_cv_glmnet</span><span class="o">$</span><span class="nf">predict</span><span class="p">(</span><span class="n">task_lasso</span><span class="p">,</span> <span class="n">row_ids</span> <span class="o">=</span> <span class="m">1</span><span class="o">:</span><span class="nf">nrow</span><span class="p">(</span><span class="n">dat</span><span class="p">))</span><span class="o">$</span><span class="n">response</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="tex2jax_ignore mathjax_ignore section" id="model-analysis">
<h1>Model analysis<a class="headerlink" href="#model-analysis" title="Permalink to this headline">¶</a></h1>
<p>This is the interesting bit - let’s look at all the models to see how they’ve performed (but remember not to draw too many conclusions about model performance from this example as discussed earlier!)</p>
<p>Before we go any further though, we will make a long version of the data set (1 model result per row) as that will make a lot of calculations easier.
data.table has a <code class="docutils literal notranslate"><span class="pre">melt</span></code> method for doing this. Tidyverse users may be more familiar with <code class="docutils literal notranslate"><span class="pre">pivot_longer()</span></code> which also does the same thing.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="c1"># get list of variables to form observations by - this is why we used a common naming structure</span>
<span class="n">model_names</span> <span class="o">&lt;-</span> <span class="nf">names</span><span class="p">(</span><span class="n">model_forecasts</span><span class="p">)[</span> <span class="nf">names</span><span class="p">(</span><span class="n">model_forecasts</span><span class="p">)</span> <span class="o">%like%</span> <span class="s">&quot;regr&quot;</span><span class="p">]</span>

<span class="c1"># wide -&gt; long</span>
<span class="n">model_forecasts_long</span> <span class="o">&lt;-</span> <span class="nf">melt</span><span class="p">(</span><span class="n">model_forecasts</span><span class="p">,</span>
                             <span class="n">measure.vars</span> <span class="o">=</span> <span class="n">model_names</span><span class="p">,</span>
                             <span class="n">id.vars</span><span class="o">=</span><span class="nf">c</span><span class="p">(</span><span class="s">&quot;acc&quot;</span><span class="p">,</span> <span class="s">&quot;dev&quot;</span><span class="p">,</span> <span class="s">&quot;cal&quot;</span><span class="p">,</span> <span class="s">&quot;pmts&quot;</span><span class="p">,</span> <span class="s">&quot;train_ind&quot;</span><span class="p">))</span>

<span class="c1"># rename columns</span>
<span class="nf">setnames</span><span class="p">(</span><span class="n">model_forecasts_long</span><span class="p">,</span> <span class="nf">c</span><span class="p">(</span><span class="s">&quot;variable&quot;</span><span class="p">,</span> <span class="s">&quot;value&quot;</span><span class="p">),</span> <span class="nf">c</span><span class="p">(</span><span class="s">&quot;model&quot;</span><span class="p">,</span> <span class="s">&quot;fitted&quot;</span><span class="p">))</span>

<span class="nf">kable</span><span class="p">(</span><span class="nf">head</span><span class="p">(</span><span class="n">model_forecasts_long</span><span class="p">))</span> <span class="o">%&gt;%</span>
  <span class="nf">as.character</span><span class="p">()</span> <span class="o">%&gt;%</span>
  <span class="nf">display_html</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><table>
 <thead>
  <tr>
   <th style="text-align:right;"> acc </th>
   <th style="text-align:right;"> dev </th>
   <th style="text-align:right;"> cal </th>
   <th style="text-align:right;"> pmts </th>
   <th style="text-align:left;"> train_ind </th>
   <th style="text-align:left;"> model </th>
   <th style="text-align:right;"> fitted </th>
  </tr>
 </thead>
<tbody>
  <tr>
   <td style="text-align:right;"> 1 </td>
   <td style="text-align:right;"> 1 </td>
   <td style="text-align:right;"> 1 </td>
   <td style="text-align:right;"> 242671.2 </td>
   <td style="text-align:left;"> TRUE </td>
   <td style="text-align:left;"> regr.rpart </td>
   <td style="text-align:right;"> 18315018 </td>
  </tr>
  <tr>
   <td style="text-align:right;"> 1 </td>
   <td style="text-align:right;"> 2 </td>
   <td style="text-align:right;"> 2 </td>
   <td style="text-align:right;"> 164001.3 </td>
   <td style="text-align:left;"> TRUE </td>
   <td style="text-align:left;"> regr.rpart </td>
   <td style="text-align:right;"> 18315018 </td>
  </tr>
  <tr>
   <td style="text-align:right;"> 1 </td>
   <td style="text-align:right;"> 3 </td>
   <td style="text-align:right;"> 3 </td>
   <td style="text-align:right;"> 3224477.8 </td>
   <td style="text-align:left;"> TRUE </td>
   <td style="text-align:left;"> regr.rpart </td>
   <td style="text-align:right;"> 18315018 </td>
  </tr>
  <tr>
   <td style="text-align:right;"> 1 </td>
   <td style="text-align:right;"> 4 </td>
   <td style="text-align:right;"> 4 </td>
   <td style="text-align:right;"> 3682530.8 </td>
   <td style="text-align:left;"> TRUE </td>
   <td style="text-align:left;"> regr.rpart </td>
   <td style="text-align:right;"> 18315018 </td>
  </tr>
  <tr>
   <td style="text-align:right;"> 1 </td>
   <td style="text-align:right;"> 5 </td>
   <td style="text-align:right;"> 5 </td>
   <td style="text-align:right;"> 10149368.6 </td>
   <td style="text-align:left;"> TRUE </td>
   <td style="text-align:left;"> regr.rpart </td>
   <td style="text-align:right;"> 18315018 </td>
  </tr>
  <tr>
   <td style="text-align:right;"> 1 </td>
   <td style="text-align:right;"> 6 </td>
   <td style="text-align:right;"> 6 </td>
   <td style="text-align:right;"> 28578274.7 </td>
   <td style="text-align:left;"> TRUE </td>
   <td style="text-align:left;"> regr.rpart </td>
   <td style="text-align:right;"> 18315018 </td>
  </tr>
</tbody>
</table></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="nf">kable</span><span class="p">(</span><span class="nf">tail</span><span class="p">(</span><span class="n">model_forecasts_long</span><span class="p">))</span> <span class="o">%&gt;%</span>
  <span class="nf">as.character</span><span class="p">()</span> <span class="o">%&gt;%</span>
  <span class="nf">display_html</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><table>
 <thead>
  <tr>
   <th style="text-align:right;"> acc </th>
   <th style="text-align:right;"> dev </th>
   <th style="text-align:right;"> cal </th>
   <th style="text-align:right;"> pmts </th>
   <th style="text-align:left;"> train_ind </th>
   <th style="text-align:left;"> model </th>
   <th style="text-align:right;"> fitted </th>
  </tr>
 </thead>
<tbody>
  <tr>
   <td style="text-align:right;"> 40 </td>
   <td style="text-align:right;"> 35 </td>
   <td style="text-align:right;"> 74 </td>
   <td style="text-align:right;"> 125261750 </td>
   <td style="text-align:left;"> FALSE </td>
   <td style="text-align:left;"> regr.cv_glmnet </td>
   <td style="text-align:right;"> 193852526 </td>
  </tr>
  <tr>
   <td style="text-align:right;"> 40 </td>
   <td style="text-align:right;"> 36 </td>
   <td style="text-align:right;"> 75 </td>
   <td style="text-align:right;"> 62657370 </td>
   <td style="text-align:left;"> FALSE </td>
   <td style="text-align:left;"> regr.cv_glmnet </td>
   <td style="text-align:right;"> 216713451 </td>
  </tr>
  <tr>
   <td style="text-align:right;"> 40 </td>
   <td style="text-align:right;"> 37 </td>
   <td style="text-align:right;"> 76 </td>
   <td style="text-align:right;"> 63467681 </td>
   <td style="text-align:left;"> FALSE </td>
   <td style="text-align:left;"> regr.cv_glmnet </td>
   <td style="text-align:right;"> 276806762 </td>
  </tr>
  <tr>
   <td style="text-align:right;"> 40 </td>
   <td style="text-align:right;"> 38 </td>
   <td style="text-align:right;"> 77 </td>
   <td style="text-align:right;"> 26041979 </td>
   <td style="text-align:left;"> FALSE </td>
   <td style="text-align:left;"> regr.cv_glmnet </td>
   <td style="text-align:right;"> 353563580 </td>
  </tr>
  <tr>
   <td style="text-align:right;"> 40 </td>
   <td style="text-align:right;"> 39 </td>
   <td style="text-align:right;"> 78 </td>
   <td style="text-align:right;"> 33947274 </td>
   <td style="text-align:left;"> FALSE </td>
   <td style="text-align:left;"> regr.cv_glmnet </td>
   <td style="text-align:right;"> 451604592 </td>
  </tr>
  <tr>
   <td style="text-align:right;"> 40 </td>
   <td style="text-align:right;"> 40 </td>
   <td style="text-align:right;"> 79 </td>
   <td style="text-align:right;"> 37258687 </td>
   <td style="text-align:left;"> FALSE </td>
   <td style="text-align:left;"> regr.cv_glmnet </td>
   <td style="text-align:right;"> 576831775 </td>
  </tr>
</tbody>
</table></div></div>
</div>
<p>Here’s a reminder on the model names:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">regr.glm</span></code> - Chainladder</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">regr.cv_glmnet</span></code> - LASSO</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">regr.rpart</span></code> - decision tree</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">regr.ranger</span></code> - random forest</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">regr.xgboost</span></code> and <code class="docutils literal notranslate"><span class="pre">regr.xgboost_prev</span></code> - the two XGBoost models.</p></li>
</ul>
<div class="section" id="rmse">
<h2>RMSE<a class="headerlink" href="#rmse" title="Permalink to this headline">¶</a></h2>
<p>As discussed above, we are going to do these calculations manually rather than use the <strong>mlr3</strong> benchmark tools because we want to include the Chainladder and LASSO models as well (even though we’ve fitted them here using <strong>mlr3</strong>, we used separate tasks). In any case the calculations are easy to do in <strong>data.table</strong> (for those who know that package anyway!) and it can be helpful to see what’s going on..</p>
<p>For those who are unfamiliar, we’ve used a feature of data.table called chaining (similar in many ways to using the <code class="docutils literal notranslate"><span class="pre">%&gt;%</span></code> pipe, or the newly introduced base R pipe, <code class="docutils literal notranslate"><span class="pre">|&gt;</span></code>). The code does the following:</p>
<ul class="simple">
<li><p>the first line calculates <code class="docutils literal notranslate"><span class="pre">(fitted-pmts)^2</span></code> for each row of the long table (the squared error contribution)</p></li>
<li><p>the second line sums up all these contributions grouped by <code class="docutils literal notranslate"><span class="pre">model</span></code> and by <code class="docutils literal notranslate"><span class="pre">train_ind</span></code>. It also gets the count of values</p></li>
<li><p>the third line calculates the RMSE as the square root of these average contributions</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">model_rmse</span> <span class="o">&lt;-</span> <span class="n">model_forecasts_long</span><span class="p">[,</span> <span class="n">se_contrib</span> <span class="o">:=</span> <span class="p">(</span><span class="n">fitted</span><span class="o">-</span><span class="n">pmts</span><span class="p">)</span><span class="o">^</span><span class="m">2</span>
                                   <span class="p">][,</span> <span class="nf">.</span><span class="p">(</span><span class="n">se_contrib</span> <span class="o">=</span> <span class="nf">sum</span><span class="p">(</span><span class="n">se_contrib</span><span class="p">),</span> <span class="n">num</span> <span class="o">=</span> <span class="n">.N</span><span class="p">),</span> <span class="n">by</span><span class="o">=</span><span class="nf">.</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">train_ind</span><span class="p">)</span>
                                     <span class="p">][,</span> <span class="n">rmse</span> <span class="o">:=</span> <span class="nf">sqrt</span><span class="p">(</span><span class="n">se_contrib</span> <span class="o">/</span> <span class="n">num</span><span class="p">)]</span>

<span class="nf">head</span><span class="p">(</span><span class="n">model_rmse</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><table class="dataframe">
<caption>A data.table: 6 × 5</caption>
<thead>
	<tr><th scope=col>model</th><th scope=col>train_ind</th><th scope=col>se_contrib</th><th scope=col>num</th><th scope=col>rmse</th></tr>
	<tr><th scope=col>&lt;fct&gt;</th><th scope=col>&lt;lgl&gt;</th><th scope=col>&lt;dbl&gt;</th><th scope=col>&lt;int&gt;</th><th scope=col>&lt;dbl&gt;</th></tr>
</thead>
<tbody>
	<tr><td>regr.rpart  </td><td> TRUE</td><td>   3307128991724779520</td><td>820</td><td>  63506568</td></tr>
	<tr><td>regr.rpart  </td><td>FALSE</td><td>2864339162983414890496</td><td>780</td><td>1916306264</td></tr>
	<tr><td>regr.ranger </td><td> TRUE</td><td>   3609895529046446080</td><td>820</td><td>  66349918</td></tr>
	<tr><td>regr.ranger </td><td>FALSE</td><td> 494621578124144345088</td><td>780</td><td> 796322942</td></tr>
	<tr><td>regr.xgboost</td><td> TRUE</td><td>    803800528423931520</td><td>820</td><td>  31308857</td></tr>
	<tr><td>regr.xgboost</td><td>FALSE</td><td> 764311151872238288896</td><td>780</td><td> 989891960</td></tr>
</tbody>
</table>
</div></div>
</div>
<p>Let’s have a look at these results separately for past and future data sets with results ranked.</p>
<p><strong>Past data - train_ind == TRUE</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="nf">kable_styling</span><span class="p">(</span>
  <span class="nf">kable</span><span class="p">(</span><span class="n">model_rmse</span><span class="p">[</span><span class="n">train_ind</span><span class="o">==</span><span class="kc">TRUE</span><span class="p">,</span> <span class="nf">.</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">num</span><span class="p">,</span> <span class="n">rmse</span><span class="p">)][</span><span class="nf">order</span><span class="p">(</span><span class="n">rmse</span><span class="p">),],</span>
        <span class="n">digits</span><span class="o">=</span><span class="m">0</span><span class="p">,</span>
        <span class="n">format.args</span> <span class="o">=</span> <span class="nf">list</span><span class="p">(</span><span class="n">big.mark</span> <span class="o">=</span> <span class="s">&quot;,&quot;</span><span class="p">,</span> <span class="n">scientific</span> <span class="o">=</span> <span class="kc">FALSE</span><span class="p">)),</span>
  <span class="n">full_width</span> <span class="o">=</span> <span class="kc">FALSE</span><span class="p">)</span> <span class="o">%&gt;%</span>
  <span class="nf">as.character</span><span class="p">()</span> <span class="o">%&gt;%</span>
  <span class="nf">display_html</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><table class="table" style="width: auto !important; margin-left: auto; margin-right: auto;">
 <thead>
  <tr>
   <th style="text-align:left;"> model </th>
   <th style="text-align:right;"> num </th>
   <th style="text-align:right;"> rmse </th>
  </tr>
 </thead>
<tbody>
  <tr>
   <td style="text-align:left;"> regr.xgboost_prev </td>
   <td style="text-align:right;"> 820 </td>
   <td style="text-align:right;"> 30,264,940 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> regr.xgboost </td>
   <td style="text-align:right;"> 820 </td>
   <td style="text-align:right;"> 31,308,857 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> regr.cv_glmnet </td>
   <td style="text-align:right;"> 820 </td>
   <td style="text-align:right;"> 46,966,367 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> regr.rpart </td>
   <td style="text-align:right;"> 820 </td>
   <td style="text-align:right;"> 63,506,568 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> regr.ranger </td>
   <td style="text-align:right;"> 820 </td>
   <td style="text-align:right;"> 66,349,918 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> regr.glm </td>
   <td style="text-align:right;"> 820 </td>
   <td style="text-align:right;"> 138,528,927 </td>
  </tr>
</tbody>
</table></div></div>
</div>
<p>On the training data, all the tuned models perform reasonably well, with the XGBoost models having the lowest RMSE, followed by the LASSO model.
Unsurprisingly, the Chainladder model (regr.glm) has high RMSE - we know that these data will not be well modelled by a Chain ladder.</p>
<p>However, the key indicator is performance on a hold-out data set, in this case the future data.</p>
<p><strong>Future data - train_ind == FALSE</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="nf">kable_styling</span><span class="p">(</span>
  <span class="nf">kable</span><span class="p">(</span><span class="n">model_rmse</span><span class="p">[</span><span class="n">train_ind</span><span class="o">==</span><span class="kc">FALSE</span><span class="p">,</span> <span class="nf">.</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">num</span><span class="p">,</span> <span class="n">rmse</span><span class="p">)][</span><span class="nf">order</span><span class="p">(</span><span class="n">rmse</span><span class="p">),],</span>
        <span class="n">digits</span><span class="o">=</span><span class="m">0</span><span class="p">,</span>
        <span class="n">format.args</span> <span class="o">=</span> <span class="nf">list</span><span class="p">(</span><span class="n">big.mark</span> <span class="o">=</span> <span class="s">&quot;,&quot;</span><span class="p">,</span> <span class="n">scientific</span> <span class="o">=</span> <span class="kc">FALSE</span><span class="p">)),</span>
  <span class="n">full_width</span> <span class="o">=</span> <span class="kc">FALSE</span><span class="p">)</span> <span class="o">%&gt;%</span>
  <span class="nf">as.character</span><span class="p">()</span> <span class="o">%&gt;%</span>
  <span class="nf">display_html</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><table class="table" style="width: auto !important; margin-left: auto; margin-right: auto;">
 <thead>
  <tr>
   <th style="text-align:left;"> model </th>
   <th style="text-align:right;"> num </th>
   <th style="text-align:right;"> rmse </th>
  </tr>
 </thead>
<tbody>
  <tr>
   <td style="text-align:left;"> regr.cv_glmnet </td>
   <td style="text-align:right;"> 780 </td>
   <td style="text-align:right;"> 251,388,945 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> regr.xgboost_prev </td>
   <td style="text-align:right;"> 780 </td>
   <td style="text-align:right;"> 322,701,619 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> regr.ranger </td>
   <td style="text-align:right;"> 780 </td>
   <td style="text-align:right;"> 796,322,942 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> regr.xgboost </td>
   <td style="text-align:right;"> 780 </td>
   <td style="text-align:right;"> 989,891,960 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> regr.glm </td>
   <td style="text-align:right;"> 780 </td>
   <td style="text-align:right;"> 1,722,472,390 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> regr.rpart </td>
   <td style="text-align:right;"> 780 </td>
   <td style="text-align:right;"> 1,916,306,264 </td>
  </tr>
</tbody>
</table></div></div>
</div>
<p>For the future data, we see a very different story. As expected, the tuned decision tree does appear to be over-fitted - it performs poorer than the default decision tree. The LASSO model is the best, followed by the previously tuned XGBoost model. Despite having similar hyper-parameters, the two XGBoost models perform differently.</p>
</div>
<div class="section" id="visualising-the-fit">
<h2>Visualising the fit<a class="headerlink" href="#visualising-the-fit" title="Permalink to this headline">¶</a></h2>
<p>Although useful, the RMSE is just a single number so it’s helpful to visualise the fit.
In particular, because these are models for a reserving data set, we can take advantage of that structure when analysing how well each model is performing.</p>
<div class="section" id="fitted-values">
<h3>Fitted values<a class="headerlink" href="#fitted-values" title="Permalink to this headline">¶</a></h3>
<p>First, lets show visualise the fitted payments.
The graphs below show the log(fitted values), or log(payments) in the case of the actual values.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="c1"># add in the actual values for comparison</span>
<span class="n">actuals</span> <span class="o">&lt;-</span> <span class="n">model_forecasts_long</span><span class="p">[</span><span class="n">model</span><span class="o">==</span><span class="s">&quot;regr.glm&quot;</span><span class="p">,]</span>
<span class="n">actuals</span><span class="p">[,</span> <span class="n">model</span> <span class="o">:=</span> <span class="s">&quot;actual&quot;</span>
        <span class="p">][,</span> <span class="n">fitted</span> <span class="o">:=</span> <span class="n">pmts</span><span class="p">]</span>

<span class="n">model_forecasts_long_plot</span> <span class="o">&lt;-</span> <span class="nf">rbind</span><span class="p">(</span><span class="n">actuals</span><span class="p">,</span> <span class="n">model_forecasts_long</span><span class="p">)</span>

<span class="c1"># calculate log_fitted</span>
<span class="n">model_forecasts_long_plot</span><span class="p">[,</span> <span class="n">log_fitted</span> <span class="o">:=</span> <span class="nf">log</span><span class="p">(</span><span class="nf">pmax</span><span class="p">(</span><span class="m">1</span><span class="p">,</span> <span class="n">fitted</span><span class="p">))]</span>

<span class="c1"># plot</span>
<span class="nf">ggplot</span><span class="p">(</span><span class="n">model_forecasts_long_plot</span><span class="p">,</span> <span class="nf">aes</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">acc</span><span class="p">))</span> <span class="o">+</span>
  <span class="nf">scale_y_reverse</span><span class="p">()</span> <span class="o">+</span>
  <span class="nf">geom_raster</span><span class="p">(</span><span class="nf">aes</span><span class="p">(</span><span class="n">fill</span> <span class="o">=</span> <span class="n">log_fitted</span><span class="p">))</span> <span class="o">+</span>
  <span class="nf">facet_wrap</span><span class="p">(</span><span class="o">~</span><span class="n">model</span><span class="p">,</span> <span class="n">ncol</span><span class="o">=</span><span class="m">2</span><span class="p">)</span><span class="o">+</span>
  <span class="nf">scale_fill_viridis_c</span><span class="p">(</span><span class="n">begin</span><span class="o">=</span><span class="m">1</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="m">0</span><span class="p">)</span> <span class="o">+</span>
  <span class="nf">geom_line</span><span class="p">(</span><span class="nf">aes</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">num_periods</span><span class="m">+1</span><span class="o">-</span><span class="n">acc</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">acc</span><span class="p">),</span> <span class="n">colour</span><span class="o">=</span><span class="n">dgrey</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="m">2</span><span class="p">)</span><span class="o">+</span>
  <span class="nf">theme_classic</span><span class="p">()</span><span class="o">+</span>
  <span class="nf">theme</span><span class="p">(</span><span class="n">strip.text</span> <span class="o">=</span> <span class="nf">element_text</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="m">8</span><span class="p">,</span><span class="n">colour</span><span class="o">=</span><span class="n">dgrey</span><span class="p">),</span> <span class="n">strip.background</span> <span class="o">=</span> <span class="nf">element_rect</span><span class="p">(</span><span class="n">colour</span><span class="o">=</span><span class="s">&quot;white&quot;</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="s">&quot;white&quot;</span><span class="p">))</span><span class="o">+</span>
  <span class="nf">theme</span><span class="p">(</span><span class="n">axis.title.x</span> <span class="o">=</span> <span class="nf">element_text</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="m">8</span><span class="p">),</span> <span class="n">axis.text.x</span>  <span class="o">=</span> <span class="nf">element_text</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="m">7</span><span class="p">))</span><span class="o">+</span>
  <span class="nf">theme</span><span class="p">(</span><span class="n">axis.title.y</span> <span class="o">=</span> <span class="nf">element_text</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="m">8</span><span class="p">),</span> <span class="n">axis.text.y</span>  <span class="o">=</span> <span class="nf">element_text</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="m">7</span><span class="p">))</span><span class="o">+</span>
  <span class="nf">theme</span><span class="p">(</span><span class="nf">element_line</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="m">0.25</span><span class="p">,</span> <span class="n">colour</span><span class="o">=</span><span class="n">dgrey</span><span class="p">))</span><span class="o">+</span>
  <span class="nf">theme</span><span class="p">(</span><span class="n">legend.position</span><span class="o">=</span><span class="nf">c</span><span class="p">(</span><span class="m">0.75</span><span class="p">,</span> <span class="m">0.1</span><span class="p">),</span> <span class="n">legend.direction</span> <span class="o">=</span> <span class="s">&quot;horizontal&quot;</span><span class="p">,</span> <span class="n">legend.title</span><span class="o">=</span><span class="nf">element_blank</span><span class="p">(),</span> <span class="n">legend.text</span><span class="o">=</span><span class="nf">element_text</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="m">8</span><span class="p">))</span><span class="o">+</span>
  <span class="nf">labs</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s">&quot;Accident Quarter&quot;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s">&quot;Development Quarter&quot;</span><span class="p">)</span><span class="o">+</span>
  <span class="kc">NULL</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/MLRWP_R_mlr3_152_0.png" src="../_images/MLRWP_R_mlr3_152_0.png" />
</div>
</div>
<p>Some things are apparent from this:</p>
<ul class="simple">
<li><p>The lack of interactions or diagonal effects in the Chain ladder (regr.glm)</p></li>
<li><p>All the machine learning models do detect and project the interaction</p></li>
<li><p>The blocky nature of the decision tree (regr.rpart) and the overfit to the past data</p></li>
<li><p>The random forest (regr.ranger) and XGBoost fit look smoother since they are a function of a number of trees.</p></li>
<li><p>The LASSO fit (regr.cv_glmnet) is the smoothest, which is not surprising since it consists of continuous functions.</p></li>
<li><p>Visually, the LASSO seems to capture the interaction the best.</p></li>
</ul>
</div>
<div class="section" id="actual-vs-fitted-heat-maps">
<h3>Actual vs Fitted heat maps<a class="headerlink" href="#actual-vs-fitted-heat-maps" title="Permalink to this headline">¶</a></h3>
<p>We can also look at the model fits via heat maps of the actual/fitted values.
The function defined below calculates the actual/fitted values, capping and collaring them at 400% and 25%.
The values are then shaded so that:</p>
<ul class="simple">
<li><p>Dark blue = 25%</p></li>
<li><p>White = 100%</p></li>
<li><p>Dark red = 400%</p></li>
</ul>
<p>For triangular reserving data, these types of plots are very helpful when examining plot fit.</p>
<p>First, here’s a function to draw the heatmaps.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="c1"># heat maps</span>

<span class="n">GraphHeatMap</span> <span class="o">&lt;-</span> <span class="nf">function</span><span class="p">(</span><span class="n">dat</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="s">&quot;dev&quot;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s">&quot;acc&quot;</span><span class="p">,</span> <span class="n">facet</span><span class="o">=</span><span class="s">&quot;model&quot;</span><span class="p">,</span> <span class="n">actual</span><span class="p">,</span> <span class="n">fitted</span><span class="p">,</span> <span class="n">lims</span><span class="o">=</span><span class="nf">c</span><span class="p">(</span><span class="m">0.25</span><span class="p">,</span> <span class="m">4</span><span class="p">),</span>
                         <span class="n">xlab</span><span class="o">=</span><span class="s">&quot;Development quarter&quot;</span><span class="p">,</span> <span class="n">ylab</span><span class="o">=</span><span class="s">&quot;Accident Quarter&quot;</span><span class="p">){</span>

  <span class="c1"># copy data to avoid modifying original</span>
  <span class="n">localdat</span> <span class="o">&lt;-</span> <span class="nf">copy</span><span class="p">(</span><span class="n">dat</span><span class="p">)</span>

  <span class="c1"># get fails if there is a variable with the same name so make local copies</span>
  <span class="n">local_x</span> <span class="o">&lt;-</span> <span class="n">x</span>
  <span class="n">local_y</span> <span class="o">&lt;-</span> <span class="n">y</span>
  <span class="n">local_actual</span> <span class="o">&lt;-</span> <span class="n">actual</span>
  <span class="n">local_fitted</span> <span class="o">&lt;-</span> <span class="n">fitted</span>

  <span class="c1"># make restricted Avs F for heatmap and set up past/future split line</span>
  <span class="n">np</span> <span class="o">&lt;-</span> <span class="nf">max</span><span class="p">(</span><span class="n">localdat</span><span class="p">[[</span><span class="n">y</span><span class="p">]])</span>

  <span class="n">localdat</span><span class="p">[,</span> <span class="n">.avsf</span> <span class="o">:=</span> <span class="nf">get</span><span class="p">(</span><span class="n">local_actual</span><span class="p">)</span> <span class="o">/</span> <span class="nf">get</span><span class="p">(</span><span class="n">local_fitted</span><span class="p">)</span>
           <span class="p">][,</span> <span class="n">.avsf_restrict_log</span> <span class="o">:=</span> <span class="nf">log</span><span class="p">(</span><span class="nf">pmax</span><span class="p">(</span><span class="nf">min</span><span class="p">(</span><span class="n">lims</span><span class="p">),</span> <span class="nf">pmin</span><span class="p">(</span><span class="nf">max</span><span class="p">(</span><span class="n">lims</span><span class="p">),</span> <span class="n">.avsf</span><span class="p">)))</span>
             <span class="p">][,</span> <span class="n">.past_line</span> <span class="o">:=</span> <span class="n">np</span> <span class="o">+</span> <span class="m">1</span> <span class="o">-</span> <span class="nf">get</span><span class="p">(</span><span class="n">local_y</span><span class="p">)]</span>


  <span class="n">g</span> <span class="o">&lt;-</span> <span class="nf">ggplot</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">localdat</span><span class="p">,</span> <span class="nf">aes_string</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">local_x</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">local_y</span><span class="p">))</span> <span class="o">+</span>
    <span class="nf">geom_tile</span><span class="p">(</span><span class="nf">aes</span><span class="p">(</span><span class="n">fill</span> <span class="o">=</span> <span class="n">.avsf_restrict_log</span><span class="p">))</span><span class="o">+</span><span class="nf">scale_y_reverse</span><span class="p">()</span><span class="o">+</span>
    <span class="nf">facet_wrap</span><span class="p">(</span><span class="o">~</span><span class="nf">get</span><span class="p">(</span><span class="n">facet</span><span class="p">),</span> <span class="n">ncol</span><span class="o">=</span><span class="m">2</span><span class="p">)</span><span class="o">+</span>
    <span class="nf">theme_classic</span><span class="p">()</span><span class="o">+</span>
    <span class="nf">scale_fill_gradient2</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&quot;AvF_min&quot;</span><span class="p">,</span> <span class="n">low</span><span class="o">=</span><span class="n">mblue</span><span class="p">,</span> <span class="n">mid</span><span class="o">=</span><span class="s">&quot;white&quot;</span><span class="p">,</span> <span class="n">high</span><span class="o">=</span><span class="n">red</span><span class="p">,</span> <span class="n">midpoint</span><span class="o">=</span><span class="m">0</span><span class="p">,</span> <span class="n">space</span><span class="o">=</span><span class="s">&quot;Lab&quot;</span><span class="p">,</span> <span class="n">na.value</span><span class="o">=</span><span class="s">&quot;grey50&quot;</span><span class="p">,</span> <span class="n">guide</span><span class="o">=</span><span class="s">&quot;colourbar&quot;</span><span class="p">)</span><span class="o">+</span>
    <span class="nf">labs</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">xlab</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">ylab</span><span class="p">)</span><span class="o">+</span>
    <span class="nf">geom_line</span><span class="p">(</span><span class="nf">aes_string</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s">&quot;.past_line&quot;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">local_y</span><span class="p">),</span> <span class="n">colour</span><span class="o">=</span><span class="n">dgrey</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="m">2</span><span class="p">)</span><span class="o">+</span>
    <span class="nf">theme</span><span class="p">(</span><span class="n">strip.text</span> <span class="o">=</span> <span class="nf">element_text</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="m">8</span><span class="p">,</span><span class="n">colour</span><span class="o">=</span><span class="s">&quot;grey30&quot;</span><span class="p">),</span> <span class="n">strip.background</span> <span class="o">=</span> <span class="nf">element_rect</span><span class="p">(</span><span class="n">colour</span><span class="o">=</span><span class="s">&quot;white&quot;</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="s">&quot;white&quot;</span><span class="p">))</span><span class="o">+</span>
    <span class="nf">theme</span><span class="p">(</span><span class="n">axis.title.x</span> <span class="o">=</span> <span class="nf">element_text</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="m">8</span><span class="p">),</span> <span class="n">axis.text.x</span>  <span class="o">=</span> <span class="nf">element_text</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="m">7</span><span class="p">))</span><span class="o">+</span>
    <span class="nf">theme</span><span class="p">(</span><span class="n">axis.title.y</span> <span class="o">=</span> <span class="nf">element_text</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="m">8</span><span class="p">),</span> <span class="n">axis.text.y</span>  <span class="o">=</span> <span class="nf">element_text</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="m">7</span><span class="p">))</span><span class="o">+</span>
    <span class="nf">theme</span><span class="p">(</span><span class="nf">element_line</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="m">0.25</span><span class="p">,</span> <span class="n">colour</span><span class="o">=</span><span class="s">&quot;grey30&quot;</span><span class="p">))</span><span class="o">+</span>
    <span class="nf">theme</span><span class="p">(</span><span class="n">legend.position</span><span class="o">=</span><span class="s">&quot;none&quot;</span><span class="p">,</span> <span class="p">)</span><span class="o">+</span>  <span class="c1"># legend.direction = &quot;horizontal&quot;, legend.title=element_blank(), legend.text=element_text(size=8)</span>
    <span class="kc">NULL</span>    


  <span class="nf">invisible</span><span class="p">(</span><span class="nf">list</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">localdat</span><span class="p">,</span> <span class="n">graph</span><span class="o">=</span><span class="n">g</span><span class="p">))</span>


<span class="p">}</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">g</span> <span class="o">&lt;-</span> <span class="nf">GraphHeatMap</span><span class="p">(</span><span class="n">model_forecasts_long</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="s">&quot;dev&quot;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s">&quot;acc&quot;</span><span class="p">,</span> <span class="n">facet</span><span class="o">=</span><span class="s">&quot;model&quot;</span><span class="p">,</span> <span class="n">actual</span><span class="o">=</span><span class="s">&quot;pmts&quot;</span><span class="p">,</span> <span class="n">fitted</span><span class="o">=</span><span class="s">&quot;fitted&quot;</span><span class="p">)</span>
<span class="n">g</span><span class="o">$</span><span class="n">graph</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/MLRWP_R_mlr3_158_0.png" src="../_images/MLRWP_R_mlr3_158_0.png" />
</div>
</div>
<p>All models have shortcomings, but the LASSO and previously tuned XGBoost models outperform the others.</p>
</div>
<div class="section" id="quarterly-tracking">
<h3>Quarterly tracking<a class="headerlink" href="#quarterly-tracking" title="Permalink to this headline">¶</a></h3>
<p>Finally, we will look at the predictions for specific parts of the data set.
Quarterly tracking graphs:</p>
<ul class="simple">
<li><p>Plot the actual and fitted payments, including future values, by one of accident / development / calendar period</p></li>
<li><p>Hold one of the other triangle directions fixed, meaning that the third direction is then determined.</p></li>
<li><p>Additionally plot the underlying mean from which the data were simulated.</p></li>
</ul>
<p>We’ll use a couple of functions because we want to do this repeatedly.</p>
<p>The first function (<code class="docutils literal notranslate"><span class="pre">GraphModelVals</span></code>) is from the blog on the LASSO model, and draws a single tracking graph.
The second function (<code class="docutils literal notranslate"><span class="pre">QTracking</span></code>) generates the graphs for all models and uses the <strong>patchwork</strong> package to wrap them into a single plot.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">GraphModelVals</span><span class="o">&lt;-</span><span class="nf">function</span><span class="p">(</span><span class="n">dat</span><span class="p">,</span> <span class="n">primary_predictor</span><span class="p">,</span> <span class="n">secondary_predictor</span><span class="p">,</span> <span class="n">secondary_predictor_val</span><span class="p">,</span>
                         <span class="n">xaxis_label</span><span class="p">,</span> <span class="n">yaxis_label</span><span class="p">,</span> <span class="n">var_names</span><span class="p">,</span> <span class="n">log_values</span> <span class="o">=</span> <span class="kc">TRUE</span><span class="p">,</span> <span class="n">include_st</span><span class="o">=</span><span class="kc">FALSE</span><span class="p">,</span> <span class="n">include_legend</span><span class="o">=</span><span class="kc">FALSE</span><span class="p">,</span> <span class="n">font_size</span><span class="o">=</span><span class="m">6</span><span class="p">){</span>


  <span class="c1"># var_names must be list with names like this: list(actual=&quot;pmts&quot;, mean=&quot;mu&quot;, fitted=&quot;fitted&quot;)</span>

  <span class="c1"># extract data we want to use</span>
  <span class="n">use_dat</span> <span class="o">&lt;-</span> <span class="n">dat</span><span class="p">[</span><span class="nf">get</span><span class="p">(</span><span class="n">secondary_predictor</span><span class="p">)</span> <span class="o">==</span> <span class="n">secondary_predictor_val</span><span class="p">,</span> <span class="p">]</span>

  <span class="c1"># turn into long format using melt.data.table since that works better with ggplot</span>
  <span class="n">dat_long</span> <span class="o">&lt;-</span> <span class="nf">melt</span><span class="p">(</span><span class="n">dat</span><span class="p">[</span><span class="nf">get</span><span class="p">(</span><span class="n">secondary_predictor</span><span class="p">)</span> <span class="o">==</span> <span class="n">secondary_predictor_val</span><span class="p">,</span> <span class="p">],</span>
                   <span class="n">measure.vars</span> <span class="o">=</span> <span class="nf">unlist</span><span class="p">(</span><span class="n">var_names</span><span class="p">),</span>
                   <span class="n">id.vars</span> <span class="o">=</span> <span class="n">primary_predictor</span><span class="p">)</span>

  <span class="c1"># make the names nicer - colnames and labels</span>
  <span class="nf">setnames</span><span class="p">(</span><span class="n">dat_long</span><span class="p">,</span> <span class="n">primary_predictor</span><span class="p">,</span> <span class="s">&quot;predictor&quot;</span><span class="p">)</span>

  <span class="n">dat_long</span><span class="p">[</span><span class="n">variable</span> <span class="o">==</span> <span class="n">var_names</span><span class="o">$</span><span class="n">actual</span><span class="p">,</span> <span class="n">variable</span> <span class="o">:=</span> <span class="s">&quot;Simulated&quot;</span>
           <span class="p">][</span><span class="n">variable</span> <span class="o">==</span> <span class="n">var_names</span><span class="o">$</span><span class="n">mean</span><span class="p">,</span> <span class="n">variable</span> <span class="o">:=</span> <span class="s">&quot;Underlying&quot;</span>
             <span class="p">][</span><span class="n">variable</span> <span class="o">==</span> <span class="n">var_names</span><span class="o">$</span><span class="n">fitted</span><span class="p">,</span> <span class="n">variable</span> <span class="o">:=</span> <span class="s">&quot;Fitted&quot;</span><span class="p">]</span>

  <span class="c1"># get the levels of the variables right so that they are plotted in the right order</span>
  <span class="n">dat_long</span><span class="p">[,</span> <span class="n">variable</span> <span class="o">:=</span> <span class="nf">factor</span><span class="p">(</span><span class="n">variable</span><span class="p">,</span> <span class="n">levels</span><span class="o">=</span><span class="nf">c</span><span class="p">(</span><span class="s">&quot;Fitted&quot;</span><span class="p">,</span> <span class="s">&quot;Simulated&quot;</span><span class="p">,</span> <span class="s">&quot;Underlying&quot;</span><span class="p">))]</span>


  <span class="nf">if </span><span class="p">(</span><span class="n">log_values</span><span class="p">)</span> <span class="n">dat_long</span><span class="p">[,</span> <span class="n">value</span> <span class="o">:=</span> <span class="nf">log</span><span class="p">(</span><span class="n">value</span><span class="p">)]</span>

  <span class="c1"># figure out past data rectangle coordinates</span>
  <span class="n">xmin1</span> <span class="o">&lt;-</span> <span class="n">use_dat</span><span class="p">[</span><span class="n">train_ind</span> <span class="o">==</span> <span class="kc">TRUE</span><span class="p">,</span> <span class="nf">min</span><span class="p">(</span><span class="nf">get</span><span class="p">(</span><span class="n">primary_predictor</span><span class="p">))]</span>
  <span class="n">xmax1</span> <span class="o">&lt;-</span> <span class="n">use_dat</span><span class="p">[</span><span class="n">train_ind</span> <span class="o">==</span> <span class="kc">TRUE</span><span class="p">,</span> <span class="nf">max</span><span class="p">(</span><span class="nf">get</span><span class="p">(</span><span class="n">primary_predictor</span><span class="p">))]</span>

  <span class="n">ymin1</span> <span class="o">&lt;-</span> <span class="n">dat_long</span><span class="p">[,</span> <span class="nf">min</span><span class="p">(</span><span class="n">value</span><span class="p">)]</span><span class="o">*</span><span class="m">0.95</span>
  <span class="n">ymax1</span> <span class="o">&lt;-</span> <span class="n">dat_long</span><span class="p">[,</span> <span class="nf">max</span><span class="p">(</span><span class="n">value</span><span class="p">)]</span><span class="o">*</span><span class="m">1.05</span>


  <span class="c1"># draw the tracking plots</span>
  <span class="n">g</span> <span class="o">&lt;-</span> <span class="nf">ggplot</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">dat_long</span><span class="p">,</span> <span class="nf">aes</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">predictor</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">value</span><span class="p">,</span> <span class="n">group</span><span class="o">=</span><span class="n">variable</span><span class="p">))</span><span class="o">+</span>
    <span class="nf">geom_line</span><span class="p">(</span><span class="nf">aes</span><span class="p">(</span><span class="n">linetype</span><span class="o">=</span><span class="n">variable</span><span class="p">,</span> <span class="n">colour</span><span class="o">=</span><span class="n">variable</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">variable</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="n">variable</span><span class="p">))</span><span class="o">+</span>
    <span class="nf">geom_line</span><span class="p">(</span><span class="nf">aes</span><span class="p">(</span><span class="n">linetype</span><span class="o">=</span><span class="n">variable</span><span class="p">,</span> <span class="n">colour</span><span class="o">=</span><span class="n">variable</span><span class="p">))</span><span class="o">+</span>
    <span class="nf">scale_colour_manual</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&quot;&quot;</span><span class="p">,</span> <span class="n">values</span><span class="o">=</span><span class="nf">c</span><span class="p">(</span><span class="n">red</span><span class="p">,</span> <span class="n">dgrey</span><span class="p">,</span> <span class="n">dgrey</span><span class="p">))</span><span class="o">+</span>
    <span class="nf">scale_linetype_manual</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&quot;&quot;</span><span class="p">,</span> <span class="n">values</span><span class="o">=</span><span class="nf">c</span><span class="p">(</span><span class="s">&quot;solid&quot;</span><span class="p">,</span> <span class="s">&quot;solid&quot;</span><span class="p">,</span> <span class="s">&quot;dotted&quot;</span><span class="p">))</span><span class="o">+</span>
    <span class="nf">scale_size_manual</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&quot;&quot;</span><span class="p">,</span> <span class="n">values</span><span class="o">=</span><span class="nf">c</span><span class="p">(</span><span class="m">2</span><span class="p">,</span><span class="m">1</span><span class="p">,</span><span class="m">1</span><span class="p">))</span><span class="o">+</span>
    <span class="nf">scale_alpha_manual</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&quot;&quot;</span><span class="p">,</span> <span class="n">values</span><span class="o">=</span><span class="nf">c</span><span class="p">(</span><span class="m">0.8</span><span class="p">,</span> <span class="m">0.5</span><span class="p">,</span> <span class="m">0.5</span><span class="p">))</span><span class="o">+</span>
    <span class="nf">theme_classic</span><span class="p">()</span><span class="o">+</span>
    <span class="nf">annotate</span><span class="p">(</span><span class="n">geom</span><span class="o">=</span><span class="s">&quot;rect&quot;</span><span class="p">,</span> <span class="n">xmin</span><span class="o">=</span><span class="n">xmin1</span><span class="p">,</span> <span class="n">xmax</span><span class="o">=</span><span class="n">xmax1</span><span class="p">,</span> <span class="n">ymin</span><span class="o">=</span><span class="n">ymin1</span><span class="p">,</span> <span class="n">ymax</span><span class="o">=</span><span class="n">ymax1</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="m">0.1</span><span class="p">)</span><span class="o">+</span>
    <span class="nf">labs</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">xaxis_label</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">yaxis_label</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="nf">paste</span><span class="p">(</span><span class="n">xaxis_label</span><span class="p">,</span> <span class="s">&quot;tracking for&quot;</span><span class="p">,</span> <span class="n">secondary_predictor</span><span class="p">,</span> <span class="s">&quot;=&quot;</span><span class="p">,</span> <span class="n">secondary_predictor_val</span><span class="p">))</span> <span class="o">+</span>
    <span class="nf">theme</span><span class="p">(</span><span class="n">axis.title</span> <span class="o">=</span> <span class="nf">element_text</span><span class="p">(</span><span class="n">size</span> <span class="o">=</span> <span class="n">font_size</span><span class="p">),</span> <span class="n">axis.text</span> <span class="o">=</span> <span class="nf">element_text</span><span class="p">(</span><span class="n">size</span> <span class="o">=</span> <span class="n">font_size</span><span class="m">-1</span><span class="p">))</span>

  <span class="nf">if</span><span class="p">(</span><span class="n">include_st</span><span class="o">==</span><span class="kc">TRUE</span><span class="p">)</span> <span class="n">g</span> <span class="o">&lt;-</span> <span class="n">g</span> <span class="o">+</span> <span class="nf">labs</span><span class="p">(</span><span class="n">subtitle</span><span class="o">=</span><span class="s">&quot;Past data in grey rectangle&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="nf">theme</span><span class="p">(</span><span class="n">plot.subtitle</span> <span class="o">=</span> <span class="nf">element_text </span><span class="p">(</span><span class="n">size</span> <span class="o">=</span> <span class="n">font_size</span><span class="p">))</span>

  <span class="n">g</span> <span class="o">&lt;-</span> <span class="nf">if</span><span class="p">(</span><span class="n">include_legend</span><span class="o">==</span><span class="kc">TRUE</span><span class="p">)</span> <span class="n">g</span> <span class="o">+</span> <span class="nf">theme</span><span class="p">(</span><span class="n">legend.position</span><span class="o">=</span><span class="nf">c</span><span class="p">(</span><span class="m">1.5</span><span class="p">,</span> <span class="m">0.5</span><span class="p">))</span> <span class="n">else</span> <span class="n">g</span> <span class="o">+</span> <span class="nf">theme</span><span class="p">(</span><span class="n">legend.position</span> <span class="o">=</span> <span class="s">&quot;none&quot;</span><span class="p">)</span>



  <span class="c1"># return the results  </span>
  <span class="nf">invisible</span><span class="p">(</span><span class="nf">list</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">dat_long</span><span class="p">,</span> <span class="n">graph</span><span class="o">=</span><span class="n">g</span><span class="p">))</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
</div>
<p>Let’s have a look at the tracking for accident quarter when development quarter = 5.
We’ll wrap this in another function since we want to call this for a few different combinations.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">QTracking</span> <span class="o">&lt;-</span> <span class="nf">function</span><span class="p">(</span><span class="n">dat</span><span class="p">,</span>
                      <span class="n">model_names</span><span class="p">,</span>
                      <span class="n">primary_predictor</span><span class="p">,</span>
                      <span class="n">secondary_predictor</span><span class="p">,</span>
                      <span class="n">secondary_predictor_val</span><span class="p">,</span>
                      <span class="n">xaxis_label</span><span class="p">,</span>
                      <span class="n">yaxis_label</span> <span class="o">=</span> <span class="s">&quot;Log(Payments)&quot;</span><span class="p">,</span>
                      <span class="n">font_size</span> <span class="o">=</span> <span class="m">8</span><span class="p">,</span>
                      <span class="n">plots_ncol</span><span class="o">=</span><span class="m">2</span><span class="p">){</span>

  <span class="c1"># hold each plot</span>
  <span class="n">tracking_g</span> <span class="o">&lt;-</span> <span class="nf">list</span><span class="p">()</span>

  <span class="c1"># produce each plot  </span>
  <span class="nf">for </span><span class="p">(</span><span class="n">model</span> <span class="n">in</span> <span class="n">model_names</span><span class="p">){</span>

    <span class="c1"># variable names in plot</span>
    <span class="n">vn</span> <span class="o">&lt;-</span> <span class="nf">list</span><span class="p">(</span><span class="n">actual</span><span class="o">=</span><span class="s">&quot;pmts&quot;</span><span class="p">,</span> <span class="n">mean</span><span class="o">=</span><span class="s">&quot;mu&quot;</span><span class="p">,</span> <span class="n">fitted</span><span class="o">=</span><span class="n">model</span><span class="p">)</span>

    <span class="c1"># include subtitle or not in the graph (first plot only)</span>
    <span class="n">bool_st</span> <span class="o">&lt;-</span> <span class="nf">if</span><span class="p">(</span><span class="n">model</span> <span class="o">==</span> <span class="n">model_names</span><span class="p">[</span><span class="m">1</span><span class="p">])</span> <span class="kc">TRUE</span> <span class="n">else</span> <span class="kc">FALSE</span>

    <span class="c1"># include legend or not in the graph (last plot only)</span>
    <span class="n">bool_legend</span> <span class="o">&lt;-</span> <span class="nf">if</span><span class="p">(</span><span class="n">model</span> <span class="o">==</span> <span class="n">model_names</span><span class="p">[</span><span class="nf">length</span><span class="p">(</span><span class="n">model_names</span><span class="p">)])</span> <span class="kc">TRUE</span> <span class="n">else</span> <span class="kc">FALSE</span>

    <span class="c1"># draw plot</span>
    <span class="n">tracking_g</span><span class="p">[[</span><span class="n">model</span><span class="p">]]</span> <span class="o">&lt;-</span> <span class="nf">GraphModelVals</span><span class="p">(</span><span class="n">dat</span><span class="p">,</span>
                                          <span class="n">primary_predictor</span> <span class="o">=</span> <span class="n">primary_predictor</span><span class="p">,</span>
                                          <span class="n">secondary_predictor</span> <span class="o">=</span> <span class="n">secondary_predictor</span><span class="p">,</span>
                                          <span class="n">secondary_predictor_val</span> <span class="o">=</span> <span class="n">secondary_predictor_val</span><span class="p">,</span>
                                          <span class="n">xaxis_label</span> <span class="o">=</span> <span class="n">xaxis_label</span><span class="p">,</span>
                                          <span class="n">yaxis_label</span> <span class="o">=</span> <span class="n">yaxis_label</span><span class="p">,</span>
                                          <span class="n">var_names</span> <span class="o">=</span> <span class="n">vn</span><span class="p">,</span>
                                          <span class="n">include_st</span> <span class="o">=</span> <span class="n">bool_st</span><span class="p">,</span>
                                          <span class="n">include_legend</span> <span class="o">=</span> <span class="n">bool_legend</span><span class="p">,</span>
                                          <span class="n">font_size</span> <span class="o">=</span> <span class="n">font_size</span><span class="p">)</span><span class="o">$</span><span class="n">graph</span> <span class="o">+</span>
      <span class="nf">ggtitle</span><span class="p">(</span><span class="nf">paste</span><span class="p">(</span><span class="s">&quot;Modelled values for&quot;</span><span class="p">,</span> <span class="n">model</span><span class="p">))</span> <span class="o">+</span>
      <span class="nf">theme </span><span class="p">(</span><span class="n">plot.title</span> <span class="o">=</span> <span class="nf">element_text </span><span class="p">(</span><span class="n">size</span> <span class="o">=</span> <span class="p">(</span><span class="n">font_size</span><span class="m">+1</span><span class="p">)))</span>
  <span class="p">}</span>

  <span class="c1"># use patchwork to wrap all plots into a single display  </span>
  <span class="nf">wrap_plots</span><span class="p">(</span><span class="n">tracking_g</span><span class="p">,</span> <span class="n">ncol</span><span class="o">=</span><span class="m">2</span><span class="p">)</span>


<span class="p">}</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="nf">QTracking</span><span class="p">(</span><span class="n">model_forecasts</span><span class="p">,</span>
          <span class="n">model_names</span> <span class="o">=</span> <span class="n">model_names</span><span class="p">,</span>
          <span class="n">primary_predictor</span> <span class="o">=</span> <span class="s">&quot;acc&quot;</span><span class="p">,</span>
          <span class="n">secondary_predictor</span> <span class="o">=</span> <span class="s">&quot;dev&quot;</span><span class="p">,</span>
          <span class="n">secondary_predictor_val</span> <span class="o">=</span> <span class="m">5</span><span class="p">,</span>
          <span class="n">xaxis_label</span> <span class="o">=</span> <span class="s">&quot;Accident Quarter&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/MLRWP_R_mlr3_165_0.png" src="../_images/MLRWP_R_mlr3_165_0.png" />
</div>
</div>
<p>Because this is mostly old data and because it is not affected by the interaction, the tracking should be generally good, even for the Chain ladder - which is the case (apart from the final quarter being a bit wild as can happen with a Chain ladder).
The decision tree model is poor, the random forest and XGBoost model show some evidence of overfitting. The LASSO model seems to strike the right balance.</p>
<p>Here are a few more tracking plots to help further illustrate the model fits.</p>
<p><strong>Tracking for accident quarter when development quarter = 24</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="nf">QTracking</span><span class="p">(</span><span class="n">model_forecasts</span><span class="p">,</span>
          <span class="n">model_names</span> <span class="o">=</span> <span class="n">model_names</span><span class="p">,</span>
          <span class="n">primary_predictor</span> <span class="o">=</span> <span class="s">&quot;acc&quot;</span><span class="p">,</span>
          <span class="n">secondary_predictor</span> <span class="o">=</span> <span class="s">&quot;dev&quot;</span><span class="p">,</span>
          <span class="n">secondary_predictor_val</span> <span class="o">=</span> <span class="m">24</span><span class="p">,</span>
          <span class="n">xaxis_label</span> <span class="o">=</span> <span class="s">&quot;Accident Quarter&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/MLRWP_R_mlr3_167_0.png" src="../_images/MLRWP_R_mlr3_167_0.png" />
</div>
</div>
<p>Development quarter 24 is impacted by the interactions for accident quarters&gt;17.
All models reflect this to different extents, with XGBoost and the LASSO doing the best.</p>
<p><strong>Tracking for accident quarter when development quarter = 35</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="nf">QTracking</span><span class="p">(</span><span class="n">model_forecasts</span><span class="p">,</span>
          <span class="n">model_names</span> <span class="o">=</span> <span class="n">model_names</span><span class="p">,</span>
          <span class="n">primary_predictor</span> <span class="o">=</span> <span class="s">&quot;acc&quot;</span><span class="p">,</span>
          <span class="n">secondary_predictor</span> <span class="o">=</span> <span class="s">&quot;dev&quot;</span><span class="p">,</span>
          <span class="n">secondary_predictor_val</span> <span class="o">=</span> <span class="m">35</span><span class="p">,</span>
          <span class="n">xaxis_label</span> <span class="o">=</span> <span class="s">&quot;Accident Quarter&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/MLRWP_R_mlr3_170_0.png" src="../_images/MLRWP_R_mlr3_170_0.png" />
</div>
</div>
<p>This is quite hard for the models since most of the values are in the future. XGBoost (previously tuned) and the LASSO are the best here.</p>
<p>We can look at similar plots by development quarter for older and newer accident quarters</p>
<p><strong>Tracking for development quarter when accident quarter = 5</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="nf">QTracking</span><span class="p">(</span><span class="n">model_forecasts</span><span class="p">,</span>
          <span class="n">model_names</span> <span class="o">=</span> <span class="n">model_names</span><span class="p">,</span>
          <span class="n">primary_predictor</span> <span class="o">=</span> <span class="s">&quot;dev&quot;</span><span class="p">,</span>
          <span class="n">secondary_predictor</span> <span class="o">=</span> <span class="s">&quot;acc&quot;</span><span class="p">,</span>
          <span class="n">secondary_predictor_val</span> <span class="o">=</span> <span class="m">5</span><span class="p">,</span>
          <span class="n">xaxis_label</span> <span class="o">=</span> <span class="s">&quot;Development Quarter&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/MLRWP_R_mlr3_175_0.png" src="../_images/MLRWP_R_mlr3_175_0.png" />
</div>
</div>
<p><strong>Tracking for development quarter when accident quarter = 20</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="nf">QTracking</span><span class="p">(</span><span class="n">model_forecasts</span><span class="p">,</span>
          <span class="n">model_names</span> <span class="o">=</span> <span class="n">model_names</span><span class="p">,</span>
          <span class="n">primary_predictor</span> <span class="o">=</span> <span class="s">&quot;dev&quot;</span><span class="p">,</span>
          <span class="n">secondary_predictor</span> <span class="o">=</span> <span class="s">&quot;acc&quot;</span><span class="p">,</span>
          <span class="n">secondary_predictor_val</span> <span class="o">=</span> <span class="m">20</span><span class="p">,</span>
          <span class="n">xaxis_label</span> <span class="o">=</span> <span class="s">&quot;Development Quarter&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/MLRWP_R_mlr3_178_0.png" src="../_images/MLRWP_R_mlr3_178_0.png" />
</div>
</div>
</div>
</div>
</div>
<div class="tex2jax_ignore mathjax_ignore section" id="reserves">
<h1>Reserves<a class="headerlink" href="#reserves" title="Permalink to this headline">¶</a></h1>
<p>Finally, we’ll look at the reserve estimates from the different models. For convenience, here’s the mapping of model name to model type again:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">regr.glm</span></code> - Chainladder</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">regr.cv_glmnet</span></code> - LASSO</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">regr.rpart</span></code> - decision tree</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">regr.ranger</span></code> - random forest</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">regr.xgboost</span></code> and <code class="docutils literal notranslate"><span class="pre">regr.xgboost_prev</span></code> - the two XGBoost models.</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="c1"># summarise the future payments and each model projection by accident quarter</span>
<span class="c1"># remember ml is a character vector of all the model names, which are columns of</span>
<span class="c1">#   fitted values in model_forecasts</span>

<span class="c1"># get reserves and payments by accident quarter</span>
<span class="n">os_acc</span> <span class="o">&lt;-</span> <span class="n">model_forecasts_long</span><span class="p">[</span><span class="n">train_ind</span> <span class="o">==</span> <span class="kc">FALSE</span><span class="p">,</span> <span class="nf">.</span><span class="p">(</span><span class="n">actual</span><span class="o">=</span><span class="nf">sum</span><span class="p">(</span><span class="n">pmts</span><span class="p">)</span><span class="o">/</span><span class="m">1e9</span><span class="p">,</span> <span class="n">reserve</span><span class="o">=</span><span class="nf">sum</span><span class="p">(</span><span class="n">fitted</span><span class="p">)</span><span class="o">/</span><span class="m">1e9</span><span class="p">),</span> <span class="n">by</span><span class="o">=</span><span class="nf">.</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">acc</span><span class="p">)]</span>

<span class="c1"># make full tidy data set by stacking actuals</span>
<span class="n">os_acc</span> <span class="o">&lt;-</span> <span class="nf">rbind</span><span class="p">(</span><span class="n">os_acc</span><span class="p">[</span><span class="n">model</span><span class="o">==</span><span class="s">&quot;regr.glm&quot;</span><span class="p">,][,</span> <span class="n">reserve</span> <span class="o">:=</span> <span class="n">actual</span><span class="p">][,</span> <span class="n">model</span> <span class="o">:=</span> <span class="s">&quot;actual&quot;</span><span class="p">],</span>
                <span class="n">os_acc</span><span class="p">)</span>

<span class="c1"># adjust levels of factor to ger correct ordering</span>
<span class="n">os_acc</span><span class="p">[,</span> <span class="n">model</span> <span class="o">:=</span> <span class="nf">factor</span><span class="p">(</span><span class="nf">as.character</span><span class="p">(</span><span class="n">model</span><span class="p">),</span> <span class="n">level</span><span class="o">=</span><span class="nf">c</span><span class="p">(</span><span class="s">&quot;actual&quot;</span><span class="p">,</span> <span class="s">&quot;regr.cv_glmnet&quot;</span><span class="p">,</span> <span class="s">&quot;regr.glm&quot;</span><span class="p">,</span> <span class="s">&quot;regr.ranger&quot;</span><span class="p">,</span>
                                                      <span class="s">&quot;regr.rpart&quot;</span><span class="p">,</span> <span class="s">&quot;regr.xgboost&quot;</span><span class="p">,</span> <span class="s">&quot;regr.xgboost_prev&quot;</span><span class="p">))]</span>

<span class="nf">setkey</span><span class="p">(</span><span class="n">os_acc</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">acc</span><span class="p">)</span>


<span class="c1"># create a factor variable from model so we can order it in the plot as we wish</span>
<span class="n">g1</span> <span class="o">&lt;-</span> <span class="nf">ggplot</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">os_acc</span><span class="p">,</span> <span class="nf">aes</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">acc</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">reserve</span><span class="p">,</span> <span class="n">group</span><span class="o">=</span><span class="n">model</span><span class="p">))</span> <span class="o">+</span>
  <span class="nf">geom_line</span><span class="p">(</span><span class="nf">aes</span><span class="p">(</span><span class="n">linetype</span><span class="o">=</span><span class="n">model</span><span class="p">,</span> <span class="n">colour</span><span class="o">=</span><span class="n">model</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">model</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="n">model</span><span class="p">))</span><span class="o">+</span>
  <span class="nf">scale_colour_manual</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&quot;&quot;</span><span class="p">,</span> <span class="n">values</span><span class="o">=</span><span class="nf">c</span><span class="p">(</span><span class="n">dgrey</span><span class="p">,</span> <span class="n">red</span><span class="p">,</span> <span class="n">dgrey</span><span class="p">,</span> <span class="n">fuscia</span><span class="p">,</span> <span class="n">dgrey</span><span class="p">,</span> <span class="n">mblue</span><span class="p">,</span> <span class="n">gold</span><span class="p">))</span><span class="o">+</span>
  <span class="nf">scale_linetype_manual</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&quot;&quot;</span><span class="p">,</span> <span class="n">values</span><span class="o">=</span><span class="nf">c</span><span class="p">(</span><span class="s">&quot;solid&quot;</span><span class="p">,</span> <span class="s">&quot;solid&quot;</span><span class="p">,</span> <span class="s">&quot;dotted&quot;</span><span class="p">,</span> <span class="s">&quot;dotdash&quot;</span><span class="p">,</span> <span class="s">&quot;dashed&quot;</span><span class="p">,</span> <span class="s">&quot;longdash&quot;</span><span class="p">,</span> <span class="s">&quot;solid&quot;</span><span class="p">))</span><span class="o">+</span>
  <span class="nf">scale_size_manual</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&quot;&quot;</span><span class="p">,</span> <span class="n">values</span><span class="o">=</span><span class="nf">c</span><span class="p">(</span><span class="m">2.5</span><span class="p">,</span> <span class="m">2</span><span class="p">,</span> <span class="m">1</span><span class="p">,</span> <span class="m">1.25</span><span class="p">,</span> <span class="m">1</span><span class="p">,</span> <span class="m">1.25</span><span class="p">,</span> <span class="m">1.5</span><span class="p">))</span><span class="o">+</span>
  <span class="nf">scale_alpha_manual</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&quot;&quot;</span><span class="p">,</span> <span class="n">values</span><span class="o">=</span><span class="nf">c</span><span class="p">(</span><span class="m">1</span><span class="p">,</span> <span class="m">0.9</span><span class="p">,</span> <span class="m">0.5</span><span class="p">,</span> <span class="m">0.7</span><span class="p">,</span> <span class="m">0.5</span><span class="p">,</span> <span class="m">0.7</span><span class="p">,</span> <span class="m">0.9</span><span class="p">))</span><span class="o">+</span>
  <span class="nf">coord_cartesian</span><span class="p">(</span><span class="n">ylim</span><span class="o">=</span><span class="nf">c</span><span class="p">(</span><span class="m">0</span><span class="p">,</span> <span class="m">100</span><span class="p">),</span> <span class="n">xlim</span><span class="o">=</span><span class="nf">c</span><span class="p">(</span><span class="m">0</span><span class="p">,</span> <span class="m">40</span><span class="p">))</span><span class="o">+</span>
  <span class="nf">theme_classic</span><span class="p">()</span> <span class="o">+</span>
  <span class="nf">theme</span><span class="p">(</span><span class="n">legend.position</span> <span class="o">=</span> <span class="s">&quot;bottom&quot;</span><span class="p">)</span><span class="o">+</span>
  <span class="nf">labs</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="s">&quot;Reserve (Bn)&quot;</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="s">&quot;Accident Quarter&quot;</span><span class="p">)</span><span class="o">+</span>
  <span class="kc">NULL</span>

<span class="n">g1</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/MLRWP_R_mlr3_181_0.png" src="../_images/MLRWP_R_mlr3_181_0.png" />
</div>
</div>
<p>Let’s look at a zoomed in version of this plot.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">g1</span> <span class="o">+</span> <span class="nf">coord_cartesian</span><span class="p">(</span><span class="n">ylim</span><span class="o">=</span><span class="nf">c</span><span class="p">(</span><span class="m">0</span><span class="p">,</span> <span class="m">40</span><span class="p">),</span> <span class="n">xlim</span><span class="o">=</span><span class="nf">c</span><span class="p">(</span><span class="m">10</span><span class="p">,</span> <span class="m">40</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Coordinate system already present. Adding new coordinate system, which will replace the existing one.
</pre></div>
</div>
<img alt="../_images/MLRWP_R_mlr3_184_1.png" src="../_images/MLRWP_R_mlr3_184_1.png" />
</div>
</div>
<p>Finally, here are the overall reserves, summed over all accident quarters</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">os</span> <span class="o">&lt;-</span> <span class="n">os_acc</span><span class="p">[,</span> <span class="nf">.</span><span class="p">(</span><span class="n">reserve</span><span class="o">=</span><span class="nf">sum</span><span class="p">(</span><span class="n">reserve</span><span class="p">),</span> <span class="n">actual</span><span class="o">=</span><span class="nf">sum</span><span class="p">(</span><span class="n">actual</span><span class="p">)),</span> <span class="n">by</span><span class="o">=</span><span class="nf">.</span><span class="p">(</span><span class="n">model</span><span class="p">)]</span>
<span class="n">os</span><span class="p">[,</span> <span class="n">ratio</span> <span class="o">:=</span> <span class="m">100</span><span class="o">*</span><span class="n">reserve</span> <span class="o">/</span> <span class="n">actual</span><span class="p">][,</span> <span class="n">actual</span> <span class="o">:=</span> <span class="kc">NULL</span><span class="p">]</span>


<span class="c1"># sort</span>
<span class="n">os</span><span class="p">[,</span> <span class="n">ratio_diff</span> <span class="o">:=</span> <span class="nf">abs</span><span class="p">(</span><span class="n">ratio</span><span class="m">-100</span><span class="p">)]</span>
<span class="n">os</span> <span class="o">&lt;-</span> <span class="n">os</span><span class="p">[</span><span class="nf">order</span><span class="p">(</span><span class="n">ratio_diff</span><span class="p">)][,</span> <span class="n">ratio_diff</span> <span class="o">:=</span> <span class="kc">NULL</span><span class="p">]</span>

<span class="c1"># output table</span>
<span class="nf">setnames</span><span class="p">(</span><span class="n">os</span><span class="p">,</span> <span class="nf">c</span><span class="p">(</span><span class="s">&quot;model&quot;</span><span class="p">,</span> <span class="s">&quot;reserve&quot;</span><span class="p">,</span> <span class="s">&quot;ratio&quot;</span><span class="p">),</span> <span class="nf">c</span><span class="p">(</span><span class="s">&quot;Model&quot;</span><span class="p">,</span> <span class="s">&quot;Reserve(Bn)&quot;</span><span class="p">,</span> <span class="s">&quot;Ratio to actual(%)&quot;</span><span class="p">))</span>
<span class="nf">kable_styling</span><span class="p">(</span> <span class="nf">kable</span><span class="p">(</span><span class="n">os</span><span class="p">,</span> <span class="n">digits</span><span class="o">=</span><span class="m">0</span><span class="p">,</span> <span class="n">format.args</span> <span class="o">=</span> <span class="nf">list</span><span class="p">(</span><span class="n">big.mark</span> <span class="o">=</span> <span class="s">&quot;,&quot;</span><span class="p">,</span> <span class="n">scientific</span> <span class="o">=</span> <span class="kc">FALSE</span><span class="p">)),</span>
               <span class="n">full_width</span> <span class="o">=</span> <span class="kc">FALSE</span><span class="p">)</span> <span class="o">%&gt;%</span>
  <span class="nf">as.character</span><span class="p">()</span> <span class="o">%&gt;%</span>
  <span class="nf">display_html</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><table class="table" style="width: auto !important; margin-left: auto; margin-right: auto;">
 <thead>
  <tr>
   <th style="text-align:left;"> Model </th>
   <th style="text-align:right;"> Reserve(Bn) </th>
   <th style="text-align:right;"> Ratio to actual(%) </th>
  </tr>
 </thead>
<tbody>
  <tr>
   <td style="text-align:left;"> actual </td>
   <td style="text-align:right;"> 608 </td>
   <td style="text-align:right;"> 100 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> regr.cv_glmnet </td>
   <td style="text-align:right;"> 628 </td>
   <td style="text-align:right;"> 103 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> regr.xgboost_prev </td>
   <td style="text-align:right;"> 649 </td>
   <td style="text-align:right;"> 107 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> regr.glm </td>
   <td style="text-align:right;"> 563 </td>
   <td style="text-align:right;"> 93 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> regr.ranger </td>
   <td style="text-align:right;"> 804 </td>
   <td style="text-align:right;"> 132 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> regr.xgboost </td>
   <td style="text-align:right;"> 1,089 </td>
   <td style="text-align:right;"> 179 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> regr.rpart </td>
   <td style="text-align:right;"> 1,680 </td>
   <td style="text-align:right;"> 276 </td>
  </tr>
</tbody>
</table></div></div>
</div>
<p>The best performers are the LASSO and the previously tuned XGBoost model.
The overall reserve for the Chainladder model (regr.glm) hides the fact that this result is actually significant under-estimation in most accident quarters balanced by significant over-estimation in the last.</p>
</div>
<div class="tex2jax_ignore mathjax_ignore section" id="commentary">
<h1>Commentary<a class="headerlink" href="#commentary" title="Permalink to this headline">¶</a></h1>
<p>What’s going on with the XGBoost results?</p>
<p>As we noted when we fitted the XGBoost model, there are a few components of randomness from one run to another, with different seeds:</p>
<ol class="simple">
<li><p>The cross validation folds will be different</p></li>
<li><p>The random search parameters will be different.</p></li>
</ol>
<p>For a small data set like this one, this has the potential to alter the results - afterall, getting a good result on the future data depends on whether the tuning gets lucky in terms of estimating the magnitude of the interaction.</p>
<p>We could reduce the variability by uisng a grid-search over a fixed set of parameters but - full disclosure - that led to even worse results.</p>
<p>So what’s going on?
It might be helpful to have another look at the folds used in the cross-validation.
These are shown below - the yellow dots represent training data points in each fold, the blue dots are the test data.
The grey rectangle marks the interaction.</p>
<div class="cell tag_remove_input docutils container">
</div>
<div class="cell tag_remove_input docutils container">
<div class="cell_output docutils container">
<img alt="../_images/MLRWP_R_mlr3_191_0.png" src="../_images/MLRWP_R_mlr3_191_0.png" />
</div>
</div>
<p>The first thing that is apparent is that the interaction only applies to a very small number of points (10) in the past data.
So in that sense, it’s quite remarkable that the models perform as well as they actually do - they all detect the interaction.
Where they start to slip up is that they do not necessarily follow the development quarter shape in the tail.</p>
<p>With cross-validation, all points are in the test data set once and once only.
So it seems to be the case that the particular allocation of data into folds in this notebook leads to poorer results for the XGBoost model.
In other words, in our previous tuning for XGBoost we got lucky.</p>
<p>So far, XGBoost seems to be the only model impacted in this way. Based on looking at a few different sets of results, the LASSO model has generally been good for different folds and for 5-, 6- and 8-fold validation. The performance of the ranger model doesn’t appear to change all that much.</p>
<p>However, given XGBoost’s popularity and flexibility, this result is not ideal.
The question is: can we improve matters?</p>
<p>Success in machine learning often comes down to optimising the following:</p>
<ul class="simple">
<li><p>What you model</p></li>
<li><p>How you model (i.e. what features you use)</p></li>
<li><p>Your performance measure</p></li>
<li><p>Your train/test split.</p></li>
</ul>
<p>Reserving is a forecasting problem - we have a time series of payments and we want to forecast into the future.
This suggests that cross-validation is not an ideal method for tuning reserving models - we would be better with a train/test split where the test data is in the future relative to the past data.</p>
<p>This problem has been discussed in the context of time series modelling, where the use of rolling window cross-validation techniques has been advocated.
We’ll be discussing this in a future article.</p>
</div>
<div class="tex2jax_ignore mathjax_ignore section" id="conclusion">
<h1>Conclusion<a class="headerlink" href="#conclusion" title="Permalink to this headline">¶</a></h1>
<p>We set out to demonstrate how to fit a number of reserving models to a data set.
Our results have been mixed - but we expected that in advance.
This work lays a baseline for our upcoming articles where we will look at ways of improving the results through:</p>
<ul class="simple">
<li><p>expanding the range of models</p></li>
<li><p>considering more appropriate validation techniques.</p></li>
</ul>
<div class="section" id="what-next">
<h2>What next?<a class="headerlink" href="#what-next" title="Permalink to this headline">¶</a></h2>
<p>You can try running this code and changing some things - e.g. the hyper-parameters tuned, search strategy, number of iterations etc.</p>
<p>You can also try running the code for different data sets. It’s best to initially work with data sets that are familiar to you, so your own data sets or other simulated data sets may be useful here. In the code block below, we’ve shared the code used to generate the data set we used. You can generate other data sets as described in the <a class="reference external" href="https://papers.ssrn.com/sol3/papers.cfm?abstract_id=3241906">LASSO paper</a> using the code block below. More details are in the paper, but in brief:</p>
<ul class="simple">
<li><p>Data set 1 = a Chainladder model</p></li>
<li><p>Data set 2 = a Chainladder model + calendar period effects</p></li>
<li><p>Data set 3 = the data set used here</p></li>
<li><p>Data set 4 = data set 2 but where the strength of the calendar period effect varies by development period.</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="nf">library</span><span class="p">(</span><span class="n">data.table</span><span class="p">)</span>

<span class="c1"># this function generates the four different forms of data set as described in the LASSO paper</span>

<span class="n">CreateSyntheticData</span><span class="o">&lt;-</span><span class="nf">function</span><span class="p">(</span><span class="n">whichsim</span><span class="p">,</span> <span class="n">numperiods</span><span class="p">)</span>
<span class="p">{</span>

	<span class="c1"># create the acc/dev/cal parameters</span>
	<span class="n">kk</span> <span class="o">&lt;-</span> <span class="nf">rep</span><span class="p">(</span><span class="m">1</span><span class="o">:</span><span class="n">numperiods</span><span class="p">,</span> <span class="n">each</span> <span class="o">=</span> <span class="n">numperiods</span><span class="p">)</span> <span class="c1">#AQ</span>
	<span class="n">jj</span> <span class="o">&lt;-</span> <span class="nf">rep</span><span class="p">(</span><span class="m">1</span><span class="o">:</span><span class="n">numperiods</span><span class="p">,</span> <span class="n">times</span><span class="o">=</span> <span class="n">numperiods</span><span class="p">)</span> <span class="c1">#DQ</span>
	<span class="n">tt</span> <span class="o">&lt;-</span> <span class="n">kk</span><span class="o">+</span><span class="n">jj</span><span class="m">-1</span> <span class="c1"># PQ</span>

	<span class="c1"># set alpha/beta/gamma - hard-code up the sim values</span>
	<span class="nf">if </span><span class="p">(</span><span class="n">whichsim</span> <span class="o">==</span> <span class="m">1</span><span class="p">){</span>
		<span class="n">alpha</span> <span class="o">&lt;-</span> <span class="nf">log</span><span class="p">(</span><span class="m">100000</span><span class="p">)</span><span class="m">+0.1</span><span class="o">*</span><span class="nf">LinearSpline</span><span class="p">(</span><span class="n">kk</span><span class="p">,</span><span class="m">1</span><span class="p">,</span><span class="m">15</span><span class="p">)</span><span class="m">+0.2</span><span class="o">*</span><span class="nf">LinearSpline</span><span class="p">(</span><span class="n">kk</span><span class="p">,</span><span class="m">15</span><span class="p">,</span><span class="m">20</span><span class="p">)</span> <span class="o">-</span> <span class="m">0.05</span><span class="o">*</span><span class="nf">LinearSpline</span><span class="p">(</span><span class="n">kk</span><span class="p">,</span><span class="m">30</span><span class="p">,</span><span class="m">40</span><span class="p">)</span>
		<span class="n">beta</span>  <span class="o">&lt;-</span> <span class="p">(</span><span class="m">16</span><span class="o">/</span><span class="m">3</span> <span class="o">-</span> <span class="m">1</span><span class="p">)</span><span class="o">*</span><span class="nf">log</span><span class="p">(</span><span class="n">jj</span><span class="p">)</span><span class="o">-</span> <span class="p">(</span><span class="m">1</span><span class="o">/</span><span class="m">3</span><span class="p">)</span><span class="o">*</span><span class="n">jj</span>
		<span class="n">gamma</span> <span class="o">&lt;-</span> <span class="m">0</span>
		<span class="n">mu</span> <span class="o">&lt;-</span> <span class="nf">exp</span><span class="p">(</span> <span class="n">alpha</span> <span class="o">+</span> <span class="n">beta</span> <span class="o">+</span> <span class="n">gamma</span><span class="p">)</span>  
	<span class="p">}</span>
	<span class="n">else</span> <span class="nf">if </span><span class="p">(</span><span class="n">whichsim</span> <span class="o">==</span> <span class="m">2</span><span class="p">){</span>
		<span class="n">alpha</span> <span class="o">&lt;-</span> <span class="nf">log</span><span class="p">(</span><span class="m">100000</span><span class="p">)</span><span class="m">+0.1</span><span class="o">*</span><span class="nf">LinearSpline</span><span class="p">(</span><span class="n">kk</span><span class="p">,</span><span class="m">1</span><span class="p">,</span><span class="m">15</span><span class="p">)</span><span class="m">+0.2</span><span class="o">*</span><span class="nf">LinearSpline</span><span class="p">(</span><span class="n">kk</span><span class="p">,</span><span class="m">15</span><span class="p">,</span><span class="m">20</span><span class="p">)</span> <span class="o">-</span> <span class="m">0.05</span><span class="o">*</span><span class="nf">LinearSpline</span><span class="p">(</span><span class="n">kk</span><span class="p">,</span><span class="m">30</span><span class="p">,</span><span class="m">40</span><span class="p">)</span>
		<span class="n">beta</span>  <span class="o">&lt;-</span> <span class="p">(</span><span class="m">16</span><span class="o">/</span><span class="m">3</span> <span class="o">-</span> <span class="m">1</span><span class="p">)</span><span class="o">*</span><span class="nf">log</span><span class="p">(</span><span class="n">jj</span><span class="p">)</span><span class="o">-</span> <span class="p">(</span><span class="m">1</span><span class="o">/</span><span class="m">3</span><span class="p">)</span><span class="o">*</span><span class="n">jj</span>  <span class="c1"># a is 16/3, b is 1/3</span>
		<span class="n">gamma</span> <span class="o">&lt;-</span> <span class="nf">gammafunc</span><span class="p">(</span><span class="n">tt</span><span class="p">)</span>
		<span class="n">mu</span> <span class="o">&lt;-</span> <span class="nf">exp</span><span class="p">(</span> <span class="n">alpha</span> <span class="o">+</span> <span class="n">beta</span> <span class="o">+</span> <span class="n">gamma</span><span class="p">)</span>  
	<span class="p">}</span>
	<span class="n">else</span> <span class="nf">if </span><span class="p">(</span><span class="n">whichsim</span> <span class="o">==</span> <span class="m">3</span><span class="p">){</span>
		<span class="n">alpha</span> <span class="o">&lt;-</span> <span class="nf">log</span><span class="p">(</span><span class="m">100000</span><span class="p">)</span><span class="m">+0.1</span><span class="o">*</span><span class="nf">LinearSpline</span><span class="p">(</span><span class="n">kk</span><span class="p">,</span><span class="m">1</span><span class="p">,</span><span class="m">15</span><span class="p">)</span><span class="m">+0.2</span><span class="o">*</span><span class="nf">LinearSpline</span><span class="p">(</span><span class="n">kk</span><span class="p">,</span><span class="m">15</span><span class="p">,</span><span class="m">20</span><span class="p">)</span> <span class="o">-</span> <span class="m">0.05</span><span class="o">*</span><span class="nf">LinearSpline</span><span class="p">(</span><span class="n">kk</span><span class="p">,</span><span class="m">30</span><span class="p">,</span><span class="m">40</span><span class="p">)</span>
		<span class="n">beta</span>  <span class="o">&lt;-</span> <span class="p">(</span><span class="m">16</span><span class="o">/</span><span class="m">3</span> <span class="o">-</span> <span class="m">1</span><span class="p">)</span><span class="o">*</span><span class="nf">log</span><span class="p">(</span><span class="n">jj</span><span class="p">)</span><span class="o">-</span> <span class="p">(</span><span class="m">1</span><span class="o">/</span><span class="m">3</span><span class="p">)</span><span class="o">*</span><span class="n">jj</span>  <span class="c1"># a is 16/3, b is 1/3</span>
		<span class="n">gamma</span> <span class="o">&lt;-</span> <span class="nf">gammafunc</span><span class="p">(</span><span class="n">tt</span><span class="p">)</span>
		<span class="n">mu</span> <span class="o">&lt;-</span> <span class="nf">exp</span><span class="p">(</span> <span class="n">alpha</span> <span class="o">+</span> <span class="n">beta</span> <span class="o">+</span> <span class="n">gamma</span> <span class="o">+</span> <span class="m">0.3</span><span class="o">*</span><span class="n">beta</span><span class="o">*</span><span class="nf">ifelse</span><span class="p">(</span><span class="n">kk</span><span class="o">&gt;</span><span class="m">16</span> <span class="o">&amp;</span> <span class="n">jj</span><span class="o">&gt;</span><span class="m">20</span><span class="p">,</span><span class="m">1</span><span class="p">,</span><span class="m">0</span><span class="p">))</span>  
	<span class="p">}</span>
	<span class="n">else</span> <span class="nf">if </span><span class="p">(</span><span class="n">whichsim</span> <span class="o">==</span> <span class="m">4</span><span class="p">){</span>
		<span class="n">alpha</span> <span class="o">&lt;-</span> <span class="nf">log</span><span class="p">(</span><span class="m">100000</span><span class="p">)</span><span class="m">+0.1</span><span class="o">*</span><span class="nf">LinearSpline</span><span class="p">(</span><span class="n">kk</span><span class="p">,</span><span class="m">1</span><span class="p">,</span><span class="m">15</span><span class="p">)</span><span class="m">+0.2</span><span class="o">*</span><span class="nf">LinearSpline</span><span class="p">(</span><span class="n">kk</span><span class="p">,</span><span class="m">15</span><span class="p">,</span><span class="m">20</span><span class="p">)</span> <span class="o">-</span> <span class="m">0.05</span><span class="o">*</span><span class="nf">LinearSpline</span><span class="p">(</span><span class="n">kk</span><span class="p">,</span><span class="m">30</span><span class="p">,</span><span class="m">40</span><span class="p">)</span>
		<span class="n">beta</span>  <span class="o">&lt;-</span> <span class="p">(</span><span class="m">16</span><span class="o">/</span><span class="m">3</span> <span class="o">-</span> <span class="m">1</span><span class="p">)</span><span class="o">*</span><span class="nf">log</span><span class="p">(</span><span class="n">jj</span><span class="p">)</span><span class="o">-</span> <span class="p">(</span><span class="m">1</span><span class="o">/</span><span class="m">3</span><span class="p">)</span><span class="o">*</span><span class="n">jj</span>  <span class="c1"># a is 16/3, b is 1/3</span>
		<span class="n">gamma</span> <span class="o">&lt;-</span> <span class="nf">gammafunc</span><span class="p">(</span><span class="n">tt</span><span class="p">)</span>
		<span class="n">mu</span> <span class="o">&lt;-</span> <span class="nf">exp</span><span class="p">(</span> <span class="n">alpha</span> <span class="o">+</span> <span class="n">beta</span> <span class="o">+</span> <span class="n">gamma</span><span class="o">*</span><span class="p">((</span><span class="n">numperiods</span><span class="m">-1</span><span class="p">)</span><span class="o">-</span><span class="nf">LinearSpline</span><span class="p">(</span><span class="n">jj</span><span class="p">,</span><span class="m">1</span><span class="p">,</span><span class="n">numperiods</span><span class="p">))</span><span class="o">/</span><span class="p">(</span><span class="n">numperiods</span><span class="m">-1</span><span class="p">)</span> <span class="p">)</span>  <span class="c1"># need to check</span>
	<span class="p">}</span>

	<span class="n">varbase</span> <span class="o">&lt;-</span> <span class="p">(</span><span class="m">0.3</span> <span class="o">*</span> <span class="n">mu</span><span class="p">[</span>  <span class="n">kk</span><span class="o">==</span><span class="m">1</span> <span class="o">&amp;</span> <span class="n">jj</span> <span class="o">==</span><span class="m">16</span><span class="p">]</span> <span class="p">)</span><span class="o">^</span><span class="m">2</span> <span class="c1"># can scale variance up and down here</span>
	<span class="n">CC</span>  <span class="o">&lt;-</span>  <span class="n">varbase</span> <span class="o">/</span> <span class="n">mu</span><span class="p">[</span>  <span class="n">kk</span><span class="o">==</span><span class="m">1</span> <span class="o">&amp;</span> <span class="n">jj</span> <span class="o">==</span><span class="m">16</span><span class="p">]</span>

	<span class="n">vars</span>   <span class="o">&lt;-</span> <span class="n">CC</span><span class="o">*</span><span class="n">mu</span>
	<span class="n">tausq</span>  <span class="o">&lt;-</span> <span class="nf">log </span><span class="p">(</span><span class="n">vars</span> <span class="o">/</span> <span class="p">(</span><span class="n">mu</span><span class="o">^</span><span class="m">2</span><span class="p">)</span> <span class="o">+</span> <span class="m">1</span><span class="p">)</span>

	<span class="n">pmts</span> <span class="o">&lt;-</span> <span class="nf">exp</span><span class="p">(</span> <span class="nf">rnorm</span><span class="p">(</span> <span class="n">numperiods</span><span class="o">^</span><span class="m">2</span><span class="p">,</span> <span class="n">mean</span> <span class="o">=</span> <span class="nf">log</span><span class="p">(</span><span class="n">mu</span><span class="p">)</span><span class="m">-0.5</span><span class="o">*</span><span class="n">tausq</span> <span class="p">,</span> <span class="n">sd</span> <span class="o">=</span> <span class="nf">sqrt</span><span class="p">(</span><span class="n">tausq</span><span class="p">)</span>  <span class="p">)</span> <span class="p">)</span>

	<span class="c1"># indicator for past/future = traint/test</span>
	<span class="n">train_ind</span><span class="o">&lt;-</span><span class="p">(</span><span class="n">tt</span><span class="o">&lt;=</span><span class="n">numperiods</span><span class="p">)</span>

	<span class="c1">### data fram for output</span>
	<span class="n">full</span><span class="o">&lt;-</span><span class="nf">data.table</span><span class="p">(</span><span class="n">pmts</span><span class="p">,</span> <span class="n">acc</span><span class="o">=</span><span class="nf">as.integer</span><span class="p">(</span><span class="n">kk</span><span class="p">),</span> <span class="n">dev</span><span class="o">=</span><span class="nf">as.integer</span><span class="p">(</span><span class="n">jj</span><span class="p">),</span> <span class="n">cal</span><span class="o">=</span><span class="nf">as.integer</span><span class="p">(</span><span class="n">tt</span><span class="p">),</span> <span class="n">mu</span><span class="p">,</span> <span class="n">train_ind</span> <span class="p">)</span>
	<span class="n">full</span>
<span class="p">}</span>


<span class="c1">#---------------------------</span>
<span class="c1"># function to generate calendar period effects used in CreateSyntheticData()</span>

<span class="n">gammafunc</span> <span class="o">&lt;-</span> <span class="nf">function</span><span class="p">(</span><span class="n">t</span><span class="p">){</span>
	<span class="n">gg</span> <span class="o">&lt;-</span>
		<span class="nf">ifelse</span><span class="p">(</span> <span class="n">t</span><span class="o">&lt;=</span><span class="m">12</span><span class="p">,</span> <span class="n">gg</span> <span class="o">&lt;-</span> <span class="m">0.0075</span><span class="o">*</span><span class="nf">LinearSpline</span><span class="p">(</span><span class="n">t</span><span class="p">,</span><span class="m">1</span><span class="p">,</span><span class="m">12</span><span class="p">),</span>
				<span class="nf">ifelse</span><span class="p">(</span><span class="n">t</span><span class="o">&lt;=</span><span class="m">24</span><span class="p">,</span>  <span class="n">gg</span> <span class="o">&lt;-</span> <span class="m">0.0075</span><span class="o">*</span><span class="nf">LinearSpline</span><span class="p">(</span><span class="m">12</span><span class="p">,</span><span class="m">1</span><span class="p">,</span><span class="m">12</span><span class="p">)</span> <span class="o">+</span> <span class="m">0.001</span><span class="o">*</span> <span class="p">(</span><span class="n">t</span><span class="m">-12</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">t</span><span class="m">-11</span><span class="p">)</span><span class="o">/</span><span class="m">2</span><span class="p">,</span>
					   <span class="nf">ifelse</span><span class="p">(</span><span class="n">t</span><span class="o">&lt;=</span><span class="m">32</span><span class="p">,</span> <span class="n">gg</span> <span class="o">&lt;-</span> <span class="m">0.0075</span><span class="o">*</span><span class="nf">LinearSpline</span><span class="p">(</span><span class="m">12</span><span class="p">,</span><span class="m">1</span><span class="p">,</span><span class="m">12</span><span class="p">)</span> <span class="o">+</span> <span class="m">0.001</span><span class="o">*</span> <span class="p">(</span><span class="m">24-12</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="m">24-11</span><span class="p">)</span><span class="o">/</span><span class="m">2</span><span class="p">,</span>
					   	   <span class="nf">ifelse</span><span class="p">(</span><span class="n">t</span><span class="o">&lt;=</span><span class="m">40</span><span class="p">,</span> <span class="n">gg</span> <span class="o">&lt;-</span> <span class="m">0.0075</span><span class="o">*</span><span class="nf">LinearSpline</span><span class="p">(</span><span class="m">12</span><span class="p">,</span><span class="m">1</span><span class="p">,</span><span class="m">12</span><span class="p">)</span> <span class="o">+</span> <span class="m">0.001</span><span class="o">*</span> <span class="p">(</span><span class="m">24-12</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="m">24-11</span><span class="p">)</span><span class="o">/</span><span class="m">2</span> <span class="o">+</span> <span class="m">0.002</span><span class="o">*</span><span class="p">(</span><span class="n">t</span><span class="m">-32</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">t</span><span class="m">-31</span><span class="p">)</span><span class="o">/</span><span class="m">2</span><span class="p">,</span>
					   	   	   <span class="m">0.0075</span><span class="o">*</span><span class="nf">LinearSpline</span><span class="p">(</span><span class="m">12</span><span class="p">,</span><span class="m">1</span><span class="p">,</span><span class="m">12</span><span class="p">)</span> <span class="o">+</span> <span class="m">0.001</span><span class="o">*</span> <span class="p">(</span><span class="m">24-12</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="m">24-11</span><span class="p">)</span><span class="o">/</span><span class="m">2</span> <span class="o">+</span> <span class="m">0.002</span><span class="o">*</span><span class="p">(</span><span class="m">40-32</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="m">40-31</span><span class="p">)</span><span class="o">/</span><span class="m">2</span>
					   	   <span class="p">))))</span>
	<span class="m">1</span><span class="o">*</span><span class="n">gg</span>  <span class="c1">#can scale up shape here if desired</span>
<span class="p">}</span>



<span class="c1">#---------------------------</span>
<span class="c1"># linear spline function - used in data generation and in spline generation below</span>
<span class="c1"># this was defined earlier on in this worked example, but including the definition here so it is self-contained</span>
<span class="n">LinearSpline</span> <span class="o">&lt;-</span> <span class="nf">function</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">stop</span><span class="p">){</span>
    <span class="nf">pmin</span><span class="p">(</span><span class="n">stop</span> <span class="o">-</span> <span class="n">start</span><span class="p">,</span> <span class="nf">pmax</span><span class="p">(</span><span class="m">0</span><span class="p">,</span> <span class="n">var</span> <span class="o">-</span> <span class="n">start</span><span class="p">))</span>
<span class="p">}</span>


<span class="c1">#---------------------------</span>
<span class="c1"># How to run the code</span>
<span class="c1"># The code below, including the seed value, recreate the data we used above</span>

<span class="c1"># vary the seed to create different data sets of the same form</span>
<span class="nf">set.seed</span><span class="p">(</span><span class="m">130</span><span class="p">)</span>  

<span class="c1"># whichsim can be 1, 2, 3, 4 to produce data sets in the form above</span>
<span class="c1"># numperiods sets the dimensions of the triangle</span>
<span class="n">dat</span> <span class="o">&lt;-</span> <span class="nf">CreateSyntheticData</span><span class="p">(</span><span class="n">whichsim</span> <span class="o">=</span> <span class="m">3</span><span class="p">,</span> <span class="n">numperiods</span> <span class="o">=</span> <span class="m">40</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>If you are looking for something more advanced, then have a look at our 3-part series on an advanced example where individual data and a number of different features are used in an XGBoost model. To find this follow the links:</p>
<ul class="simple">
<li><p><a class="reference external" href="https://institute-and-faculty-of-actuaries.github.io/mlr-blog/post/baudry-part1/">Part 1</a> - data generation</p></li>
<li><p><a class="reference external" href="https://institute-and-faculty-of-actuaries.github.io/mlr-blog/post/baudry-part2/">Part 2</a> - data preparation</p></li>
<li><p><a class="reference external" href="https://institute-and-faculty-of-actuaries.github.io/mlr-blog/post/baudry-part3/">Part 3</a> - modelling and analysis</p></li>
</ul>
</div>
</div>
<div class="tex2jax_ignore mathjax_ignore section" id="session-details">
<h1>Session details<a class="headerlink" href="#session-details" title="Permalink to this headline">¶</a></h1>
<p>The details of the R session used to generate the results are below.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="nf">sessionInfo</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>R version 4.1.0 (2021-05-18)
Platform: x86_64-apple-darwin17.0 (64-bit)
Running under: macOS High Sierra 10.13.6

Matrix products: default
BLAS:   /Library/Frameworks/R.framework/Versions/4.1/Resources/lib/libRblas.dylib
LAPACK: /Library/Frameworks/R.framework/Versions/4.1/Resources/lib/libRlapack.dylib

locale:
[1] en_AU.UTF-8/en_AU.UTF-8/en_AU.UTF-8/C/en_AU.UTF-8/en_AU.UTF-8

attached base packages:
[1] stats     graphics  grDevices utils     datasets  methods   base     

other attached packages:
 [1] IRdisplay_1.0           kableExtra_1.3.4        rpart.plot_3.0.9       
 [4] rpart_4.1-15            patchwork_1.1.1         ggplot2_3.3.4          
 [7] data.table_1.14.0       mlr3extralearners_0.4.7 mlr3tuning_0.8.0       
[10] paradox_0.7.1           mlr3learners_0.4.5      mlr3_0.11.0            

loaded via a namespace (and not attached):
 [1] viridis_0.6.1        httr_1.4.2           jsonlite_1.7.2      
 [4] viridisLite_0.4.0    splines_4.1.0        foreach_1.5.1       
 [7] assertthat_0.2.1     lgr_0.4.2            highr_0.9           
[10] remotes_2.4.0        mlr3misc_0.9.1       globals_0.14.0      
[13] bbotk_0.3.2          pillar_1.6.1         backports_1.2.1     
[16] lattice_0.20-44      glue_1.4.2           uuid_0.1-4          
[19] digest_0.6.27        checkmate_2.0.0      rvest_1.0.0         
[22] colorspace_2.0-1     htmltools_0.5.1.1    Matrix_1.3-3        
[25] pkgconfig_2.0.3      mlr3measures_0.3.1   listenv_0.8.0       
[28] purrr_0.3.4          scales_1.1.1         webshot_0.5.2       
[31] ranger_0.12.1        svglite_2.0.0        tibble_3.1.2        
[34] farver_2.1.0         generics_0.1.0       xgboost_1.4.1.1     
[37] ellipsis_0.3.2       withr_2.4.2          repr_1.1.3          
[40] survival_3.2-11      magrittr_2.0.1       crayon_1.4.1        
[43] evaluate_0.14        future_1.21.0        fansi_0.5.0         
[46] parallelly_1.26.0    xml2_1.3.2           palmerpenguins_0.1.0
[49] tools_4.1.0          lifecycle_1.0.0      stringr_1.4.0       
[52] munsell_0.5.0        glmnet_4.1-1         compiler_4.1.0      
[55] systemfonts_1.0.2    rlang_0.4.11         grid_4.1.0          
[58] pbdZMQ_0.3-5         iterators_1.0.13     IRkernel_1.2        
[61] rstudioapi_0.13      labeling_0.4.2       base64enc_0.1-3     
[64] rmarkdown_2.9        gtable_0.3.0         codetools_0.2-18    
[67] curl_4.3.1           DBI_1.1.1            R6_2.5.0            
[70] gridExtra_2.3        knitr_1.33           dplyr_1.0.7         
[73] future.apply_1.7.0   utf8_1.2.1           shape_1.4.6         
[76] stringi_1.6.2        parallel_4.1.0       Rcpp_1.0.7          
[79] vctrs_0.3.8          tidyselect_1.1.1     xfun_0.23           
</pre></div>
</div>
</div>
</div>
</div>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "ActuariesInstitute/cookbook",
            ref: "main",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "r"
        },
        kernelOptions: {
            kernelName: "ir",
            path: "./docs"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'ir'</script>

              </div>
              
            
                <!-- Previous / next buttons -->
<div class='prev-next-area'> 
    <a class='left-prev' id="prev-link" href="MLRWP_R_Lasso.html" title="previous page">
        <i class="fas fa-angle-left"></i>
        <div class="prev-next-info">
            <p class="prev-next-subtitle">previous</p>
            <p class="prev-next-title">R: Reserving with LASSO</p>
        </div>
    </a>
    <a class='right-next' id="next-link" href="MLRWP_Py_triangles_example.html" title="next page">
    <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Py: Machine Learning Triangles</p>
    </div>
    <i class="fas fa-angle-right"></i>
    </a>
</div>
            
        </div>
    </div>
    <footer class="footer">
  <p>
    
      By YDAWG, DAPC, YAC and other contributors.<br/>
    
      <div class="extra_footer">
         The Actuaries' Analytical Cookbook is a series of data and analytics recipes to help actuaries quickly get started with a new project.   This site is intended to be a resource to actuaries in both data science and traditional fields.  Opinions expressed in this publication are the opinions of contributors and do not necessarily represent those of either the Institute of Actuaries of Australia (the ‘Institute’), its members, directors, officers, employees, agents, or that of the employers of the contributors. <br>© Institute of Actuaries of Australia and Contributors 2021. All rights reserved.
      </div>
  </p>
</footer>
</main>


      </div>
    </div>
  
  <script src="../_static/js/index.be7d3bbb2ef33a8344ce.js"></script>

  </body>
</html>